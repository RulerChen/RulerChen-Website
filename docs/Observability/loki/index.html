<!doctype html><html lang=zh-Hant dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Observability/loki" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.0"><title data-rh=true>[Loki] 惡作劇之神 - Loki 解密日誌迷宮 | RulerChen</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://RulerChen.github.io/RulerChen-Website/img/profile.png><meta data-rh=true name=twitter:image content=https://RulerChen.github.io/RulerChen-Website/img/profile.png><meta data-rh=true property=og:url content=https://RulerChen.github.io/RulerChen-Website/docs/Observability/loki/><meta data-rh=true property=og:locale content=zh_Hant><meta data-rh=true name=docusaurus_locale content=zh-Hant><meta data-rh=true name=docsearch:language content=zh-Hant><meta data-rh=true name=google-site-verification content=QrdRbPEcOsJJ_kfRVewqfwR6GjPcRf0UVgRb85I-5fc><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="[Loki] 惡作劇之神 - Loki 解密日誌迷宮 | RulerChen"><meta data-rh=true name=description content="Grafana Loki 基本介紹"><meta data-rh=true property=og:description content="Grafana Loki 基本介紹"><meta data-rh=true name=keywords content=grafana,loki,log><link data-rh=true rel=icon href=/RulerChen-Website/img/profile.png><link data-rh=true rel=canonical href=https://RulerChen.github.io/RulerChen-Website/docs/Observability/loki/><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/docs/Observability/loki/ hreflang=zh-Hant><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/docs/Observability/loki/ hreflang=x-default><link data-rh=true rel=preconnect href=https://GSV9DQB5UM-dsn.algolia.net crossorigin=anonymous><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://RulerChen.github.io/RulerChen-Website/docs/Observability/","name":"Observability","position":1},{"@type":"ListItem","item":"https://RulerChen.github.io/RulerChen-Website/docs/Observability/loki","name":"[Loki] 惡作劇之神 - Loki 解密日誌迷宮","position":2}]}</script><link rel=alternate type=application/rss+xml href=/RulerChen-Website/blog/rss.xml title="RulerChen RSS Feed"><link rel=alternate type=application/atom+xml href=/RulerChen-Website/blog/atom.xml title="RulerChen Atom Feed"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script><link rel=search type=application/opensearchdescription+xml title=RulerChen href=/RulerChen-Website/opensearch.xml><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><link rel=stylesheet href=/RulerChen-Website/assets/css/styles.f06f4216.css><script src=/RulerChen-Website/assets/js/runtime~main.4fdb14be.js defer></script><script src=/RulerChen-Website/assets/js/main.e4b1fa3b.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark",e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label=跳至主要内容><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>跳至主要内容</a></div><nav aria-label=主導航 class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label=切換導覽列 aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/RulerChen-Website/><div class=navbar__logo><img src=/RulerChen-Website/img/profile.png alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/RulerChen-Website/img/profile.png alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/RulerChen-Website/docs/intro/>Notes</a><a class="navbar__item navbar__link" href=/RulerChen-Website/blog/>Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href=https://github.com/RulerChen target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><a href=https://www.linkedin.com/in/rulerchen/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">Linkdin<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="切換淺色/深色模式（當前為system mode）"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="搜尋 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>搜尋</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label=回到頂部 class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label=文件側邊欄 class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/RulerChen-Website/docs/intro/>Roadmap</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/docs/C++/intro/>C++</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/docs/Python/setup/>Python</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/docs/NodeJs/expresssetup/>Node.js</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/docs/Golang/syntax/>Go</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/docs/Next.js/EslintPrettier/>Next.js</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/docs/PostgreSQL/pg-tuning/>PostgreSQL</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/RulerChen-Website/docs/Observability/>Observability</a><button aria-label="收起側邊欄分類 'Observability'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/RulerChen-Website/docs/Observability/loki/>[Loki] 惡作劇之神 - Loki 解密日誌迷宮</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/loki-demo/>[Loki 實戰] 打造本地日誌蒐集系統</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/grafana/>[Grafana] 眾神之鏡 - Grafana 展現數據視覺化的偉岸</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/tempo/>[Tempo] 時光之韻 - Tempo 捕捉追蹤節奏</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/mimir/>[Mimir] 智慧之泉 - Mimir 啟迪監控新境界</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/mimir-demo/>[Mimir 實戰] 打造本地監控系統</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/alloy/>[Alloy] 神秘鍛造 - Alloy 鍛就數據新神話</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/prometheus/>[Prometheus] 普羅米修斯 - 以神火點燃數據監控革新</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/pyroscope/>[Pyroscope] 火焰之眼 - Pyroscope 剖析性能奧秘</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/belya/>[Belya] 農豐之侍 - 揭開弗雷隨從中的豐饒符號</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Observability/faro/>[Faro] 海之燈塔 - 導航前端性能的明燈</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/docs/Security/log4j/>Security</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/RulerChen-Website/docs/CMU15-445/>CMU 15-445/645</a><button aria-label="展開側邊欄分類 'CMU 15-445/645'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/docs/Others/shell/>Others</a></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_z5aJ"><div class=docItemContainer_c0TR><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=頁面路徑><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label=主頁面 class=breadcrumbs__link href=/RulerChen-Website/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/RulerChen-Website/docs/Observability/><span>Observability</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>[Loki] 惡作劇之神 - Loki 解密日誌迷宮</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>[Loki] 惡作劇之神 - Loki 解密日誌迷宮</h1></header><div style=display:flex;justify-content:center><svg xmlns=http://www.w3.org/2000/svg xml:space=preserve id=Layer_1 width=236.87 height=142.1 x=0 y=0 viewBox="0.36 0.95 236.87 142.1" style=width:200px;height:200px><style>.st0{fill:#f7f7f7}</style><path d="M14.95 128.29h13.73c-1.01 5.66-5.81 9.74-11.49 9.74-6.64 0-11.85-5.38-11.85-12.25 0-6.81 5.48-12.34 12.21-12.34 3.74 0 6.94 2.09 8.97 3.85l.16.14 2.97-3.66-.14-.13c-3.59-3.35-7.72-5.13-11.96-5.13-9.48 0-17.19 7.75-17.19 17.28 0 9.64 7.39 17.19 16.82 17.19 9.04 0 16.41-7.27 16.78-16.54v-2.57H14.95zM40.78 121.28v-1.64h-4.16v23.05h4.93v-13.83c0-2.63 2-4.46 4.87-4.46h2.78v-4.75h-3.28c-2.08-.01-3.92.58-5.14 1.63M67.89 122.22a11.22 11.22 0 0 0-7.54-2.94c-6.58 0-11.93 5.31-11.93 11.84 0 6.58 5.35 11.93 11.93 11.93 2.84 0 5.52-1.04 7.59-2.94v2.58h4.25v-23.05h-4.3zm-.59 8.9c0 3.83-3.1 6.95-6.91 6.95s-6.91-3.12-6.91-6.95c0-3.81 3.1-6.91 6.91-6.91s6.91 3.1 6.91 6.91M75.73 118.71v23.98h4.89v-18.66h7.2v-4.39h-7.2v-1.07c0-1.84 1.51-3.33 3.38-3.33h3.83v-4.66H84c-4.87 0-8.27 3.34-8.27 8.13M106.87 122.22a11.23 11.23 0 0 0-7.54-2.95c-6.58 0-11.93 5.31-11.93 11.84 0 6.58 5.35 11.93 11.93 11.93 2.84 0 5.52-1.04 7.59-2.94v2.58h4.25v-23.05h-4.3zm-7.5 15.85c-3.81 0-6.91-3.12-6.91-6.95 0-3.81 3.1-6.91 6.91-6.91s6.91 3.1 6.91 6.91c0 3.83-3.1 6.95-6.91 6.95M124.52 119.28c-2.13 0-4.21.74-5.91 2.08v-1.72h-4.16v23.05h4.93v-13.61c0-2.69 2.21-4.87 4.92-4.87a4.87 4.87 0 0 1 4.87 4.87v13.61h4.98v-13.61c-.01-5.4-4.32-9.8-9.63-9.8M155.54 122.22a11.23 11.23 0 0 0-7.54-2.95c-6.58 0-11.93 5.31-11.93 11.84 0 6.58 5.35 11.93 11.93 11.93 2.84 0 5.52-1.04 7.59-2.94v2.58h4.25v-23.05h-4.3zm-.59 8.9c0 3.83-3.1 6.95-6.91 6.95s-6.91-3.12-6.91-6.95c0-3.81 3.1-6.91 6.91-6.91s6.91 3.1 6.91 6.91M178.48 134.37v-24.66h-5.07v24.66c0 5.42 2.5 8.05 7.63 8.05h1.49v-5.07h-1.4c-1.68 0-2.65-1.08-2.65-2.98M196.11 118.57c-6.68 0-12.11 5.43-12.11 12.11s5.43 12.11 12.11 12.11 12.11-5.43 12.11-12.11-5.43-12.11-12.11-12.11m7.04 12.11c0 3.88-3.16 7.04-7.04 7.04s-7.04-3.16-7.04-7.04 3.16-7.04 7.04-7.04 7.04 3.15 7.04 7.04M229.01 118.94h-6.03l-7.14 7.98v-17.21h-5.07v32.71h5.07v-8.48l1.08-1.27 6.91 9.66.06.09h6.04l-9.74-13.44zM231.81 118.94h4.97v23.48h-4.97zM234.17 117.57c1.8 0 3.06-1.24 3.06-3.02 0-1.48-1.15-3.02-3.06-3.02-1.58 0-3.02 1.44-3.02 3.02 0 1.69 1.33 3.02 3.02 3.02" class=st0 /><linearGradient id=SVGID_1_ x1=542.915 x2=542.915 y1=723.249 y2=595.214 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_1_) d="m102.59 95.31-8.28 1.28 1.28 8.28 8.28-1.27z"/><linearGradient id=SVGID_2_ x1=596.576 x2=596.576 y1=723.249 y2=595.214 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_2_) d="m132.49 85.92 36.56-5.63-1.28-8.28-36.55 5.62z"/><linearGradient id=SVGID_3_ x1=569.155 x2=569.155 y1=723.249 y2=595.214 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_3_) d="m118.25 79.63 1.27 8.28 8.29-1.27-1.28-8.29z"/><linearGradient id=SVGID_4_ x1=556.035 x2=556.035 y1=723.249 y2=595.214 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_4_) d="m116.84 101.6-1.28-8.28-8.28 1.27 1.27 8.29z"/><linearGradient id=SVGID_5_ x1=542.915 x2=542.915 y1=723.249 y2=595.214 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_5_) d="m93.59 91.9 8.28-1.27-1.27-8.29-8.28 1.28z"/><linearGradient id=SVGID_6_ x1=596.576 x2=596.576 y1=723.249 y2=595.214 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_6_) d="m169.77 84.98-36.56 5.62 1.28 8.29 36.55-5.63z"/><linearGradient id=SVGID_7_ x1=569.155 x2=569.155 y1=723.249 y2=595.214 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_7_) d="m120.25 92.6 1.27 8.28 8.28-1.27-1.27-8.29z"/><linearGradient id=SVGID_8_ x1=556.035 x2=556.035 y1=723.249 y2=595.214 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_8_) d="m106.56 89.91 8.28-1.28-1.27-8.28-8.29 1.27z"/><linearGradient id=SVGID_9_ x1=540.495 x2=540.495 y1=720.762 y2=599.332 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_9_) d="m91.6 78.94 3.49-.54L84.9 12.12l-3.5.54z"/><linearGradient id=SVGID_10_ x1=545.361 x2=545.361 y1=724.13 y2=593.756 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_10_) d="m96.4 78.2 3.5-.54L88.96 6.5l-3.5.54z"/><linearGradient id=SVGID_11_ x1=553.668 x2=553.668 y1=727.089 y2=588.856 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_11_) d="m104.62 76.93 3.49-.54L96.51.95l-3.5.54z"/><linearGradient id=SVGID_12_ x1=558.534 x2=558.534 y1=722.492 y2=596.468 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_12_) d="m109.42 76.19 3.5-.54-10.58-68.78-3.5.54z"/><linearGradient id=SVGID_13_ x1=566.737 x2=566.737 y1=717.193 y2=605.243 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_13_) d="m117.53 74.95 3.5-.54-9.4-61.1-3.5.53z"/><linearGradient id=SVGID_14_ x1=571.603 x2=571.603 y1=718.808 y2=602.568 fill=#000 gradientTransform="rotate(-8.748 -3581.317 3299.473)" gradientUnits=userSpaceOnUse><stop offset=0 stop-color=#faed1e /><stop offset=1 stop-color=#f15b2b /></linearGradient><path fill=url(#SVGID_14_) d="m122.34 74.21 3.5-.54-9.76-63.44-3.5.53z"/></svg></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=background>Background<a href=#background class=hash-link aria-label=Background的直接連結 title=Background的直接連結>​</a></h2>
<p>首先來了解一下 Loki 這個工具出現的背景，下圖說明了一般情況下如何用傳統的監控方式進行錯誤分析。</p>
<p><img decoding=async loading=lazy alt="Observability Cloud" src=/RulerChen-Website/assets/images/image-1-ad1158978292da846a982f97a8a9bb44.png width=1442 height=800 class=img_ev3q></p>
<p>首先 Prometheus 會依據一些指標來發送警報給負責人，負責人就去會查看儀表板來查看到底是哪個服務出錯，找到之後就會透過日誌來查看錯誤，或者使用類似 Jaeger 的追蹤工具來查看請求的流程。</p>
<p>在 Loki 出現之前，如果我們需要查看 k8s 中的日誌，我們可以使用 <code>kubectl logs -l name=XXX | grep XXX</code> 指令來查看，這樣的缺點是需要逐一查看每個 pod，並且當 pod 被重啟時就有可能會導致日誌丟失，同時，在儀表板跟 CLI 中切換也是一件麻煩的事情。</p>
<p>我們當然可以使用類似 ELK 的系統來儲存和查看日誌，但是 ELK 本身並不是為日誌所設計，因此就會有一些缺點，例如儲存成本非常昂貴。</p>
<p>也因此，Grafana Labs 推出了 Loki 這個開源的日誌蒐集工具，目的就是 <code>Keep it simple. Just support grep!</code>。</p>
<p><img decoding=async loading=lazy alt="Observability Cloud" src=/RulerChen-Website/assets/images/image-2-d1728d71c5e6efbbdbf1e8ed14503ece.png width=616 height=267 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=introduction>Introduction<a href=#introduction class=hash-link aria-label=Introduction的直接連結 title=Introduction的直接連結>​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>資訊</div><div class=admonitionContent_BuS1><blockquote>
<p>Like Prometheus, but for logs.</p>
</blockquote></div></div>
<p>Loki 是在 2018 年的 KubeCon 中由 Grafana Labs 發布的開源軟體，是一個受到 Prometheus 啟發的水平可擴展、高可用、多租戶的日誌聚合系統，與 Prometheus 的不同之處在於它專注於日誌而不是指標，並透過 push 模型來收集日誌。</p>
<p>從整體的架構來看，主要可以分為三個部分 :</p>
<p><img decoding=async loading=lazy alt=Loki src=/RulerChen-Website/assets/images/image-3-afd33d7da142558806603f5585317875.png width=1200 height=372 class=img_ev3q></p>
<ul>
<li><strong>Agent</strong> : 常見的有 Promtail、Alloy 跟 Fluentd 等，用於收集日誌和標籤並透過 HTTP request 將日誌發送到 Loki</li>
<li><strong>Loki</strong> : 用於接收、存儲日誌以及處理查詢</li>
<li><strong>Grafana</strong> : 可以使用 LogQL 來查詢並顯示 Loki 中的日誌</li>
</ul>
<p>Loki 具有以下特點 :</p>
<ul>
<li>擴展性 (Scalability) : Loki 有三種不同的部屬模式，可以將所有的組件都部屬在單一節點上，也可以將每個組件分開部屬，以滿足不同的需求</li>
<li>多租戶性 (Multi-tenancy) : Loki 可以允許多個租戶共享實例。每個租戶的資料都可以透過設定 ID 與其他租戶完全隔離</li>
<li>儲存效率 (Storage Efficiency) : Loki 使用了經過壓縮的 chunks、較小的索引以及使用物件存儲，大幅降低了儲存成本</li>
<li>警報 (Alerting) : Loki 中的 <code>ruler</code> 組件可以用來監控日誌中的異常</li>
<li>Grafana 整合 : Loki 與 Grafana 的整合非常緊密，可以方便的使用 LogQL 語言來查詢日誌</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=architecture>Architecture<a href=#architecture class=hash-link aria-label=Architecture的直接連結 title=Architecture的直接連結>​</a></h2>
<p>Loki 是 microservice-based 的架構，可以將所有的組件分開部署，並使用 <code>-target</code> 控制這個容器應該擔任的角色，具體的組件如下圖所示 :</p>
<p><img decoding=async loading=lazy alt="Loki Architecture" src=/RulerChen-Website/assets/images/image-4-3f7a4948581705f9c575231640dee933.png width=1024 height=774 class=img_ev3q></p>
<p>當資料寫入時，流程如下 :</p>
<ol>
<li>Distributor 接收包含日誌流和日誌行的 HTTP POST 請求</li>
<li>Distributor 對請求中包含的每個日誌流進行哈希運算，根據一致性哈希環 (Consistent Hash Ring) 的資訊，確認每個流應被發送到哪個 Ingester</li>
<li>Distributor 將每個日誌流發送到對應的 Ingester 實例以及配置的副本 (根據 Replication Factor)</li>
<li>Ingester 接收到日誌流後，會為該流的數據創建一個新的 chunk 或者將數據追加到已存在的 chunk 中</li>
<li>Ingester 確認寫入操作完成，向 Distributor 發送回應</li>
<li>Distributor 等待多數 (Quorum) Ingester 的寫入確認</li>
<li>寫入操作成功 (失敗) 後，Distributor 向客戶端回應操作結果</li>
</ol>
<p>當讀取資料時，流程如下 :</p>
<ol>
<li>Query Frontend 收到包含 LogQL 查詢的 HTTP GET 請求</li>
<li>Query Frontend 將查詢分解為多個子查詢，並將這些子查詢傳遞給 Query Scheduler</li>
<li>Querier 從 Query Scheduler 中提取子查詢</li>
<li>Querier 將子查詢發送到所有的 Ingester，用於讀取記憶體中的數據</li>
<li>如果有的話，Ingester 會在記憶體中查找並返回相關數據</li>
<li>如果 Ingester 返回的數據不足或沒有數據，Querier 會從後端存儲中延遲加載相關數據，並對其執行查詢</li>
<li>Querier 對所有接收到的數據進行迭代與去重處理，生成子查詢的結果</li>
<li>Query Frontend 等待所有的子查詢完成並由 Querier 返回結果</li>
<li>Query Frontend 將所有子查詢的結果合併，並將結果返回給客戶端</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=storage>Storage<a href=#storage class=hash-link aria-label=Storage的直接連結 title=Storage的直接連結>​</a></h3>
<p>前面提到，Loki 最大的優勢就在於它使用了 Object Storage (如 GCS、S3、MinIO) 來存儲日誌，所有的資料都可以被分成 index 和 chunks 兩部分來存儲。</p>
<p>在 2.0 版本之前，Loki 需要將 index 和 chunks 分別儲存在不同的地方，index 儲存在 NoSQL / key-value 的資料庫中，chunks 儲存在物件存儲中。
在 2.0 版本之後，Loki 引進了 index shipper 來使 index 也能夠以物件存儲的形式儲存，減少了 Loki 的對外部服務的依賴，一開始採用的是 BoltDB，在 2.8 版本之後改為使用 tsdb</p>
<ul>
<li><strong>Index</strong> : 用於存儲日誌的 metadata，例如日誌的標籤、時間等，是 key-value 的形式</li>
<li><strong>Chunks</strong> : 用於存儲日誌的內容</li>
</ul>
<p>下圖展示了 Loki 如何儲存 index 和 chunks :</p>
<p><img decoding=async loading=lazy alt="Loki Storage" src=/RulerChen-Website/assets/images/image-5-5a20ca48706bd76423a19d587ab851d7.png width=859 height=531 class=img_ev3q></p>
<p>Loki 會將 label 進行 hash 來生成唯一的 stream ID，所有具有相同 stream ID 的 log line 都會被存儲在同一個 chunk 中。
當 chunk 被填滿時，Loki 會將這個 chunk 壓縮並上傳到物件存儲中，並且在 index 中記錄一些 metadata 跟該 chunk 的時間範圍。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=multi-tenancy>Multi-tenancy<a href=#multi-tenancy class=hash-link aria-label=Multi-tenancy的直接連結 title=Multi-tenancy的直接連結>​</a></h3>
<p>當 Loki 在 Multi-tenancy 模式下運行時，記憶體和物件儲存中的所有資料都可以按租戶 ID 進行分區，租戶 ID 會依據請求中的 <code>X-Scope-OrgID</code> HTTP header 來決定。
當 Loki 不處於 Multi-tenancy 模式時，header 會被忽略且租戶 ID 將設定為 fake。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=components>Components<a href=#components class=hash-link aria-label=Components的直接連結 title=Components的直接連結>​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=distributor>Distributor<a href=#distributor class=hash-link aria-label=Distributor的直接連結 title=Distributor的直接連結>​</a></h3>
<p>Distributor 是 Loki 的入口，它接收來自搜集器的日誌並將其分發給 Ingester。
由於 Distributor 是 stateless 的，所以通常會在 Distributor 前面部屬一個負載均衡器，以便將流量分發到多個 Distributor 上，這樣做可以最大程度的減輕 Ingester 的壓力並防禦 DDoS 攻擊。</p>
<p>Distributor 有以下幾個主要功能 :</p>
<ol>
<li>
<p>Validate</p>
<p>確保傳入的格式符合規範，像是檢查標籤是否有效，時間戳是否合法等</p>
</li>
<li>
<p>Preprocessing</p>
<p>Distributor 會將標籤進行排序方便後面進行哈希運算，例如將 <code>c=b,a=b</code> 轉換為 <code>a=b,c=b</code></p>
</li>
<li>
<p>Rate limiting</p>
<p>可以對每個不同的租戶進行限流，以防止某個租戶的日誌過多導致系統壓力過大</p>
<p>Loki 允許我們在集群級別進行限流，會根據當前 Distributor 的數量來計算，舉例來說，假如有 10 個 Distributor 且我們的限流為 10 MB/s，那麼每個 Distributor 的限流就是 1 MB/s</p>
</li>
<li>
<p>Forwarding</p>
<p>一旦日誌被驗證並預處理，Distributor 就會將日誌轉發給指定的 Ingester</p>
<ul>
<li>
<p>Replication factor</p>
<p>為了降低單個 Ingester 可能遺失資料的風險，Distributor 會將寫入資料轉發到多個 Ingester，這個數量由 Loki 的設定檔中的 <code>replication_factor</code> 決定，預設為 3</p>
<p>Distributor 會透過 ring 來判斷目前那些 Ingester 是活著的，並將資料轉發給這些 Ingester 並等待回應</p>
</li>
<li>
<p>WAL (Write-Ahead Log)</p>
<p>除了 Replication factor 之外，Ingester 還會有 Write-Ahead Log (WAL) 來保證在重新啟動時不會遺失資料</p>
</li>
</ul>
</li>
<li>
<p>Hashing</p>
<p>Distributor 會將日誌流進行哈希運算，並根據一致性哈希環 (Consistent Hash Ring) 的資訊，確認每個流應被發送到哪個 Ingester</p>
</li>
<li>
<p>Quorum consistency</p>
<p>所有的 Distributor 都會共享同一個 ring 以確保寫入請求可以被路由到任一個 Ingester</p>
<p>Loki 使用了 dynamo-style quorum consistency 來確保寫入的一致性，這意味著至少需要 <code>replication_factor / 2 + 1</code> 個 Ingester 回應才會顯示成功，否則會重新進行寫入</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=ingester>Ingester<a href=#ingester class=hash-link aria-label=Ingester的直接連結 title=Ingester的直接連結>​</a></h3>
<p>Ingester 是 Loki 的核心，它負責接收日誌並將其寫入物件存儲中，同時也負責從記憶體中讀取日誌並提供給 Querier 進行查詢。</p>
<p>Ingester 包含一個生命管理器 (Lifecycler)，用於管理在哈希環內的生命週期，分別為 :</p>
<ul>
<li>PENDING : 當 Ingester 啟動並在等待一個舊的 Ingester 做 handoff 時就會處於 PENDING 狀態 (需要注意 handoff 這個機制已經棄用)</li>
<li>JOINING : 當 Ingester 正在將令牌插入到哈希環中時就會處於 JOINING 狀態，此時已經可以接收寫入請求</li>
<li>ACTIVE : 完成初始化並開始接收讀寫請求時就會處於 ACTIVE 狀態</li>
<li>LEAVING : 當 Ingester 準備離開哈希環時就會處於 LEAVING 狀態，此時依然可以處理讀取請求來提供記憶體中的資料</li>
<li>UNHEALTHY : 當 Ingester 無法發送 heartbeat 時就會處於 UNHEALTHY 狀態</li>
</ul>
<p>Ingester 接收到的每個 log stream 會被組織成多個 chunks 儲存在記憶體中，並在可配置的時間後 flush 到物件存儲中。</p>
<p>在以下的情況下，chunk 會被標記成 read-only 並壓縮 :</p>
<ul>
<li>Chunk 被寫滿</li>
<li>Chunk 有一段時間沒有被寫入</li>
<li>發生 flush</li>
</ul>
<p>每當有 chunk 被標記成 read-only 時，就會有新的 chunk 被創建。</p>
<p>如果 Ingester 突然崩潰，未被寫入物件存儲中的 chunk 會被丟失，因此 Loki 通常會設置 replica factor 並使用 WAL 來保證在 Ingester 重啟時不會遺失資料。</p>
<p>當 Ingester 要將 chunk 寫入物件存儲中時，會依據租戶 ID、標籤、內容來計算一個 hash 值，讓後端不需要重覆儲存相同的 chunk，但如果有資料寫入失敗，則會在後端儲存多個副本，Querier 會在查詢時進行去重。</p>
<p>Loki 預設為接受無序的日誌，但可以透過設定 <code>unordered_writes</code> 來接受有序的日誌，如果設置成有序的話，則會在 Distributor 中進行驗證。</p>
<p>對於相同納米的 timestamp，如果內容完全相同，則 Loki 會將其視為重複的日誌，並且只會儲存一份。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=query-frontend>Query Frontend<a href=#query-frontend class=hash-link aria-label="Query Frontend的直接連結" title="Query Frontend的直接連結">​</a></h3>
<p>Query Frontend 是一個可選的組件，可以用於加速查詢。當有 Query Frontend 時，應該要將查詢的流量導向到 Query Frontend 上，再由 Query Frontend 將查詢分發給 Querier。</p>
<p>Query Frontend 是一種無狀態的組件，在大多數情況下只需要兩個就足夠了。</p>
<p>以下是 Query Frontend 的主要功能 :</p>
<ol>
<li>
<p>Queueing</p>
<p>即使沒有獨立的 Query Scheduler，Query Frontend 也可以將查詢排隊</p>
<p>排隊功能可以帶來以下的好處 :</p>
<ul>
<li>防止 Querier 的記憶體溢出 (OOM) : 如果發生了 OOM，也可以進行重試，提升查詢的穩定性，同時也可以降低記憶體的需求</li>
<li>負載均衡 : 將大型查詢分散到多個 Querier 上，避免單個 Querier 被壓垮</li>
<li>租戶的公平調度 : 可以用於防止單一租戶的 DDoS 影響到其他租戶</li>
</ul>
</li>
<li>
<p>Splitting</p>
<p>Query Frontend 可以將大型查詢分割成多個子查詢來並行處理，在進行合併，可以避免單個查詢過於龐大而導致 OOM</p>
</li>
<li>
<p>Caching</p>
<p>Query Frontend 提供了多種不同的 cache 策略，用於提升查詢的速度 :</p>
<ul>
<li>Metric queries : 可以快取前端的 metric 查詢結果，如果塊取的結果不完整，則可以使用子查詢來補全。此外，可以選擇性地將查詢與 step 參數對齊，以提高 cache 的命中率，並將結果快取到 redis 或 memory 中。</li>
<li>Log queries : 對於 log query，Query Frontend 使用 negative cache 來記錄空的時間段</li>
<li>Index stats queries (索引統計查詢) : 主要用於 Loki 內部，類似 Metric queries，只能在 single store 的 tsdb 中使用</li>
<li>Log volume queries (日誌量查詢) : 主要用於 Loki 內部，類似 Metric queries，只能在 single store 的 tsdb 中使用</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=query-scheduler>Query Scheduler<a href=#query-scheduler class=hash-link aria-label="Query Scheduler的直接連結" title="Query Scheduler的直接連結">​</a></h3>
<p>Query Scheduler 是 Loki 的一個可選組件，提供比 Querier Frontend 更進階的排隊功能，如階層式的隊列。</p>
<p>可以參考 <a href=https://grafana.com/docs/loki/latest/operations/query-fairness/ target=_blank rel="noopener noreferrer">advanced queuing functionality</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=querier>Querier<a href=#querier class=hash-link aria-label=Querier的直接連結 title=Querier的直接連結>​</a></h3>
<p>Querier 負責實際執行 LogQL 查詢，它會從 Ingester 跟 Object Storage 中讀取資料，並將結果返回給 Query Frontend。</p>
<p>由於 replication_factor 的存在，有時候 Querier 會收到重覆的資料，因此 Loki 會在 Querier 中進行去重。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=index-gateway>Index Gateway<a href=#index-gateway class=hash-link aria-label="Index Gateway的直接連結" title="Index Gateway的直接連結">​</a></h3>
<p>Index Gateway 負責處理有關於 metadata 的查詢，例如 label names 等等的查詢。</p>
<p>Query Frontend 會跟 Index Gateway 查詢日誌量，以便決定該用甚麼方法進行查詢分片。
Querier 則會向 Index Gateway 查詢 chunks 的引用，以便知道要查詢哪些 chunks。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=compactor>Compactor<a href=#compactor class=hash-link aria-label=Compactor的直接連結 title=Compactor的直接連結>​</a></h3>
<p>Compactor 會定期運行，從物件存儲中讀取 tsdb 檔案進行合併後再寫回物件存儲中，此外，Compactor 也負責日誌的保留跟刪除功能，通常會使用單一的實例。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=ruler>Ruler<a href=#ruler class=hash-link aria-label=Ruler的直接連結 title=Ruler的直接連結>​</a></h3>
<p>可以在物件存儲中設定告警規則，Ruler 會定期檢查這些規則並發送告警，也可以將這些規則委託給 Query Frontend 來執行，這種模式稱為 Remote Rule Evaluation。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=other-components>Other Components<a href=#other-components class=hash-link aria-label="Other Components的直接連結" title="Other Components的直接連結">​</a></h3>
<p>除了之外，目前也有一些基於布隆過濾器 (Bloom filter) 的組件在筆者寫這篇文章時還在處在實驗性的階段，例如 :</p>
<ul>
<li>Bloom Planner</li>
<li>Bloom Builder</li>
<li>Bloom Gateway</li>
</ul>
<p>這三個組件旨在利用布隆過濾器來加速 chunk 的查詢，快速過濾掉那些不可能符合條件的 chunk。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=deployment-mode>Deployment Mode<a href=#deployment-mode class=hash-link aria-label="Deployment Mode的直接連結" title="Deployment Mode的直接連結">​</a></h2>
<p>如前所述，Loki 是一個有很多微服務組成的分散式系統，因此可以根據不同的需求來部署不同的模式。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=monolithic-mode>Monolithic mode<a href=#monolithic-mode class=hash-link aria-label="Monolithic mode的直接連結" title="Monolithic mode的直接連結">​</a></h3>
<p>最簡單的部屬方法就是單體部屬模式，將所有的組件都部屬在同一個節點上，對於 20GB/day 左右的日誌量來說，這樣的部屬方式是足夠的。</p>
<p>這種方式同樣也可以做水平擴展，只需要在設定檔中設定 <code>ring</code> 和 <code>memberlist_config</code> 就可以了。</p>
<p><img decoding=async loading=lazy alt="Monolithic mode" src=/RulerChen-Website/assets/images/image-6-17d3bdf2a6067940b53a8c8ec260f8e6.png width=618 height=606 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=simple-scalable-mode>Simple scalable mode<a href=#simple-scalable-mode class=hash-link aria-label="Simple scalable mode的直接連結" title="Simple scalable mode的直接連結">​</a></h3>
<p>這種模式是 Helm Chart 預設的部屬方式，將組建分成讀取、寫入、後端三個部分，並使用 Nginx 作為反向代理來分開轉發讀寫請求，對於 TB 級別的日誌量來說，這樣的部屬方式是足夠的。</p>
<ul>
<li><code>target=write</code> : Distributor、Ingester，是有狀態的，由 k8s statefulset 控制</li>
<li><code>target=read</code> : Querier、Query Frontend，是無狀態的，由 k8s deployment 控制</li>
<li><code>target=backend</code> : Compactor、Ruler、Index Gateway、Query Scheduler，是有狀態的，由 k8s statefulset 控制</li>
</ul>
<p><img decoding=async loading=lazy alt="Simple scalable mode" src=/RulerChen-Website/assets/images/image-7-27297de2f2623d363647363fd4096d65.png width=971 height=725 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=microservices-mode>Microservices mode<a href=#microservices-mode class=hash-link aria-label="Microservices mode的直接連結" title="Microservices mode的直接連結">​</a></h3>
<p>也可以選擇將全部的組件都分開部署以提供最好的擴展性，但同時也會增加部署的複雜度。</p>
<p><img decoding=async loading=lazy alt="Microservices mode" src=/RulerChen-Website/assets/images/image-8-68f62bb3bb922a56e3adb5595be3f0c3.png width=956 height=667 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=label>Label<a href=#label class=hash-link aria-label=Label的直接連結 title=Label的直接連結>​</a></h2>
<p>Labels 對於 Loki 來說是一個非常重要的組件，它不僅可以用於當 sharding key 來決定日誌的存儲位置，也可以用於查詢時的過濾，因此正確的使用 label 可以顯著提高 Loki 的效能。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=label-best-practices>Label Best Practices<a href=#label-best-practices class=hash-link aria-label="Label Best Practices的直接連結" title="Label Best Practices的直接連結">​</a></h3>
<p>接下來會透過一個例子來說明如何正確地使用 label 來提高 Loki 的效能。</p>
<p>首先我們可以簡單的分配一個 label 來表示 host，例如 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">{host="rook"}</span><br></span></code></pre></div></div>
<p>這時候 Loki 就會基於這個 label 來建立 stream，在固定的時間間隔後，Loki 會將這些 stream 壓縮成 chunks 並上傳到物件存儲中。</p>
<p><img decoding=async loading=lazy alt=Label src=/RulerChen-Website/assets/images/1-297c8451fdae33055090e0839baf3f20.gif width=960 height=640 class=img_ev3q></p>
<p>在 rook 這個 host 上，我們可能同時運行了很多個 service，使用者目前無法透過日誌知道這條 log 來自於哪個系統，因此決定可以再加上一個 label 來表示服務名稱，例如 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">{host=”rook”, app=”webserver”}</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">{host=”rook”, app=”ftp”}</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">{host=”rook”, app=”middleware”}</span><br></span></code></pre></div></div>
<p>於是，我們就可以使用 app 來查詢了</p>
<p><img decoding=async loading=lazy alt=Label src=/RulerChen-Website/assets/images/2-deb538bf7a0a69e6c938dee5adcdb3ea.gif width=960 height=640 class=img_ev3q></p>
<p>接著使用者又遇到了新的問題，我想要查詢每筆訂單的日誌，但是 Loki 並沒有辦法直接查詢到這些日誌，因此決定再新增一個 label 來表示訂單 ID，例如 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">{host=”rook”, app=”webserver”, order_id=”123”}</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">{host=”rook”, app=”webserver”, order_id=”456”}</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">{host=”rook”, app=”webserver”, order_id=”789”}</span><br></span></code></pre></div></div>
<p>這時候就遇到問題了，每筆 log 都被儲存在 short-lived 的 stream 中，當每個 stream 都被寫成獨立的文件時，就會產生非常多占用空間的小檔案，降低了 Loki 的效能。</p>
<p><img decoding=async loading=lazy alt=Label src=/RulerChen-Website/assets/images/3-c82d9e3b6a38daa6905ac67783f7d049.gif width=960 height=640 class=img_ev3q></p>
<p>因此，與其它的日誌系統相比，我們需要在 label 的設計上有不同的思考方式，以下是一些 Loki 的 label 設計原則 :</p>
<ul>
<li>Describe infrastructure : 例如 region、zone、host、cluster、namespace、environment 等等</li>
<li>Long-lived : 這些標籤應該長期存在</li>
<li>Intuitive : 標籤應該是直觀的，例如 <code>app</code>、<code>service</code>、<code>component</code> 等等</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=automatic-stream-sharding>Automatic Stream Sharding<a href=#automatic-stream-sharding class=hash-link aria-label="Automatic Stream Sharding的直接連結" title="Automatic Stream Sharding的直接連結">​</a></h3>
<p>同時，為了防止同一個 stream 的流量太多導致所有的日誌都被分發到同一個 Ingester 中，Loki 也引入了 automatic stream sharding 機制，這樣可以讓 Loki 在寫入時自動將流量分發到不同的 Ingester 中。</p>
<p><img decoding=async loading=lazy alt=Label src=/RulerChen-Website/assets/images/4-835f248c5bb2199d9c638a62878a4e0d.gif width=960 height=640 class=img_ev3q>
<img decoding=async loading=lazy alt=Label src=/RulerChen-Website/assets/images/5-07fcf05d46187b30988ca6dcf3f46709.gif width=960 height=640 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=structure-metadata>Structure Metadata<a href=#structure-metadata class=hash-link aria-label="Structure Metadata的直接連結" title="Structure Metadata的直接連結">​</a></h3>
<p>在這樣的 label 設計下有可能會產生一些問題，例如我們想要搜尋某個 Pod 的 ID，但是由於這個值是一個高基數的 label，因此我們不確定是不是應該把這個值放在 label 中。</p>
<p>在新版的 Loki 中，Loki 引入了 structured metadata 的概念，可以將 key-value 的值儲存在日誌行的旁邊而不是存在 label 中，這樣就可以避免產生高基數的 label 並且可以更快的查詢到這些資料。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=bloom-filter>Bloom Filter<a href=#bloom-filter class=hash-link aria-label="Bloom Filter的直接連結" title="Bloom Filter的直接連結">​</a></h3>
<p>那麼如果我想在 Loki 中搜尋唯一的 ID 時應該怎麼辦呢?</p>
<p>舉例來說，我可能會想做以下的搜尋 <code>{env=”prod”} |= “603e0dcf-9b24-4c37-8f0d-6d8ebe5c5c8a”</code></p>
<p>Loki 會採用大量平行化的方式來處理這個問題，同時使用 Bloom filter 搭配 n-gram 來進行過濾。</p>
<ul>
<li>Bloom filter : 一種機率型資料結構，用於快速檢查一個元素是否在一個集合中，空間效率非常高</li>
<li>n-gram : 一種將字串拆分成 n 個連續的子字串的方法，這樣做的原因是可以提高彈性與容錯，同時可以讓我們捕捉到 schemaless 的 log</li>
</ul>
<p><img decoding=async loading=lazy alt=Label src=/RulerChen-Website/assets/images/image-10-8ea8c59eab1344a5553431abe0b59e4c.png width=900 height=584 class=img_ev3q></p>
<p>我們可以從上圖中看到兩個關鍵的組件，分別是 Bloom Compactor 跟 Bloom Gateway。</p>
<ul>
<li>
<p>Bloom Compactor :</p>
<ul>
<li>負責在 Loki 的物件儲存中的日誌區塊 (chunks) 建立 Bloom filter</li>
<li>針對每個日誌序列 (series，類似於 stream id) 建立 Bloom filter</li>
<li>從每個日誌序列的每個日誌行中提取 n-grams</li>
<li>將每個 n-gram 的雜湊值 以及 (n-gram + chunk ID) 的雜湊值 加入到對應日誌序列的 Bloom filter 中</li>
<li>將 Bloom filter 聚合到區塊檔案 (block files) 中，並產生元數據檔案 (metadata files) 記錄 Bloom 區塊和對應的 TSDB 索引檔案的關聯</li>
</ul>
</li>
<li>
<p>Bloom Gateway :</p>
<ul>
<li>接收來自 Index Gateway 的區塊過濾請求</li>
<li>根據查詢的過濾表達式，提取 n-grams</li>
<li>使用這些 n-grams 查詢 Bloom filter，判斷哪些日誌區塊 可能 包含符合過濾條件的日誌</li>
<li>過濾掉被 Bloom filter 判斷為肯定不符合的區塊，只將可能符合的區塊送給後續的查詢引擎進行詳細掃描</li>
</ul>
</li>
</ul>
<p>透過上面這兩種方式，Loki 可以在不增加額外的資源的情況下，提高查詢的效能。</p>
<p>但是，並不是每種 LogQL 都能受益於 Bloom filter，以下是一些可以使用跟不能使用 Bloom filter 的例子 :</p>
<ul>
<li>查詢應該包含至少一種過濾式</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain"># 使用布隆過濾器</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">{host="rook", app="webserver"} |= "order=17863472" | logfmt</span><br></span></code></pre></div></div>
<ul>
<li>使用了 <code>!=</code> 或 <code>!~</code> 的過濾式以及在 format 之後的過濾式不會使用布隆過濾器</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain"># 不使用布隆過濾器</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">{host="rook", app="webserver"} != "debug"</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">{host="rook", app="webserver"} !~ "(staging|dev)"</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain"># `level="error"` 使用布隆過濾器</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain"># `traceID="3ksn8d4jj3"` 不使用布隆過濾器</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">{host="rook", app="webserver"}</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">|= `level="error"`</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">| logfmt</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">| line_format “ERROR {{.err}}”</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">|= `traceID=“3ksn8d4jj3”`</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=reference>Reference<a href=#reference class=hash-link aria-label=Reference的直接連結 title=Reference的直接連結>​</a></h2>
<ul>
<li><a href=https://grafana.com/oss/loki/ target=_blank rel="noopener noreferrer">Grafana Loki</a></li>
<li><a href="https://grafana.com/go/webinar/getting-started-with-logging-and-grafana-loki/?pg=docs-loki-latest&plcmt=related" target=_blank rel="noopener noreferrer">How to get started with logging using Grafana Loki</a></li>
<li><a href=https://taisho6339.gitbook.io/grafana-loki-deep-dive target=_blank rel="noopener noreferrer">Grafana Loki Deep Dive</a></li>
<li><a href=https://ithelp.ithome.com.tw/articles/10335935 target=_blank rel="noopener noreferrer">可觀測性宇宙的第二十二天 - Grafana Loki 介紹 - 性價比的王者</a></li>
<li><a href=https://grafana.com/blog/2018/12/12/loki-prometheus-inspired-open-source-logging-for-cloud-natives/ target=_blank rel="noopener noreferrer">Loki: Prometheus-inspired, open source logging for cloud natives</a></li>
<li><a href=https://grafana.com/blog/2023/12/11/open-source-log-monitoring-the-concise-guide-to-grafana-loki/ target=_blank rel="noopener noreferrer">Open source log monitoring: The concise guide to Grafana Loki</a></li>
<li><a href="https://www.youtube.com/watch?v=_hv4i84Z68s" target=_blank rel="noopener noreferrer">All the Components of Loki Explained | Grafana Labs</a></li>
<li><a href=https://grafana.com/blog/2024/05/29/grafana-loki-query-acceleration-how-we-sped-up-queries-without-adding-resources/ target=_blank rel="noopener noreferrer">Grafana Loki query acceleration: How we sped up queries without adding resources</a></li>
<li><a href=https://medium.com/@jieshiun/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0-grafana-loki-%E5%BE%9E%E5%85%A5%E9%96%80%E5%88%B0%E7%B2%BE%E9%80%9A-feab84c209f0 target=_blank rel="noopener noreferrer">手把手教你 Grafana Loki : 從入門到精通</a></li>
<li><a href=https://medium.com/@NeroHin/devops-grafana-loki-promtail-logging-system-%E5%B0%8F%E8%A9%A6%E7%89%9B%E5%88%80-b922ba8ed0d8 target=_blank rel="noopener noreferrer">【DevOps】Grafana + Loki + Promtail Logging system 小試牛刀</a></li>
<li><a href=https://www.qikqiak.com/post/grafana-loki-usage/ target=_blank rel="noopener noreferrer">Grafana Loki 简明教程</a></li>
<li><a href=https://juejin.cn/post/7196699593836937276 target=_blank rel="noopener noreferrer">Grafana 系列文章（九）：开源云原生日志解决方案 Loki 简介</a></li>
<li><a href=https://juejin.cn/post/7197239663102705724 target=_blank rel="noopener noreferrer">Grafana 系列文章（十）：为什么应该使用 Loki</a></li>
<li><a href=https://grafana.com/blog/2022/05/16/all-things-logs-best-practices-for-logging-and-grafana-loki/ target=_blank rel="noopener noreferrer">All things logs: best practices for logging and Grafana Loki</a></li>
<li><a href=https://vik-y.medium.com/why-you-should-consider-loki-as-an-alternative-to-elasticsearch-ae3fad99ab9a target=_blank rel="noopener noreferrer">Why You Should Consider Loki as an Alternative to Elasticsearch!</a></li>
<li><a href=https://grafana.com/blog/2020/02/19/how-loki-reduces-log-storage/ target=_blank rel="noopener noreferrer">How Loki Reduces Log Storage</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/RulerChen/RulerChen-Website/tree/main/docs/Observability/loki.mdx target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>編輯此頁</a></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated>最後<!-- -->於 <b><time datetime=2025-02-12T14:49:42.000Z itemprop=dateModified>2025年2月12日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label=文件選項卡><a class="pagination-nav__link pagination-nav__link--prev" href=/RulerChen-Website/docs/Observability/><div class=pagination-nav__sublabel>上一頁</div><div class=pagination-nav__label>Observability</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/RulerChen-Website/docs/Observability/loki-demo/><div class=pagination-nav__sublabel>下一頁</div><div class=pagination-nav__label>[Loki 實戰] 打造本地日誌蒐集系統</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#background class="table-of-contents__link toc-highlight">Background</a><li><a href=#introduction class="table-of-contents__link toc-highlight">Introduction</a><li><a href=#architecture class="table-of-contents__link toc-highlight">Architecture</a><ul><li><a href=#storage class="table-of-contents__link toc-highlight">Storage</a><li><a href=#multi-tenancy class="table-of-contents__link toc-highlight">Multi-tenancy</a></ul><li><a href=#components class="table-of-contents__link toc-highlight">Components</a><ul><li><a href=#distributor class="table-of-contents__link toc-highlight">Distributor</a><li><a href=#ingester class="table-of-contents__link toc-highlight">Ingester</a><li><a href=#query-frontend class="table-of-contents__link toc-highlight">Query Frontend</a><li><a href=#query-scheduler class="table-of-contents__link toc-highlight">Query Scheduler</a><li><a href=#querier class="table-of-contents__link toc-highlight">Querier</a><li><a href=#index-gateway class="table-of-contents__link toc-highlight">Index Gateway</a><li><a href=#compactor class="table-of-contents__link toc-highlight">Compactor</a><li><a href=#ruler class="table-of-contents__link toc-highlight">Ruler</a><li><a href=#other-components class="table-of-contents__link toc-highlight">Other Components</a></ul><li><a href=#deployment-mode class="table-of-contents__link toc-highlight">Deployment Mode</a><ul><li><a href=#monolithic-mode class="table-of-contents__link toc-highlight">Monolithic mode</a><li><a href=#simple-scalable-mode class="table-of-contents__link toc-highlight">Simple scalable mode</a><li><a href=#microservices-mode class="table-of-contents__link toc-highlight">Microservices mode</a></ul><li><a href=#label class="table-of-contents__link toc-highlight">Label</a><ul><li><a href=#label-best-practices class="table-of-contents__link toc-highlight">Label Best Practices</a><li><a href=#automatic-stream-sharding class="table-of-contents__link toc-highlight">Automatic Stream Sharding</a><li><a href=#structure-metadata class="table-of-contents__link toc-highlight">Structure Metadata</a><li><a href=#bloom-filter class="table-of-contents__link toc-highlight">Bloom Filter</a></ul><li><a href=#reference class="table-of-contents__link toc-highlight">Reference</a></ul></div></div></div></div></main></div></div></div></div>