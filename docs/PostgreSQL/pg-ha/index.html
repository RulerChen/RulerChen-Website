<!doctype html>
<html lang="zh-Hant" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-PostgreSQL/pg-ha" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">[PG] PostgreSQL High Availability | RulerChen</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" name="twitter:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" property="og:url" content="https://RulerChen.github.io/RulerChen-Website/docs/PostgreSQL/pg-ha/"><meta data-rh="true" property="og:locale" content="zh_Hant"><meta data-rh="true" name="docusaurus_locale" content="zh-Hant"><meta data-rh="true" name="docsearch:language" content="zh-Hant"><meta data-rh="true" name="google-site-verification" content="QrdRbPEcOsJJ_kfRVewqfwR6GjPcRf0UVgRb85I-5fc"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[PG] PostgreSQL High Availability | RulerChen"><meta data-rh="true" name="description" content="Postgres 高可用性"><meta data-rh="true" property="og:description" content="Postgres 高可用性"><meta data-rh="true" name="keywords" content="Postgres,高可用性"><link data-rh="true" rel="icon" href="/RulerChen-Website/img/profile.png"><link data-rh="true" rel="canonical" href="https://RulerChen.github.io/RulerChen-Website/docs/PostgreSQL/pg-ha/"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/PostgreSQL/pg-ha/" hreflang="zh-Hant"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/PostgreSQL/pg-ha/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GSV9DQB5UM-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/RulerChen-Website/blog/rss.xml" title="RulerChen RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/RulerChen-Website/blog/atom.xml" title="RulerChen Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script>



<link rel="search" type="application/opensearchdescription+xml" title="RulerChen" href="/RulerChen-Website/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/RulerChen-Website/assets/css/styles.07de3075.css">
<script src="/RulerChen-Website/assets/js/runtime~main.0994b388.js" defer="defer"></script>
<script src="/RulerChen-Website/assets/js/main.3722ec54.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切換導覽列" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/RulerChen-Website/"><div class="navbar__logo"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/RulerChen-Website/docs/intro/">Notes</a><a class="navbar__item navbar__link" href="/RulerChen-Website/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/RulerChen" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.linkedin.com/in/rulerchen/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Linkdin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切換淺色/深色模式（當前為深色模式）" aria-label="切換淺色/深色模式（當前為深色模式）" aria-live="polite" aria-pressed="true"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜尋 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜尋</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/RulerChen-Website/docs/intro/">Roadmap</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/C++/intro/">C++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Python/setup/">Python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/NodeJs/expresssetup/">Node.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Golang/syntax/">Go</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Next.js/EslintPrettier/">Next.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/RulerChen-Website/docs/PostgreSQL/pg-tuning/">PostgreSQL</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/PostgreSQL/pg-tuning/">[PG] PostgreSQL Performance Tuning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/RulerChen-Website/docs/PostgreSQL/pg-ha/">[PG] PostgreSQL High Availability</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/RulerChen-Website/docs/Observability/">Observability</a><button aria-label="展開側邊欄分類 &#x27;Observability&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Security/log4j/">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/RulerChen-Website/docs/CMU15-445/">CMU 15-445/645</a><button aria-label="展開側邊欄分類 &#x27;CMU 15-445/645&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/RulerChen-Website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">PostgreSQL</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[PG] PostgreSQL High Availability</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>[PG] PostgreSQL High Availability</h1></header><p>這篇文章是我看了 <a href="https://www.udemy.com/course/postgresql-replication-high-availability-ha-and-scalability" target="_blank" rel="noopener noreferrer">PostgreSQL Replication, High Availability HA and Scalability</a> 這門課後的筆記。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="environment-setup">Environment Setup<a href="#environment-setup" class="hash-link" aria-label="Environment Setup的直接連結" title="Environment Setup的直接連結">​</a></h2>
<p>在這篇文章中，我會在 GCP 上面建立一個 VM (Debian) 來安裝 PostgreSQL (15.10) 來做 demo</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo apt install postgresql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>安裝完之後應該會自行啟動，我們可以透過以下指令來確認是否有啟動</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo systemctl status postgresql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們可以切換使用者並且進入 psql 來進行操作</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>輸入 <code>\q</code> 即可離開 psql</p>
<p>除此之外我們會使用到 <code>pg_ctl</code> 這個指令，需要先設定 <code>.bashrc</code> 跟 <code>.bash_profile</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">nano ~/.bashrc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set export PATH=$PATH:/usr/lib/postgresql/15/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">nano ~/.bash_profile</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># if [ -f ~/.bashrc ]; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#   . ~/.bashrc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著重新登入就會自動載入設定</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl --version</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="scaling-postgresql">Scaling PostgreSQL<a href="#scaling-postgresql" class="hash-link" aria-label="Scaling PostgreSQL的直接連結" title="Scaling PostgreSQL的直接連結">​</a></h2>
<p>當我們的資料庫需要處理大量的資料時，我們首先需要檢查我們的資料庫是否已經達到其處理能力的極限，像是 SQL 優化或參數調整等等，
如果還是沒辦法提供足夠的效能，我們就需要考慮擴充我們的資料庫</p>
<p>擴充資料庫的方式大致分為以下兩種 :</p>
<ul>
<li><strong>Vertical Scaling</strong>: 增加資源，像是 CPU、Memory、Storage 等等</li>
<li><strong>Horizontal Scaling</strong>: 增加節點，像是增加資料庫節點、增加資料庫叢集等等</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Scaling" src="/RulerChen-Website/assets/images/image-0c0bd50adc5761f6c79e1bb1a0ccff47.png" width="1654" height="904" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="streaming-replication">Streaming Replication<a href="#streaming-replication" class="hash-link" aria-label="Streaming Replication的直接連結" title="Streaming Replication的直接連結">​</a></h2>
<p>Streaming Replication 是 PostgreSQL 用來實現高可用性的主要機制，它透過將主節點的 WAL 日誌傳送到從節點，從而實現接近實時的資料同步。</p>
<p>在 PostgreSQL 中預設的執行方式是非同步的，說主節點在執行完一個 transaction 後，不需要等待從節點確認收到 WAL 日誌，就可以繼續執行下一個 transaction。
這種方法的好處是效能較高，缺點是如果發生故障，可能會因為 WAL 缺少而導致資料不一致。
我們也可以設置為同步，這樣主節點在執行完後，需要等待從節點確認收到 WAL 日誌，才能繼續執行，
這種方法的好處是資料一致性較高且可以保證資料的完整性，缺點是效能較低。</p>
<p>我們可以針對不同的資料 (table)，來選擇不同的方式。</p>
<p><img decoding="async" loading="lazy" alt="Streaming Replication" src="/RulerChen-Website/assets/images/image-10-6a666c38c2d3febb18a300499825faab.png" width="1052" height="548" class="img_ev3q"></p>
<p>synchronous_commit 的設定有以下幾種 :</p>
<ul>
<li><code>off</code>: 只寫入 shared buffer，不保證寫入 WAL 日誌</li>
<li><code>local</code>: 寫入 WAL buffer，並同步到本地的硬碟</li>
<li><code>remote_write</code>: 主節點寫入硬碟，從節點的 WAL buffer 收到但不保證寫入硬碟</li>
<li><code>remote_apply</code>: 在單機狀態下與 <code>local</code> 相同，在多機環境下，主節點寫入硬碟，從節點收到並寫入硬碟</li>
<li><code>on</code>: 主節點寫入硬碟，從節點收到並寫入硬碟並成功應用</li>
</ul>
<p>首先使用 <code>initdb</code> 來初始化資料庫集群，資料庫集群是由單個資料庫實例所管理的資料庫集合。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">which initdb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/lib/postgresql/15/bin/initdb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">initdb -D /tmp/primary_db/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nano /tmp/primary_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set listen_addresses to &#x27;*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set permission</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo chown -R postgres:postgres /tmp/primary_db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql --port=5433 postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create user requser replication;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nano /tmp/primary_db/pg_hba.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># add the following line</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># host all requser 127.0.0.1/32 trust</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們創建一個 replication 的資料庫，並使用 <code>pg_basebackup</code> 來進行複製</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_basebackup -h localhost -U requser --checkpoint=fast -D /tmp/replica_db -R --slot=some_slot -C --port 5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nano /tmp/replica_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set listen_addresses to &#x27;*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5434</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/replica_db start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最  後讓我們來做主節點的測試</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql --port=5433 postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> pg_stat_replication</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">----+------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pid              </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">595</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">usesysid         </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">16384</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">usename          </span><span class="token operator">|</span><span class="token plain"> requser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">application_name </span><span class="token operator">|</span><span class="token plain"> walreceiver</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_addr      </span><span class="token operator">|</span><span class="token plain"> ::</span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_hostname  </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_port      </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">49798</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend_start    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">15</span><span class="token plain">:</span><span class="token number">14.549951</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend_xmin     </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">state            </span><span class="token operator">|</span><span class="token plain"> streaming</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sent_lsn         </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flush_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replay_lsn       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write_lag        </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flush_lag        </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replay_lag       </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sync_priority    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sync_state       </span><span class="token operator">|</span><span class="token plain"> async</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">reply_time       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">33</span><span class="token plain">:</span><span class="token number">45.648063</span><span class="token operator">+</span><span class="token number">00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>從節點的測試</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql postgres --port=5434</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> pg_stat_wal_receiver</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pid                   </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">594</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">status</span><span class="token plain">                </span><span class="token operator">|</span><span class="token plain"> streaming</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">receive_start_lsn     </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">receive_start_tli     </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">written_lsn           </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flushed_lsn           </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">received_tli          </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">last_msg_send_time    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">36</span><span class="token plain">:</span><span class="token number">45.703365</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">last_msg_receipt_time </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">36</span><span class="token plain">:</span><span class="token number">45.70343</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">latest_end_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">latest_end_time       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">15</span><span class="token plain">:</span><span class="token number">14.551133</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">slot_name             </span><span class="token operator">|</span><span class="token plain"> some_slot</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sender_host           </span><span class="token operator">|</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sender_port           </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">5433</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conninfo              </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">user</span><span class="token operator">=</span><span class="token plain">requser passfile</span><span class="token operator">=</span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">postgresql</span><span class="token operator">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">pgpass channel_binding</span><span class="token operator">=</span><span class="token plain">prefer dbname</span><span class="token operator">=</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">replication</span><span class="token plain"> host</span><span class="token operator">=</span><span class="token plain">localhost port</span><span class="token operator">=</span><span class="token number">5433</span><span class="token plain"> fallback_application_name</span><span class="token operator">=</span><span class="token plain">walreceiver sslmode</span><span class="token operator">=</span><span class="token plain">prefer sslcompression</span><span class="token operator">=</span><span class="token number">0</span><span class="token plain"> sslcertmode</span><span class="token operator">=</span><span class="token plain">allow sslsni</span><span class="token operator">=</span><span class="token number">1</span><span class="token plain"> ssl_min_protocol_version</span><span class="token operator">=</span><span class="token plain">TLSv1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token number">2</span><span class="token plain"> gssencmode</span><span class="token operator">=</span><span class="token plain">prefer krbsrvname</span><span class="token operator">=</span><span class="token plain">postgres gssdelegation</span><span class="token operator">=</span><span class="token number">0</span><span class="token plain"> target_session_attrs</span><span class="token operator">=</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">any</span><span class="token plain"> load_balance_hosts</span><span class="token operator">=</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">disable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們在主節點上創建一個 table，然後在從節點上查詢，看看是否能夠查詢到</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> test_table </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">id </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SERIAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">KEY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> name </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VARCHAR</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">255</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTO</span><span class="token plain"> test_table </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;test&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> test_table</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> id </span><span class="token operator">|</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">----+------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果在兩台機器上都能夠查詢到，代表我們的 streaming replication 是成功的</p>
<p>最後關閉資料庫</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/replica_db stop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logical-replication">Logical Replication<a href="#logical-replication" class="hash-link" aria-label="Logical Replication的直接連結" title="Logical Replication的直接連結">​</a></h2>
<p>logical replication 是一種透過將 SQL 語句來進行複製的方式，
這種方式的好處是資料複製的效能較高適用於網路環境較差的地方，且可以在不同版本之間進行複製，同時也可以選擇複製特定的資料，
缺點是無法執行一些 DDL 的指令，像是 <code>CREATE TABLE</code> 或是 <code>ALTER TABLE</code> 等等，
同時 sequence 的值默認也不會複製，這代表如果需要 failover 的話，需要另外處理 sequence 的值</p>
<p><img decoding="async" loading="lazy" alt="Logical Replication" src="/RulerChen-Website/assets/images/image-1-e2174585abf64dcc3e3f553d2f5e701a.png" width="1138" height="563" class="img_ev3q"></p>
<p>創建資料庫並修改參數</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">initdb -D /tmp/publish_db/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">initdb -D /tmp/subscribe_db/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo chown -R postgres:postgres /tmp/publish_db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo chown -R postgres:postgres /tmp/subscribe_db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nano /tmp/publish_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set wal_level to logical</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nano /tmp/subscribe_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5434</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/publish_db start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/subscribe_db start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>創建好表，並使用 <code>pg_dump</code> 來複製資料</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql postgres --port=5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE DATABASE pub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">\c pub</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE test_table (id SERIAL PRIMARY KEY, name VARCHAR(255));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">INSERT INTO test_table (name) VALUES (&#x27;test&#x27;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">exit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql postgres --port=5434</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE DATABASE sub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">exit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_dump -t test_table -p 5433 -s pub | psql -p 5434 -d sub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>創建 publication 和 subscription</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql pub --port=5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE PUBLICATION test_publication FOR TABLE test_table;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql sub --port=5434</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE SUBSCRIPTION test_subscription CONNECTION &#x27;host=localhost port=5433 user=rulerchen dbname=pub&#x27; PUBLICATION test_publication;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># -- (需要改 user)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT * FROM test_table;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們可以透過 <code>pg_stat_replication</code> 來查看 replication 的狀態，並注意 lag 的部分</p>
<ul>
<li><code>write_lag</code>: 主節點寫入 WAL 的時間</li>
<li><code>flush_lag</code>: 主節點將 WAL 刷新到磁盤的時間</li>
<li><code>replay_lag</code>: 從節點應用 WAL 的時間</li>
</ul>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> pg_stat_replication</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">----+------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pid              </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">222</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">usesysid         </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">usename          </span><span class="token operator">|</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">application_name </span><span class="token operator">|</span><span class="token plain"> test_subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_addr      </span><span class="token operator">|</span><span class="token plain"> ::</span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_hostname  </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_port      </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">36752</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend_start    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">04</span><span class="token plain"> </span><span class="token number">07</span><span class="token plain">:</span><span class="token number">23</span><span class="token plain">:</span><span class="token number">31.011034</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend_xmin     </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">state            </span><span class="token operator">|</span><span class="token plain"> streaming</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sent_lsn         </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">196</span><span class="token plain">EA40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">196</span><span class="token plain">EA40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flush_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">196</span><span class="token plain">EA40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replay_lsn       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">196</span><span class="token plain">EA40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write_lag        </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flush_lag        </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replay_lag       </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sync_priority    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sync_state       </span><span class="token operator">|</span><span class="token plain"> async</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">reply_time       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">04</span><span class="token plain"> </span><span class="token number">07</span><span class="token plain">:</span><span class="token number">41</span><span class="token plain">:</span><span class="token number">12.252314</span><span class="token operator">+</span><span class="token number">00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我們也可以使用以下指令來查看 publication 和 subscription 的狀態</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">\dRp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">List </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">of</span><span class="token plain"> publications</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">----------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Name       </span><span class="token operator">|</span><span class="token plain"> test_publication</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Owner      </span><span class="token operator">|</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">All</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">tables</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> f</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Inserts    </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Updates    </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Deletes    </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Truncates  </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Via root   </span><span class="token operator">|</span><span class="token plain"> f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">\dRs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">List </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">of</span><span class="token plain"> subscriptions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">-------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Name        </span><span class="token operator">|</span><span class="token plain"> test_subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Owner       </span><span class="token operator">|</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Enabled     </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Publication </span><span class="token operator">|</span><span class="token plain"> {test_publication}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最後關閉資料庫</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">source ~/.bashrc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/publish_db stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/subscribe_db stop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgbouncer">PgBouncer<a href="#pgbouncer" class="hash-link" aria-label="PgBouncer的直接連結" title="PgBouncer的直接連結">​</a></h2>
<p>在正常的情況下，PostgreSQL 可以在一秒鐘處理約 350 個 transaction，
如果超過的話就可以考慮使用 connection pool 來進行優化，
這樣可以減少每次連接資料庫時創建 process (fork) 所需要消耗的資源</p>
<p>PgBouncer 本身沒有支援 multi-host、failover 以及 load balancing，
所以如果需要這樣的功能，我們需要使用其他的工具</p>
<p><img decoding="async" loading="lazy" alt="PgBouncer" src="/RulerChen-Website/assets/images/image-2-ea84074f202988d0af69359a84ceb2b8.png" width="994" height="552" class="img_ev3q"></p>
<p>pgbouncer 包含三種模式 :</p>
<ul>
<li><code>session</code>: 默認和最安全的模式，client 在連接期間，會持續保持連接，直到 session 結束</li>
<li><code>transaction</code>: client 僅在 transaction 期間保持與資料庫的連接</li>
<li><code>statement</code>: 每個 SQL 語句執行後，連接就會返回到池中</li>
</ul>
<p>接下來我們會安裝 pgbouncer 並且進行簡單的設定</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">initdb -D /tmp/pgbouncer_db/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo chown -R postgres:postgres /tmp/pgbouncer_db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/pgbouncer_db start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo apt install pgbouncer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd /etc/pgbouncer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo cp pgbouncer.ini pgbouncer.ini.bak # 備份原本的設定</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo nano pgbouncer.ini</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set test_db = dbname=postgres host=localhost port=5432 auth_user=postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql -p 5432 postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE USER postgres SUPERUSER;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>啟動 pgbouncer</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/sbin/pgbouncer /etc/pgbouncer/pgbouncer.ini</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 記得先關閉 pgbouncer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># sudo systemctl stop pgbouncer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># adjust min_pool_size、default_pool_size、max_client_conn to appropriate value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們可以透過 pgbench 來進行壓力測試</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo touch /tmp/pgbouncer_db/test.sql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo nano /tmp/pgbouncer_db/test.sql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># SELECT 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/pgbouncer_db start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">exit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pgbench -i postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo chmod 755 /tmp/pgbouncer_db/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>沒有 pgbouncer 的  情況</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pgbench -c 10 -t 500 -S postgres -C -f /tmp/pgbouncer_db/test.sql -p 5432</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># -- result</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pgbench (15.10 (Debian 15.10-0+deb12u1))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">starting vacuum...end.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">transaction type: multiple scripts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scaling factor: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">query mode: simple</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of clients: 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of threads: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">maximum number of tries: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of transactions per client: 500</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of transactions actually processed: 5000/5000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of failed transactions: 0 (0.000%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">latency average = 44.289 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">average connection time = 4.395 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tps = 225.789016 (including reconnection times)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SQL script 1: &lt;builtin: select only&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - weight: 1 (targets 50.0% of total)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - 2453 transactions (49.1% of total, tps = 110.772091)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - number of failed transactions: 0 (0.000%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - latency average = 17.399 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - latency stddev = 11.772 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SQL script 2: /tmp/pgbouncer_db/test.sql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - weight: 1 (targets 50.0% of total)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - 2547 transactions (50.9% of total, tps = 115.016925)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - number of failed transactions: 0 (0.000%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - latency average = 16.865 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - latency stddev = 11.840 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有 pgbouncer 的情況</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pgbench -c 10 -t 500 -S test_db -C -f /tmp/pgbouncer_db/test.sql -p 6432</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># -- result</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pgbench (15.10 (Debian 15.10-0+deb12u1))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">starting vacuum...end.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">transaction type: multiple scripts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scaling factor: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">query mode: simple</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of clients: 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of threads: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">maximum number of tries: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of transactions per client: 500</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of transactions actually processed: 5000/5000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">number of failed transactions: 0 (0.000%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">latency average = 5.059 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">average connection time = 0.432 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tps = 1976.638505 (including reconnection times)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SQL script 1: &lt;builtin: select only&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - weight: 1 (targets 50.0% of total)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - 2468 transactions (49.4% of total, tps = 975.668766)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - number of failed transactions: 0 (0.000%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - latency average = 2.538 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - latency stddev = 1.538 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SQL script 2: /tmp/pgbouncer_db/test.sql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - weight: 1 (targets 50.0% of total)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - 2532 transactions (50.6% of total, tps = 1000.969739)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - number of failed transactions: 0 (0.000%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - latency average = 2.361 ms</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> - latency stddev = 1.460 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以觀察到 tps 有明顯的提升，從 225 提升到 1976。</p>
<p>pgbench 的參數說明如下 :</p>
<ul>
<li><code>-i</code>: 初始化資料庫</li>
<li><code>-c</code>: 同時執行的 client 數量</li>
<li><code>-t</code>: 每個 client 執行的 transaction 數量</li>
<li><code>-S</code>: 使用 simple query mode</li>
<li><code>-C</code>: 為每個 transaction 創建一個新的連接</li>
<li><code>-f</code>: 指定要執行的 SQL 檔案</li>
<li><code>-p</code>: 指定 port</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="partition">Partition<a href="#partition" class="hash-link" aria-label="Partition的直接連結" title="Partition的直接連結">​</a></h2>
<p>對於資料量大的表，不管是查詢或是 vacuum 都會需要較長的時間，這時候我們可以考慮將表進行分割提升效能</p>
<p>在新版的 PostgreSQL 中，partition 多使用 declarative 的方式來進行分割，而不是 inheritance 的方式。</p>
<p>partition 的方法大致有以下四種 :</p>
<ul>
<li><strong>Range Partition</strong>: 依 照範圍來進行分割，像是時間、數值等等</li>
<li><strong>List Partition</strong>: 依照特定的值來進行分割</li>
<li><strong>Hash Partition</strong>: 依照 hash 值來進行分割</li>
<li><strong>Composite Partition</strong>: 結合以上兩種或多種方式來進行分割</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql --port=5433 postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> customers </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    id </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TEXT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    age </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">NUMERIC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> RANGE </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> customers_young </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">OF</span><span class="token plain"> customers </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">MINVALUE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">25</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> customers_adult </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">OF</span><span class="token plain"> customers </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">25</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">65</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> customers_old </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">OF</span><span class="token plain"> customers </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">65</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">MAXVALUE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTO</span><span class="token plain"> customers </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;John Doe&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Jane Doe&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;John Smith&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">60</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Jane Smith&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">70</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> tableoid::regclass</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> customers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tableoid     </span><span class="token operator">|</span><span class="token plain"> id </span><span class="token operator">|</span><span class="token plain">    name    </span><span class="token operator">|</span><span class="token plain"> age</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-----------------+----+------------+-----</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> customers_young </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> John Doe   </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> customers_adult </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">2</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> Jane Doe   </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> customers_adult </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">3</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> John Smith </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> customers_old   </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">4</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> Jane Smith </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">70</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">4</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">rows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼 簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sharding">Sharding<a href="#sharding" class="hash-link" aria-label="Sharding的直接連結" title="Sharding的直接連結">​</a></h2>
<p>sharding 是將資料分割到多個資料庫，以減輕單個資料庫的負擔。</p>
<p>sharding 的關鍵在於如何選擇 sharding key，
我們需要依據業務場景來選擇合適的 sharding key，
來保證我們的查詢或寫入盡量落在同一個資料庫中。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgresql-high-availability">PostgreSQL High Availability<a href="#postgresql-high-availability" class="hash-link" aria-label="PostgreSQL High Availability的直接連結" title="PostgreSQL High Availability的直接連結">​</a></h2>
<p>在生產環境中，我們需要考慮在各種不同的環境下都能穩定地提供服務，這時候我們就需要考慮高可用性的問題</p>
<p>HA 主要分為三個步驟 :</p>
<ol>
<li>replication : 主節點將資料複製到從節點，以保證資料的一致性</li>
<li>failover : 當主節點故障時，從節點自動升級為主節點</li>
</ol>
<ul>
<li><code>pg_ctl promote</code></li>
<li><code>pgpool II</code></li>
<li><code>PAF</code></li>
<li><code>Patroni</code></li>
<li><code>Repmgr</code></li>
</ul>
<ol start="3">
<li>failback : 當主節點恢復正常時，從節點降級為從節點</li>
</ol>
<ul>
<li><code>pg rewind</code></li>
<li><code>pgpool II</code></li>
<li><code>PAF</code></li>
<li><code>Patroni</code></li>
<li><code>Repmgr</code></li>
</ul>
<p>在處理 HA 之前要先了解以下幾個問題 :</p>
<ol>
<li>資料的重要性</li>
</ol>
<p><img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-4-43ddab330de03fd9be5d3839420acb1a.png" width="1150" height="600" class="img_ev3q"></p>
<ol start="2">
<li>RTO (Recovery Time Objective) &amp;&amp; RPO (Recovery Point Objective)</li>
</ol>
<p><img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-6-c45c5c7d2f3ce27138d4d9fd9596a702.png" width="903" height="538" class="img_ev3q">
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-7-cf637ecc909fb1861929e56a3baffe4c.png" width="834" height="548" class="img_ev3q"></p>
<ol start="3">
<li>Auto failover 的機制</li>
</ol>
<p><img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-5-188a8cfcf12935273ef3f49331db134a.png" width="1124" height="552" class="img_ev3q">
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-11-6065b5f7679677d4f63bd6c496636501.png" width="1084" height="627" class="img_ev3q"></p>
<ol start="4">
<li>Cross-center replication</li>
</ol>
<p><img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-8-30da38745b6cb7a9f25fa250d4453c6b.png" width="1144" height="575" class="img_ev3q"></p>
<ol start="5">
<li>Do we open replication for read</li>
</ol>
<p><img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-9-bbf01b748da17a187599839ada5b5bbd.png" width="921" height="572" class="img_ev3q"></p>
<p>一個基本的架構圖大致如下 :</p>
<p><img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-12-42d8d39af659e187ed8625550f7b8c80.png" width="1086" height="630" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgpool-ii">Pgpool II<a href="#pgpool-ii" class="hash-link" aria-label="Pgpool II的直接連結" title="Pgpool II的直接連結">​</a></h2>
<p>pgpool 是一個位在資料庫跟客戶端的 middleware，
可以提供 load balancing、failover、connection pooling 等功能，
是一個很好的 HA 解決方案</p>
<p>接下來會示範 pgpool 的簡易設定 :</p>
<p>首先需要設定 streaming application，跟之前的設定相同，並安裝 pgpool</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/replica_db start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下來我們會先設定 load balance 的部分，將 SELECT 的 query 導向 replica，其他的 query 導向 primary</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo apt install pgpool2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd /etc/pgpool2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo nano pgpool.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set listen_addresses to &#x27;*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set backend_hostname0 to localhost</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set backend_port0 to 5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set backend_weight0 to 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set backend_data_directory0 to &#x27;/tmp/primary_db/&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set backend_hostname1 to localhost</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set backend_port1 to 5434</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set backend_weight1 to 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set backend_data_directory1 to &#x27;/tmp/replica_db/&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set log_statement to &#x27;on&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set log_per_node_statement to &#x27;on&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set sr_check_user to &#x27;requser&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set health_check_period to 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set health_check_user to &#x27;requser&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo systemctl stop pgpool2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo /usr/sbin/pgpool -n -f /etc/pgpool2/pgpool.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著嘗試連線</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql -p 9999 postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> table1 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">id </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SERIAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">KEY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> name </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VARCHAR</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">255</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTO</span><span class="token plain"> table1 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;test&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> table1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 pgpool 的 log 中我們可以看到 query 是如何被導向的</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 02:58:32.383: psql pid 40763: LOG:  DB node id: 0 backend pid: 40797 statement: CREATE TABLE table1 (id SERIAL PRIMARY KEY, name VARCHAR(255));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 02:58:35.931: psql pid 40763: LOG:  DB node id: 0 backend pid: 40797 statement: INSERT INTO table1 (name) VALUES (&#x27;test&#x27;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 02:59:00.839: psql pid 40763: LOG:  DB node id: 1 backend pid: 40798 statement: SELECT * FROM table1;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>SELECT 被導向到 node 1，其他的 query 則被導向到 node 0</p>
<p>接著我們會利用 pgpool 來實現 HA :</p>
<p>首先我們會先修改 primary 的設定，將 synchronous 修改為 remote_apply，並且設定 wal_log_hints 為 on (方便使用 <code>pg_rewind</code> 來進行 failback)</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo nano /tmp/primary_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set synchronous_commit to remote_apply</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set synchronous_standby_names to &#x27;*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set wal_log_hints to on</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至 剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>新增一個檔案來當作 failover 的 script</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo nano /tmp/failover.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">/tmp/failover.sh</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#! /bin/sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">failed_node=$1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">trigger_file=$2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if [$failed_node = 1];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">then exit 0;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">touch $trigger_file</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">exit 0;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著修改 pgpool 的設定</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo nano /etc/pgpool2/pgpool.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set failover_command to &#x27;/tmp/failover.sh %d /tmp/replica_db/down.trg&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著修改 replica 的設定</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo nano /tmp/replica_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set promote_trigger_file to &#x27;/tmp/replica_db/down.trg&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/replica_db restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著來做測試，我們會啟動 pgpool 並把 primary_db 關閉來測試結果</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo systemctl stop pgpool2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo chmod +x /tmp/failover.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo /usr/sbin/pgpool -n -f /etc/pgpool2/pgpool.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo -i -u postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db stop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>停止 primary 之後，我們可以看到 pgpool 的 log 中有 failover 的訊息</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 14:32:55.722: main pid 51351: LOG:  execute command: /tmp/failover.sh 0 /tmp/replica_db/down.trg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 14:32:55.750: main pid 51351: LOG:  find_primary_node_repeatedly: waiting for finding a primary node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 14:32:55.755: main pid 51351: LOG:  find_primary_node: standby node is 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 14:32:56.760: main pid 51351: LOG:  find_primary_node: standby node is 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 14:32:57.765: main pid 51351: LOG:  find_primary_node: primary node is 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 14:32:57.766: main pid 51351: LOG:  failover: set new primary node: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-12-27 14:32:57.766: main pid 51351: LOG:  failover: set new main node: 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們可以嘗試連線到 pgpool 來查看是否真的連接到了 replica</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql -p 9999 postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SHOW</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># -- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> port</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token number">5434</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">row</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>這樣代表我們成功連到了第二個節點，完成了 failover 的測試</p>
<p>最後，當我們的故障節點恢復正常時，我們就可以使用 <code>pg_rewind</code> 來進行 failback</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="#reference" class="hash-link" aria-label="Reference的直接連結" title="Reference的直接連結">​</a></h2>
<ul>
<li><a href="https://www.udemy.com/course/postgresql-replication-high-availability-ha-and-scalability" target="_blank" rel="noopener noreferrer">PostgreSQL Replication, High Availability HA and Scalability</a></li>
<li><a href="https://www.interdb.jp/pg/index.html" target="_blank" rel="noopener noreferrer">The Internals of PostgreSQL</a></li>
<li><a href="https://www.youtube.com/watch?v=a_lW1Hz-IPU" target="_blank" rel="noopener noreferrer">Scaling PostgreSQL with Google Cloud and HAProxy</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/RulerChen/RulerChen-Website/tree/main/docs/PostgreSQL/pg-ha.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>編輯此頁</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最後<!-- -->於 <b><time datetime="2024-12-28T12:38:29.000Z" itemprop="dateModified">2024年12月28日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/RulerChen-Website/docs/PostgreSQL/pg-tuning/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">[PG] PostgreSQL Performance Tuning</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/RulerChen-Website/docs/Observability/"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">Observability</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#environment-setup" class="table-of-contents__link toc-highlight">Environment Setup</a></li><li><a href="#scaling-postgresql" class="table-of-contents__link toc-highlight">Scaling PostgreSQL</a></li><li><a href="#streaming-replication" class="table-of-contents__link toc-highlight">Streaming Replication</a></li><li><a href="#logical-replication" class="table-of-contents__link toc-highlight">Logical Replication</a></li><li><a href="#pgbouncer" class="table-of-contents__link toc-highlight">PgBouncer</a></li><li><a href="#partition" class="table-of-contents__link toc-highlight">Partition</a></li><li><a href="#sharding" class="table-of-contents__link toc-highlight">Sharding</a></li><li><a href="#postgresql-high-availability" class="table-of-contents__link toc-highlight">PostgreSQL High Availability</a></li><li><a href="#pgpool-ii" class="table-of-contents__link toc-highlight">Pgpool II</a></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>