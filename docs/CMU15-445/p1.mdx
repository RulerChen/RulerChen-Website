---
title: 'P1 - Buffer Pool Manager'
sidebar_position: '101'
description: Buffer Pool Manager
keywords: [CMU15-445/645, Buffer Pool Manager, CMU15-445/645 ç­†è¨˜]
tags: [CMU15-445, CMU15-445 Projects]
---

<head>
  <title>CMU 15-445 2024Fall P1 Buffer Pool Manager</title>
</head>

åœ¨é€™å€‹ project ä¸­ï¼Œæˆ‘å€‘éœ€è¦å¯¦ç¾ä¸€å€‹ buffer pool managerï¼Œç¸½å…±æœ‰ 3 å€‹ task :

- LRU-K Replacement Policy
- Disk Scheduler
- Buffer Pool Manager

æˆ‘æ¡å–çš„åšæ³•éƒ½æ˜¯åªæ±‚é€šéä¸æ±‚æ•ˆèƒ½ï¼Œå¦‚æœæƒ³è¦é€²è¡Œæ•ˆèƒ½å„ªåŒ–ï¼Œå¯ä»¥åƒè€ƒæœ€ä¸‹æ–¹ References ä¸­çš„æ–‡ç« ã€‚

## Background

é€™å€‹ project çš„èƒŒæ™¯æ˜¯æ¨¡æ“¬è³‡æ–™åº«ç³»çµ±ä¸­ buffer pool manager çš„é‹ä½œï¼Œä¸»è¦æ˜¯ç”¨ä¾†ç®¡ç†è¨˜æ†¶é«”ä¸­çš„é é¢ã€‚

åœ¨é–‹å§‹ä¹‹å‰ï¼Œæˆ‘å€‘å¯ä»¥å…ˆä¾†çœ‹ä¸€ä¸‹ bustub çš„ IO æ¶æ§‹åœ– :

<ImageModal src="/img/cmu15-445/p1/IO workflow.webp" caption="Bustub IO Workflow" />

ç”¨æ–‡å­—ä¾†æè¿°çš„è©±ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ :

1. ä¸Šå±¤å‘¼å« `BufferPoolManager` çš„ API ä¾†ç²å¾— `PageGuard`
2. `BufferPoolManager` æœƒå…ˆæª¢æŸ¥ page æ˜¯å¦åœ¨ buffer pool ä¸­ï¼Œä¸¦æŠŠ metadata æ”¾åœ¨ `FrameHeader` ä¸­ (åŒ…å« pin_countã€is_dirty ç­‰ç­‰)
3. å¦‚æœ page ä¸åœ¨ buffer pool ä¸­ï¼Œ`BufferPoolManager` æœƒå…ˆæª¢æŸ¥ free list æ˜¯å¦æœ‰ç©ºé–“ï¼Œå¦‚æœæ²’æœ‰çš„è©±å°±å‘¼å« `LRUKReplacer` ä¾†æ‰¾ä¸€å€‹ page ä¾† evictï¼Œ`LRUKReplacer` æœƒæ ¹æ“š `LRUKNode` ä¸­çš„æ­·å²ç´€éŒ„ä¾†æ±ºå®šè¦ evict å“ªå€‹ page
4. å¦‚æœè¦ evict çš„ page æ˜¯ dirty çš„è©± (æˆ–å…¶ä»–éœ€è¦ flush çš„æƒ…æ³)ï¼Œå°±æœƒå‚³é€ä¸€å€‹ `DiskRequest` çµ¦ `DiskScheduler`ï¼Œ`DiskScheduler` æœƒæŠŠ request æ”¾åˆ° queue ä¸­ï¼Œä¸¦ç”±èƒŒæ™¯çš„ worker thread ä¾†è™•ç†
5. æ¥è‘— worker thread æœƒå‘¼å« `DiskManager` ä¾†è®€å– / å¯«å…¥è³‡æ–™åˆ°ç¡¬ç¢Ÿ

## Task 1 - LRU-K Replacement Policy

Task 1 çš„ç›®æ¨™æ˜¯å¯¦ç¾ LRU-K replacement policyï¼Œä¸»è¦åŒ…æ‹¬ `LRUKReplacer` è·Ÿ `LRUKNode` å…©å€‹ classã€‚

åŸºæœ¬ä¸Šå°±æ˜¯ç¶­è­· `node_store_` è·Ÿ `LRUKNode` ä¸­çš„ `history_` å°±å¥½ï¼Œå¯ä»¥é †ä¾¿å° `LRUKNode` å¯«ä¸€äº› get function ä¾†æ–¹ä¾¿å–å¾—è³‡æ–™ã€‚

LRU-K çš„é‚è¼¯å¦‚ä¸‹ :

1. ç•¶ä¸€å€‹ page è¢« access çš„æ™‚å€™ï¼Œå°±æœƒæŠŠç•¶å‰çš„ timestamp åŠ åˆ° `history_` ä¸­ï¼Œç•¶ `history_` çš„å¤§å°è¶…é K çš„æ™‚å€™ï¼Œå°±æœƒæŠŠæœ€æ—©çš„ timestamp ç§»é™¤
2. ç•¶è¦ evict çš„æ™‚å€™ï¼Œæœƒå…ˆæ‰¾å‡ºæ‰€æœ‰ `IsEvictable` çš„ nodeï¼Œç„¶å¾Œåˆ†æˆå…©çµ„ï¼Œä¸€çµ„æ˜¯ `history_` ä¸­æœ‰ K å€‹ timestamp çš„ï¼Œå¦ä¸€çµ„æ˜¯ä¸æ»¿ K å€‹çš„
3. æœƒå„ªå…ˆæ’é™¤ä¸æ»¿ K å€‹ timestamp çš„ nodeï¼Œæ‰¾å‡ºé€™çµ„ä¸­æœ€å¾Œä¸€å€‹ timestamp æœ€æ—©çš„ node ä¾† evict
4. å¦‚æœæ‰€æœ‰ node éƒ½æ»¿ K å€‹ timestamp çš„è©±ï¼Œå°±åœ¨é€™çµ„ä¸­æ‰¾å‡ºæœ€å¾Œä¸€å€‹ timestamp æœ€æ—©çš„ node ä¾† evict

å¯¦ä½œä¸Šå¤§è‡´å¦‚ä¸‹ï¼Œå…¶å¯¦éƒ½éå¸¸ç›´è§€ï¼Œæ²’æœ‰ç‰¹åˆ¥éœ€è¦æ³¨æ„çš„åœ°æ–¹ :

- `Evict` : ä¸»è¦æ˜¯å¯¦ä½œä¸Šé¢æåˆ°çš„é‚è¼¯
- `RecordAccess` : æ›´æ–° `history_` ä¸­çš„è³‡æ–™
- `SetEvictable` : åˆ¤æ–· `IsEvictable` çš„æƒ…æ³ä¸¦åˆªé™¤å³å¯
- `Remove` : æª¢æŸ¥ `IsEvictable` ä¹‹å¾Œå°±å¯ä»¥ç›´æ¥åˆªé™¤
- `Size` : ç›´æ¥å›å‚³ `curr_size_`

æ¸¬è©¦é€™å€‹ task çš„æŒ‡ä»¤å¦‚ä¸‹ :

```bash
make lru_k_replacer_test -j$(nproc) && ./test/lru_k_replacer_test
```

## Task 2 - Disk Scheduler

Task 2 çš„ç›®æ¨™æ˜¯å¯¦ç¾ disk schedulerï¼Œä¸»è¦æ˜¯è¦å¯¦ä½œ `DiskScheduler` ä¸­çš„å…©å€‹ function :

- `Schedule` : åªéœ€è¦å°‡ r ä¸Ÿåˆ° `request_queue_` ä¸­å³å¯
- `StartWorkerThread` : è¨­è¨ˆä¸€å€‹ while è¿´åœˆä¸¦åŸ·è¡Œ requestï¼Œæœ€å¾Œå†è¨­å®š callback ç‚º true å³å¯ï¼Œæ‹¿åˆ° `std::nullopt` å°±å¯ä»¥è·³å‡ºè¿´åœˆ

ä»¥åŠè¦æ³¨æ„è¨»è§£æ‰å»ºæ§‹å­ä¸­çš„ throw errorï¼Œé€™æ¨£æ‰èƒ½æ­£å¸¸åŸ·è¡Œ testã€‚

æ¸¬è©¦é€™å€‹ task çš„æŒ‡ä»¤å¦‚ä¸‹ :

```bash
make disk_scheduler_test -j$(nproc) && ./test/disk_scheduler_test
```

## Task 3 - Buffer Pool Manager

Task 3 çš„ç›®æ¨™æ˜¯å¯¦ä½œ buffer pool managerï¼Œä¸»è¦æœƒç”¨åˆ°çš„ class æœ‰ `PageGuard`ã€`BufferPoolManager`ã€`FrameHeader`ã€‚
é€™å€‹ task ç›¸å°æ–¼å‰å…©å€‹è¦èŠ±è »å¤šæ™‚é–“æ€è€ƒçš„ï¼Œæˆ‘èªç‚ºå¯ä»¥å…ˆæ€è€ƒåœ¨å–®ç·šç¨‹ä¸‹çš„é‚è¼¯ï¼Œæœ€å¾Œå†ä¾†è™•ç†æœ‰é—œé–çš„å•é¡Œã€‚

`PageGuard` æ˜¯ä¸€å€‹å¯ä»¥å° frame é€²è¡Œè®€å¯«çš„ classï¼Œåˆ†æˆ `ReadPageGuard` è·Ÿ `WritePageGuard` å…©å€‹ classï¼Œåªæœ‰æ‹¿åˆ° `PageGuard` æ‰èƒ½å° frame é€²è¡Œè®€å¯«ï¼Œå¦‚ `WritePageGuard::GetDataMut()` æœƒå›å‚³å¯ä¿®æ”¹çš„ `char[]`ã€‚

åŒæ™‚ï¼Œé€™å€‹ class é‚„éœ€è¦æ­é… `FrameHeader` ä¸­çš„ `rwlatch_` ä¾†ç¢ºä¿å¤šç·šç¨‹ä¸‹çš„å®‰å…¨æ€§ï¼Œæˆ‘å€‘æœƒåœ¨å¾Œé¢è¨è«–é€™å€‹éƒ¨åˆ†ã€‚

å…©å€‹ class çš„é‚è¼¯å¤§è‡´ç›¸åŒ (åªæœ‰é–çš„ç¨®é¡ä¸åŒè€Œå·²)ï¼Œé€™è£¡ä»¥ `ReadPageGuard` ç‚ºä¾‹ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å¹¾å€‹ function :

- `ReadPageGuard` : å–å¾— frame_->rwlatch çš„é–ï¼Œä¸¦æŠŠ is_valid è¨­å®šç‚º true
- `ReadPageGuard(ReadPageGuard &&that)` : `PageGuard` åªèƒ½è¢« move ä¸èƒ½è¢« copy (é€™æ˜¯ç‚ºäº†é¿å…è³‡æºç®¡ç†ä¸Šçš„å•é¡Œ)ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦å¯¦ä½œ move constructorï¼Œä¸»è¦æ˜¯æŠŠ that çš„è³‡æ–™æ¬éä¾†ï¼Œç„¶å¾ŒæŠŠ that çš„ is_valid è¨­å®šç‚º false
- `operator=` : é¡ä¼¼å‰é¢
- `Drop` : å…ˆæª¢æŸ¥ is_valid æ˜¯å¦ç‚º trueï¼Œå¦‚æœæ˜¯çš„è©±è™•ç† pin_count è·Ÿ SetEvictable çš„æƒ…æ³ï¼Œç„¶å¾Œå†æŠŠ is_valid è¨­å®šç‚º false

`BufferPoolManager` å‰‡æ˜¯ç”¨ä¾†ç®¡ç† buffer pool çš„ classï¼Œä¸»è¦ç¶­è­· page è·Ÿ frame çš„å°æ‡‰é—œä¿‚ (`page_table_`)ï¼Œé™¤æ­¤ä¹‹å¤–ä¹ŸåŒ…å«äº† `replacer_` è·Ÿ `disk_scheduler_` ä¾†åšé é¢æ›¿æ›ä»¥åŠç¡¬ç¢Ÿçš„è®€å¯«ã€‚

ä¸»è¦éœ€è¦å¯¦ä½œçš„ function å¦‚ä¸‹ :

- `NewPage` : æŠŠ `next_page_id` +1 ä¹‹å¾Œä½¿ç”¨ `disk_scheduler_->IncreaseDiskSpace` æ–°å¢ page å³å¯
- `DeletePage` : å…ˆç¢ºå®šé€™å€‹ page æœ‰åœ¨ `page_table` ä¸­ï¼Œæ¥è‘—å†æª¢æŸ¥ pin_count æ˜¯å¦ç‚º 0ï¼Œç„¶å¾Œå†æª¢æŸ¥ is_dirty çœ‹æ˜¯å¦éœ€è¦ FlushPageï¼Œæœ€å¾Œå†å‘¼å« `FrameHeader->Reset` å³å¯
- `CheckedWritePage` & `CheckedReadPage` : é€™å…©å€‹å‡½æ•¸æ˜¯é€™å€‹ task æœ€é‡è¦çš„å‡½æ•¸ï¼Œå¯¦ä½œä¸Šä¹Ÿéå¸¸é¡ä¼¼ï¼Œä¸»è¦é‚è¼¯å¦‚ä¸‹ :
  - å¦‚æœé€™å€‹ page å·²ç¶“åœ¨ buffer pool ä¸­äº†ï¼Œé‚£å°±è¦æ›´æ–°å®ƒçš„ metadata (pin_count, evictable, recordaccess)
  - å¦‚æœ `page_id` ä¸åœ¨ buffer pool ä¸­ï¼Œä½†æ˜¯ `free_frame` ä¸­æœ‰ç©ºé–“ï¼Œé‚£å°±å¯ä»¥ pop_front ä¸€å€‹ frameï¼Œç„¶å¾Œæ›´æ–° metadata
  - å¦‚æœ `page_id` ä¸åœ¨ buffer pool ä¸­ï¼Œä¸” `free_frame` ä¹Ÿæ²’æœ‰ç©ºé–“ï¼Œé‚£æˆ‘å€‘å°±è¦ä½¿ç”¨ `replacer_` ä¾† evict ä¸€å€‹ frameï¼Œç„¶å¾Œä¸€æ¨£æ›´æ–° metadata
- `FlushPage` : æª¢æŸ¥ `page_id` æ˜¯å¦åœ¨ `page_table` ä¸­ï¼Œç„¶å¾Œæª¢æŸ¥ `is_dirty` ï¼Œå¯ä»¥ä½¿ç”¨ `disk_scheduler_` ä¾†æŠŠè³‡æ–™å¯«å›ç¡¬ç¢Ÿï¼Œé€™å€‹å‡½æ•¸åŸºæœ¬å¯ä»¥å‡è¨­å‘¼å«å®ƒçš„äººéƒ½æœ‰ bpm é–ï¼Œæ‰€ä»¥ä¸éœ€è¦å†ç²å–
- `FlushAllPages` : éæ­· `page_table` ä¸­çš„è³‡æ–™ï¼Œç„¶å¾Œä½¿ç”¨ `FlushPage` ä¾†å¯«å›ç¡¬ç¢Ÿ
- `GetPinCount` : æª¢æŸ¥ `page_id` æ˜¯å¦åœ¨ `page_table` ä¸­ï¼Œç„¶å¾Œå›å‚³ `pin_count`

è¨è«–å®ŒåŸºæœ¬åŠŸèƒ½ä¹‹å¾Œå°±å¯ä»¥é–‹å§‹æ€è€ƒ concurrency çš„å•é¡Œã€‚
é€™å€‹ task æœ‰å…©å€‹é–ï¼Œä¸€å€‹æ˜¯ bpm çš„é–ï¼Œå¦ä¸€å€‹æ˜¯ frame çš„é–ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿é€™å…©å€‹é–åœ¨ä½¿ç”¨ä¸Šä¸æœƒç™¼ç”Ÿ deadlockã€‚

é€™éƒ¨åˆ†æˆ‘è¦ºå¾— [é€™ç¯‡æ–‡ç« ](https://zhuanlan.zhihu.com/p/828933572) æœ‰å¾ˆè©³ç´°çš„èªªæ˜ï¼Œæˆ‘ä¹Ÿæ˜¯åƒè€ƒé€™ç¯‡æ–‡ç« çš„åšæ³•ä¾†å¯¦ä½œï¼Œé€™è£¡å°±ç°¡å–®èªªæ˜ä¸€ä¸‹ã€‚

é€™ç¯‡æ–‡ç« åˆ—å‡ºäº†ä¸‰å€‹éœ€è¦æ³¨æ„çš„åœ°æ–¹ :

1. `pin_count_` è·Ÿ `rwlatch_` çš„é †åºè¦éµå®ˆ pin -> lock -> unlock -> unpin çš„é †åº
2. ç”¨ `bpm_latch_` ä¿è­· `pin_count_` è·Ÿ `SetEvictable` çš„æ›´æ–°
3. ç²å– `rwlatch_` çš„æ™‚å€™ä¸èƒ½åŒæ™‚æŒæœ‰ `bpm_latch_`

æœ‰é—œæ–¼ç¬¬ä¸€é»å¯ä»¥ç”¨åä¾‹ä¾†èªªæ˜ã€‚
å¦‚æœé †åºæ˜¯å…ˆ lock åœ¨ pin çš„è©±ï¼Œä»£è¡¨é †åºå¦‚ä¸‹ :

1. T1 æ‹¿åˆ° frame 0 çš„é–
2. T1 åŸ·è¡Œ `pin_count_++`
3. T1 åšäº†ä¸€äº›äº‹æƒ…å¾Œï¼Œ `pin_count--`
4. T1 æ”¾æ‰ frame 0 çš„é–
5. T2 æ‹¿åˆ° frame 0 çš„é–

ä»”ç´°æ€è€ƒçš„è©±å¯ä»¥ç™¼ç¾ï¼ŒT1 åœ¨ç¬¬ 3 æ­¥é©Ÿçš„æ™‚å€™ï¼Œ`pin_count_` å¯èƒ½æœƒè®Šæˆ 0ï¼Œä»£è¡¨é€™æ®µæ™‚é–“é–‹å§‹åˆ° T2 æ‹¿åˆ°é–ä¹‹å‰ï¼Œé€™å€‹ frame å¯èƒ½æœƒè¢« evict æ‰ï¼Œå°è‡´ T2 æ‹¿åˆ°çš„ frame æ˜¯å·²ç¶“è¢« evict æ‰çš„ frameã€‚

ç¬¬äºŒé»ç†è§£èµ·ä¾†æ¯”è¼ƒç°¡å–®ï¼Œå°±æ˜¯å› ç‚º `pin_count_` è·Ÿ `is_evictable_` éœ€è¦æ˜¯åŸå­æ“ä½œï¼Œæ‰€ä»¥éœ€è¦ç”¨ `bpm_latch_` ä¾†ä¿è­·ã€‚

ç¬¬ä¸‰é»å¯ä»¥ç”¨æ¸¬è©¦æ¡ˆä¾‹ `DeadlockTest` ä¾†è§£é‡‹ï¼Œé€™å€‹æ¸¬è©¦å¦‚ä¸‹ :

```cpp title="test/buffer/buffer_pool_manager_test.cpp"
TEST(BufferPoolManagerTest, DeadlockTest) {
  auto disk_manager = std::make_shared<DiskManager>(db_fname);
  auto bpm = std::make_shared<BufferPoolManager>(FRAMES, disk_manager.get(), K_DIST);

  auto pid0 = bpm->NewPage();
  auto pid1 = bpm->NewPage();

  auto guard0 = bpm->WritePage(pid0);

  // A crude way of synchronizing threads, but works for this small case.
  std::atomic<bool> start = false;

  auto child = std::thread([&]() {
    // Acknowledge that we can begin the test.
    start.store(true);

    // Attempt to write to page 0.
    auto guard0 = bpm->WritePage(pid0);
  });

  // Wait for the other thread to begin before we start the test.
  while (!start.load()) {
  }

  // Make the other thread wait for a bit.
  // This mimics the main thread doing some work while holding the write latch on page 0.
  std::this_thread::sleep_for(std::chrono::milliseconds(1000));

  // If your latching mechanism is incorrect, the next line of code will deadlock.
  // Think about what might happen if you hold a certain "all-encompassing" latch for too long...

  // While holding page 0, take the latch on page 1.
  auto guard1 = bpm->WritePage(pid1);

  // Let the child thread have the page 0 since we're done with it.
  guard0.Drop();

  child.join();
}
```

å…ˆç°¡å–®æ•˜è¿°ä¸€ä¸‹é€™å€‹ Test çš„é‚è¼¯ï¼Œé¦–å…ˆä¸»åŸ·è¡Œç·’æœƒå…ˆå–å¾— frame 0 çš„ç¨ä½”é–ï¼Œæ¥è‘—å•Ÿå‹•ä¸€å€‹å­åŸ·è¡Œç·’ä¹Ÿä¾†è®€å– frame 0 çš„ç¨ä½”é–ï¼Œé€™æ™‚å€™ä¸»åŸ·è¡Œç·’æœƒå…ˆç¡ 1 ç§’é˜ï¼Œç„¶å¾Œå†å–å¾— frame 1 çš„ç¨ä½”é–ï¼Œæœ€å¾Œä¸»åŸ·è¡Œç·’å†é‡‹æ”¾ frame 0 çš„ç¨ä½”é–ã€‚

å¦‚æœæˆ‘å€‘ç›´æ¥åœ¨ `CheckedWritePage` ä¸­ä½¿ç”¨ `std::scoped_lock` ä¾†é–ä½ bpm çš„é–ï¼Œé‚£éº¼é€™å€‹æ¸¬è©¦å°±æœƒæ­»é–ï¼Œæµç¨‹å¦‚ä¸‹ :

1. ä¸»åŸ·è¡Œç·’å–å¾— bpm çš„é–
2. ä¸»åŸ·è¡Œç·’å–å¾— frame 0 çš„ç¨ä½”é–
3. ä¸»åŸ·è¡Œç·’æ”¾æ£„ bpm çš„é–
4. å­åŸ·è¡Œç·’å–å¾— bpm çš„é–
5. å­åŸ·è¡Œç·’ç­‰å¾… frame 0 çš„ç¨ä½”é–
6. ä¸»åŸ·è¡Œç·’ç­‰å¾… bpm çš„é– (æº–å‚™è®€å– frame 1)
7. ç”±æ–¼å…©é‚Šéƒ½åœ¨ç­‰å¾…å°æ–¹çš„é–ï¼Œæ‰€ä»¥å°±æœƒæ­»é–

ç”±ä¸Šé¢çš„ç¯„ä¾‹æˆ‘å€‘å¯ä»¥çŸ¥é“ï¼Œæˆ‘å€‘å¿…é ˆè¦åœ¨å–å¾— frame çš„é–ä¹‹å‰æ”¾æ‰ bpm çš„é–ï¼Œé€™æ¨£æ‰èƒ½é¿å…æ­»é–çš„å•é¡Œã€‚

ä½†é€™æ¨£é‚„æœ‰ä¸€å€‹ç–‘æƒ‘æ˜¯ï¼Œå‡è¨­æˆ‘å€‘åœ¨å–å¾— frame çš„é–ä¹‹å‰æ”¾æ‰ bpm çš„é–ï¼Œé‚£éº¼åœ¨é€™æ®µæ™‚é–“å…§ï¼Œå…¶ä»–çš„åŸ·è¡Œç·’å°±æœ‰å¯èƒ½æœƒæ’éšŠï¼Œé€™æ¨£æœƒä¸æœƒå°è‡´æˆ‘å€‘å–å¾—çš„ frame ä¸æ˜¯æˆ‘å€‘æƒ³è¦çš„ frame å‘¢?

ç­”æ¡ˆæ˜¯ä¸æœƒï¼Œå› ç‚ºæˆ‘å€‘æœƒåœ¨æŒæœ‰ bpm çš„é–çš„æ™‚å€™å°±æ›´æ–° `pin_count_` è·Ÿ `is_evictable_`ï¼Œæ‰€ä»¥å³ä½¿å…¶ä»–åŸ·è¡Œç·’æ’éšŠä¹Ÿä¸æœƒå°è‡´æˆ‘å€‘è¦çš„ frame è¢« evict æ‰ï¼Œåªæ˜¯æœƒåœ¨åŸ·è¡Œé †åºä¸Šæœ‰äº›ä¸åŒè€Œå·²ã€‚

ç¶œåˆä»¥ä¸Šçš„ä¸‰å€‹é™åˆ¶ï¼Œæˆ‘åœ¨å¯¦ä½œä¸Šæ¡å–çš„æ–¹æ³•æ˜¯åœ¨ `CheckedWritePage` ä¸­ä½¿ç”¨ `std::unique_lock` ä¾†å–å¾— bpm çš„é–ï¼Œæ¥è‘—åœ¨å‰µå»º `WritePageGuard` å‰è§£é–ï¼Œç„¶å¾Œåœ¨ `WritePageGuard` çš„ constructor å–å¾— frame çš„é–ï¼Œæœ€å¾Œåœ¨ `Drop()` çš„æ™‚å€™å…ˆé‡‹æ”¾ frame çš„é–ï¼Œå†ä½¿ç”¨ bpm çš„é–æ›´æ–° frame çš„ metadataã€‚

æ¸¬è©¦é€™å€‹ task çš„æŒ‡ä»¤å¦‚ä¸‹ :

```bash
make page_guard_test -j$(nproc) && ./test/page_guard_test
```

```bash
make buffer_pool_manager_test -j$(nproc) && ./test/buffer_pool_manager_test
```

## Submit

```bash
make format && make check-format && make check-lint &&make check-clang-tidy-p1
```

```bash
make submit-p1
```

## Takeaways

ç¬¬ä¸€æ¬¡å¯«é€™å€‹ä½œæ¥­çš„æ™‚å€™é‚„æ˜¯ 2023 fall çš„ç‰ˆæœ¬ï¼Œæƒ³èªªæ”¹æˆ 2024 fall çš„ç‰ˆæœ¬æ‡‰è©²ä¸€å¤©å°±å¯ä»¥äº†ï¼Œçµæœç«Ÿç„¶èŠ±äº†ä¸€å€‹ç¦®æ‹œæ‰å¼„å®Œ ğŸ« 

ä¸»è¦æ˜¯å› ç‚ºæ–°å¢çš„ PageGuard å°è‡´å¯¦ä½œä¸Šè·ŸåŸæœ¬çš„å·®çš„æœ‰é»å¤šï¼Œä½†æˆ‘ç›¸ä¿¡é€™å€‹ class æ‡‰è©²æœƒè®“å¾Œé¢çš„ project å¯¦ä½œä¸Šæ›´ç°¡å–® (å§?)

## References

- [CMU 15445 2024 Fall Project 1 è®°å½•](https://zhuanlan.zhihu.com/p/1657237277)
- [CMU Fall 2024 15-445 P1&P2[ä¼˜åŒ– P2]](https://zhuanlan.zhihu.com/p/828933572)
- [CMU 15445 Project 1](https://4ever-xxxl.github.io/cmu-15445-project-1/)
- [CMU 15-445 2023 P1 ä¼˜åŒ–æ”»ç•¥](https://www.aneureka.com/posts/cmu-15445-p1-opt)
- [CMU15-445 2023 Fall Project0~4 é€šå…³æ€»ç»“](https://zhuanlan.zhihu.com/p/679980578)
