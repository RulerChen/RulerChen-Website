---
title: 'P4 - Concurrency Control'
sidebar_position: '104'
description: Concurrency Control
keywords: [CMU15-445/645, Concurrency Control, CMU15-445/645 ç­†è¨˜]
tags: [CMU15-445, CMU15-445 Projects]
---

<head>
  <title>CMU 15-445 2024Fall P4 Concurrency Control</title>
</head>

åœ¨é€™å€‹ project ä¸­ï¼Œæˆ‘å€‘éœ€è¦å¯¦ç¾ transaction è·Ÿ MVCCï¼Œç¸½å…±æœ‰ 4 å€‹ task è·Ÿ 2 å€‹ bonus :

- Timestamps
- Storage Format and Sequential Scan
- MVCC Executors
- Primary Key Index
- Abort
- Serializable Verification

## Background

åœ¨é–‹å§‹å¯¦ä½œä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦å…ˆäº†è§£ä¸€äº›è·Ÿé€™å€‹ project æœ‰é—œçš„ classï¼Œä¸»è¦æ˜¯é—œæ–¼ transaction è·Ÿ MVCC çš„éƒ¨åˆ†ã€‚

<ImageModal src="/img/cmu15-445/p4/transaction.webp" caption="Transaction Class" />

`TransactionManager` æ˜¯å…¨å±€çš„äº¤æ˜“ç®¡ç†å™¨ï¼Œè² è²¬å¦‚é–‹å§‹äº¤æ˜“ã€æäº¤äº¤æ˜“ã€å›æ»¾äº¤æ˜“ç­‰åŠŸèƒ½ï¼Œä¹Ÿè² è²¬ç®¡ç† id çš„åˆ†é…è·Ÿå›æ”¶ã€‚
è£¡é¢ä¸»è¦æœƒç”¨åˆ°çš„æˆå“¡åŒ…å«äº† `txn_map_`ã€`version_info_`ã€`watermark_` ç­‰ç­‰ã€‚
`txn_map_` ç”¨æ–¼è¨˜éŒ„æ‰€æœ‰çš„äº¤æ˜“ï¼Œ`version_info_` ç”¨æ–¼è¨˜éŒ„æ¯å€‹ tuple çš„ç‰ˆæœ¬è³‡è¨Šï¼Œ`watermark_` ç”¨æ–¼è¨˜éŒ„ç›®å‰æ‰€æœ‰æ´»èºäº¤æ˜“ä¸­æœ€å°çš„ `read_ts`ã€‚

`Transaction` é¡åˆ¥ä»£è¡¨ä¸€å€‹äº¤æ˜“ï¼ŒåŒ…å«äº¤æ˜“çš„ç‹€æ…‹ (RUNNINGã€TAINTEDã€COMMITTEDã€ABORTED)ã€éš”é›¢ç´šåˆ¥ (SI & Serializable)ã€é–‹å§‹æ™‚é–“æˆ³ (read_ts)ã€çµæŸæ™‚é–“æˆ³ (commit_ts) ç­‰è³‡è¨Šã€‚
æ¯å€‹äº¤æ˜“åœ¨é–‹å§‹æ™‚æœƒè¢«åˆ†é…ä¸€å€‹å”¯ä¸€çš„ `txn_id`ï¼Œä¸¦ä¸”æœƒæœ‰ `write_set_` è·Ÿ `scan_predicates_` æˆå“¡ï¼Œåˆ†åˆ¥ç”¨æ–¼è¨˜éŒ„è©²äº¤æ˜“æ‰€åšçš„å¯«å…¥æ“ä½œä»¥åŠæƒææ“ä½œã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œ`Transaction` é‚„æœƒç´€éŒ„å®ƒçš„æ¯ä¸€æ¢ `UndoLog`ï¼Œé€™å€‹ log ç”¨æ–¼æŸ¥çœ‹èˆŠç‰ˆæœ¬çš„ tupleã€‚

`UndoLog` åŒ…å«äº†ä»¥ä¸‹çš„è³‡è¨Š (**éå¸¸é‡è¦**) :

- `is_deleted_` : `bool`ï¼Œç”¨æ–¼æ¨™è¨˜å‰ä¸€å€‹ç‰ˆæœ¬çš„ tuple æ˜¯å¦è¢«åˆªé™¤ã€‚å¦‚æœæ“ä½œæ˜¯ INSERTï¼Œ`is_deleted_` å°±æœƒæ˜¯ trueï¼Œè¡¨ç¤ºä¸Šä¸€å€‹ç‰ˆæœ¬ä¸å­˜åœ¨
- `modified_fields_` : `vector<bool>`ï¼Œç”¨æ–¼æ¨™è¨˜å“ªäº›æ¬„ä½è¢«ä¿®æ”¹éã€‚å‡å¦‚æœ‰ 3 å€‹æ¬„ä½ï¼Œ`modified_fields_` å¯èƒ½æœƒæ˜¯ `[true, false, true]`ï¼Œè¡¨ç¤ºç¬¬ 0 è·Ÿç¬¬ 2 å€‹æ¬„ä½è¢«ä¿®æ”¹é
- `tuple_` : `Tuple`ï¼Œç´€éŒ„ä¸Šä¸€å€‹ç‰ˆæœ¬çš„ tupleï¼Œå…§å®¹æœƒä¾æ“š `modified_fields_` ä¾†æ±ºå®šæœ‰å“ªäº›æ¬„ä½ã€‚å‡å¦‚ `modified_fields_` æ˜¯ `[true, false, true]`ï¼Œé‚£ `tuple_` åªæœƒåŒ…å«ç¬¬ 0 è·Ÿç¬¬ 2 å€‹æ¬„ä½çš„å€¼
- `ts_` : `timestamp_t`ï¼Œå‰µå»ºé€™å€‹ log çš„ transaction çš„ commit timestamp
- `prev_version_` : `UndoLink`ï¼ŒæŒ‡å‘å‰ä¸€å€‹ç‰ˆæœ¬çš„ `UndoLog`ã€‚`UndoLink` åŒ…å«äº† `prev_txn_` (`txn_id`) è·Ÿ `prev_log_idx_`ï¼Œè¡¨ç¤ºé€™å€‹ log çš„ä¸Šä¸€ç‰ˆæ˜¯ç”±é‚£å€‹ transaction çš„ç¬¬å¹¾æ¢ `UndoLog` æ‰€å‰µå»ºçš„

## Task 1 - Timestamps

### Task 1.1 Timestamp Allocation

é€™å€‹ task ä¸»è¦æ˜¯è¦ç†è§£ timestamp çš„åˆ†é…æ–¹å¼ã€‚

æ¯ä¸€å€‹äº¤æ˜“éƒ½æœ‰å…©å€‹ timestampï¼Œ`read_ts` è·Ÿ `commit_ts`ã€‚
åœ¨äº¤æ˜“é–‹å§‹æ™‚ï¼Œæœƒåˆ†é…ä¸€å€‹ `read_ts`ï¼Œé€™å€‹ timestamp æ˜¯ç›®å‰å·²æäº¤çš„æœ€å¤§ timestampã€‚
åœ¨äº¤æ˜“æäº¤æ™‚ï¼Œæœƒåˆ†é…ä¸€å€‹ `commit_ts`ï¼Œé€™å€‹ timestamp æ˜¯ç›®å‰å·²æäº¤çš„æœ€å¤§ timestamp åŠ ä¸€ã€‚

ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœä¸€å€‹äº¤æ˜“çš„ `read_ts` æ˜¯ 5ï¼Œé‚£éº¼å®ƒåªèƒ½çœ‹åˆ° `commit_ts` å°æ–¼ç­‰æ–¼ 5 çš„ç‰ˆæœ¬ã€‚

æˆ‘å€‘è¦åšçš„äº‹æƒ…å°±æ˜¯æŠŠé€™äº›é‚è¼¯åŠ åˆ° `TransactionManager::Begin` è·Ÿ `TransactionManager::Commit` è£¡é¢ã€‚

### Task 1.2 Watermark

Watermark ä¸»è¦æ˜¯ç”¨ä¾†è¿½è¹¤æ‰€æœ‰é‚„æ²’ Abort æˆ– Commit çš„äº¤æ˜“ä¸­ï¼Œæœ€å°çš„ `read_ts`ï¼Œå¦‚æœæ²’æœ‰ä»»ä½•äº¤æ˜“åœ¨åŸ·è¡Œï¼Œwatermark å°±æœƒæ˜¯ `commit_ts`ã€‚

é€™å€‹ class ä¸»è¦æ˜¯è¨­è¨ˆç”¨ä¾†å¹«åŠ© task 3.5 çš„ garbage collectionï¼Œç•¶æˆ‘å€‘è¦å›æ”¶èˆŠç‰ˆæœ¬æ™‚ï¼Œwatermark å¯ä»¥å‘Šè¨´æˆ‘å€‘é‚£äº›ç‰ˆæœ¬å·²ç¶“ä¸æœƒå†è¢«ä»»ä½•äº¤æ˜“ä½¿ç”¨äº†ã€‚

é€™è£¡æˆ‘ä½¿ç”¨äº†æœ€ç°¡å–®çš„ $O(log(n))$ çš„æ–¹æ³•ä¾†å¯¦ä½œï¼Œå°±æ˜¯æŠŠå„²å­˜çš„æ–¹å¼æ”¹æˆ `std::map`ã€‚

## Task 2 - Storage Format and Sequential Scan

### Task 2.1 - Tuple Reconstruction

é€™å€‹ task çš„ç›®æ¨™æ˜¯å¯¦ä½œ `ReconstructTuple`ã€‚
é€™å€‹å‡½æ•¸æ˜¯æ ¹æ“š tuple ç¾åœ¨çš„æƒ…æ³è·Ÿ `UndoLog` ä¾†é‚„åŸå‡ºäº¤æ˜“é–‹å§‹æ™‚çš„ tupleã€‚

æˆ‘èªç‚ºéœ€è¦æ³¨æ„çš„æ˜¯ `UndoLog` çš„é †åºæ˜¯å¾æ–°åˆ°èˆŠï¼Œä»¥åŠ `is_deleted_` ä»£è¡¨çš„æ˜¯ä¸Šä¸€å€‹ç‰ˆæœ¬çš„ tuple æ˜¯å¦è¢«åˆªé™¤ã€‚

é€™è£¡æˆ‘çš„å¯¦ä½œé †åºå¦‚ä¸‹ :

1. æª¢æŸ¥ `undo_logs` æ˜¯å¦ç‚ºç©ºï¼Œå¦‚æœæ˜¯ç©ºçš„ä¸”æ²’æœ‰è¢«åˆªé™¤ï¼Œç›´æ¥å›å‚³ç•¶å‰çš„ tuple
2. æ‰¾åˆ°æœ€å¾Œä¸€å€‹ `is_deleted_` ç‚º true çš„ logï¼Œé€™ä»£è¡¨å¾ index 0 åˆ°é€™å€‹ log çš„ tuple éƒ½æ²’æœ‰ç”¨ï¼Œå¦‚æœé€™æ˜¯æœ€å¾Œä¸€å€‹ logï¼Œä»£è¡¨é€™å€‹ tuple æ˜¯è¢«åˆªé™¤çš„ï¼Œç›´æ¥å›å‚³ `std::nullopt`
3. å¾ä¸‹ä¸€å€‹ log é–‹å§‹ï¼Œä¾åºæŠŠ `modified_fields_` ç‚º true çš„æ¬„ä½å¾ `undo_logs` è¤‡è£½åˆ° `tuple` ä¸Š
4. å¦‚æœé‚„æ˜¯é€™å€‹æ¬„ä½å¾©åŸåˆ°æœ€å¾Œéƒ½æ²’æœ‰å€¼ï¼Œç›´æ¥å¡« `base_tuple` ä¸Šçš„å€¼ (é€™ä»£è¡¨ä¸­é–“éƒ½æ²’æœ‰ `is_deleted_` ç‚º true ä¹Ÿæ²’æœ‰è¢«ä¿®æ”¹é)

### Task 2.2 - Sequential Scan (Tuple Retrieval)

é€™å€‹ task æ˜¯è¦æ­é… `ReconstructTuple` ä¾†å¯¦ä½œ `CollectUndoLogs` ä¸¦ä¸”æŠŠ project 3 è£¡é¢çš„ `SeqScanExecutor` æ”¹æˆæ”¯æ´ MVCCã€‚

é€™é‚Šéœ€è¦å…ˆç†è§£ä¸€ä¸‹ bustub çš„ timestamp åˆ†é…æ–¹å¼ã€‚
timestamp åˆ†ç‚ºå…©ç¨®ï¼Œä¸€ç¨®æ˜¯ commit éå¾Œçš„ timestamp (`ts < TXN_START_ID`)ï¼Œå¦ä¸€ç¨®æ˜¯é‚„æ²’ commit çš„ timestamp (`ts >= TXN_START_ID`)ï¼Œé‚„æ²’ commit çš„å¯ä»¥ç”¨ `GetTransactionTempTs()` ä¾†å–å¾—ã€‚

`CollectUndoLogs` çš„å¯¦ä½œé‚è¼¯å¾ˆç°¡å–®ï¼Œå°±æ˜¯å¾æœ€æ–°çš„ `UndoLog` é–‹å§‹å¾€å‰æ‰¾ï¼Œç›´åˆ°è’é›†å¥½æ‰€æœ‰è¦å›æ»¾çš„ log å³å¯ã€‚
å¯è¦‹æ€§åˆ¤æ–·é‚è¼¯é™¤äº†è¦ `GetReadTs() >= ts` ä¹‹å¤–ï¼Œé‚„è¦è€ƒæ…®åˆ°æ˜¯ä¸æ˜¯è‡ªå·±ä¿®æ”¹éçš„ `GetTransactionTempTs() == ts`ã€‚

æ¥è‘—å›åˆ° `SeqScanExecutor`ï¼Œé€™é‚Šçš„å¯¦ä½œé‚è¼¯ä¹Ÿæ¯”è¼ƒç°¡å–®ï¼Œå°±æ˜¯æŠŠ `CollectUndoLogs` è·Ÿ `ReconstructTuple` ä¸²èµ·ä¾†å³å¯ï¼Œæ‹¿ metadata çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ `GetTupleAndUndoLink()`ã€‚

## Task 3 - MVCC Executors

### Task 3.1 - Insert Executor

ä¸€æ¨£æ˜¯ä¿®æ”¹ project 3 è£¡é¢çš„ `InsertExecutor`ï¼Œä¸»è¦ä¿®æ”¹çš„åœ°æ–¹å°±æ˜¯ timestamp è·Ÿä½¿ç”¨ `AppendWriteSet()` ä¾†æŠŠæœ‰ä¿®æ”¹çš„ RID åŠ å…¥åˆ° `write_set_` è£¡é¢ã€‚

ç”±æ–¼ insert æ˜¯æ’å…¥åˆ°æ–°çš„ RIDï¼Œæ‰€ä»¥ä¸éœ€è¦ç”Ÿæˆ `UndoLog`ã€‚

### Task 3.2 - Commit

è·Ÿè‘—ä½œæ¥­èªªæ˜åšå°±å¥½ï¼Œä¸»è¦å°±æ˜¯åœ¨ `Commit` è£¡é¢éæ­· `write_set_`ï¼Œç„¶å¾Œæ›´æ–° timestampã€‚

é™¤æ­¤ä¹‹å¤–èªªæ˜è£¡é¢é‚„æœ‰èªªå¯ä»¥è‡ªå·±å¯¦ç¾ä¸€å€‹ `TxnMgrDbg`ï¼Œæˆ‘å€‹äººè¦ºå¾—é€™å€‹æ±è¥¿é‚„è »æœ‰ç”¨çš„ï¼Œä½†å¯«èµ·ä¾†ä¹Ÿæ˜¯å¾ˆéº»ç…©ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥ä¸Ÿçµ¦ AI äº†...

### Task 3.3 - Generate Undo Log

å¯¦ä½œ `GenerateNewUndoLog` è·Ÿ `GenerateUpdatedUndoLog`ï¼Œé€™å…©å€‹å‡½æ•¸å…§å®¹ä¸è¤‡é›œï¼Œå¯ä»¥åˆ†æˆ insertã€ deleteã€ update ä¸‰ç¨®æƒ…æ³ä¾†è™•ç†ã€‚

- Insert : å‚³å…¥çš„ `base_tuple` æ˜¯ç©ºçš„ï¼Œå›å‚³ä¸€å€‹ `is_deleted_=true` çš„ `UndoLog`
- Delete : å‚³å…¥çš„ `target_tuple` æ˜¯ç©ºçš„ï¼Œå›å‚³ `is_deleted_=false` ä¸¦ä¸”éœ€è¦ä¿®æ”¹ `modified_fields_` è·Ÿ `tuple_`
- Update : å›å‚³ `is_deleted_=false`ï¼Œä¸¦è·Ÿæ“š `target_tuple` è·Ÿ `base_tuple` ä¾†æ±ºå®š `modified_fields_` è·Ÿ `tuple_`

å…¶ä»–çš„éƒ¨åˆ†å°±ç…§è‘—ä½œæ¥­èªªæ˜åšå°±å¥½ï¼Œä¸»è¦å°±æ˜¯è¦æŠŠ tuple æ‹¼èµ·ä¾†æœ‰é»éº»ç…©ã€‚

### Task 3.4 - Update & Delete Executor

é€™è£¡ä¸€æ¨£æ˜¯ä¿®æ”¹ project 3 è£¡é¢çš„ `UpdateExecutor` è·Ÿ `DeleteExecutor`ï¼Œä¸»è¦å°±æ˜¯ä½¿ç”¨ task 3.3 è£¡é¢çš„ `GenerateUpdatedUndoLog` è·Ÿ `GenerateNewUndoLog` ä¾†ç”Ÿæˆè·Ÿä¿®æ”¹ `UndoLog`ï¼Œä¸¦ä¸”æŠŠæœ‰ä¿®æ”¹çš„ RID åŠ å…¥åˆ° `write_set_` è£¡é¢ã€‚

é€™éƒ¨åˆ†éƒ½é‚„å…ˆä¸ç”¨ç†æœ‰é—œ index çš„éƒ¨åˆ†ï¼Œä½†éœ€è¦æª¢æŸ¥ WW è¡çªã€‚
æœ‰å…©ç¨®æƒ…æ³ï¼Œç¬¬ä¸€ç¨®æ˜¯ `meta.ts_ > TXN_START_ID && meta.ts_ != txn->GetTransactionTempTs()`ï¼Œé€™ä»£è¡¨é€™å€‹ tuple å·²ç¶“è¢«å…¶ä»–æœªæäº¤çš„äº¤æ˜“ä¿®æ”¹éäº†ã€‚
ç¬¬äºŒç¨®æ˜¯ `meta.ts_ < TXN_START_ID && meta.ts_ > txn->GetReadTs()`ï¼Œé€™ä»£è¡¨é€™å€‹ tuple å·²ç¶“è¢«å…¶ä»–å·²æäº¤ä¸”æ›´æ™šçš„äº¤æ˜“ä¿®æ”¹éäº†ã€‚

### Task 3.5 - Stop-the-world Garbage Collection

ç‚ºäº†é™ä½ä½µç™¼çš„è¤‡é›œåº¦ï¼Œbustub æ¡ç”¨çš„æ˜¯ stop-the-world çš„åƒåœ¾å›æ”¶æ©Ÿåˆ¶ï¼Œåªæœƒåœ¨æ‰€æœ‰äº¤æ˜“éƒ½çµæŸå¾Œæ‰æœƒé€²è¡Œåƒåœ¾å›æ”¶ã€‚

é€™å€‹ task æœƒçµåˆæˆ‘å€‘åœ¨ task 1.2 å¯¦ä½œçš„ watermarkï¼Œé€™è£¡æˆ‘è‡ªå·±åˆ†æˆä¸‰å€‹æ­¥é©Ÿ :

- éæ­· `txn_map_` è·Ÿ `write_set_`ï¼ŒæŠŠå·²ç¶“ commit æˆ– abort çš„äº¤æ˜“ä¸­æœ‰ä¿®æ”¹éçš„ RID å…¨éƒ¨è’é›†èµ·ä¾†ï¼Œå»ºç«‹ä¸€å€‹ `unordered_map<txn_id_t, unordered_map<table_oid_t, unordered_set<RID>>>` çš„æ˜ å°„
- ç´€éŒ„ä¸èƒ½è¢«åˆªé™¤çš„ txn (`unordered_set`)ï¼Œæª¢æŸ¥ `watermark <= meta.ts_`ï¼Œå¦‚æœæ˜¯çš„è©±å°±æŠŠé€™å€‹ txn åŠ å…¥åˆ°ä¸å¯åˆªé™¤çš„é›†åˆè£¡é¢ï¼Œæ¥è‘—å†éæ­·é€™å€‹ RID çš„ `UndoLog` æ‰¾å‡º `watermark <= undo_log->ts_` çš„ä¹ŸåŠ å…¥ä¸å¯åˆªé™¤çš„é›†åˆ
- æœ€å¾Œéæ­· `txn_map_`ï¼Œå¦‚æœæ˜¯ COMMITTED æˆ– ABORTED ç„¶å¾Œåˆä¸åœ¨ä¸å¯åˆªé™¤çš„ txn è£¡é¢ï¼Œå°±å¯ä»¥æŠŠé€™å€‹ txn åˆªæ‰

## Task 4 - Primary Key Index

### Task 4.1 - Index Insert

é€™å€‹ task ä¸»è¦ç›®æ¨™æ˜¯è®“ Insert æ“ä½œå¯ä»¥åœ¨ä½µç™¼ç’°å¢ƒä¸‹æ­£ç¢ºçš„è™•ç†ä¸»éµçš„è¡çªã€‚

å¯ä»¥å…ˆé€é `index_info->index_->GetMetadata()->IsPrimaryKey()` æ‹¿åˆ° primary key index çš„è³‡è¨Šï¼Œæ¥è‘—åœ¨è®€è³‡æ–™çš„æ™‚å€™å…ˆæª¢æŸ¥é€™å€‹ key æ˜¯ä¸æ˜¯å·²ç¶“å­˜åœ¨äº†ï¼Œå¦‚æœå­˜åœ¨å°±æŠŠç‹€æ…‹æ”¹æˆ TAINTED ä¸¦æ‹‹éŒ¯å³å¯ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé‚£å°±å¸¶è‘—è‡¨æ™‚çš„ timestamp ç›´æ¥æ’å…¥ï¼Œä¸¦ä¸”å‘¼å« `InsertEntry()` ä¾†æ’å…¥ indexã€‚

ä¹Ÿè¦æ³¨æ„è™•ç† `InsertEntry()` å›å‚³ false çš„æƒ…æ³ï¼Œé€™ä»£è¡¨æœ‰å…¶ä»–äº¤æ˜“å·²ç¶“æ’å…¥äº†ç›¸åŒçš„ keyï¼Œè™•ç†æ–¹å¼è·Ÿå‰é¢ä¸€æ¨£ã€‚

### Task 4.2 - Index Scan, Delete, & Update

é€™å€‹ task ä¸»è¦æ˜¯è®“æ‰€æœ‰çš„æ“ä½œéƒ½èƒ½æ”¯æŒ MVCC (åŒ…æ‹¬ Index Scanã€Deleteã€Updateã€Insert)ã€‚

ç‚ºäº†è®“ç´¢å¼•å¯ä»¥æ”¯æ´éå»çš„è³‡æ–™ï¼Œbustub è¦å®šç´¢å¼•ä¸€æ—¦è¢«å‰µå»ºå°±æ°¸é ä¸æœƒè¢«ç‰©ç†åˆªé™¤ï¼Œæ‰€ä»¥é€™å€‹ task éœ€è¦ä¿®æ”¹æ‰€æœ‰çš„ executorsã€‚

é¦–å…ˆï¼Œåœ¨ project 3 ä¸­çš„ `DeleteExecutor` éœ€è¦æŠŠ `TupleMeta` çš„ `is_deleted_` æ”¹æˆ trueï¼Œä¸¦ä¸”è¦æŠŠç´¢å¼•ä¹Ÿåˆªæ‰ã€‚
è€Œç¾åœ¨éœ€è¦æŠŠåˆªé™¤ç´¢å¼•çš„é‚£éƒ¨åˆ†å®Œå…¨ç§»é™¤ï¼Œåªéœ€è¦æŠŠ `TupleMeta` çš„ `is_deleted_` æ”¹æˆ true å³å¯ã€‚

æ¥è‘—æ˜¯ INSERT çš„éƒ¨åˆ†ï¼Œåœ¨ task 4.1 ä¸­æˆ‘å€‘æœ‰æåˆ°è¦å…ˆæª¢æŸ¥ä¸»éµæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è¦æŠŠç‹€æ…‹æ”¹æˆ TAINTED ä¸¦æ‹‹éŒ¯ã€‚
è€Œç¾åœ¨éœ€è¦æ”¹æˆå¦‚æœé€™å€‹éµå­˜åœ¨ä¸”æ²’æœ‰è¢«åˆªé™¤ (`meta.is_deleted_ == false`)ï¼Œæ‰æŠŠç‹€æ…‹æ”¹æˆ TAINTED ä¸¦æ‹‹éŒ¯ï¼Œå¦‚æœé€™å€‹éµå­˜åœ¨ä½†è¢«åˆªé™¤ (`meta.is_deleted_ == true`)ï¼Œå°±å¯ä»¥ç›´æ¥ reuse é€™å€‹ RIDã€‚

Index scan çš„éƒ¨åˆ†å¯ä»¥åƒè€ƒ task 2.2 çš„ `SeqScanExecutor` ä¾†å¯¦ä½œï¼Œå·®åˆ¥åœ¨æ–¼è¦å…ˆå¾ index è£¡é¢å–å¾— RIDï¼Œä¹Ÿæ˜¯ä¸€æ¨£ä½¿ç”¨ `CollectUndoLogs` è·Ÿ `ReconstructTuple` ä¾†é‚„åŸ tupleã€‚

é™¤äº†ä¸Šé¢é€™å¹¾å€‹ executors ä¹‹å¤–ï¼Œæˆ‘å€‘é‚„éœ€è¦å¯¦ä½œ `UpdateTupleAndUndoLink()` è£¡é¢çš„ check å‡½æ•¸ä¾†é¿å… race condition çš„æƒ…æ³ã€‚
ç”±æ–¼åœ¨åŸ·è¡Œ `UpdateTupleAndUndoLink()` ä¹‹å‰ï¼Œæˆ‘å€‘æ‡‰è©²å·²ç¶“æª¢æŸ¥é WW è¡çªäº† (by task 3.4)ï¼Œæ‰€ä»¥é€™è£¡åªè¦æª¢æŸ¥ `meta.ts_ == ts` å³å¯ã€‚

### Task 4.3 - Primary Key Updates

é€™å€‹ task ä¸»è¦æ˜¯è¦è™•ç† UPDATE æ“ä½œï¼Œé‡å° primary key è¢«ä¿®æ”¹çš„æƒ…æ³ã€‚

é€™è£¡çš„é‚è¼¯å…¶å¯¦è »å¤šçš„ï¼Œä½†æ˜¯ç¸½é«”ä¾†èªªå¯ä»¥æ‹†æˆä¸€æ¬¡åˆªé™¤è·Ÿä¸€æ¬¡æ’å…¥ä¾†è™•ç†ï¼Œå…·é«”å¯¦ä½œè·Ÿ task 4.2 çš„ INSERT è·Ÿ DELETE å·®ä¸å¤šã€‚

## Bonus 1 - Abort

ç”±æ–¼å¦‚æœäº¤æ˜“å¤±æ•—çš„è©±ï¼Œå°±æ²’æœ‰å…¶ä»–äº¤æ˜“å¯ä»¥ç¹¼çºŒä¿®æ”¹é€™å€‹ tuple äº†ï¼Œæ‰€ä»¥æˆ‘å€‘åªéœ€è¦é—œå¿ƒè¢«ä¿®æ”¹éå¾Œçš„ tuple æœ€å¾Œä¸€æ¬¡çš„ç‹€æ…‹å³å¯ã€‚

é€™è£¡æˆ‘é¸æ“‡çš„æ˜¯ Implementation #2 çš„åšæ³•ï¼Œæœ‰ä¸‰ç¨®æƒ…æ³ :

- å¦‚æœæ²’æœ‰ `UndoLink`ï¼Œä»£è¡¨é€™å€‹ tuple æ˜¯è¢« insert çš„ï¼Œç›´æ¥æ’å…¥ `TupleMeta{0, true}` å³å¯
- å¦‚æœæœ‰ `UndoLink`ï¼Œä»£è¡¨é€™å€‹ tuple æ˜¯è¢« update æˆ– delete çš„
  - å¦‚æœ `ReconstructTuple` å›å‚³ç©ºçš„ optionalï¼Œä»£è¡¨é€™å€‹ tuple æ˜¯è¢« delete çš„ï¼Œæ›´æ–°ç‚º `TupleMeta{undo_log.ts_, true}` å³å¯
  - å¦‚æœ `ReconstructTuple` å›å‚³æœ‰å€¼ï¼Œä»£è¡¨é€™å€‹ tuple æ˜¯è¢« update çš„ï¼Œæ›´æ–°ç‚º `TupleMeta{undo_log.ts_, false}` å³å¯

## Bonus 2 - Serializable Verification

ç‚ºäº†å¯¦ç¾å¯åºåˆ—åŒ–ï¼Œæˆ‘å€‘éœ€è¦åœ¨ index scan è·Ÿ seq scan çš„æ™‚å€™æŠŠ predicate åŠ å…¥åˆ° `scan_predicates_` è£¡é¢ã€‚

å¯¦ç¾çš„é‚è¼¯å¦‚ä¸‹ :

1. è·³éåªè®€äº¤æ˜“
2. æ”¶é›†è¡çªäº¤æ˜“ (commit_ts > æœ¬ txn çš„ read_ts)
3. å°æ¯å€‹è¡çªäº¤æ˜“çš„æ¯å€‹ table çš„å¯«é›†åˆåšæª¢æŸ¥ï¼Œä¸¦çœ‹çœ‹å®ƒæ˜¯å¦æœ‰è·Ÿç•¶å‰äº¤æ˜“æƒæéçš„ predicate æœ‰äº¤é›† (åŒä¸€å€‹ `table_oid_t`)
4. å°è¡çªäº¤æ˜“ä¿®æ”¹çš„æ¯å€‹ RIDï¼Œå–å¾—åˆ° read_ts æ™‚çš„æ‰€æœ‰ `UndoLog`
5. æ¥è‘—å°±å¯ä»¥å˜—è©¦å°é€™å€‹ RID ä¸æ–·ç”¨ `ReconstructTuple` ä¾†é‚„åŸ tuple ä¸¦æ¸¬è©¦æ˜¯å¦åœ¨ predicate çš„ç¯„åœå…§

## Submit

```bash
make txn_timestamp_test -j$(nproc) && ./test/txn_timestamp_test

make txn_scan_test -j$(nproc) && ./test/txn_scan_test

make txn_executor_test -j$(nproc) && ./test/txn_executor_test

make txn_index_test -j$(nproc) && ./test/txn_index_test

make txn_index_concurrent_test -j$(nproc) && ./test/txn_index_concurrent_test

make txn_abort_serializable_test -j$(nproc) && ./test/txn_abort_serializable_test
```

```bash
make format && make check-format && make check-lint && make check-clang-tidy-p4
```

```bash
make submit-p4
```

## Takeaways

çµ‚æ–¼å¯«å®Œå…¨éƒ¨çš„ç­†è¨˜å•¦~ ç‘èŠ± ğŸ‰

é€™å€‹ project æ˜¯æˆ‘èŠ±æœ€ä¹…æ™‚é–“çš„ä¸€å€‹ï¼Œæˆ‘è¦ºå¾—ä¸»è¦åŸå› æ˜¯å¾ˆé›£æ‰¾åˆ° bug åœ¨å“ªï¼Œå³ä½¿ç¾åœ¨äº¤åˆ° gradescope å¯ä»¥å…¨éæˆ‘ä¾ç„¶è¦ºå¾—æˆ‘çš„å¾ˆå¤šå¯¦ç¾ç†è«–ä¸Šæ‡‰è©²è¦æœ‰å•é¡Œæ‰å°ï¼Œä½†åæ­£æ¸¬è³‡çœ‹ä¸åˆ°æˆ‘ä¹Ÿç•¶çœ‹ä¸åˆ°å¥½äº† ğŸ«£

ç¸½é«”ä¾†èªªé€™æ¬¡çš„ project å°±æ˜¯ä¸€å€‹ä¸æ–·é‡æ§‹çš„éç¨‹ï¼Œé™¤äº†è¦å›æ†¶ project #3 çš„å…§å®¹ä¹‹å¤–ï¼Œç”šè‡³åœ¨åŒä¸€å€‹ task è£¡é¢ä¹Ÿæœƒä¸æ–·çš„é‡æ§‹ï¼Œåƒæ˜¯ task 4 å°±æ˜¯ä¸æ–·çš„é‡æ”¹åˆé‡æ”¹ï¼ŒçœŸçš„æ˜¯æœ‰ä¸€é»ç…©ã€‚
ä¸éé€™æ¬¡çš„å¯¦ä½œä¾ç„¶è®“æˆ‘å° MVCC çš„æ•´é«”æ¦‚å¿µæœ‰æ¯”è¼ƒå¥½çš„ç†è§£ï¼Œæ”¶ç©«é‚„ç®—æ˜¯æ»¿å¤§çš„ã€‚

## References

- [CMU Fall 2024 15-445 MVCC & SI & P4[å¾…å®Œ]](https://zhuanlan.zhihu.com/p/10666804837)
- [CMU 15445 Project4](https://4ever-xxxl.github.io/cmu-15445-project-4/)
- [CMU15445-2024fall-project4è¸©å‘ç»å†](https://zhuanlan.zhihu.com/p/1932549868683007217)
