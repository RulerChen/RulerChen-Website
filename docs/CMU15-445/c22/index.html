<!doctype html>
<html lang="zh-Hant" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CMU15-445/c22" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">CMU 15-445/645 筆記 Distributed OLTP Database Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" name="twitter:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" property="og:url" content="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c22/"><meta data-rh="true" property="og:locale" content="zh_Hant"><meta data-rh="true" name="docusaurus_locale" content="zh-Hant"><meta data-rh="true" name="docsearch:language" content="zh-Hant"><meta data-rh="true" name="google-site-verification" content="QrdRbPEcOsJJ_kfRVewqfwR6GjPcRf0UVgRb85I-5fc"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Distributed OLTP Database Systems | RulerChen"><meta data-rh="true" name="description" content="CMU15-445/645 Distributed OLTP Database Systems"><meta data-rh="true" property="og:description" content="CMU15-445/645 Distributed OLTP Database Systems"><meta data-rh="true" name="keywords" content="CMU15-445/645,Distributed OLTP Database Systems,CMU15-445/645 筆記"><link data-rh="true" rel="icon" href="/RulerChen-Website/img/profile.png"><link data-rh="true" rel="canonical" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c22/"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c22/" hreflang="zh-Hant"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c22/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GSV9DQB5UM-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/RulerChen-Website/blog/rss.xml" title="RulerChen RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/RulerChen-Website/blog/atom.xml" title="RulerChen Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="RulerChen" href="/RulerChen-Website/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/RulerChen-Website/assets/css/styles.4025f7b4.css">
<script src="/RulerChen-Website/assets/js/runtime~main.76f95922.js" defer="defer"></script>
<script src="/RulerChen-Website/assets/js/main.98db364d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/RulerChen-Website/"><div class="navbar__logo"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/RulerChen-Website/docs/intro/">Notes</a><a class="navbar__item navbar__link" href="/RulerChen-Website/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/RulerChen" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.linkedin.com/in/rulerchen/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Linkdin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜尋"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜尋</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/RulerChen-Website/docs/intro/">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Algorithm/KMP/">Algorithm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Database/pg-tuning/">Database</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/SystemDesign/cdn/">System Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/NodeJs/expresssetup/">Node.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Next.js/EslintPrettier/">Next.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Security/log4j/">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/RulerChen-Website/docs/CMU15-445/c01/">CMU15-445/645 Database Systems</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c01/">Relational Model &amp; Algebra</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c02/">Modern SQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c03/">Database Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c05/">Storage Models &amp; Compression</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c06/">Memory &amp; Disk I/O Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c07/">Hash Tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c08/">Trees Indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c09/">Index Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c10/">Sorting &amp; Aggregations Algorithms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c11/">Joins Algorithms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c12/">Query Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c14/">Query Planning &amp; Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c15/">Concurrency Control Theory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c16/">Two-Phase Locking Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c17/">Timestamp Ordering Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c18/">Multi-Version Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c19/">Database Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c20/">Database Recovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c21/">Introduction to Distributed Databases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c22/">Distributed OLTP Database Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c23/">Distributed OLAP Database Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p0/">P0 - C++ Primer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p1/">P1 - Buffer Pool Manager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p2/">P2 - Hash Index</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p3/">P3 - Query Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p4/">P4 - Concurrency Control</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/RulerChen-Website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">CMU15-445/645 Database Systems</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Distributed OLTP Database Systems</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>Distributed OLTP Database Systems</h1></header>
<p>在上節中，我們討論了基本的分散式資料庫系統，但仍然有很多細節沒有討論到，這節會討論一些分散式 OLTP 系統的細節，像是 :</p>
<ul>
<li>如果其中有節點發生故障怎麼處理</li>
<li>如果訊息在網路上延遲怎麼處理</li>
<li>是否需要所有節點都同意才能 commit 一個 transaction</li>
</ul>
<p>我們要假設所有的節點都是可信任的，不然就需要採用 Byzantine Fault Tolerance 的方法 (blockchain)。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replication">Replication<a class="hash-link" aria-label="Replication的直接連結" title="Replication的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#replication">​</a></h2>
<p>DBMS 可以將資料複製到多個節點上以及高可用性，在實現上，有幾個重要的考慮因素 :</p>
<ul>
<li>Replication Configuration</li>
<li>Propagation Scheme</li>
<li>Propagation Timing</li>
<li>Update Method</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="replication-configuration">Replication Configuration<a class="hash-link" aria-label="Replication Configuration的直接連結" title="Replication Configuration的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#replication-configuration">​</a></h3>
<p>主要可以分為兩種方式，Primary-Replica 和 Multi-Master。</p>
<p><img decoding="async" loading="lazy" alt="Replication" src="/RulerChen-Website/assets/images/image-51ca14fa6ae023a6796f4e3790543be9.png" width="958" height="536" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="primary-replica">Primary-Replica<a class="hash-link" aria-label="Primary-Replica的直接連結" title="Primary-Replica的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#primary-replica">​</a></h4>
<p>所有關於寫的操作都會先寫到 primary node， primary node 更新完後再通知其他 replica node 更新，而只讀的資料可以直接從 replica node 讀取。
如果 master 節點崩潰，則由共識算法選擇新的 master 節點。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="multi-master">Multi-Master<a class="hash-link" aria-label="Multi-Master的直接連結" title="Multi-Master的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#multi-master">​</a></h4>
<p>每個節點都可以更新資料，但節點之間需要透過 atomic commit protocol 來確保一致性。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="k-safety">K-safety<a class="hash-link" aria-label="K-safety的直接連結" title="K-safety的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#k-safety">​</a></h4>
<p>K-safety 是用來衡量資料庫的容錯能力的閾值，K 值表示每個物件必須始終可用的副本數量，如果副本數量低於這個閾值，DBMS 會停止系統。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="propagation-scheme">Propagation Scheme<a class="hash-link" aria-label="Propagation Scheme的直接連結" title="Propagation Scheme的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#propagation-scheme">​</a></h3>
<p>當交易在資料庫上提交時，DBMS 會決定是否需要等待該交易傳播到其他節點後再向應用程式客戶端發送確認，主要有兩種方式 :</p>
<ul>
<li>Synchronous Propagation : Strong Consistency</li>
<li>Asynchronous Propagation : Eventual Consistency</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Propagation Scheme" src="/RulerChen-Website/assets/images/image-2-2f3c9375a167b11c8e298a2c03e383c4.png" width="958" height="537" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="synchronous-propagation">Synchronous Propagation<a class="hash-link" aria-label="Synchronous Propagation的直接連結" title="Synchronous Propagation的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#synchronous-propagation">​</a></h4>
<p>主節點將更新發送到從節點，並等待它們確認已完全應用更改後，再通知客戶端更新成功。
確保了強一致性，不會丟失任何數據，通常在傳統的 DBMS 中使用。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="asynchronous-propagation">Asynchronous Propagation<a class="hash-link" aria-label="Asynchronous Propagation的直接連結" title="Asynchronous Propagation的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#asynchronous-propagation">​</a></h4>
<p>主節點在本地更新完後立即向應用程式返回確認，而不等待從節點更改完成。
可能會導致讀取過期數據，但如果可以容忍某些數據丟失，這種方式是一種有效的優化，通常在 NoSQL 系統中使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="propagation-timing">Propagation Timing<a class="hash-link" aria-label="Propagation Timing的直接連結" title="Propagation Timing的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#propagation-timing">​</a></h3>
<p>主節點甚麼時候將更新發送到從節點的策略，主要有兩種方式 :</p>
<ul>
<li>Continuous Propagation</li>
<li>On Commit Propagation</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="continuous-propagation">Continuous Propagation<a class="hash-link" aria-label="Continuous Propagation的直接連結" title="Continuous Propagation的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#continuous-propagation">​</a></h4>
<p>DBMS 在生成 log 後立即發送 log 給從節點，其中包括提交和中止消息。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="on-commit-propagation">On Commit Propagation<a class="hash-link" aria-label="On Commit Propagation的直接連結" title="On Commit Propagation的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#on-commit-propagation">​</a></h4>
<p>DBMS 只有在交易提交後才將該交易的 log 發送到從節點，避免了為 abort 的交易傳送 log，但會導致同步效率較低。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="active-vs-passive">Active vs Passive<a class="hash-link" aria-label="Active vs Passive的直接連結" title="Active vs Passive的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#active-vs-passive">​</a></h3>
<p>根據如何將更改應用到從節點上，複製可以分為 :</p>
<ul>
<li>Active-Active</li>
<li>Active-Passive</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="active-active">Active-Active<a class="hash-link" aria-label="Active-Active的直接連結" title="Active-Active的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#active-active">​</a></h4>
<p>交易在每個從節點上獨立執行，最後 DBMS 檢查每個節點上的結果是否一致，以確保交易正確提交。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="active-passive">Active-Passive<a class="hash-link" aria-label="Active-Passive的直接連結" title="Active-Passive的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#active-passive">​</a></h4>
<p>交易在一個節點上執行，然後將總體更改傳播到從節點。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="atomic-commit-protocols">Atomic Commit Protocols<a class="hash-link" aria-label="Atomic Commit Protocols的直接連結" title="Atomic Commit Protocols的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#atomic-commit-protocols">​</a></h2>
<p>當一個橫跨多個節點的交易完成時，DBMS 需要詢問所有參與的節點是否可以安全地提交交易。
根據所使用的協議，可能需要不同數量的節點同意才能提交交易，</p>
<p>常 見的協議包括 :</p>
<ul>
<li>Two-Phase Commit (2PC)</li>
<li>Three-Phase Commit (3PC)</li>
<li>Paxos</li>
<li>Raft</li>
<li>Zookeeper Atomic Broadcast (ZAB)</li>
<li>Viewstamped Replication</li>
</ul>
<p>本節主要討論 2PC 和 Paxos。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="two-phase-commit-2pc">Two-Phase Commit (2PC)<a class="hash-link" aria-label="Two-Phase Commit (2PC)的直接連結" title="Two-Phase Commit (2PC)的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#two-phase-commit-2pc">​</a></h3>
<p>2PC 是一個經典的分散式交易提交協議，分為兩個階段 :</p>
<ul>
<li>Prepare Phase</li>
<li>Commit Phase</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2pc-success">2PC Success<a class="hash-link" aria-label="2PC Success的直接連結" title="2PC Success的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#2pc-success">​</a></h4>
<p>首先應用程式會向協調者發送提交請求之後進入準備階段 (Prepare Phase)。</p>
<p>協調者向參與節點發送 prepare 請求，詢問它們是否可以提交當前交易</p>
<p><img decoding="async" loading="lazy" alt="2PC" src="/RulerChen-Website/assets/images/image-3-1cd801c54a457af6d563e0c7c2cb94d5.png" width="958" height="535" class="img_ev3q"></p>
<p>等待所有節點回覆 OK 後，則進入提交階段 (Commit Phase)。</p>
<p>協調者會向所有參與者發送提交消息，通知它們提交交易。</p>
<p><img decoding="async" loading="lazy" alt="2PC" src="/RulerChen-Website/assets/images/image-4-5f4000faf6aad0ca0253386442573f79.png" width="959" height="537" class="img_ev3q"></p>
<p>等待所有交易提交後，協調者向應用程式回覆提交成功。</p>
<p><img decoding="async" loading="lazy" alt="2PC" src="/RulerChen-Website/assets/images/image-5-514f26f78625e00570595b440401ad66.png" width="958" height="536" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2pc-abort">2PC Abort<a class="hash-link" aria-label="2PC Abort的直接連結" title="2PC Abort的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#2pc-abort">​</a></h4>
<p>在準備階段時，如果有任何一個節點無法執行，則應該回覆 ABORT 給協調者。</p>
<p><img decoding="async" loading="lazy" alt="2PC" src="/RulerChen-Website/assets/images/image-6-724046e719b6f1d9d42dc94408aeffaa.png" width="958" height="537" class="img_ev3q"></p>
<p>而此時協調者應該向應用程式回覆提交失敗，同時向所有參與者發送中止消息，並且確保所有交易都有回滾。</p>
<p><img decoding="async" loading="lazy" alt="2PC" src="/RulerChen-Website/assets/images/image-7-e6195ef49b3240c911b18f382b01cddf.png" width="959" height="536" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2pc-optimization">2PC Optimization<a class="hash-link" aria-label="2PC Optimization的直接連結" title="2PC Optimization的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#2pc-optimization">​</a></h4>
<ul>
<li>Early Prepare Voting (Rare): 如果 DBMS 發送的查詢已經是某個節點最後的查詢，該節點可以將查詢結果和準備階段的投票一起返回</li>
<li>Early Acknowledgement after Prepare (Common): 如果所有節點都在準備階段同意提交交易，協調者可以在提交階段完成前向客戶端發送成功確認</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2pc-fault-tolerance">2PC Fault Tolerance<a class="hash-link" aria-label="2PC Fault Tolerance的直接連結" title="2PC Fault Tolerance的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#2pc-fault-tolerance">​</a></h4>
<p>在 2PC 中，每個節點都需要保存每個階段輸入和輸出的 log 來幫助恢復。</p>
<p>在 recovery 時可能會有以下情況 :</p>
<ul>
<li>如果交易在準備階段，則連絡協調者確認最後的交易結果</li>
<li>如果交易不在準備狀態，則該交易立即中止，因為節點在崩潰之前並未達到準備狀態</li>
<li>如果交易正在提交且該節點是協  調者，會在重啟後向所有參與節點發送 COMMIT 消息，以完成交易提交</li>
</ul>
<p>如果是協調者在 commit 之前發生故障，則只需要等待協調者重啟後再次發送 COMMIT 消息即可，如果是在 commit 開始之後發生故障，則其他節點需要等待該節點重啟或者直接決定新的協調者。</p>
<p>如果是參與者在 commit 開始之前發生故障，則協調者只要依據超時機制將交易中止即可，如果是在 commit 開始之後發生故障，則協調者需要不斷重試來保證一致性。</p>
<p>由於 2PC 需要等待所有節點的回覆，可能會導致 live lock，因此有了共識算法。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="paxos">Paxos<a class="hash-link" aria-label="Paxos的直接連結" title="Paxos的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#paxos">​</a></h3>
<p>Paxos 是一種共識算法，在這個算法中，提議者會負責提交 commit 或 abort 的指令，而接受者則投票決定是否接受提議，由於不需要每個節點都同意，因此效能上會比 2PC 好。</p>
<p>Paxos 的協調者被稱為提議者 (Proposer)，參與者被稱為接受者 (Acceptor)。</p>
<p>首先，應用程式會向 proposer 發送提交請求，然後 proposer 會向 acceptor 發送提議</p>
<p><img decoding="async" loading="lazy" alt="Paxos" src="/RulerChen-Website/assets/images/image-8-e210e467a409aeda83d8f348ff857e6d.png" width="960" height="538" class="img_ev3q"></p>
<p>與 2PC 不同的是，Paxos 不需要等待所有節點的回覆，只需要等待過半數的節點同意即可，因此會繼續向 acceptor 發送 commit 請求。</p>
<p><img decoding="async" loading="lazy" alt="Paxos" src="/RulerChen-Website/assets/images/image-9-cd08efa859e20988afbe9a19bca5fadb.png" width="960" height="538" class="img_ev3q"></p>
<p>但不同的是，即使在 commit 階段，acceptor 也可以拒絕提議，舉例如下 :</p>
<p>假設有兩個 proposer，proposer 1 在 n 的時間提出協 議並被所有人 agree</p>
<p><img decoding="async" loading="lazy" alt="Paxos" src="/RulerChen-Website/assets/images/image-10-b9e66593cb10ee44f25c0bc9622063b0.png" width="958" height="539" class="img_ev3q"></p>
<p>這時候 proposer 2 在 n+1 的時間提出協議，接著 proposer 1 發出 commit 請求，由於時間先後順序，acceptor 會拒絕 proposer 1 的提議，之後 proposer 2 會繼續直到提交完成。</p>
<p><img decoding="async" loading="lazy" alt="Paxos" src="/RulerChen-Website/assets/images/image-11-fd00edc8fd7bb2332462357391baa112.png" width="958" height="537" class="img_ev3q"></p>
<p>這樣會導致的問題是有可能同時兩個 proposer 互相組塞，因此我們可以透過 Multi-Paxos 來解決這個問題。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="multi-paxos">Multi-Paxos<a class="hash-link" aria-label="Multi-Paxos的直接連結" title="Multi-Paxos的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#multi-paxos">​</a></h4>
<p>如果系統內常有任意數量的 proposer，達成共識就會有點困難，因此我們可以先透過 Paxos 選出一個主要的提議者，然後由主要提議者來進行提議，並在達到一定時間之後再重新選舉主要提議者。
這樣在一段時間內提交交易就不需要 propose 而是直接進行 commit，這樣就能提高效率。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consistency-issues-cap--pacelc">Consistency Issues (CAP / PACELC)<a class="hash-link" aria-label="Consistency Issues (CAP / PACELC)的直接連結" title="Consistency Issues (CAP / PACELC)的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#consistency-issues-cap--pacelc">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cap">CAP<a class="hash-link" aria-label="CAP的直接連結" title="CAP的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#cap">​</a></h3>
<p>CAP 定理指出一個分散式系統無法同時滿足以下三個條件 :</p>
<ul>
<li>一致性 (Consistency) : 對所有節點上的操作來說，一旦寫入完成，所有後續的讀取應該返回該寫入的值或更晚的寫入值</li>
<li>可用性 (Availability) : 可用性指的是所有仍在運行的節點都能滿足所有請求的能力。即使部分節點故障，仍然能夠提供服務</li>
<li>分區容錯性 (Partition Tolerance) : 分區容錯性意味著即使系統中部分節點間的消息丟失，系統仍能正確運行</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pacelc">PACELC<a class="hash-link" aria-label="PACELC的直接連結" title="PACELC的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#pacelc">​</a></h3>
<p>CAP 定理的現代版本是 PACELC 定理，這個定理進一步考慮了一致性和延遲之間的取捨。</p>
<ul>
<li>P (Partition)：當在網絡分區時，系統必須在可用性 (A) 和一致性 (C) 之間做出選擇。</li>
<li>EL (Else)：即使在系統運行正常且無網絡分區的情況下，也必須在延遲 (L) 和一致性 (C) 之間做出選擇。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cap-vs-pacelc">CAP vs PACELC<a class="hash-link" aria-label="CAP vs PACELC的直接連結" title="CAP vs PACELC的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#cap-vs-pacelc">​</a></h3>
<p>在 RDBMS 中，通常會在重要節點故障時拒絕寫入，以確保一致性，而在 NoSQL 中，通常會接受寫入，常採用的策略是最後一次寫入勝出。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="google-spanner">Google Spanner<a class="hash-link" aria-label="Google Spanner的直接連結" title="Google Spanner的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#google-spanner">​</a></h2>
<p>Google Spanner 是一個由 google 發明的資料庫系統，具有以下特點 :</p>
<ul>
<li>semi-relational data model、Decentralized shared-disk architecture 以及 Log-structured on-disk storage</li>
<li>Strict 2PL + MVCC + Multi-Paxos + 2PC</li>
<li>Externally consistent : Spanner 保證  事務具有外部一致性，這意味著如果事務 T1 完成後事務 T2 開始，則 T2 必須看到 T1 的結果。為了實現這一點，Spanner 使用原子鐘和 GPS 產生的全球唯一時間戳來確保事務順序。</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Google Spanner" src="/RulerChen-Website/assets/images/image-1-56adc1282b54205ccc472e2555a0b4ca.png" width="958" height="537" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a class="hash-link" aria-label="References的直接連結" title="References的直接連結" href="/RulerChen-Website/docs/CMU15-445/c22/#references">​</a></h2>
<ul>
<li><a href="https://15445.courses.cs.cmu.edu/fall2023/" target="_blank" rel="noopener noreferrer">CMU 15-445/645: Introduction to Database Systems</a></li>
<li><a href="https://www.youtube.com/watch?v=QRJs_57Pung&amp;list=PLSE8ODhjZXjbj8BMuIrRcacnQh20hmY9g&amp;index=23" target="_blank" rel="noopener noreferrer">CMU 15-445/645: Introduction to Database Systems Youtube 2023 Fall</a></li>
<li><a href="https://poweichen.gitbook.io/blockchain-guide-zh/distribute_system/paxos" target="_blank" rel="noopener noreferrer">Paxos</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/RulerChen/RulerChen-Website/tree/main/docs/CMU15-445/c22.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>編輯此頁</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最後<!-- -->於 <b><time datetime="2024-09-02T04:39:45.000Z" itemprop="dateModified">2024年9月2日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/RulerChen-Website/docs/CMU15-445/c21/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">Introduction to Distributed Databases</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/RulerChen-Website/docs/CMU15-445/c23/"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">Distributed OLAP Database Systems</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#replication">Replication</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#replication-configuration">Replication Configuration</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#propagation-scheme">Propagation Scheme</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#propagation-timing">Propagation Timing</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#active-vs-passive">Active vs Passive</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#atomic-commit-protocols">Atomic Commit Protocols</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#two-phase-commit-2pc">Two-Phase Commit (2PC)</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#paxos">Paxos</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#consistency-issues-cap--pacelc">Consistency Issues (CAP / PACELC)</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#cap">CAP</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#pacelc">PACELC</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#cap-vs-pacelc">CAP vs PACELC</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#google-spanner">Google Spanner</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c22/#references">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 RulerChen, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>