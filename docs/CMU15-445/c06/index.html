<!doctype html>
<html lang="zh-Hant" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CMU15-445/c06" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">CMU 15-445/645 Memory &amp; Disk I/O Management</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" name="twitter:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" property="og:url" content="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c06/"><meta data-rh="true" property="og:locale" content="zh_Hant"><meta data-rh="true" name="docusaurus_locale" content="zh-Hant"><meta data-rh="true" name="docsearch:language" content="zh-Hant"><meta data-rh="true" name="google-site-verification" content="QrdRbPEcOsJJ_kfRVewqfwR6GjPcRf0UVgRb85I-5fc"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Memory &amp; Disk I/O Management | RulerChen"><meta data-rh="true" name="description" content="CMU15-445/645 Memory &amp; Disk I/O Management"><meta data-rh="true" property="og:description" content="CMU15-445/645 Memory &amp; Disk I/O Management"><meta data-rh="true" name="keywords" content="CMU15-445/645,Storage Models &amp; Compression,CMU15-445/645 筆記"><link data-rh="true" rel="icon" href="/RulerChen-Website/img/profile.png"><link data-rh="true" rel="canonical" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c06/"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c06/" hreflang="zh-Hant"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c06/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GSV9DQB5UM-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/RulerChen-Website/blog/rss.xml" title="RulerChen RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/RulerChen-Website/blog/atom.xml" title="RulerChen Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="RulerChen" href="/RulerChen-Website/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/RulerChen-Website/assets/css/styles.4025f7b4.css">
<script src="/RulerChen-Website/assets/js/runtime~main.b6633933.js" defer="defer"></script>
<script src="/RulerChen-Website/assets/js/main.dcec3fe0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/RulerChen-Website/"><div class="navbar__logo"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/RulerChen-Website/docs/intro/">Notes</a><a class="navbar__item navbar__link" href="/RulerChen-Website/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/RulerChen" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.linkedin.com/in/rulerchen/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Linkdin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜尋"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜尋</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/RulerChen-Website/docs/intro/">Roadmap</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/C++/intro/">C++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Python/setup/">Python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/NodeJs/expresssetup/">Node.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/DS/intro/">Data Structure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Algorithm/KMP/">Algorithm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/OS/intro/">Operating System</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Network/intro/">Computer Network</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/CA/intro/">Computer Architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Next.js/EslintPrettier/">Next.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Database/pg-tuning/">PostgreSQL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Security/log4j/">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/SystemDesign/intro/">System Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/RulerChen-Website/docs/CMU15-445/c01/">CMU 15-445/645 Database Systems 2023 Fall</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c01/">Relational Model &amp; Algebra</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c02/">Modern SQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c03/">Database Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c05/">Storage Models &amp; Compression</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c06/">Memory &amp; Disk I/O Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c07/">Hash Tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c08/">Trees Indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c09/">Index Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c10/">Sorting &amp; Aggregations Algorithms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c11/">Joins Algorithms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c12/">Query Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c14/">Query Planning &amp; Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c15/">Concurrency Control Theory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c16/">Two-Phase Locking Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c17/">Timestamp Ordering Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c18/">Multi-Version Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c19/">Database Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c20/">Database Recovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c21/">Introduction to Distributed Databases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c22/">Distributed OLTP Database Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c23/">Distributed OLAP Database Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p0/">P0 - C++ Primer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p1/">P1 - Buffer Pool Manager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p2/">P2 - Hash Index</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p3/">P3 - Query Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/p4/">P4 - Concurrency Control</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/RulerChen-Website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">CMU 15-445/645 Database Systems 2023 Fall</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Memory &amp; Disk I/O Management</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>Memory &amp; Disk I/O Management</h1></header>
<p>這節會討論 DBMS 如何管理在記憶體和硬碟中移動的資料，主要分為兩個部分 :</p>
<ul>
<li>Spatial Control : 決定把 page 寫到硬碟中的哪個位置，目標是將常常需要一起用到的 page 放在一起來提高 I/O 效率</li>
<li>Temporal Control : 決定甚麼時候要把 page 讀進記憶體或是寫回硬碟，目標是降低 I/O 的停頓時間</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Buffer Pool" src="/RulerChen-Website/assets/images/image-eb522a6c73fcc7ddcecac48e0cefc009.png" width="960" height="539" class="img_ev3q"></p>
<p>需要注意的是，與 mmap 不同，buffer pool 不保證兩次讀取同一個 page 會得到相同的記憶體位置。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="buffer-pool-management">Buffer Pool Management<a class="hash-link" aria-label="Buffer Pool Management的直接連結" title="Buffer Pool Management的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#buffer-pool-management">​</a></h2>
<p>在啟動 DBMS 時，DBMS 會向 OS 申請一塊記憶體，這塊記憶體就是 buffer pool。
DBMS 會將這塊記憶體分成相同大小的 frame，當需要讀取 page 時，就把 page 讀進 frame 中。</p>
<p>同時 DBMS 會維護一個 page table 來記錄每個 page 在記憶體中的位置，也會記錄一些 metadata，比如 dirty flag (是否被修改過)、Pin / Reference Counter (是否被使用中)。</p>
<p><img decoding="async" loading="lazy" alt="Buffer Pool Management" src="/RulerChen-Website/assets/images/image-1-53d7213bffc644cfe107cce257cfd922.png" width="960" height="538" class="img_ev3q"></p>
<p>當 page 被引用時，DBMS 會將這個 page 的 reference counter +1 表示這個 page 正在被使用中，不能被移出記憶體。當我們要請求不在記憶體中的 page 時，DBMS 會先請求一個 latch，然後把 page 讀進 buffer pool 中，再釋放 latch，這樣可以避免多個 thread 同時修改同一個 entry。</p>
<p>latch 跟 lock 的差別如下 :</p>
<ul>
<li>lock<!-- -->
<ul>
<li>保護資料庫不受其他 transaction 的干擾</li>
<li>通常是在 transaction 進行時才會被使用</li>
<li>可以進行 rollback</li>
</ul>
</li>
<li>latch<!-- -->
<ul>
<li>保護資料庫不受其他 thread 的干擾</li>
<li>無法 rollback</li>
</ul>
</li>
</ul>
<p>在 DBMS 中，記憶體的分配會依據兩個原則 (Memory Allocation Policies) :</p>
<ul>
<li>Global Policies : 考慮所有查詢來分配記憶體</li>
<li>Local Policies : 只考慮單一查詢來分配記憶體</li>
</ul>
<p>大部分的 DBMS 會混合使用這兩種原則。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="buffer-pool-optimization">Buffer Pool Optimization<a class="hash-link" aria-label="Buffer Pool Optimization的直接連結" title="Buffer Pool Optimization的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#buffer-pool-optimization">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multiple-buffer-pools">Multiple Buffer Pools<a class="hash-link" aria-label="Multiple Buffer Pools的直接連結" title="Multiple Buffer Pools的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#multiple-buffer-pools">​</a></h3>
<p>DBMS 可以維護多個 buffer pool，每個 buffer pool 有不同的大小和替換策略，這麼做可以減少 latch 的競爭，並提升 locality。</p>
<p>例如可以有以下幾種 buffer pool :</p>
<ul>
<li>Multiple buffer pool instances</li>
<li>Per-database buffer pool</li>
<li>Per-page type buffer pool</li>
</ul>
<p>常見的分配方式有兩種 :</p>
<ul>
<li>Object Id : 在 record 中產生一個 object id，然後根據 object id 來決定放在哪個 buffer pool</li>
<li>Hashing : 根據 page id 的 hash 來決定放在哪個 buffer pool</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prefetching">Prefetching<a class="hash-link" aria-label="Prefetching的直接連結" title="Prefetching的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#prefetching">​</a></h3>
<p>DBMS 可以透過 query plan 來預測未來可能會用到的 page，然後提前把這些 page 讀進 buffer pool 中。
這其中包含 sequential scan 和 index scan，與 OS 不同的是，OS 無法預測像 index scan 會使用到的 page。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scan-sharing-synchronized-scans">Scan Sharing (Synchronized Scans)<a class="hash-link" aria-label="Scan Sharing (Synchronized Scans)的直接連結" title="Scan Sharing (Synchronized Scans)的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#scan-sharing-synchronized-scans">​</a></h3>
<p>scan sharing 主要是在有多個查詢同時進行 sequential scan 時，可以共享同一個 scan 的結果。
舉例來說，如果有 A 和 B 兩個查詢先後進行，當 B 開始查詢時，可以先跟 A 一起掃描，等到 A 結束時，自己再重新掃描一開始缺少的部分。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="buffer-pool-bypass">Buffer Pool Bypass<a class="hash-link" aria-label="Buffer Pool Bypass的直接連結" title="Buffer Pool Bypass的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#buffer-pool-bypass">​</a></h3>
<p>當需要使用 sequential scan 來掃描資料量很大的表時，如果 DBMS 將每個 page 都讀進 buffer pool 中，會導致 buffer pool 被汙染，因為這些 page 大都只用一次，會排擠到其他常用的 page，因此我們可以單獨分配一塊記憶體來存放這些 page，這樣可以避免 buffer pool 被汙染。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="buffer-replacement-policies">Buffer Replacement Policies<a class="hash-link" aria-label="Buffer Replacement Policies的直接連結" title="Buffer Replacement Policies的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#buffer-replacement-policies">​</a></h2>
<p>當 buffer pool 被填滿時，DBMS 需要決定要替換哪些 page，這個決定是根據替換策略 (Replacement Policy) 來決定的。</p>
<p>這個替換策略的目標如下 :</p>
<ul>
<li>Correctness : 確保 page 在被替換前被寫回硬碟</li>
<li>Accuracy : 確保替換的 page 是最不可能再被使用的</li>
<li>Speed : 快速找到要被替換的 page，因為每次移除都要使用 latch</li>
<li>Metadata Overhead : 策略所需的 metadata 越少越好</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="least-recently-used-lru">Least Recently Used (LRU)<a class="hash-link" aria-label="Least Recently Used (LRU)的直接連結" title="Least Recently Used (LRU)的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#least-recently-used-lru">​</a></h3>
<p>使用 linked list 來記錄每個 page 最後一次被使用的時間，如果滿了，就把最久沒被使用的 page 替換掉。</p>
<p><img decoding="async" loading="lazy" alt="LRU" src="/RulerChen-Website/assets/images/image-2-69b94d20eaac9bf800e93a81b628573c.png" width="956" height="537" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="clock">Clock<a class="hash-link" aria-label="Clock的直接連結" title="Clock的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#clock">​</a></h3>
<p>與 LRU 類似，但是 clock 不需要紀錄上一次訪問的時間，而是記錄一個 reference bit。</p>
<ul>
<li>當 page 被訪問時，reference bit 會被設為 1。</li>
<li>當需要移除 page 時，從上一次的位置開始，輪流詢問 reference bit，
如果 reference bit 是 1，則將 reference bit 設為 0，然後繼續往下找。
如果 reference bit 是 0，則將這個 page 移除。</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Clock" src="/RulerChen-Website/assets/images/image-3-cdac81bcf6348260d008b457e54bbe36.png" width="959" height="538" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lru-k">LRU-K<a class="hash-link" aria-label="LRU-K的直接連結" title="LRU-K的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#lru-k">​</a></h3>
<p>不管是 LRU 還是 clock，都會遇到 sequential flooding 的問題，最新讀取的 page 反而是最不需要的 page，因此又產生了 LRU-K 來解決這個問題。</p>
<p>LRU-K 會保存每個 page 最後 k 次被訪問的時間，然後根據這個時間來預估下次被訪問的時間，如果 k = 1 就是 LRU，通常會使用 k = 2。</p>
<p>不過這種方式也有可能導致有些 page 會一直被排出 buffer pool，所以我們會在記憶體中維護一個 hash table，紀錄一些被排出的頁面被訪問的時間，這樣就不會讓這些 page 一直被排出 buffer pool。</p>
<p>這種方式被 PostgreSQL 以及 SQL Server 所使用。</p>
<p>而 MySQL 則是使用了一種類似的 midpoint insertion strategy 方法，這種方法會將 list 分成 young list 跟 old list，當新的 page 被訪問時，會被放到 old list 的最前面，而當 old list 裡面的 page 被訪問到時，會被放到 young list 的最前面。</p>
<p><img decoding="async" loading="lazy" alt="LRU-K" src="/RulerChen-Website/assets/images/image-4-4e32a2f0129ef0fd182844aad57fcdfc.png" width="958" height="539" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="localization">Localization<a class="hash-link" aria-label="Localization的直接連結" title="Localization的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#localization">​</a></h3>
<p>DBMS 會根據每個查詢來選擇要被移除的 page，這樣可以盡量減少對 buffer pool 的汙染。</p>
<p>如 PostgreSQL 會對每個查詢維護一個 ring buffer。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="priority-hints">Priority Hints<a class="hash-link" aria-label="Priority Hints的直接連結" title="Priority Hints的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#priority-hints">​</a></h3>
<p>有時候 DBMS 可以知道每個 page 在執行期間的上下文訊息，可以幫助 DBMS 選擇要被移除的 page。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dirty-page">Dirty Page<a class="hash-link" aria-label="Dirty Page的直接連結" title="Dirty Page的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#dirty-page">​</a></h3>
<p>移除一個 dirty page 的成本是非常高的，因為還要將其先寫入硬碟。</p>
<p>除了在 replacement policy 中考慮 dirty page 外，DBMS 也會在後台定期將 dirty page 寫入硬碟。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="os-problem">OS problem<a class="hash-link" aria-label="OS problem的直接連結" title="OS problem的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#os-problem">​</a></h2>
<p>總體來說，DBMS 應該盡量減少對 OS 的依賴。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scheduler">Scheduler<a class="hash-link" aria-label="Scheduler的直接連結" title="Scheduler的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#scheduler">​</a></h3>
<p>OS 會嘗試透過重新排序以及合併 I/O 來提高效率，但 OS 並不會知道那些 IO 對 DBMS 來說是重要的，所以許多 DBMS 會建議使用 deadline 或 noop scheduler (FIFO)，如 MySQL、Oracle。</p>
<p>同時，DBMS 會自己有一個 scheduler 來管理讀寫請求，它會根據 I/O 方式、table / index / log、sequential / random 等等來決定讀寫的順序。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="page-cache">Page Cache<a class="hash-link" aria-label="Page Cache的直接連結" title="Page Cache的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#page-cache">​</a></h3>
<p>OS 會維護一個 page cache 來 存放最近被讀取的 page，但這有可能會跟 DBMS 衝突，因此通常會使用 <code>O_DIRECT</code> 來避免這個問題，除了 PostgreSQL 以外。</p>
<p><img decoding="async" loading="lazy" alt="Page Cache" src="/RulerChen-Website/assets/images/image-5-78626b6ddeca6717883cda04ee9e14cf.png" width="956" height="537" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fsync">fsync<a class="hash-link" aria-label="fsync的直接連結" title="fsync的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#fsync">​</a></h3>
<p>當我們執行 <code>fwrite</code> 的時候，OS 並不會立即將資料寫入硬碟，而是會先寫入 page cache，然後再由 OS 來決定什麼時候寫入硬碟。</p>
<p>當我們執行 <code>fsync</code> 的時候，OS 會強制將 page cache 的資料寫入硬碟，並且會 block 住這個 thread 直到寫入完成，並告訴你已經完成寫入。但如果 fsync 失敗，它依然會將 dirty page 標記為 clean，這樣當下次使用這個 page 時，會導致錯誤。</p>
<p>這是 linux 針對 USB 的一個設計，導致 postgresql 之前有發生過嚴重問題，可以參考 <a href="https://wiki.postgresql.org/wiki/Fsync_Errors" target="_blank" rel="noopener noreferrer">PostgreSQL Fsync Errors</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a class="hash-link" aria-label="References的直接連結" title="References的直接連結" href="/RulerChen-Website/docs/CMU15-445/c06/#references">​</a></h2>
<ul>
<li><a href="https://15445.courses.cs.cmu.edu/fall2023/" target="_blank" rel="noopener noreferrer">CMU 15-445/645: Introduction to Database Systems</a></li>
<li><a href="https://www.youtube.com/watch?v=BS5h8QZHCPk&amp;list=PLSE8ODhjZXjbj8BMuIrRcacnQh20hmY9g&amp;index=7" target="_blank" rel="noopener noreferrer">CMU 15-445/645: Introduction to Database Systems Youtube 2023 Fall</a></li>
<li><a href="https://zhenghe.gitbook.io/open-courses/cmu-15-445-645-database-systems/database-storage" target="_blank" rel="noopener noreferrer">Notes 1</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/RulerChen/RulerChen-Website/tree/main/docs/CMU15-445/c06.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>編輯此頁</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最後<!-- -->於 <b><time datetime="2024-09-16T02:08:07.000Z" itemprop="dateModified">2024年9月16日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/RulerChen-Website/docs/CMU15-445/c05/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">Storage Models &amp; Compression</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/RulerChen-Website/docs/CMU15-445/c07/"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">Hash Tables</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#buffer-pool-management">Buffer Pool Management</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#buffer-pool-optimization">Buffer Pool Optimization</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#multiple-buffer-pools">Multiple Buffer Pools</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#prefetching">Prefetching</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#scan-sharing-synchronized-scans">Scan Sharing (Synchronized Scans)</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#buffer-pool-bypass">Buffer Pool Bypass</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#buffer-replacement-policies">Buffer Replacement Policies</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#least-recently-used-lru">Least Recently Used (LRU)</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#clock">Clock</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#lru-k">LRU-K</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#localization">Localization</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#priority-hints">Priority Hints</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#dirty-page">Dirty Page</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#os-problem">OS problem</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#scheduler">Scheduler</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#page-cache">Page Cache</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#fsync">fsync</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c06/#references">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 RulerChen, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>