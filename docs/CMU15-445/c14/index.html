<!doctype html>
<html lang="zh-Hant" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CMU15-445/c14" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">CMU 15-445/645 筆記 Query Planning &amp; Optimization</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" name="twitter:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" property="og:url" content="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c14/"><meta data-rh="true" property="og:locale" content="zh_Hant"><meta data-rh="true" name="docusaurus_locale" content="zh-Hant"><meta data-rh="true" name="docsearch:language" content="zh-Hant"><meta data-rh="true" name="google-site-verification" content="QrdRbPEcOsJJ_kfRVewqfwR6GjPcRf0UVgRb85I-5fc"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Query Planning &amp; Optimization | RulerChen"><meta data-rh="true" name="description" content="CMU15-445/645 Query Planning &amp; Optimization"><meta data-rh="true" property="og:description" content="CMU15-445/645 Query Planning &amp; Optimization"><meta data-rh="true" name="keywords" content="CMU15-445/645,Query Planning &amp; Optimization,CMU15-445/645 筆記"><link data-rh="true" rel="icon" href="/RulerChen-Website/img/profile.png"><link data-rh="true" rel="canonical" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c14/"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c14/" hreflang="zh-Hant"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/c14/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GSV9DQB5UM-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/RulerChen-Website/blog/rss.xml" title="RulerChen RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/RulerChen-Website/blog/atom.xml" title="RulerChen Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="RulerChen" href="/RulerChen-Website/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/RulerChen-Website/assets/css/styles.4025f7b4.css">
<script src="/RulerChen-Website/assets/js/runtime~main.948e35ed.js" defer="defer"></script>
<script src="/RulerChen-Website/assets/js/main.a0b4d0fa.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/RulerChen-Website/"><div class="navbar__logo"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/RulerChen-Website/docs/intro/">Notes</a><a class="navbar__item navbar__link" href="/RulerChen-Website/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/RulerChen" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.linkedin.com/in/rulerchen/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Linkdin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜尋"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜尋</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/RulerChen-Website/docs/intro/">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Algorithm/KMP/">Algorithm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Database/pg-tuning/">Database</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/SystemDesign/cdn/">System Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Docker/Introduction/">Docker</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Kubernetes/Introduction/">Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/NodeJs/expresssetup/">Node.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Next.js/Caching/">Next.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/RulerChen-Website/docs/CMU15-445/c01/">CMU15-445/645 Database Systems</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c01/">Relational Model &amp; Algebra</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c02/">Modern SQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c03/">Database Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c05/">Storage Models &amp; Compression</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c06/">Memory &amp; Disk I/O Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c07/">Hash Tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c08/">Trees Indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c09/">Index Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c10/">Sorting &amp; Aggregations Algorithms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c11/">Joins Algorithms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c12/">Query Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c14/">Query Planning &amp; Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c15/">Concurrency Control Theory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c16/">Two-Phase Locking Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c17/">Timestamp Ordering Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c18/">Multi-Version Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c19/">Database Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c20/">Database Recovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c21/">Introduction to Distributed Databases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c22/">Distributed OLTP Database Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c23/">Distributed OLAP Database Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c24/">SingleStore Database Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/CMU15-445/c25/">Final Review + Systems Potpourri</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/RulerChen-Website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">CMU15-445/645 Database Systems</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Query Planning &amp; Optimization</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>Query Planning &amp; Optimization</h1></header>
<p>由於 SQL 是一種宣告式的語言，所以 DBMS 不會具體知道自己應該要怎麼執行，
而是需要將 SQL 語句轉換成可執行的 query plan。</p>
<p>找到最佳的 query plan 是一個 NP-hard 的問題，
因此本節的主要內容就是如何透過演算法在有限的時間內找到一個好的 query plan。</p>
<p>我們使用的策略主要有兩個</p>
<ul>
<li>Heuristic-based : 使用既定的規則來調整順序</li>
<li>Cost-based : 依據統計資料來估算成本，選擇 cost 最低的 query plan</li>
</ul>
<p>而 query plan 主要也有兩種類型</p>
<ul>
<li>Logical Plan: 查詢中的關係代數表達式</li>
<li>Physical Plan: 具體的執行策略，如排序的方法、join 的方式等</li>
</ul>
<!-- -->
<img src="/RulerChen-Website/assets/images/image-d760ff7017529bc7bb69e2d07c499537.png" alt="test" style="width:100%;height:auto">
<p>在這個 SQL 語句執行的流程圖中 tree rewriter 會負責將 SQL 語句轉換成 logical plan，
而 optimizer 則會透過 system catalog 所提供的資訊來將 logical plan 轉換成 physical plan。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logical-query-optimization">Logical Query Optimization<a class="hash-link" aria-label="Logical Query Optimization的直接連結" title="Logical Query Optimization的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#logical-query-optimization">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selection-optimization">Selection Optimization<a class="hash-link" aria-label="Selection Optimization的直接連結" title="Selection Optimization的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#selection-optimization">​</a></h3>
<ul>
<li>盡早執行  篩選條件 : 透過篩選條件減少 tuple 數量，特別是在 join 之前</li>
<li>重新排序篩選條件 : 將選擇性最高的條件放在前面執行，使後面所需過濾的 tuple 數量更少</li>
<li>將複雜的篩選條件拆分 : 拆分篩選條件，如 <code>X = Y AND Y = 3</code> 可以拆分成 <code>X = 3 AND Y = 3</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="projection-optimization">Projection Optimization<a class="hash-link" aria-label="Projection Optimization的直接連結" title="Projection Optimization的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#projection-optimization">​</a></h3>
<ul>
<li>刪除不必要的 column : 減少 I/O，舉例來說，如果 SQL 中只有 <code>SELECT name FROM table</code>，那麼我們就應該在一開始只留 name 欄位再做後續操作</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="query-rewrite-optimizations">Query Rewrite Optimizations<a class="hash-link" aria-label="Query Rewrite Optimizations的直接連結" title="Query Rewrite Optimizations的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#query-rewrite-optimizations">​</a></h3>
<ul>
<li>移除不可能或不必要的篩選條件 : 如 <code>WHERE 1 = 0</code></li>
<li>合併篩選條件 : 如 <code>VAL BETWEEN 1 AND 10 OR VAL BETWEEN 5 AND 15</code> 可以合併成 <code>VAL BETWEEN 1 AND 15</code></li>
<li>消除子查詢 : 將子查詢攤平 (flatten) 或取消關聯 (de-correlate)</li>
<li>拆解和儲存結果至臨時表 : 如果有複雜的子查詢，可以將結果儲存至臨時表並逐一優化</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="join-optimization">Join Optimization<a class="hash-link" aria-label="Join Optimization的直接連結" title="Join Optimization的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#join-optimization">​</a></h3>
<ul>
<li>Join Reordering : 重新排序 join 的順序</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cost-estimation">Cost Estimation<a class="hash-link" aria-label="Cost Estimation的直接連結" title="Cost Estimation的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#cost-estimation">​</a></h2>
<p>除了一些基本的 heuristic 外，有許多操作在 DBMS 中沒有一定的優劣，所以我們需要透過 cost estimation 來估算成本。</p>
<p>查詢成本通常取決於很多因素，如</p>
<ul>
<li>CPU</li>
<li>磁碟 I/O</li>
<li>記憶體</li>
<li>網絡</li>
</ul>
<p>但大部分的成本依舊取決於在整個 query plan 中我們要讀寫多少 tuple，
因此 DBMS 需要維護一些統計資料，如 tuple 數量、篩選條件的選擇性等等來幫助估算成本。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="statistics">Statistics<a class="hash-link" aria-label="Statistics的直接連結" title="Statistics的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#statistics">​</a></h3>
<p>通常對於一個任意的 table R，DBMS 都會維護以下統計資料</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>R</mi></msub></mrow><annotation encoding="application/x-tex">N_R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> : R 中的 tuple 數量</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V(A,R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.22222em">V</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mclose">)</span></span></span></span> : R 中屬性 A 的不同值數量</li>
</ul>
<p>透過這兩個資訊，我們可以得到 selection cardinality <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>C</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>R</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>N</mi><mi>R</mi></msub><mi mathvariant="normal">/</mi><mi>V</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SC(A,R) = N_R / V(A,R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.07153em">SC</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.22222em">V</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mclose">)</span></span></span></span>，
這種方式通常會有三個假設</p>
<ul>
<li>Uniform Data : 值的分布是一致的</li>
<li>Independent Predicates : 屬性之間是獨立的</li>
<li>Inclusion Principle : join 使用的 key 在 outer table 必定存在</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="histograms">Histograms<a class="hash-link" aria-label="Histograms的直接連結" title="Histograms的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#histograms">​</a></h3>
<p>真實的資料中幾乎不可能是 uniform 的，因此我們可以使用 histogram 來更好的估算成本，
儲存方式通常有以下幾種可能</p>
<p><img decoding="async" loading="lazy" alt="Histograms" src="/RulerChen-Website/assets/images/image-1-ca719ff330d81541ffb875ad5153b4eb.png" width="961" height="536" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Histograms" src="/RulerChen-Website/assets/images/image-2-c87dc7fcde682fa9695dae6b8f7b02c1.png" width="955" height="538" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Histograms" src="/RulerChen-Website/assets/images/image-3-764b66be93d4733d46069c574441d2e8.png" width="959" height="540" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sketches">Sketches<a class="hash-link" aria-label="Sketches的直接連結" title="Sketches的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#sketches">​</a></h3>
<p>我們可以使用 Probabilistic data structures 來產生近似於 dataset 的資料，
如 HyperLogLog、Count-Min Sketch 等等。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sampling">Sampling<a class="hash-link" aria-label="Sampling的直接連結" title="Sampling的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#sampling">​</a></h3>
<p>DBMS 可以針對 table 的部分資料進行 sampling 來估算成本，並在 table 變動超過一定比例時重新進行 sampling，
如 PostgreSQL 的 <code>ANALYZE</code> 指令。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="query-plan">Query Plan<a class="hash-link" aria-label="Query Plan的直接連結" title="Query Plan的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#query-plan">​</a></h2>
<p>在執行完 rule-based 的 rewrite 之後，DBMS 會枚舉不同的查詢計畫並估計成本，
直到嘗試完所有可能或超時為止。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="single-relation-query-plans">Single-Relation Query Plans<a class="hash-link" aria-label="Single-Relation Query Plans的直接連結" title="Single-Relation Query Plans的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#single-relation-query-plans">​</a></h3>
<p>只需要使用簡單的啟發式規則即可，目標使找到最佳的 access method。</p>
<ul>
<li>sequential scan</li>
<li>index scan</li>
<li>binary search (clustered indexes)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multi-relation-query-plans">Multi-Relation Query Plans<a class="hash-link" aria-label="Multi-Relation Query Plans的直接連結" title="Multi-Relation Query Plans的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#multi-relation-query-plans">​</a></h3>
<p>隨著連結數量的增加，可以選擇的計劃數量會急劇增加，因此我們需要限制搜索空間以便在有限時間內找到最佳計劃，
通常有 bottom-up 和 top-down 兩種方法。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="buttom-up">Buttom-Up<a class="hash-link" aria-label="Buttom-Up的直接連結" title="Buttom-Up的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#buttom-up">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Buttom-Up" src="/RulerChen-Website/assets/images/image-4-496577ee728f893fdb908072c17c2faf.png" width="959" height="541" class="img_ev3q"></p>
<p>使用動態規劃 (Dynamic Programming) 來找到最佳的 join order，步驟如下</p>
<ul>
<li>將查詢分成多個邏輯區塊</li>
<li>對每個 logical operator 找到最佳的 physical operator (hash join、sort merge join ...)</li>
<li>使用 left-deep tree 並透過動態規劃找到最佳的 join order</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="top-down">Top-Down<a class="hash-link" aria-label="Top-Down的直接連結" title="Top-Down的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#top-down">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Top-Down" src="/RulerChen-Website/assets/images/image-5-ca54253207d99dae7e66beeddbfaa7d7.png" width="960" height="537" class="img_ev3q"></p>
<p>optimizer 會從 logical plan 開始，使用 branch and bound 的方法來遍歷樹狀結構，並將 logical operator 轉換成 physical operator。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a class="hash-link" aria-label="References的直接連結" title="References的直接連結" href="/RulerChen-Website/docs/CMU15-445/c14/#references">​</a></h2>
<ul>
<li><a href="https://15445.courses.cs.cmu.edu/fall2023/" target="_blank" rel="noopener noreferrer">CMU 15-445/645: Introduction to Database Systems</a></li>
<li><a href="https://www.youtube.com/watch?v=ePGPVJCyCAk&amp;list=PLSE8ODhjZXjbj8BMuIrRcacnQh20hmY9g&amp;index=16" target="_blank" rel="noopener noreferrer">CMU 15-445/645: Introduction to Database Systems Youtube 2023 Fall</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/RulerChen/RulerChen-Website/tree/main/docs/CMU15-445/c14.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>編輯此頁</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最後<!-- -->於 <b><time datetime="2024-08-22T15:34:21.000Z" itemprop="dateModified">2024年8月22日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/RulerChen-Website/docs/CMU15-445/c12/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">Query Execution</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/RulerChen-Website/docs/CMU15-445/c15/"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">Concurrency Control Theory</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#logical-query-optimization">Logical Query Optimization</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#selection-optimization">Selection Optimization</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#projection-optimization">Projection Optimization</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#query-rewrite-optimizations">Query Rewrite Optimizations</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#join-optimization">Join Optimization</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#cost-estimation">Cost Estimation</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#statistics">Statistics</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#histograms">Histograms</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#sketches">Sketches</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#sampling">Sampling</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#query-plan">Query Plan</a><ul><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#single-relation-query-plans">Single-Relation Query Plans</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#multi-relation-query-plans">Multi-Relation Query Plans</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/CMU15-445/c14/#references">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 RulerChen, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>