<!doctype html>
<html lang="zh-Hant" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Database/pg-ha" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">[PG] Postgres HA and Scale | RulerChen</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" name="twitter:image" content="https://RulerChen.github.io/RulerChen-Website/img/profile.png"><meta data-rh="true" property="og:url" content="https://RulerChen.github.io/RulerChen-Website/docs/Database/pg-ha/"><meta data-rh="true" property="og:locale" content="zh_Hant"><meta data-rh="true" name="docusaurus_locale" content="zh-Hant"><meta data-rh="true" name="docsearch:language" content="zh-Hant"><meta data-rh="true" name="google-site-verification" content="QrdRbPEcOsJJ_kfRVewqfwR6GjPcRf0UVgRb85I-5fc"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[PG] Postgres HA and Scale | RulerChen"><meta data-rh="true" name="description" content="Postgres 高可用性"><meta data-rh="true" property="og:description" content="Postgres 高可用性"><meta data-rh="true" name="keywords" content="Postgres,高可用性"><link data-rh="true" rel="icon" href="/RulerChen-Website/img/profile.png"><link data-rh="true" rel="canonical" href="https://RulerChen.github.io/RulerChen-Website/docs/Database/pg-ha/"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/Database/pg-ha/" hreflang="zh-Hant"><link data-rh="true" rel="alternate" href="https://RulerChen.github.io/RulerChen-Website/docs/Database/pg-ha/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GSV9DQB5UM-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/RulerChen-Website/blog/rss.xml" title="RulerChen RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/RulerChen-Website/blog/atom.xml" title="RulerChen Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="RulerChen" href="/RulerChen-Website/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/RulerChen-Website/assets/css/styles.4025f7b4.css">
<script src="/RulerChen-Website/assets/js/runtime~main.89450d5f.js" defer="defer"></script>
<script src="/RulerChen-Website/assets/js/main.778afbae.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/RulerChen-Website/"><div class="navbar__logo"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/RulerChen-Website/img/profile.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/RulerChen-Website/docs/intro/">Notes</a><a class="navbar__item navbar__link" href="/RulerChen-Website/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/RulerChen" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.linkedin.com/in/rulerchen/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Linkdin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜尋"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜尋</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/RulerChen-Website/docs/intro/">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Algorithm/KMP/">Algorithm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/RulerChen-Website/docs/Database/pg-tuning/">Database</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/RulerChen-Website/docs/Database/pg-tuning/">[PG] Postgres Tuning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/RulerChen-Website/docs/Database/pg-ha/">[PG] Postgres HA and Scale</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/SystemDesign/cdn/">System Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Docker/Introduction/">Docker</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Kubernetes/Introduction/">Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/NodeJs/expresssetup/">Node.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Next.js/Caching/">Next.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/Security/log4j/">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/RulerChen-Website/docs/CMU15-445/c01/">CMU15-445/645 Database Systems</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/RulerChen-Website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Database</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[PG] Postgres HA and Scale</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>[PG] Postgres HA and Scale</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scaling-postgresql">Scaling PostgreSQL<a class="hash-link" aria-label="Scaling PostgreSQL的直接連結" title="Scaling PostgreSQL的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#scaling-postgresql">​</a></h2>
<p>當我們的資料庫需要處理大量的資料時，我們首先需要檢查我們的資料庫是否已經達到其處理能力的極限，像是 SQL 優化或參數調整等等，
如果還是沒辦法提供足夠的效能，我們就需要考慮擴充我們的資料庫。</p>
<ul>
<li><strong>Vertical Scaling</strong>: 增加資源，像是 CPU、Memory、Storage 等等</li>
<li><strong>Horizontal Scaling</strong>: 增加節點，像是增加資料庫節點、增加資料庫叢集等等</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Scaling" src="/RulerChen-Website/assets/images/image-0c0bd50adc5761f6c79e1bb1a0ccff47.png" width="1654" height="904" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="streaming-replication">Streaming Replication<a class="hash-link" aria-label="Streaming Replication的直接連結" title="Streaming Replication的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#streaming-replication">​</a></h2>
<p>Streaming Replication 是 PostgreSQL 用來實現高可用性的主要機制，它透過將主節點的 WAL 日誌傳送到從節點，從而實現接近實時的資料同步。</p>
<p>在 postgres 中，預設的執行方式是非同步的，
也就是說主節點在執行完一個 transaction 後，不需要等待從節點確認收到 WAL 日誌，就可以繼續執行下一個 transaction，
這種方法的好處是效能較高，缺點是如果 發生故障，可能會因為 WAL 缺少而導致資料不一致。
我們也可以設置為同步，這樣主節點在執行完後，需要等待從節點確認收到 WAL 日誌，才能繼續執行，
這種方法的好處是資料一致性較高且可以保證資料的完整性，缺點是效能較低。
我們可以針對不同的資料(table)，來選擇不同的方式。</p>
<p><img decoding="async" loading="lazy" alt="Streaming Replication" src="/RulerChen-Website/assets/images/image-10-6a666c38c2d3febb18a300499825faab.png" width="1052" height="548" class="img_ev3q"></p>
<p>首先使用 <code>initdb</code> 來初始化資料庫集群，資料庫集群是由單個資料庫實例所管理的資料庫集合。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker run -d --name pg-ha1 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker exec -it pg-ha1 /bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">su postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">initdb -D /tmp/primary_db/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vi /tmp/primary_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set listen_addresses to &#x27;*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql --port=5433 postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create user requser replication;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vi /tmp/primary_db/pg_hba.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># add the following line</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">host all requser 127.0.0.1/32 trust</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/primary_db restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們創建一個 replication 的資料庫</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_basebackup -h localhost -U requser --checkpoint=fast -D /tmp/replica_db -R --slot=some_slot -C --port 5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vi /tmp/replica_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set listen_addresses to &#x27;*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5434</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/replica_db start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最後讓我們來做主節點的測試</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql postgres --port=5433</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">postgres</span><span class="token operator">=</span><span class="token comment" style="color:rgb(98, 114, 164)"># SELECT * FROM pg_stat_replication;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">----+------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pid              </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">595</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">usesysid         </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">16384</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">usename          </span><span class="token operator">|</span><span class="token plain"> requser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">application_name </span><span class="token operator">|</span><span class="token plain"> walreceiver</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_addr      </span><span class="token operator">|</span><span class="token plain"> ::</span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_hostname  </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_port      </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">49798</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend_start    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">15</span><span class="token plain">:</span><span class="token number">14.549951</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend_xmin     </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">state            </span><span class="token operator">|</span><span class="token plain"> streaming</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sent_lsn         </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flush_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replay_lsn       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write_lag        </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flush_lag        </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replay_lag       </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sync_priority    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sync_state       </span><span class="token operator">|</span><span class="token plain"> async</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">reply_time       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">33</span><span class="token plain">:</span><span class="token number">45.648063</span><span class="token operator">+</span><span class="token number">00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>從節點的測試</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql postgres --port=5434</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> pg_stat_wal_receiver</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pid                   </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">594</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">status</span><span class="token plain">                </span><span class="token operator">|</span><span class="token plain"> streaming</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">receive_start_lsn     </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">receive_start_tli     </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">written_lsn           </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flushed_lsn           </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">received_tli          </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">last_msg_send_time    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">36</span><span class="token plain">:</span><span class="token number">45.703365</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">last_msg_receipt_time </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">36</span><span class="token plain">:</span><span class="token number">45.70343</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">latest_end_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3000148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">latest_end_time       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:</span><span class="token number">15</span><span class="token plain">:</span><span class="token number">14.551133</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">slot_name             </span><span class="token operator">|</span><span class="token plain"> some_slot</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sender_host           </span><span class="token operator">|</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sender_port           </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">5433</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conninfo              </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">user</span><span class="token operator">=</span><span class="token plain">requser passfile</span><span class="token operator">=</span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">postgresql</span><span class="token operator">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">pgpass channel_binding</span><span class="token operator">=</span><span class="token plain">prefer dbname</span><span class="token operator">=</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">replication</span><span class="token plain"> host</span><span class="token operator">=</span><span class="token plain">localhost port</span><span class="token operator">=</span><span class="token number">5433</span><span class="token plain"> fallback_application_name</span><span class="token operator">=</span><span class="token plain">walreceiver sslmode</span><span class="token operator">=</span><span class="token plain">prefer sslcompression</span><span class="token operator">=</span><span class="token number">0</span><span class="token plain"> sslcertmode</span><span class="token operator">=</span><span class="token plain">allow sslsni</span><span class="token operator">=</span><span class="token number">1</span><span class="token plain"> ssl_min_protocol_version</span><span class="token operator">=</span><span class="token plain">TLSv1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token number">2</span><span class="token plain"> gssencmode</span><span class="token operator">=</span><span class="token plain">prefer krbsrvname</span><span class="token operator">=</span><span class="token plain">postgres gssdelegation</span><span class="token operator">=</span><span class="token number">0</span><span class="token plain"> target_session_attrs</span><span class="token operator">=</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">any</span><span class="token plain"> load_balance_hosts</span><span class="token operator">=</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">disable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們在主節點上創建一個 table，然後在從節點上查詢，看看是否能夠查詢到。</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> test_table </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">id </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SERIAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">KEY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> name </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VARCHAR</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">255</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTO</span><span class="token plain"> test_table </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;test&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> test_table</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> id </span><span class="token operator">|</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">----+------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logical-replication">Logical Replication<a class="hash-link" aria-label="Logical Replication的直接連結" title="Logical Replication的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#logical-replication">​</a></h2>
<p><img decoding="async" loading="lazy" alt="Logical Replication" src="/RulerChen-Website/assets/images/image-1-e2174585abf64dcc3e3f553d2f5e701a.png" width="1138" height="563" class="img_ev3q"></p>
<p>logical replication 是一種透過將 SQL 語句來進行複製的方式，
這種方式的好處是資料複製的效能較高適用於網路環境較差的地方，且可以在不同版本之間進行複製，
同時也可以選擇複製特定的資料，
缺點是無法執行一些 DDL 的指令，像是 <code>CREATE TABLE</code> 或是 <code>ALTER TABLE</code> 等等，
同時 sequence 的值默認也不會複製，這代表如果需要 failover 的話，需要另外處理 sequence 的值。</p>
<p>先開好 docker 的環境</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker run -d --name pg-ha2 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker exec -it pg-ha2 /bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">su postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>創建資料庫並修改參數</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">initdb -D /tmp/publish_db/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">initdb -D /tmp/subscribe_db/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vi /tmp/publish_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set wal_level to logical</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/publish_db start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vi /tmp/subscribe_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5434</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/subscribe_db start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>創建好表，並使用 <code>pg_dump</code> 來進行複製</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql postgres --port=5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE DATABASE pub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">\c pub</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE test_table (id SERIAL PRIMARY KEY, name VARCHAR(255));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">INSERT INTO test_table (name) VALUES (&#x27;test&#x27;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql postgres --port=5434</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE DATABASE sub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_dump -t test_table -p 5433 -s pub | psql -p 5434 -d sub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>創建 publication 和 subscription</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> PUBLICATION test_publication </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> test_table</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> SUBSCRIPTION test_subscription CONNECTION </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;host=localhost port=5433 user=postgres dbname=pub&#x27;</span><span class="token plain"> PUBLICATION test_publication</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> test_table</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著我們可以透過 <code>pg_stat_replication</code> 來查看 replication 的狀態，
可以關注 lag 的部分</p>
<ul>
<li><code>write_lag</code>: 主節點寫入 WAL 的時間</li>
<li><code>flush_lag</code>: 主節點將 WAL 刷新到磁盤的時間</li>
<li><code>replay_lag</code>: 從節點應用 WAL 的時間</li>
</ul>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> pg_stat_replication</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">----+------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pid              </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">222</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">usesysid         </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">usename          </span><span class="token operator">|</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">application_name </span><span class="token operator">|</span><span class="token plain"> test_subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_addr      </span><span class="token operator">|</span><span class="token plain"> ::</span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_hostname  </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client_port      </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">36752</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend_start    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">04</span><span class="token plain"> </span><span class="token number">07</span><span class="token plain">:</span><span class="token number">23</span><span class="token plain">:</span><span class="token number">31.011034</span><span class="token operator">+</span><span class="token number">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend_xmin     </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">state            </span><span class="token operator">|</span><span class="token plain"> streaming</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sent_lsn         </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">196</span><span class="token plain">EA40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">196</span><span class="token plain">EA40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flush_lsn        </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">196</span><span class="token plain">EA40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replay_lsn       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">/</span><span class="token number">196</span><span class="token plain">EA40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write_lag        </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">flush_lag        </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replay_lag       </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sync_priority    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sync_state       </span><span class="token operator">|</span><span class="token plain"> async</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">reply_time       </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">04</span><span class="token plain"> </span><span class="token number">07</span><span class="token plain">:</span><span class="token number">41</span><span class="token plain">:</span><span class="token number">12.252314</span><span class="token operator">+</span><span class="token number">00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我們也可以使用以下指令來查看 publication 和 subscription 的狀態</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">\dRp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">List </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">of</span><span class="token plain"> publications</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">----------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Name       </span><span class="token operator">|</span><span class="token plain"> test_publication</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Owner      </span><span class="token operator">|</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">All</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">tables</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> f</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Inserts    </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Updates    </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Deletes    </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Truncates  </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Via root   </span><span class="token operator">|</span><span class="token plain"> f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">\dRs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">List </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">of</span><span class="token plain"> subscriptions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> RECORD </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">-------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Name        </span><span class="token operator">|</span><span class="token plain"> test_subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Owner       </span><span class="token operator">|</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Enabled     </span><span class="token operator">|</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Publication </span><span class="token operator">|</span><span class="token plain"> {test_publication}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgbouncer">PgBouncer<a class="hash-link" aria-label="PgBouncer的直接連結" title="PgBouncer的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#pgbouncer">​</a></h2>
<p><img decoding="async" loading="lazy" alt="PgBouncer" src="/RulerChen-Website/assets/images/image-2-ea84074f202988d0af69359a84ceb2b8.png" width="994" height="552" class="img_ev3q"></p>
<p>在正常的情況下，postgres 可以在一秒鐘處理 350 個 transaction，
如果超過的話，我們可能需要考慮使用 connection pool 來進行優化，
這樣可以減少每次連接資料庫時創建 process (fork) 所需要消耗的資源。
PgBouncer 本身沒有支援 multi-host 、 failover 以及 load balancing，
所以如果需要這樣的功能，我們需要使用其他的工具。</p>
<p>pgbouncer 包含三種模式 :</p>
<ul>
<li><code>session</code>: 默認和最安全的模式，client 在連接期間，會持續保持連接，直到 session 結束</li>
<li><code>transaction</code>: client 僅在 transaction 期間保持與資料庫的連接</li>
<li><code>statement</code>: 每個 SQL 語句執行後，連接就會返回到池中</li>
</ul>
<p>在 docker 執行時遇到各種權限問題，待修改 ...</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker run -d --name pg-ha3 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker exec -it --user root pg-ha3 /bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">su postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">initdb -D /tmp/pgbouncer_db/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vi /tmp/pgbouncer_db/postgresql.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set port to 5433</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_ctl -D /tmp/pgbouncer_db start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">exit # exit from postgres user</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apk update &amp;&amp; apk add pgbouncer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd etc/pgbouncer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cp pgbouncer.ini pgbouncer.ini.bak</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vi pgbouncer.ini</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set test_db= dbname=postgres host=localhost port=5433 auth_user=pguser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># set logfile = /tmp/pgbouncer.log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql -p 5433 -U postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE USER pguser SUPERUSER;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pgbouncer pgbouncer.ini</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># adjust min_pool_size、default_pool_size、max_client_conn</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="partition">Partition<a class="hash-link" aria-label="Partition的直接連結" title="Partition的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#partition">​</a></h2>
<p>對於資料量大的表，不管是查詢或是 vacuum 都會需要較長的時間，
這時候我們可以考慮將表進行分割提升效能。
在新版的 postgres 中，partition 多使用 declarative 的方式來進行分割，
而不是 inheritance 的方式。</p>
<p>partition 的方法大致有以下四種 :</p>
<ul>
<li><strong>Range Partition</strong>: 依照範圍來進行分割，像是時間、數值等等</li>
<li><strong>List Partition</strong>: 依照特定的值來進行分割</li>
<li><strong>Hash Partition</strong>: 依照 hash 值來進行分割</li>
<li><strong>Composite Partition</strong>: 結合以上兩種或多種方式來進行分割</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker run -d --name pg-ha4 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker exec -it pg-ha4 /bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">psql -U postgres -d postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> customers </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    id </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TEXT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    age </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">NUMERIC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> RANGE </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> customers_young </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">OF</span><span class="token plain"> customers </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">MINVALUE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">25</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> customers_adult </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">OF</span><span class="token plain"> customers </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">25</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">65</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> customers_old </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">OF</span><span class="token plain"> customers </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">65</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">MAXVALUE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTO</span><span class="token plain"> customers </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;John Doe&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Jane Doe&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;John Smith&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">60</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Jane Smith&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">70</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> tableoid::regclass</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> customers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tableoid     </span><span class="token operator">|</span><span class="token plain"> id </span><span class="token operator">|</span><span class="token plain">    name    </span><span class="token operator">|</span><span class="token plain"> age</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-----------------+----+------------+-----</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> customers_young </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> John Doe   </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> customers_adult </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">2</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> Jane Doe   </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> customers_adult </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">3</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> John Smith </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> customers_old   </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">4</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> Jane Smith </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">70</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">4</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">rows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sharding">Sharding<a class="hash-link" aria-label="Sharding的直接連結" title="Sharding的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#sharding">​</a></h2>
<p>sharding 是將資料分割到多個資料庫，以減輕單個資料庫的負擔。</p>
<p>sharding 的關鍵在於如何選擇 sharding key，
我們需要依據業務場景來選擇合適的 sharding key，
來保證我們的查詢或寫入盡量落在同一個資料庫中。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgresql-high-availability">PostgreSQL High Availability<a class="hash-link" aria-label="PostgreSQL High Availability的直接連結" title="PostgreSQL High Availability的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#postgresql-high-availability">​</a></h2>
<p>在生產環境中，我們需要考慮在各種不同的環境下都能穩定地提供服務，
這時候我們就需要考慮高可用性的問題。</p>
<p>HA 主要分為三個步驟 :</p>
<ol>
<li>replication : 主節點將資料複製到從節點，以保證資料的一致性</li>
<li>failover : 當主節點故障時，從節點自動升級為主節點</li>
</ol>
<ul>
<li><code>pg_ctl promote</code></li>
<li><code>pgpool II</code></li>
<li><code>PAF</code></li>
<li><code>Patroni</code></li>
<li><code>Repmgr</code></li>
</ul>
<ol start="3">
<li>failback : 當主節點恢復正常時，從節點降級為從節點</li>
</ol>
<ul>
<li><code>pg rewind</code></li>
<li><code>pgpool II</code></li>
<li><code>PAF</code></li>
<li><code>Patroni</code></li>
<li><code>Repmgr</code></li>
</ul>
<p>在處理 HA 之前要先定義一些問題</p>
<ol>
<li>資料的重要性
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-4-43ddab330de03fd9be5d3839420acb1a.png" width="1150" height="600" class="img_ev3q"></li>
<li>RTO(Recovery Time Objective) &amp;&amp; RPO(Recovery Point Objective)
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-6-c45c5c7d2f3ce27138d4d9fd9596a702.png" width="903" height="538" class="img_ev3q">
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-7-cf637ecc909fb1861929e56a3baffe4c.png" width="834" height="548" class="img_ev3q"></li>
<li>auto failover 的機制
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-5-188a8cfcf12935273ef3f49331db134a.png" width="1124" height="552" class="img_ev3q">
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-11-6065b5f7679677d4f63bd6c496636501.png" width="1084" height="627" class="img_ev3q"></li>
<li>cross-center replication
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-8-30da38745b6cb7a9f25fa250d4453c6b.png" width="1144" height="575" class="img_ev3q"></li>
<li>do we open replication for read
<img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-9-bbf01b748da17a187599839ada5b5bbd.png" width="921" height="572" class="img_ev3q"></li>
</ol>
<p>解決的架構圖大致如下</p>
<p><img decoding="async" loading="lazy" alt="HA Problem" src="/RulerChen-Website/assets/images/image-12-42d8d39af659e187ed8625550f7b8c80.png" width="1086" height="630" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgpool-ii">Pgpool II<a class="hash-link" aria-label="Pgpool II的直接連結" title="Pgpool II的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#pgpool-ii">​</a></h2>
<p>pgpool 是一個位在資料庫跟客戶端的 middleware，
可以提供 load balancing、failover、connection pooling 等功能，
是一個很好的 HA 解決方案。</p>
<p>docker 開發方法待補充...</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker run -d --name pg-ha5 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker exec -it pg-ha5 /bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">su postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接著需要設定 streaming application，如前所示
再來安裝 pgpool</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apk update &amp;&amp; apk add pgpool-ii</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a class="hash-link" aria-label="Reference的直接連結" title="Reference的直接連結" href="/RulerChen-Website/docs/Database/pg-ha/#reference">​</a></h2>
<ul>
<li><a href="https://www.udemy.com/course/postgresql-replication-high-availability-ha-and-scalability" target="_blank" rel="noopener noreferrer">PostgreSQL Replication, High Availability HA and Scalability</a></li>
<li><a href="https://www.interdb.jp/pg/index.html" target="_blank" rel="noopener noreferrer">The Internals of PostgreSQL</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/RulerChen/RulerChen-Website/tree/main/docs/Database/pg-ha.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>編輯此頁</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最後<!-- -->於 <b><time datetime="2024-08-04T14:40:23.000Z" itemprop="dateModified">2024年8月4日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/RulerChen-Website/docs/Database/pg-tuning/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">[PG] Postgres Tuning</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/RulerChen-Website/docs/SystemDesign/cdn/"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">[SD] CDN 內容傳遞網路</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#scaling-postgresql">Scaling PostgreSQL</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#streaming-replication">Streaming Replication</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#logical-replication">Logical Replication</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#pgbouncer">PgBouncer</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#partition">Partition</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#sharding">Sharding</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#postgresql-high-availability">PostgreSQL High Availability</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#pgpool-ii">Pgpool II</a></li><li><a class="table-of-contents__link toc-highlight" href="/RulerChen-Website/docs/Database/pg-ha/#reference">Reference</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 RulerChen, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>