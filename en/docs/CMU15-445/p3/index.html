<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CMU15-445/p3" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.1"><title data-rh=true>CMU 15-445 2024Fall P3 Query Execution</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:image content=https://RulerChen.github.io/RulerChen-Website/en/img/profile/profile.webp /><meta data-rh=true name=twitter:image content=https://RulerChen.github.io/RulerChen-Website/en/img/profile/profile.webp /><meta data-rh=true property=og:url content=https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/p3/ /><meta data-rh=true property=og:locale content=en /><meta data-rh=true property=og:locale:alternate content=zh_Hant /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docusaurus_version content=current /><meta data-rh=true name=docusaurus_tag content=docs-default-current /><meta data-rh=true name=docsearch:version content=current /><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current /><meta data-rh=true property=og:title content="P3 - Query Execution | RulerChen"/><meta data-rh=true name=description content="Query Execution"/><meta data-rh=true property=og:description content="Query Execution"/><meta data-rh=true name=keywords content="CMU15-445/645,Query Execution,CMU15-445/645 筆記"/><link data-rh=true rel=icon href=/RulerChen-Website/en/img/profile/profile.webp /><link data-rh=true rel=canonical href=https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/p3/ /><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/p3/ hreflang=zh-Hant /><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/p3/ hreflang=en /><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/p3/ hreflang=x-default /><link data-rh=true rel=preconnect href=https://GSV9DQB5UM-dsn.algolia.net crossorigin=anonymous /><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/","name":"CMU 15-445","position":1},{"@type":"ListItem","item":"https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/p3","name":"P3 - Query Execution","position":2}]}</script><link rel=alternate type=application/rss+xml href=/RulerChen-Website/en/blog/rss.xml title="RulerChen's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/RulerChen-Website/en/blog/atom.xml title="RulerChen's Blog Atom Feed"><link rel=alternate type=application/json href=/RulerChen-Website/en/blog/feed.json title="RulerChen's Blog JSON Feed"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script><link rel=search type=application/opensearchdescription+xml title=RulerChen href=/RulerChen-Website/en/opensearch.xml><link rel=preconnect href=https://cdn.jsdelivr.net crossorigin=anonymous><link rel=preconnect href=https://fonts.googleapis.com crossorigin=anonymous><link rel=preconnect href=https://fonts.gstatic.com crossorigin=anonymous><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><link rel=stylesheet href=/RulerChen-Website/en/assets/css/styles.68e07ae9.css /><script src=/RulerChen-Website/en/assets/js/runtime~main.bfac46ca.js defer></script><script src=/RulerChen-Website/en/assets/js/main.8950f972.js defer></script></head><body class=navigation-with-keyboard><svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t;document.documentElement.setAttribute("data-theme",t||"dark"),document.documentElement.setAttribute("data-theme-choice",t||"dark")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/RulerChen-Website/en/img/profile/profile.webp /><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/RulerChen-Website/en/><div class=navbar__logo><img src=/RulerChen-Website/en/img/profile/profile.webp alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"/><img src=/RulerChen-Website/en/img/profile/profile.webp alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"/></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/RulerChen-Website/en/docs/intro/>Notes</a><a class="navbar__item navbar__link" href=/RulerChen-Website/en/blog/>Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>English</a><ul class=dropdown__menu><li><a href=/RulerChen-Website/docs/CMU15-445/p3/ target=_self rel="noopener noreferrer" class=dropdown__link lang=zh-Hant>繁體中文</a><li><a href=/RulerChen-Website/en/docs/CMU15-445/p3/ target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=en>English</a></ul></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Meta+k)" aria-keyshortcuts=Meta+k><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 24 24" aria-hidden=true><circle cx=11 cy=11 r=8 stroke=currentColor fill=none stroke-width=1.4 /><path d="m21 21-4.3-4.3" stroke=currentColor fill=none stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/RulerChen-Website/en/docs/intro/><span title=Roadmap class=linkLabel_WmDU>Roadmap</span></a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/RulerChen-Website/en/docs/CMU15-213/><span title="CMU 15-213" class=categoryLinkLabel_W154>CMU 15-213</span></a><button aria-label="Expand sidebar category 'CMU 15-213'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href=/RulerChen-Website/en/docs/CMU15-445/><span title="CMU 15-445" class=categoryLinkLabel_W154>CMU 15-445</span></a><button aria-label="Collapse sidebar category 'CMU 15-445'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c01/><span title="Relational Model & Algebra" class=linkLabel_WmDU>Relational Model & Algebra</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c02/><span title="Modern SQL" class=linkLabel_WmDU>Modern SQL</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c03/><span title="Database Storage" class=linkLabel_WmDU>Database Storage</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c05/><span title="Storage Models & Compression" class=linkLabel_WmDU>Storage Models & Compression</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c06/><span title="Memory & Disk I/O Management" class=linkLabel_WmDU>Memory & Disk I/O Management</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c07/><span title="Hash Tables" class=linkLabel_WmDU>Hash Tables</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c08/><span title="Indexes & Filters" class=linkLabel_WmDU>Indexes & Filters</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c09/><span title="Index Concurrency Control" class=linkLabel_WmDU>Index Concurrency Control</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c11/><span title="Sorting & Aggregations Algorithms" class=linkLabel_WmDU>Sorting & Aggregations Algorithms</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c12/><span title="Joins Algorithms" class=linkLabel_WmDU>Joins Algorithms</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c13/><span title="Query Execution" class=linkLabel_WmDU>Query Execution</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c15/><span title="Query Planning & Optimization" class=linkLabel_WmDU>Query Planning & Optimization</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c16/><span title="Concurrency Control Theory" class=linkLabel_WmDU>Concurrency Control Theory</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c17/><span title="Two-Phase Locking Concurrency Control" class=linkLabel_WmDU>Two-Phase Locking Concurrency Control</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c18/><span title="Timestamp Ordering Concurrency Control" class=linkLabel_WmDU>Timestamp Ordering Concurrency Control</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c19/><span title="Multi-Version Concurrency Control" class=linkLabel_WmDU>Multi-Version Concurrency Control</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c20/><span title="Database Logging" class=linkLabel_WmDU>Database Logging</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c21/><span title="Database Recovery" class=linkLabel_WmDU>Database Recovery</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c22/><span title="Introduction to Distributed Databases" class=linkLabel_WmDU>Introduction to Distributed Databases</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c23/><span title="Distributed OLTP Database Systems" class=linkLabel_WmDU>Distributed OLTP Database Systems</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c24/><span title="Distributed OLAP Database Systems" class=linkLabel_WmDU>Distributed OLAP Database Systems</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p0/><span title="P0 - C++ Primer" class=linkLabel_WmDU>P0 - C++ Primer</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p1/><span title="P1 - Buffer Pool Manager" class=linkLabel_WmDU>P1 - Buffer Pool Manager</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p2/><span title="P2 - B+ Tree" class=linkLabel_WmDU>P2 - B+ Tree</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p3/><span title="P3 - Query Execution" class=linkLabel_WmDU>P3 - Query Execution</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p4/><span title="P4 - Concurrency Control" class=linkLabel_WmDU>P4 - Concurrency Control</span></a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/RulerChen-Website/en/docs/Security/><span title=Security class=categoryLinkLabel_W154>Security</span></a><button aria-label="Expand sidebar category 'Security'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/RulerChen-Website/en/docs/SystemDesign/><span title="System Design" class=categoryLinkLabel_W154>System Design</span></a><button aria-label="Expand sidebar category 'System Design'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/RulerChen-Website/en/docs/Other/shell/><span title=Other class=categoryLinkLabel_W154>Other</span></a></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_z5aJ"><div class=docItemContainer_c0TR><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/RulerChen-Website/en/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/RulerChen-Website/en/docs/CMU15-445/><span>CMU 15-445</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>P3 - Query Execution</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>P3 - Query Execution</h1></header>
<p>在這個 project 中，我們需要實現一個 query execution engine，總共有 4 個 task :</p>
<ul>
<li>Access Method Executors</li>
<li>Aggregation & Join Executors</li>
<li>HashJoin Executor and Optimization</li>
<li>External Merge Sort + Limit Executors</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=background>Background<a href=#background class=hash-link aria-label="Direct link to Background" title="Direct link to Background" translate=no>​</a></h2>
<p>這個 project 的背景知識相對比較複雜，需要大量閱讀程式碼來了解整個結構。</p>
<p>我會介紹一下整個 SQL 從輸入到執行的流程以及資料儲存的結構來方便大家理解。
如果還是有卡住的話，我建議可以先去看一些已經實現好的 Executor 來了解整個流程。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=sql-query-journey>SQL Query Journey<a href=#sql-query-journey class=hash-link aria-label="Direct link to SQL Query Journey" title="Direct link to SQL Query Journey" translate=no>​</a></h3>
<p>這邊會用一個簡單的 SQL 當作範例，簡單介紹一下 bustub 中 SQL 是怎麼被執行的。
範例這部分我是用 AI 幫忙生成的，不一定是真正的欄位但能了解意思就好 :</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">course</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> student s</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">JOIN</span><span class="token plain"> enrollment e </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ON</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id </span><span class="token operator">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sid</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">age </span><span class="token operator">></span><span class="token plain"> </span><span class="token number">18</span><span class="token plain"></span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br/></span></code></pre></div></div>
<figure class=image-modal-container><img src=/RulerChen-Website/en/img/cmu15-445/p3/image.webp alt="" width=100% class=image-modal-thumbnail style=cursor:pointer loading=lazy /><figcaption class=image-modal-caption>SQL Query Journey</figcaption></figure>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=entrypoint>Entrypoint<a href=#entrypoint class=hash-link aria-label="Direct link to Entrypoint" title="Direct link to Entrypoint" translate=no>​</a></h4>
<p>Shell 的入口點在 <code>src/tools/shell/shell.cpp</code>，負責創建 <code>BustubInstance</code> 實例並呼叫 <code>bustub->ExecuteSql()</code> 來執行 SQL。</p>
<p><code>BustubInstance</code> 的 <code>ExecuteSql()</code> 函數是執行 SQL 的主要入口，它會呼叫 <code>ExecuteSqlTxn()</code> 來執行查詢，如果出現錯誤則會呼叫 <code>Abort()</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=parser>Parser<a href=#parser class=hash-link aria-label="Direct link to Parser" title="Direct link to Parser" translate=no>​</a></h4>
<p>首先 query 會先進入 parser，parser 的作用是將 SQL 解析成 AST，這部分 bustub 是使用第三方的工具 <code>libpg_query</code> 來完成的。</p>
<p>在 <code>ExecuteSqlTxn()</code> 中 bustub 會呼叫 <code>ParseAndSave()</code> 來將 SQL 解析成 AST，並把結果存到 <code>statement_nodes_</code> 中。</p>
<p>以上面的 SQL 為例，解析後的 AST 可能會長這樣 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">PGSelectStmt {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  targetList: [</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    PGResTarget { name: "id", val: PGColumnRef { fields: ["s", "id"] } },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    PGResTarget { name: "name", val: PGColumnRef { fields: ["s", "name"] } },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    PGResTarget { name: "course", val: PGColumnRef { fields: ["e", "course"] } }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  ],</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  fromClause: [</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    PGJoinExpr {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      jointype: JOIN_INNER,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      larg: PGRangeVar { relname: "student", alias: "s" },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      rarg: PGRangeVar { relname: "enrollment", alias: "e" },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      quals: PGAExpr { op: "=", lexpr: "s.id", rexpr: "e.sid" }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  ],</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  whereClause: PGAExpr { op: ">", lexpr: "s.age", rexpr: 18 },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  limitCount: 10</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">}</span><br/></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=binder>Binder<a href=#binder class=hash-link aria-label="Direct link to Binder" title="Direct link to Binder" translate=no>​</a></h4>
<p>接著這個 AST 就會交給 binder，binder 的作用是透過 Catalog 將 AST 中的名稱綁定到實際的資料庫物件上。</p>
<p>在 <code>ExecuteSqlTxn()</code> 中，<code>BindStatement()</code> 函數會負責這個工作。</p>
<p>以上面的 SQL 為例，綁定之後的 AST 可能會長這樣，可以看到它已經有 <code>table_oid</code> 跟 <code>col_idx</code> 了 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">SelectStatement {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  select_list_: [</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    BoundColumnRef { col_name: "id", type: INTEGER, table_oid: 1, col_idx: 0 },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    BoundColumnRef { col_name: "name", type: VARCHAR, table_oid: 1, col_idx: 1 },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    BoundColumnRef { col_name: "course", type: VARCHAR, table_oid: 2, col_idx: 1 }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  ],</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  table_: BoundJoinRef {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    type: INNER_JOIN,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    left: BoundBaseTableRef { </span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      table: "student", </span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      alias: "s", </span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      oid: 1,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      schema: [id:INTEGER, name:VARCHAR, age:INTEGER]</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    right: BoundBaseTableRef { </span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      table: "enrollment", </span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      alias: "e", </span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      oid: 2,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      schema: [sid:INTEGER, course:VARCHAR]</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    condition: BoundBinaryOp {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      op_type: EQUAL,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      left: BoundColumnRef { col_name: "id", table_oid: 1, col_idx: 0 },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      right: BoundColumnRef { col_name: "sid", table_oid: 2, col_idx: 0 }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  where_: BoundBinaryOp {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    op_type: GREATER_THAN,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    left: BoundColumnRef { col_name: "age", table_oid: 1, col_idx: 2 },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    right: BoundConstant { value: 18, type: INTEGER }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  limit_: BoundConstant { value: 10, type: INTEGER }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">}</span><br/></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=planner>Planner<a href=#planner class=hash-link aria-label="Direct link to Planner" title="Direct link to Planner" translate=no>​</a></h4>
<p>綁定好物件之後就會交給 planner，planner 的作用是將綁定好的 AST 轉換成執行計劃 (PlanNode)。</p>
<p><code>Planner</code> 的 <code>PlanQuery()</code> 函數會將 <code>Binder</code> 轉換為 <code>PlanNode</code>，這是一個樹狀結構，表示 SQL 語句的執行計劃。</p>
<p>以上面的 SQL 為例，轉換後的執行計劃可能會長這樣 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">LimitPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  limit_: 10,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  child_: ProjectionPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    expressions_: [</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      ColumnValueExpression { col_idx: 0 }, // s.id</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      ColumnValueExpression { col_idx: 1 }, // s.name  </span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      ColumnValueExpression { col_idx: 4 }  // e.course (after join)</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    ],</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    output_schema_: Schema([id:INTEGER, name:VARCHAR, course:VARCHAR]),</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    child_: FilterPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      predicate_: ComparisonExpression {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        op_: GREATER_THAN,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        left_: ColumnValueExpression { col_idx: 2 }, // s.age</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        right_: ConstantValueExpression { value: 18 }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      child_: NestedLoopJoinPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        join_type_: INNER,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        join_predicate_: ComparisonExpression {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">          op_: EQUAL,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">          left_: ColumnValueExpression { col_idx: 0 }, // s.id</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">          right_: ColumnValueExpression { col_idx: 3 }  // e.sid</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        output_schema_: Schema([id:INTEGER, name:VARCHAR, age:INTEGER, sid:INTEGER, course:VARCHAR]),</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        left_child_: SeqScanPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">          table_oid_: 1, // student table</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">          output_schema_: Schema([id:INTEGER, name:VARCHAR, age:INTEGER])</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        right_child_: SeqScanPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">          table_oid_: 2, // enrollment table</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">          output_schema_: Schema([sid:INTEGER, course:VARCHAR])</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">}</span><br/></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=optimizer>Optimizer<a href=#optimizer class=hash-link aria-label="Direct link to Optimizer" title="Direct link to Optimizer" translate=no>​</a></h4>
<p>接著就會交給 optimizer 來優化執行計劃，這裡 bustub 採用的是 rule-based 的方式，也就是它會一條一條規則的套用到執行計劃上。</p>
<p><code>Optimizer</code> 的 <code>Optimize()</code> 函數會檢查這些規則並套用到 <code>PlanNode</code> 上，比如說我們要實作的 <code>OptimizeNLJAsIndexJoin</code>。</p>
<p>以上面的 SQL 為例，優化後的執行計劃可能會長這樣，改成使用 NestedIndexJoin 並做了 predicate pushdown :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">LimitPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  limit_: 10,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  child_: ProjectionPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    expressions_: [</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      ColumnValueExpression { col_idx: 0 },  // s.id</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      ColumnValueExpression { col_idx: 1 },  // s.name</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      ColumnValueExpression { col_idx: 4 }   // e.course</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    ],</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    child_: NestedIndexJoinPlanNode {        </span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      outer_child_: FilterPlanNode {</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        predicate_: ComparisonExpression { op: GT, left: age, right: 18 },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">        child_: SeqScanPlanNode { table: "student" }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      },</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      key_predicate_: ColumnValueExpression { col_idx: 0 },  // s.id</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      inner_table_oid_: 2,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      index_oid_: 5,</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">      index_name_: "enrollment_sid_idx"</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">    }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">  }</span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">}</span><br/></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=executor>Executor<a href=#executor class=hash-link aria-label="Direct link to Executor" title="Direct link to Executor" translate=no>​</a></h4>
<p>最後就是交給 executor 來將 <code>PlanNode</code> 轉換成對應的 <code>Executor</code>，這裡 bustub 採用的是 pull-based 的 volcano model，也就是每個 <code>Executor</code> 都有 <code>Init()</code> 跟 <code>Next()</code> 兩個方法，並且上層的 <code>Executor</code> 會不斷呼叫下層的 <code>Executor</code> 的 <code>Next()</code> 來取得資料直到回傳 false 為止。</p>
<p>Executor 的入口點在 <code>src/execution/executor_engine.cpp</code>，它會呼叫 <code>ExecutorFactory::CreateExecutor()</code> 來遞迴地針對不同種類的 <code>PlanNode</code> 創建對應的 <code>Executor</code>。
同時它也會呼叫 <code>Init()</code> 來初始化整個 executor 樹，最後呼叫 <code>PollExecutor()</code> 來不斷的 pull 資料直到沒有資料為止。</p>
<p>除此之外，<code>ExecutorContext</code> 也會在這個時候被創建，它包含了 <code>Transaction</code>、<code>Catalog</code>、<code>BufferPoolManager</code> 等等執行時需要的物件。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=storage-structure>Storage Structure<a href=#storage-structure class=hash-link aria-label="Direct link to Storage Structure" title="Direct link to Storage Structure" translate=no>​</a></h3>
<p>在了解了整個 SQL 的執行流程之後，我們還需要了解一下資料庫中的結構以及這些結構是如何被儲存的。</p>
<figure class=image-modal-container><img src=/RulerChen-Website/en/img/cmu15-445/p3/storage.webp alt="" width=100% class=image-modal-thumbnail style=cursor:pointer loading=lazy /><figcaption class=image-modal-caption>Storage Structure</figcaption></figure>
<ul>
<li><code>Catalog</code> : 最頂層的結構，負責管理資料表跟索引，有 <code>CreateTable()</code>、<code>GetTable()</code>、<code>CreateIndex()</code>、<code>GetIndex()</code> 等等方法</li>
<li><code>TableInfo</code> : 代表一個資料表，包含了 <code>Schema</code>、<code>TableHeap</code>、<code>TableOid</code>、<code>Name</code> 等等資訊</li>
<li><code>IndexInfo</code> : 代表一個索引，包含了 <code>Schema</code>、<code>Index</code>、<code>IndexOid</code>、<code>Name</code> 等等資訊</li>
<li><code>TableHeap</code> : 代表 page 的儲存結構，維護 <code>first_page_id_</code> 跟 <code>last_page_id_</code> 方便插入跟查詢資料，同時提供了很多很有用的方法，例如 <code>InsertTuple()</code>、<code>GetTuple()</code>、<code>UpdateTupleMeta()</code>、<code>UpdateTupleInPlaceWithLockAcquired()</code></li>
<li><code>TablePage</code> : 代表一個 page，採用 slotted-page 的結構來儲存 tuple</li>
<li><code>Tuple</code> : 代表一筆資料，包含了 <code>RID</code> (由 page id / slot num 組成) 跟 <code>data</code>，<code>data</code> 裡面有多個 <code>Value</code>，<code>Value</code> 可以代表不同的資料型態</li>
<li><code>TupleInfo</code> : 代表 tuple 在 page 中的 offset 跟 size 以及 <code>TupleMeta</code>，<code>TupleMeta</code> 包含了 <code>is_deleted_</code> 跟 <code>ts_</code> (timestamp)</li>
<li><code>Schema</code> : 代表資料表的 schema，包含了多個 <code>Column</code></li>
<li><code>Column</code> : 代表一個欄位，包含了欄位名稱、欄位類型、欄位長度等等資訊</li>
</ul>
<p>在 executor 中，如果我們要讀取資料表的資料，通常會要通過 <code>exec_ctx_->GetCatalog()</code> 先取得 <code>Catalog</code>，然後再繼續往下取得 <code>TableInfo</code>、<code>TableHeap</code> 等我們需要的資訊。</p>
<p>整體來說單一的函數實作起來難度應該不是太高，所以下面我就簡單說明一下流程跟一些可能會用到的方法就好。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=task-1---access-method-executors>Task 1 - Access Method Executors<a href=#task-1---access-method-executors class=hash-link aria-label="Direct link to Task 1 - Access Method Executors" title="Direct link to Task 1 - Access Method Executors" translate=no>​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=seqscan>SeqScan<a href=#seqscan class=hash-link aria-label="Direct link to SeqScan" title="Direct link to SeqScan" translate=no>​</a></h3>
<p>使用 <code>TableIterator</code> 來掃描，注意跳過被刪除的資料跟 WHERE 條件，可以用 <code>Evaluate()</code> 來判斷 WHERE 條件。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=insert>Insert<a href=#insert class=hash-link aria-label="Direct link to Insert" title="Direct link to Insert" translate=no>​</a></h3>
<p>除了 <code>TableHeap::InsertTuple()</code> 之外，還需要新增索引，可以用 <code>InsertEntry()</code> 來新增索引，key 可以用 <code>KeyFromTuple()</code> 來取得。</p>
<p>需要注意要有一個參數負責記錄之前有沒有回傳過結果了，因為上層會不斷呼叫 <code>Next()</code>，如果已經回傳過結果了就要回傳 false，包括後面的一些 executor 也是一樣。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=update>Update<a href=#update class=hash-link aria-label="Direct link to Update" title="Direct link to Update" translate=no>​</a></h3>
<p>先把舊的 TupleMeta 使用 <code>UpdateTupleMeta()</code> 標記為刪除，接著把 index 刪除，然後再插入新的 tuple 並插入新的索引。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=delete>Delete<a href=#delete class=hash-link aria-label="Direct link to Delete" title="Direct link to Delete" translate=no>​</a></h3>
<p>沒啥特別好說的，就是把 TupleMeta 標記為刪除，然後刪除索引。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=indexscan>IndexScan<a href=#indexscan class=hash-link aria-label="Direct link to IndexScan" title="Direct link to IndexScan" translate=no>​</a></h3>
<p>用 <code>pred_keys_</code> 判斷是點查詢還是範圍查詢，如果是點查詢就用 <code>ScanKey()</code> 查詢每一個 key，如果是範圍查詢就直接用 B+ tree 的迭代器來掃描。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=indexscan-optimizer>IndexScan Optimizer<a href=#indexscan-optimizer class=hash-link aria-label="Direct link to IndexScan Optimizer" title="Direct link to IndexScan Optimizer" translate=no>​</a></h3>
<p>首先要先遞迴來遍歷整個 <code>AbstractPlanNodeRef</code>，接著檢查是不是 seq_scan + filter 的組合，並看看有沒有 index 可以用。</p>
<p>有三種情況要處理 :</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> t1 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> v1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> t1 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> v1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> t1 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> v1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">OR</span><span class="token plain"> v1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br/></span></code></pre></div></div>
<p>對於前兩種情況，我們需要檢查謂詞是否為 <code>ComparisonExpression</code>，且比較類型為 Equal。
接著檢查左右子節點，確保一邊是 <code>ColumnValueExpression</code> (變數)，另一邊是 <code>ConstantValueExpression</code>(常數)。
再來檢查 <code>ColumnValueExpression</code> 的 <code>col_idx</code> 是否與某個可用索引的第一個鍵值欄位相符。
最後檢查 <code>GetTupleIdx() == 0</code>，這個檢查確保了這個欄位屬於當前正在掃描的這張表。</p>
<p>對於第三種情況，我們需要遞迴地分析。
如果表達式是一個 <code>LogicExpression</code> 且邏輯類型是 <code>LogicType::Or</code>，那麼我們就遞迴地對其左右子表達式應用前兩種情況的判斷邏輯。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=task-2---aggregation--join-executors>Task 2 - Aggregation & Join Executors<a href=#task-2---aggregation--join-executors class=hash-link aria-label="Direct link to Task 2 - Aggregation & Join Executors" title="Direct link to Task 2 - Aggregation & Join Executors" translate=no>​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=aggregation>Aggregation<a href=#aggregation class=hash-link aria-label="Direct link to Aggregation" title="Direct link to Aggregation" translate=no>​</a></h3>
<p>首先要完成 <code>CombineAggregateValues</code> 中幾種函數的實作，這部分比較簡單，主要是要注意 <code>NULL</code> 的處理。</p>
<p>這個 executor 是一個 pipeline breaker，所以在 <code>Init()</code> 的時候就要把所有資料都讀進來並計算好結果，可以利用 <code>MakeAggregateKey</code>、<code>MakeAggregateValue</code> 並丟到 <code>InsertCombine()</code> 來做。
最後輸出的時候要把 <code>AggregateKey</code> 跟 <code>AggregateValue</code> 的條件也一起輸出方便上面的 <code>Projection</code> 使用。</p>
<p>需要特別處理 empty input 的情況，可以呼叫 <code>GenerateInitialAggregateValue()</code> 來產生初始值。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=nestedloopjoin>NestedLoopJoin<a href=#nestedloopjoin class=hash-link aria-label="Direct link to NestedLoopJoin" title="Direct link to NestedLoopJoin" translate=no>​</a></h3>
<p>需要處理 INNER JOIN 跟 LEFT JOIN 兩種情況。
這裡我的做法是先讀左邊的一個 tuple，然後重新 <code>Init()</code> 右邊的 executor，接著不斷呼叫右邊的 <code>Next()</code> 並用 <code>EvaluateJoin</code> 來判斷有沒有符合條件，如果有就把兩個 tuple 合併起來並回傳。</p>
<p>如果是 <code>LEFT JOIN</code> 的話，當右邊的 executor 掃描完之後還沒有找到符合條件的 tuple，就要回傳左邊的 tuple 並把右邊的欄位設為 <code>NULL</code>，可以使用 <code>ValueFactory::GetNullValueByType()</code> 來產生 <code>NULL</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=nestedindexjoin>NestedIndexJoin<a href=#nestedindexjoin class=hash-link aria-label="Direct link to NestedIndexJoin" title="Direct link to NestedIndexJoin" translate=no>​</a></h3>
<p>整體邏輯跟 <code>NestedLoopJoin</code> 差不多，差別在於右邊的 executor 是一個 <code>IndexScan</code>，所以每次讀左邊的 tuple 之後要用 <code>KeyPredicate</code> 來生成 probe key。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=task-3---hashjoin-executor-and-optimization>Task 3 - HashJoin Executor and Optimization<a href=#task-3---hashjoin-executor-and-optimization class=hash-link aria-label="Direct link to Task 3 - HashJoin Executor and Optimization" title="Direct link to Task 3 - HashJoin Executor and Optimization" translate=no>​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=hashjoin>HashJoin<a href=#hashjoin class=hash-link aria-label="Direct link to HashJoin" title="Direct link to HashJoin" translate=no>​</a></h3>
<p>這個 task 要做的事情還蠻多的，除了 <code>Init()</code> 跟 <code>Next()</code> 之外，還要實作針對 <code>std::vector&lt;Value></code> 的 hash 方法。</p>
<p>我實作了一個 <code>JoinKey</code> 的 class 來代表 join key，並且實作了 <code>operator==</code> 跟 <code>std::hash</code> 來讓它可以被 hash，這部分可以大致參考 <code>AggregationPlanNode</code> 的實作。</p>
<p>在 <code>Init()</code> 的時候可以先把一邊的資料都讀進來並建立 hash table，我的儲存方式是 <code>std::unordered_map&lt;JoinKey, std::vector&lt;Tuple>></code>。</p>
<p>在 <code>Next()</code> 的時候就不斷讀另一邊的資料，然後用 join key 去 hash table 裡面找有沒有符合的 tuple，如果有就把兩個 tuple 合併起來並回傳，需要特別處理一對多的情況。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=hashjoin-optimizer>HashJoin Optimizer<a href=#hashjoin-optimizer class=hash-link aria-label="Direct link to HashJoin Optimizer" title="Direct link to HashJoin Optimizer" translate=no>​</a></h3>
<p>有兩種情況可以優化成 HashJoin :</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> t1 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">JOIN</span><span class="token plain"> t2 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ON</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">v1 </span><span class="token operator">=</span><span class="token plain"> t2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">v1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> t1 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">JOIN</span><span class="token plain"> t2 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ON</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">v1 </span><span class="token operator">=</span><span class="token plain"> t2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">v1 </span><span class="token operator">AND</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">v2 </span><span class="token operator">=</span><span class="token plain"> t2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">v2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br/></span></code></pre></div></div>
<p>首先，跟其他 optimizer 一樣需要先把樹遞迴到底在開始。</p>
<p>對於第一種情況來說，需要檢查掃描方法是不是 <code>NestedLoopJoin</code> 且是透過 <code>ComparisonType::Equal</code> 跟 <code>ColumnValueExpression</code> 來 join 的，接著再確定他們是不是來自不同的 table。</p>
<p>對於第二種情況來說，還需要考慮 AND 的情況，可以用遞迴的方式來檢查 <code>LogicExpression</code> 是不是 <code>LogicType::And</code>，然後檢查左右子節點符不符合第一種情況的條件。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=task-4---external-merge-sort--limit-executors>Task 4 - External Merge Sort + Limit Executors<a href=#task-4---external-merge-sort--limit-executors class=hash-link aria-label="Direct link to Task 4 - External Merge Sort + Limit Executors" title="Direct link to Task 4 - External Merge Sort + Limit Executors" translate=no>​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=external-merge-sort>External Merge Sort<a href=#external-merge-sort class=hash-link aria-label="Direct link to External Merge Sort" title="Direct link to External Merge Sort" translate=no>​</a></h3>
<p>首先要實作 <code>TupleComparator::operator()</code> 來比較兩個 tuple 的大小，這部分可以用 <code>Value</code> 裡面的 <code>CompareEquals()</code>、<code>CompareLessThan()</code> 來比較大小，要區分 <code>ASC</code> (<code>DEFAULT</code>) 跟 <code>DESC</code>。</p>
<p>接著實作 <code>GenerateSortKey()</code> 來產生排序的 key，可以用 <code>MakeKeyFromTuple()</code> 來產生。</p>
<p>然後需要實作 <code>SortPage</code> 跟 <code>MergeSortRun</code> 來代表硬碟上的 page 以及一個邏輯上的 run，可以自行依據需求寫一些 helper function。
在我自己的實作中，<code>SortPage</code> 會包含一個成員 <code>char data_[BUSTUB_PAGE_SIZE]</code>，這個成員的前 4 個 byte 會用來記錄這個 page 裡面有多少個 tuple，剩下的空間就用來放 tuple 的資料。</p>
<p>這邊有兩個問題要注意，第一個是要在 <code>MergeSortRun</code> 中的 <code>Iterator</code> 保留上一次讀取的 <code>ReadPageGuard</code>，不然測試很容易超時。
第二個是如果遇到了 <code>test incurred 0 times of disk deletion, which is too low</code> 的錯誤訊息，代表有可能在 project 1 的時候就沒有正確使用 <code>disk_scheduler_->DeallocatePage()</code> 導致它抓不到 page 的刪除次數。</p>
<p>最後就是實作真正的 <code>ExternalMergeSortExecutor</code> 了，這裡我實作了 4 個 helper function 來分別處理不同的階段 :</p>
<ul>
<li><code>CreateInitialRuns()</code> : 從 child executor 拉 tuple，組成 <code>&lt;sort_key, tuple></code> 的 pair，滿一個 page 的大小就呼叫 <code>FlushRunToDisk()</code> 來把這些 tuple 排序並寫到硬碟上</li>
<li><code>FlushRunToDisk()</code> : 把一個 run 的 tuple 排序並寫到硬碟上，這裡可以用 <code>std::sort()</code> 來排序，並寫入到 <code>SortPage</code> 中最後把 page_id 記錄起來並塞回硬碟中</li>
<li><code>MergeRuns()</code> : 每次取出兩個 page 並呼叫 <code>MergeTwoRuns()</code> 來合併成一個新的 run，最後回傳新的 run 的 page_id</li>
<li><code>MergeTwoRuns()</code> : 運用兩個 iterator 來將兩個 <code>MergeSortRun</code> 合併成一個新的 <code>MergeSortRun</code></li>
</ul>
<p>同時這個 executor 也是一個 pipeline breaker，所以在 <code>Init()</code> 的時候就要把所有資料都讀進來並排序好，最後在 <code>Next()</code> 的時候只需要不斷地從排序好的 run 中讀取 tuple 並回傳。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=limit>Limit<a href=#limit class=hash-link aria-label="Direct link to Limit" title="Direct link to Limit" translate=no>​</a></h3>
<p>這應該是最簡單的 executor，只需要在 <code>Next()</code> 的時候計數，當超過 limit 的數量就回傳 false。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=submit>Submit<a href=#submit class=hash-link aria-label="Direct link to Submit" title="Direct link to Submit" translate=no>​</a></h2>
<p>如果要執行 SQL，可以使用以下指令或是到<a href=https://15445.courses.cs.cmu.edu/fall2024/bustub/ target=_blank rel="noopener noreferrer">這個網站</a>上執行 :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> -j</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">nproc</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"> shell </span><span class="token operator">&&</span><span class="token plain"> ./bin/bustub-shell</span><br/></span></code></pre></div></div>
<p>測試的方式有點麻煩，要自己一個一個試 :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> -j</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">nproc</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"> sqllogictest </span><span class="token operator">&&</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br/></span><span class=token-line style=color:#F8F8F2><span class="token plain">./bin/bustub-sqllogictest </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">/test/sql/p3.05-index-scan-btree.slt </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--verbose</span><br/></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">format</span><span class="token plain"> </span><span class="token operator">&&</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> check-format </span><span class="token operator">&&</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> check-lint </span><span class="token operator">&&</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> check-clang-tidy-p3</span><br/></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> submit-p3</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=takeaways>Takeaways<a href=#takeaways class=hash-link aria-label="Direct link to Takeaways" title="Direct link to Takeaways" translate=no>​</a></h2>
<p>這個 project 做起來其實蠻無聊的，因為大部分都是照著規格一步一步實作就好，沒有什麼特別的技巧，不過因為要看的東西不少，所以還是花了我蠻多時間的。</p>
<p>對於想要快速通關的人來說我覺得 AI 在這個 project 上面應該可以幫助很大，但要注意一定要能理解 AI 幫你寫的東西，因為下一個 project 會需要在這個 project 的基礎上繼續實作。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=references>References<a href=#references class=hash-link aria-label="Direct link to References" title="Direct link to References" translate=no>​</a></h2>
<ul>
<li><a href=https://zhuanlan.zhihu.com/p/5843407385 target=_blank rel="noopener noreferrer">CMU Fall 2024 15-445 P3[待优化]&PaperNotes</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/587566135 target=_blank rel="noopener noreferrer">做个数据库：2022 CMU15-445 Project3 Query Execution</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/570917775 target=_blank rel="noopener noreferrer">BusTub 养成记：从课程项目到 SQL 数据库</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/593909820 target=_blank rel="noopener noreferrer">CMU 15445-2022 P3 Query Optimize</a></li>
<li><a href=https://juejin.cn/post/7527199538878939146 target=_blank rel="noopener noreferrer">CMU15445-2024fall-project3 踩坑经历</a></li>
</ul></div><div style=margin-top:32px></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/RulerChen-Website/en/docs/tags/cmu-15-445/>CMU15-445</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/RulerChen-Website/en/docs/tags/cmu-15-445-projects/>CMU15-445 Projects</a></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/RulerChen/RulerChen-Website/tree/main/docs/CMU15-445/p3.mdx target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated>Last updated<!-- --> on <b><time datetime=2025-09-21T12:45:45.000Z itemprop=dateModified>Sep 21, 2025</time></b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/RulerChen-Website/en/docs/CMU15-445/p2/><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>P2 - B+ Tree</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/RulerChen-Website/en/docs/CMU15-445/p4/><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>P4 - Concurrency Control</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#background class="table-of-contents__link toc-highlight">Background</a><ul><li><a href=#sql-query-journey class="table-of-contents__link toc-highlight">SQL Query Journey</a><li><a href=#storage-structure class="table-of-contents__link toc-highlight">Storage Structure</a></ul><li><a href=#task-1---access-method-executors class="table-of-contents__link toc-highlight">Task 1 - Access Method Executors</a><ul><li><a href=#seqscan class="table-of-contents__link toc-highlight">SeqScan</a><li><a href=#insert class="table-of-contents__link toc-highlight">Insert</a><li><a href=#update class="table-of-contents__link toc-highlight">Update</a><li><a href=#delete class="table-of-contents__link toc-highlight">Delete</a><li><a href=#indexscan class="table-of-contents__link toc-highlight">IndexScan</a><li><a href=#indexscan-optimizer class="table-of-contents__link toc-highlight">IndexScan Optimizer</a></ul><li><a href=#task-2---aggregation--join-executors class="table-of-contents__link toc-highlight">Task 2 - Aggregation & Join Executors</a><ul><li><a href=#aggregation class="table-of-contents__link toc-highlight">Aggregation</a><li><a href=#nestedloopjoin class="table-of-contents__link toc-highlight">NestedLoopJoin</a><li><a href=#nestedindexjoin class="table-of-contents__link toc-highlight">NestedIndexJoin</a></ul><li><a href=#task-3---hashjoin-executor-and-optimization class="table-of-contents__link toc-highlight">Task 3 - HashJoin Executor and Optimization</a><ul><li><a href=#hashjoin class="table-of-contents__link toc-highlight">HashJoin</a><li><a href=#hashjoin-optimizer class="table-of-contents__link toc-highlight">HashJoin Optimizer</a></ul><li><a href=#task-4---external-merge-sort--limit-executors class="table-of-contents__link toc-highlight">Task 4 - External Merge Sort + Limit Executors</a><ul><li><a href=#external-merge-sort class="table-of-contents__link toc-highlight">External Merge Sort</a><li><a href=#limit class="table-of-contents__link toc-highlight">Limit</a></ul><li><a href=#submit class="table-of-contents__link toc-highlight">Submit</a><li><a href=#takeaways class="table-of-contents__link toc-highlight">Takeaways</a><li><a href=#references class="table-of-contents__link toc-highlight">References</a></ul></div></div></div></div></main></div></div></div></div></body>