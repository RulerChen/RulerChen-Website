<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CMU15-445/p1" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.1"><title data-rh=true>CMU 15-445 2024Fall P1 Buffer Pool Manager</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://RulerChen.github.io/RulerChen-Website/en/img/profile/profile.webp><meta data-rh=true name=twitter:image content=https://RulerChen.github.io/RulerChen-Website/en/img/profile/profile.webp><meta data-rh=true property=og:url content=https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/p1/><meta data-rh=true property=og:locale content=en><meta data-rh=true property=og:locale:alternate content=zh_Hant><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="P1 - Buffer Pool Manager | RulerChen"><meta data-rh=true name=description content="Buffer Pool Manager"><meta data-rh=true property=og:description content="Buffer Pool Manager"><meta data-rh=true name=keywords content="CMU15-445/645,Buffer Pool Manager,CMU15-445/645 ç­†è¨˜"><link data-rh=true rel=icon href=/RulerChen-Website/en/img/profile/profile.webp><link data-rh=true rel=canonical href=https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/p1/><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/p1/ hreflang=zh-Hant><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/p1/ hreflang=en><link data-rh=true rel=alternate href=https://RulerChen.github.io/RulerChen-Website/docs/CMU15-445/p1/ hreflang=x-default><link data-rh=true rel=preconnect href=https://GSV9DQB5UM-dsn.algolia.net crossorigin=anonymous><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/","name":"CMU 15-445/645","position":1},{"@type":"ListItem","item":"https://RulerChen.github.io/RulerChen-Website/en/docs/CMU15-445/p1","name":"P1 - Buffer Pool Manager","position":2}]}</script><link rel=alternate type=application/rss+xml href=/RulerChen-Website/en/blog/rss.xml title="RulerChen RSS Feed"><link rel=alternate type=application/atom+xml href=/RulerChen-Website/en/blog/atom.xml title="RulerChen Atom Feed"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=G-8BEHDPLQMG"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8BEHDPLQMG",{anonymize_ip:!0})</script><link rel=search type=application/opensearchdescription+xml title=RulerChen href=/RulerChen-Website/en/opensearch.xml><meta name=google-site-verification content=QrdRbPEcOsJJ_kfRVewqfwR6GjPcRf0UVgRb85I-5fc><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><link rel=stylesheet href=/RulerChen-Website/en/assets/css/styles.21807039.css><script src=/RulerChen-Website/en/assets/js/runtime~main.753605fb.js defer></script><script src=/RulerChen-Website/en/assets/js/main.00448433.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark",e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/RulerChen-Website/en/img/profile/profile.webp><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/RulerChen-Website/en/><div class=navbar__logo><img src=/RulerChen-Website/en/img/profile/profile.webp alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/RulerChen-Website/en/img/profile/profile.webp alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RulerChen</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/RulerChen-Website/en/docs/intro/>Notes</a><a class="navbar__item navbar__link" href=/RulerChen-Website/en/blog/>Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>English</a><ul class=dropdown__menu><li><a href=/RulerChen-Website/docs/CMU15-445/p1/ target=_self rel="noopener noreferrer" class=dropdown__link lang=zh-Hant>ç¹é«”ä¸­æ–‡</a><li><a href=/RulerChen-Website/en/docs/CMU15-445/p1/ target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=en>English</a></ul></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/RulerChen-Website/en/docs/intro/>Roadmap</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/RulerChen-Website/en/docs/CMU15-445/>CMU 15-445/645</a><button aria-label="Collapse sidebar category 'CMU 15-445/645'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c01/>Relational Model & Algebra</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c02/>Modern SQL</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c03/>Database Storage</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c05/>Storage Models & Compression</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c06/>Memory & Disk I/O Management</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c07/>Hash Tables</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c08/>Indexes & Filters</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c09/>Index Concurrency Control</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c11/>Sorting & Aggregations Algorithms</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c12/>Joins Algorithms</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c13/>Query Execution</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c15/>Query Planning & Optimization</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c16/>Concurrency Control Theory</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c17/>Two-Phase Locking Concurrency Control</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c18/>Timestamp Ordering Concurrency Control</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c19/>Multi-Version Concurrency Control</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c20/>Database Logging</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c21/>Database Recovery</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c22/>Introduction to Distributed Databases</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c23/>Distributed OLTP Database Systems</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/c24/>Distributed OLAP Database Systems</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p0/>P0 - C++ Primer</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p1/>P1 - Buffer Pool Manager</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p2/>P2 - B+ Tree</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p3/>P3 - Query Execution</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/RulerChen-Website/en/docs/CMU15-445/p4/>P4 - Concurrency Control</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/RulerChen-Website/en/docs/Security/>Security</a><button aria-label="Expand sidebar category 'Security'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_z5aJ"><div class=docItemContainer_c0TR><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/RulerChen-Website/en/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/RulerChen-Website/en/docs/CMU15-445/><span>CMU 15-445/645</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>P1 - Buffer Pool Manager</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>P1 - Buffer Pool Manager</h1></header>
<p>åœ¨é€™å€‹ project ä¸­ï¼Œæˆ‘å€‘éœ€è¦å¯¦ç¾ä¸€å€‹ buffer pool managerï¼Œç¸½å…±æœ‰ 3 å€‹ task :</p>
<ul>
<li>LRU-K Replacement Policy</li>
<li>Disk Scheduler</li>
<li>Buffer Pool Manager</li>
</ul>
<p>æˆ‘æ¡å–çš„åšæ³•éƒ½æ˜¯åªæ±‚é€šéä¸æ±‚æ•ˆèƒ½ï¼Œå¦‚æœæƒ³è¦é€²è¡Œæ•ˆèƒ½å„ªåŒ–ï¼Œå¯ä»¥åƒè€ƒæœ€ä¸‹æ–¹ References ä¸­çš„æ–‡ç« ã€‚</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=background>Background<a href=#background class=hash-link aria-label="Direct link to Background" title="Direct link to Background">â€‹</a></h2>
<p>é€™å€‹ project å°±æ˜¯è¦å¯¦ä½œ buffer pool managerï¼Œä¸»è¦æ˜¯è² è²¬æŠŠç¡¬ç¢Ÿä¸Šçš„ page load åˆ°è¨˜æ†¶é«”ä¸­ï¼Œä¸¦ä¸”æä¾›ä¸€å€‹ä»‹é¢è®“ä¸Šå±¤å¯ä»¥è®€å– / å¯«å…¥ pageã€‚</p>
<p>åœ¨é–‹å§‹ä¹‹å‰ï¼Œæˆ‘å€‘å¯ä»¥å…ˆä¾†çœ‹ä¸€ä¸‹ bustub çš„ IO æ¶æ§‹åœ– :</p>
<figure class=image-modal-container><img src=/RulerChen-Website/en/img/cmu15-445/p1/ioworkflow.webp alt="" width=100% class=image-modal-thumbnail style=cursor:pointer loading=lazy><figcaption class=image-modal-caption>Bustub IO Workflow</figcaption></figure>
<p>ç”¨æ–‡å­—ä¾†æè¿°çš„è©±ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ :</p>
<ol>
<li>ä¸Šå±¤å‘¼å« <code>BufferPoolManager</code> çš„ API ä¾†ç²å¾— <code>PageGuard</code></li>
<li><code>BufferPoolManager</code> æœƒå…ˆæª¢æŸ¥ page æ˜¯å¦åœ¨ buffer pool ä¸­ï¼Œä¸¦æŠŠ metadata æ”¾åœ¨ <code>FrameHeader</code> ä¸­ (åŒ…å« pin_countã€is_dirty ç­‰ç­‰)</li>
<li>å¦‚æœ page ä¸åœ¨ buffer pool ä¸­ï¼Œ<code>BufferPoolManager</code> æœƒå…ˆæª¢æŸ¥ free list æ˜¯å¦æœ‰ç©ºé–“ï¼Œå¦‚æœæ²’æœ‰çš„è©±å°±å‘¼å« <code>LRUKReplacer</code> ä¾†æ‰¾ä¸€å€‹ page ä¾† evictï¼Œ<code>LRUKReplacer</code> æœƒæ ¹æ“š <code>LRUKNode</code> ä¸­çš„æ­·å²ç´€éŒ„ä¾†æ±ºå®šè¦ evict å“ªå€‹ page</li>
<li>å¦‚æœè¦ evict çš„ page æ˜¯ dirty çš„è©± (æˆ–å…¶ä»–éœ€è¦ flush çš„æƒ…æ³)ï¼Œå°±æœƒå‚³é€ä¸€å€‹ <code>DiskRequest</code> çµ¦ <code>DiskScheduler</code>ï¼Œ<code>DiskScheduler</code> æœƒæŠŠ request æ”¾åˆ° queue ä¸­ï¼Œä¸¦ç”±èƒŒæ™¯çš„ worker thread ä¾†è™•ç†</li>
<li>æ¥è‘— worker thread æœƒå‘¼å« <code>DiskManager</code> ä¾†è®€å– / å¯«å…¥è³‡æ–™åˆ°ç¡¬ç¢Ÿ</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=task-1---lru-k-replacement-policy>Task 1 - LRU-K Replacement Policy<a href=#task-1---lru-k-replacement-policy class=hash-link aria-label="Direct link to Task 1 - LRU-K Replacement Policy" title="Direct link to Task 1 - LRU-K Replacement Policy">â€‹</a></h2>
<p>Task 1 çš„ç›®æ¨™æ˜¯å¯¦ç¾ LRU-K replacement policyï¼Œä¸»è¦åŒ…æ‹¬ <code>LRUKReplacer</code> è·Ÿ <code>LRUKNode</code> å…©å€‹ classã€‚</p>
<p>åŸºæœ¬ä¸Šå°±æ˜¯ç¶­è­· <code>node_store_</code> è·Ÿ <code>LRUKNode</code> ä¸­çš„ <code>history_</code> å°±å¥½ï¼Œå¯ä»¥é †ä¾¿å° <code>LRUKNode</code> å¯«ä¸€äº› get function ä¾†æ–¹ä¾¿å–å¾—è³‡æ–™ã€‚</p>
<p>LRU-K çš„é‚è¼¯å¦‚ä¸‹ :</p>
<ol>
<li>ç•¶ä¸€å€‹ page è¢« access çš„æ™‚å€™ï¼Œå°±æœƒæŠŠç•¶å‰çš„ timestamp åŠ åˆ° <code>history_</code> ä¸­ï¼Œç•¶ <code>history_</code> çš„å¤§å°è¶…é K çš„æ™‚å€™ï¼Œå°±æœƒæŠŠæœ€æ—©çš„ timestamp ç§»é™¤</li>
<li>ç•¶è¦ evict çš„æ™‚å€™ï¼Œæœƒå…ˆæ‰¾å‡ºæ‰€æœ‰ <code>IsEvictable</code> çš„ nodeï¼Œç„¶å¾Œåˆ†æˆå…©çµ„ï¼Œä¸€çµ„æ˜¯ <code>history_</code> ä¸­æœ‰ K å€‹ timestamp çš„ï¼Œå¦ä¸€çµ„æ˜¯ä¸æ»¿ K å€‹çš„</li>
<li>æœƒå„ªå…ˆæ’é™¤ä¸æ»¿ K å€‹ timestamp çš„ nodeï¼Œæ‰¾å‡ºé€™çµ„ä¸­æœ€å¾Œä¸€å€‹ timestamp æœ€æ—©çš„ node ä¾† evict</li>
<li>å¦‚æœæ‰€æœ‰ node éƒ½æ»¿ K å€‹ timestamp çš„è©±ï¼Œå°±åœ¨é€™çµ„ä¸­æ‰¾å‡ºæœ€å¾Œä¸€å€‹ timestamp æœ€æ—©çš„ node ä¾† evict</li>
</ol>
<p>å¯¦ä½œä¸Šå¤§è‡´å¦‚ä¸‹ï¼Œå…¶å¯¦éƒ½éå¸¸ç›´è§€ï¼Œæ²’æœ‰ç‰¹åˆ¥éœ€è¦æ³¨æ„çš„åœ°æ–¹ :</p>
<ul>
<li><code>Evict</code> : ä¸»è¦æ˜¯å¯¦ä½œä¸Šé¢æåˆ°çš„é‚è¼¯</li>
<li><code>RecordAccess</code> : æ›´æ–° <code>history_</code> ä¸­çš„è³‡æ–™</li>
<li><code>SetEvictable</code> : åˆ¤æ–· <code>IsEvictable</code> çš„æƒ…æ³ä¸¦åˆªé™¤å³å¯</li>
<li><code>Remove</code> : æª¢æŸ¥ <code>IsEvictable</code> ä¹‹å¾Œå°±å¯ä»¥ç›´æ¥åˆªé™¤</li>
<li><code>Size</code> : ç›´æ¥å›å‚³ <code>curr_size_</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=task-2---disk-scheduler>Task 2 - Disk Scheduler<a href=#task-2---disk-scheduler class=hash-link aria-label="Direct link to Task 2 - Disk Scheduler" title="Direct link to Task 2 - Disk Scheduler">â€‹</a></h2>
<p>Task 2 çš„ç›®æ¨™æ˜¯å¯¦ç¾ disk schedulerï¼Œä¸»è¦æ˜¯è¦å¯¦ä½œ <code>DiskScheduler</code> ä¸­çš„å…©å€‹ function :</p>
<ul>
<li><code>Schedule</code> : åªéœ€è¦å°‡ r ä¸Ÿåˆ° <code>request_queue_</code> ä¸­å³å¯</li>
<li><code>StartWorkerThread</code> : è¨­è¨ˆä¸€å€‹ while è¿´åœˆä¸¦åŸ·è¡Œ requestï¼Œæœ€å¾Œå†è¨­å®š callback ç‚º true å³å¯ï¼Œæ‹¿åˆ° <code>std::nullopt</code> å°±å¯ä»¥è·³å‡ºè¿´åœˆ</li>
</ul>
<p>ä»¥åŠè¦æ³¨æ„è¨»è§£æ‰å»ºæ§‹å­ä¸­çš„ throw errorï¼Œé€™æ¨£æ‰èƒ½æ­£å¸¸åŸ·è¡Œ testã€‚</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=task-3---buffer-pool-manager>Task 3 - Buffer Pool Manager<a href=#task-3---buffer-pool-manager class=hash-link aria-label="Direct link to Task 3 - Buffer Pool Manager" title="Direct link to Task 3 - Buffer Pool Manager">â€‹</a></h2>
<p>Task 3 çš„ç›®æ¨™æ˜¯å¯¦ä½œ buffer pool managerï¼Œä¸»è¦æœƒç”¨åˆ°çš„ class æœ‰ <code>PageGuard</code>ã€<code>BufferPoolManager</code>ã€<code>FrameHeader</code>ã€‚
é€™å€‹ task ç›¸å°æ–¼å‰å…©å€‹è¦èŠ±è »å¤šæ™‚é–“æ€è€ƒçš„ï¼Œæˆ‘èªç‚ºå¯ä»¥å…ˆæ€è€ƒåœ¨å–®ç·šç¨‹ä¸‹çš„é‚è¼¯ï¼Œæœ€å¾Œå†ä¾†è™•ç†æœ‰é—œé–çš„å•é¡Œã€‚</p>
<p><code>PageGuard</code> æ˜¯ä¸€å€‹å¯ä»¥å° frame é€²è¡Œè®€å¯«çš„ classï¼Œåˆ†æˆ <code>ReadPageGuard</code> è·Ÿ <code>WritePageGuard</code> å…©å€‹ classï¼Œåªæœ‰æ‹¿åˆ° <code>PageGuard</code> æ‰èƒ½å° frame é€²è¡Œè®€å¯«ï¼Œå¦‚ <code>WritePageGuard::GetDataMut()</code> æœƒå›å‚³å¯ä¿®æ”¹çš„ <code>char[]</code>ã€‚</p>
<p>åŒæ™‚ï¼Œé€™å€‹ class é‚„éœ€è¦æ­é… <code>FrameHeader</code> ä¸­çš„ <code>rwlatch_</code> ä¾†ç¢ºä¿å¤šç·šç¨‹ä¸‹çš„å®‰å…¨æ€§ï¼Œæˆ‘å€‘æœƒåœ¨å¾Œé¢è¨è«–é€™å€‹éƒ¨åˆ†ã€‚</p>
<p>å…©å€‹ class çš„é‚è¼¯å¤§è‡´ç›¸åŒ (åªæœ‰é–çš„ç¨®é¡ä¸åŒè€Œå·²)ï¼Œé€™è£¡ä»¥ <code>ReadPageGuard</code> ç‚ºä¾‹ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å¹¾å€‹ function :</p>
<ul>
<li><code>ReadPageGuard</code> : å–å¾— frame_->rwlatch çš„é–ï¼Œä¸¦æŠŠ is_valid è¨­å®šç‚º true</li>
<li><code>ReadPageGuard(ReadPageGuard &&that)</code> : <code>PageGuard</code> åªèƒ½è¢« move ä¸èƒ½è¢« copy (é€™æ˜¯ç‚ºäº†é¿å…è³‡æºç®¡ç†ä¸Šçš„å•é¡Œ)ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦å¯¦ä½œ move constructorï¼Œä¸»è¦æ˜¯æŠŠ that çš„è³‡æ–™æ¬éä¾†ï¼Œç„¶å¾ŒæŠŠ that çš„ is_valid è¨­å®šç‚º false</li>
<li><code>operator=</code> : é¡ä¼¼å‰é¢</li>
<li><code>Drop</code> : å…ˆæª¢æŸ¥ is_valid æ˜¯å¦ç‚º trueï¼Œå¦‚æœæ˜¯çš„è©±è™•ç† pin_count è·Ÿ SetEvictable çš„æƒ…æ³ï¼Œç„¶å¾Œå†æŠŠ is_valid è¨­å®šç‚º false</li>
</ul>
<p><code>BufferPoolManager</code> å‰‡æ˜¯ç”¨ä¾†ç®¡ç† buffer pool çš„ classï¼Œä¸»è¦ç¶­è­· page è·Ÿ frame çš„å°æ‡‰é—œä¿‚ (<code>page_table_</code>)ï¼Œé™¤æ­¤ä¹‹å¤–ä¹ŸåŒ…å«äº† <code>replacer_</code> è·Ÿ <code>disk_scheduler_</code> ä¾†åšé é¢æ›¿æ›ä»¥åŠç¡¬ç¢Ÿçš„è®€å¯«ã€‚</p>
<p>ä¸»è¦éœ€è¦å¯¦ä½œçš„ function å¦‚ä¸‹ :</p>
<ul>
<li><code>NewPage</code> : æŠŠ <code>next_page_id</code> +1 ä¹‹å¾Œä½¿ç”¨ <code>disk_scheduler_->IncreaseDiskSpace</code> æ–°å¢ page å³å¯</li>
<li><code>DeletePage</code> : å…ˆç¢ºå®šé€™å€‹ page æœ‰åœ¨ <code>page_table</code> ä¸­ï¼Œæ¥è‘—å†æª¢æŸ¥ pin_count æ˜¯å¦ç‚º 0ï¼Œç„¶å¾Œå†æª¢æŸ¥ is_dirty çœ‹æ˜¯å¦éœ€è¦ FlushPageï¼Œæœ€å¾Œå†å‘¼å« <code>FrameHeader->Reset</code> å³å¯</li>
<li><code>CheckedWritePage</code> & <code>CheckedReadPage</code> : é€™å…©å€‹å‡½æ•¸æ˜¯é€™å€‹ task æœ€é‡è¦çš„å‡½æ•¸ï¼Œå¯¦ä½œä¸Šä¹Ÿéå¸¸é¡ä¼¼ï¼Œä¸»è¦é‚è¼¯å¦‚ä¸‹ :<!-- -->
<ul>
<li>å¦‚æœé€™å€‹ page å·²ç¶“åœ¨ buffer pool ä¸­äº†ï¼Œé‚£å°±è¦æ›´æ–°å®ƒçš„ metadata (pin_count, evictable, recordaccess)</li>
<li>å¦‚æœ <code>page_id</code> ä¸åœ¨ buffer pool ä¸­ï¼Œä½†æ˜¯ <code>free_frame</code> ä¸­æœ‰ç©ºé–“ï¼Œé‚£å°±å¯ä»¥ pop_front ä¸€å€‹ frameï¼Œç„¶å¾Œæ›´æ–° metadata</li>
<li>å¦‚æœ <code>page_id</code> ä¸åœ¨ buffer pool ä¸­ï¼Œä¸” <code>free_frame</code> ä¹Ÿæ²’æœ‰ç©ºé–“ï¼Œé‚£æˆ‘å€‘å°±è¦ä½¿ç”¨ <code>replacer_</code> ä¾† evict ä¸€å€‹ frameï¼Œç„¶å¾Œä¸€æ¨£æ›´æ–° metadata</li>
</ul>
</li>
<li><code>FlushPage</code> : æª¢æŸ¥ <code>page_id</code> æ˜¯å¦åœ¨ <code>page_table</code> ä¸­ï¼Œç„¶å¾Œæª¢æŸ¥ <code>is_dirty</code> ï¼Œå¯ä»¥ä½¿ç”¨ <code>disk_scheduler_</code> ä¾†æŠŠè³‡æ–™å¯«å›ç¡¬ç¢Ÿï¼Œé€™å€‹å‡½æ•¸åŸºæœ¬å¯ä»¥å‡è¨­å‘¼å«å®ƒçš„äººéƒ½æœ‰ bpm é–ï¼Œæ‰€ä»¥ä¸éœ€è¦å†ç²å–</li>
<li><code>FlushAllPages</code> : éæ­· <code>page_table</code> ä¸­çš„è³‡æ–™ï¼Œç„¶å¾Œä½¿ç”¨ <code>FlushPage</code> ä¾†å¯«å›ç¡¬ç¢Ÿ</li>
<li><code>GetPinCount</code> : æª¢æŸ¥ <code>page_id</code> æ˜¯å¦åœ¨ <code>page_table</code> ä¸­ï¼Œç„¶å¾Œå›å‚³ <code>pin_count</code></li>
</ul>
<p>è¨è«–å®ŒåŸºæœ¬åŠŸèƒ½ä¹‹å¾Œå°±å¯ä»¥é–‹å§‹æ€è€ƒ concurrency çš„å•é¡Œã€‚
é€™å€‹ task æœ‰å…©å€‹é–ï¼Œä¸€å€‹æ˜¯ bpm çš„é–ï¼Œå¦ä¸€å€‹æ˜¯ frame çš„é–ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿é€™å…©å€‹é–åœ¨ä½¿ç”¨ä¸Šä¸æœƒç™¼ç”Ÿ deadlockã€‚</p>
<p>é€™éƒ¨åˆ†æˆ‘è¦ºå¾— <a href=https://zhuanlan.zhihu.com/p/828933572 target=_blank rel="noopener noreferrer">é€™ç¯‡æ–‡ç« </a> æœ‰å¾ˆè©³ç´°çš„èªªæ˜ï¼Œæˆ‘ä¹Ÿæ˜¯åƒè€ƒé€™ç¯‡æ–‡ç« çš„åšæ³•ä¾†å¯¦ä½œï¼Œé€™è£¡å°±ç°¡å–®èªªæ˜ä¸€ä¸‹ã€‚</p>
<p>é€™ç¯‡æ–‡ç« åˆ—å‡ºäº†ä¸‰å€‹éœ€è¦æ³¨æ„çš„åœ°æ–¹ :</p>
<ol>
<li><code>pin_count_</code> è·Ÿ <code>rwlatch_</code> çš„é †åºè¦éµå®ˆ pin -> lock -> unlock -> unpin çš„é †åº</li>
<li>ç”¨ <code>bpm_latch_</code> ä¿è­· <code>pin_count_</code> è·Ÿ <code>SetEvictable</code> çš„æ›´æ–°</li>
<li>ç²å– <code>rwlatch_</code> çš„æ™‚å€™ä¸èƒ½åŒæ™‚æŒæœ‰ <code>bpm_latch_</code></li>
</ol>
<p>æœ‰é—œæ–¼ç¬¬ä¸€é»å¯ä»¥ç”¨åä¾‹ä¾†èªªæ˜ã€‚
å¦‚æœé †åºæ˜¯å…ˆ lock åœ¨ pin çš„è©±ï¼Œä»£è¡¨é †åºå¦‚ä¸‹ :</p>
<ol>
<li>T1 æ‹¿åˆ° frame 0 çš„é–</li>
<li>T1 åŸ·è¡Œ <code>pin_count_++</code></li>
<li>T1 åšäº†ä¸€äº›äº‹æƒ…å¾Œï¼Œ <code>pin_count--</code></li>
<li>T1 æ”¾æ‰ frame 0 çš„é–</li>
<li>T2 æ‹¿åˆ° frame 0 çš„é–</li>
</ol>
<p>ä»”ç´°æ€è€ƒçš„è©±å¯ä»¥ç™¼ç¾ï¼ŒT1 åœ¨ç¬¬ 3 æ­¥é©Ÿçš„æ™‚å€™ï¼Œ<code>pin_count_</code> å¯èƒ½æœƒè®Šæˆ 0ï¼Œä»£è¡¨é€™æ®µæ™‚é–“é–‹å§‹åˆ° T2 æ‹¿åˆ°é–ä¹‹å‰ï¼Œé€™å€‹ frame å¯èƒ½æœƒè¢« evict æ‰ï¼Œå°è‡´ T2 æ‹¿åˆ°çš„ frame æ˜¯å·²ç¶“è¢« evict æ‰çš„ frameã€‚</p>
<p>ç¬¬äºŒé»ç†è§£èµ·ä¾†æ¯”è¼ƒç°¡å–®ï¼Œå°±æ˜¯å› ç‚º <code>pin_count_</code> è·Ÿ <code>is_evictable_</code> éœ€è¦æ˜¯åŸå­æ“ä½œï¼Œæ‰€ä»¥éœ€è¦ç”¨ <code>bpm_latch_</code> ä¾†ä¿è­·ã€‚</p>
<p>ç¬¬ä¸‰é»å¯ä»¥ç”¨æ¸¬è©¦æ¡ˆä¾‹ <code>DeadlockTest</code> ä¾†è§£é‡‹ï¼Œé€™å€‹æ¸¬è©¦å¦‚ä¸‹ :</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockTitle_OeMC>test/buffer/buffer_pool_manager_test.cpp</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token function" style="color:rgb(80, 250, 123)">TEST</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">BufferPoolManagerTest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> DeadlockTest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token plain"> disk_manager </span><span class="token operator">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token generic-function function" style="color:rgb(80, 250, 123)">make_shared</span><span class="token generic-function generic class-name operator">&lt;</span><span class="token generic-function generic class-name">DiskManager</span><span class="token generic-function generic class-name operator">></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">db_fname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token plain"> bpm </span><span class="token operator">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token generic-function function" style="color:rgb(80, 250, 123)">make_shared</span><span class="token generic-function generic class-name operator">&lt;</span><span class="token generic-function generic class-name">BufferPoolManager</span><span class="token generic-function generic class-name operator">></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">FRAMES</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> disk_manager</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> K_DIST</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token plain"> pid0 </span><span class="token operator">=</span><span class="token plain"> bpm</span><span class="token operator">-></span><span class="token function" style="color:rgb(80, 250, 123)">NewPage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token plain"> pid1 </span><span class="token operator">=</span><span class="token plain"> bpm</span><span class="token operator">-></span><span class="token function" style="color:rgb(80, 250, 123)">NewPage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token plain"> guard0 </span><span class="token operator">=</span><span class="token plain"> bpm</span><span class="token operator">-></span><span class="token function" style="color:rgb(80, 250, 123)">WritePage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">pid0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// A crude way of synchronizing threads, but works for this small case.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">atomic</span><span class="token operator">&lt;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">bool</span><span class="token operator">></span><span class="token plain"> start </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token plain"> child </span><span class="token operator">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">thread</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token operator">&</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Acknowledge that we can begin the test.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">    start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">store</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Attempt to write to page 0.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token plain"> guard0 </span><span class="token operator">=</span><span class="token plain"> bpm</span><span class="token operator">-></span><span class="token function" style="color:rgb(80, 250, 123)">WritePage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">pid0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Wait for the other thread to begin before we start the test.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">load</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Make the other thread wait for a bit.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// This mimics the main thread doing some work while holding the write latch on page 0.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">this_thread</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">sleep_for</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">chrono</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">milliseconds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// If your latching mechanism is incorrect, the next line of code will deadlock.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Think about what might happen if you hold a certain "all-encompassing" latch for too long...</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// While holding page 0, take the latch on page 1.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token plain"> guard1 </span><span class="token operator">=</span><span class="token plain"> bpm</span><span class="token operator">-></span><span class="token function" style="color:rgb(80, 250, 123)">WritePage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">pid1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Let the child thread have the page 0 since we're done with it.</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  guard0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Drop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">  child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">join</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>å…ˆç°¡å–®æ•˜è¿°ä¸€ä¸‹é€™å€‹ Test çš„é‚è¼¯ï¼Œé¦–å…ˆä¸»åŸ·è¡Œç·’æœƒå…ˆå–å¾— frame 0 çš„ç¨ä½”é–ï¼Œæ¥è‘—å•Ÿå‹•ä¸€å€‹å­åŸ·è¡Œç·’ä¹Ÿä¾†è®€å– frame 0 çš„ç¨ä½”é–ï¼Œé€™æ™‚å€™ä¸»åŸ·è¡Œç·’æœƒå…ˆç¡ 1 ç§’é˜ï¼Œç„¶å¾Œå†å–å¾— frame 1 çš„ç¨ä½”é–ï¼Œæœ€å¾Œä¸»åŸ·è¡Œç·’å†é‡‹æ”¾ frame 0 çš„ç¨ä½”é–ã€‚</p>
<p>å¦‚æœæˆ‘å€‘ç›´æ¥åœ¨ <code>CheckedWritePage</code> ä¸­ä½¿ç”¨ <code>std::scoped_lock</code> ä¾†é–ä½ bpm çš„é–ï¼Œé‚£éº¼é€™å€‹æ¸¬è©¦å°±æœƒæ­»é–ï¼Œæµç¨‹å¦‚ä¸‹ :</p>
<ol>
<li>ä¸»åŸ·è¡Œç·’å–å¾— bpm çš„é–</li>
<li>ä¸»åŸ·è¡Œç·’å–å¾— frame 0 çš„ç¨ä½”é–</li>
<li>ä¸»åŸ·è¡Œç·’æ”¾æ£„ bpm çš„é–</li>
<li>å­åŸ·è¡Œç·’å–å¾— bpm çš„é–</li>
<li>å­åŸ·è¡Œç·’ç­‰å¾… frame 0 çš„ç¨ä½”é–</li>
<li>ä¸»åŸ·è¡Œç·’ç­‰å¾… bpm çš„é– (æº–å‚™è®€å– frame 1)</li>
<li>ç”±æ–¼å…©é‚Šéƒ½åœ¨ç­‰å¾…å°æ–¹çš„é–ï¼Œæ‰€ä»¥å°±æœƒæ­»é–</li>
</ol>
<p>ç”±ä¸Šé¢çš„ç¯„ä¾‹æˆ‘å€‘å¯ä»¥çŸ¥é“ï¼Œæˆ‘å€‘å¿…é ˆè¦åœ¨å–å¾— frame çš„é–ä¹‹å‰æ”¾æ‰ bpm çš„é–ï¼Œé€™æ¨£æ‰èƒ½é¿å…æ­»é–çš„å•é¡Œã€‚</p>
<p>ä½†é€™æ¨£é‚„æœ‰ä¸€å€‹ç–‘æƒ‘æ˜¯ï¼Œå‡è¨­æˆ‘å€‘åœ¨å–å¾— frame çš„é–ä¹‹å‰æ”¾æ‰ bpm çš„é–ï¼Œé‚£éº¼åœ¨é€™æ®µæ™‚é–“å…§ï¼Œå…¶ä»–çš„åŸ·è¡Œç·’å°±æœ‰å¯èƒ½æœƒæ’éšŠï¼Œé€™æ¨£æœƒä¸æœƒå°è‡´æˆ‘å€‘å–å¾—çš„ frame ä¸æ˜¯æˆ‘å€‘æƒ³è¦çš„ frame å‘¢?</p>
<p>ç­”æ¡ˆæ˜¯ä¸æœƒï¼Œå› ç‚ºæˆ‘å€‘æœƒåœ¨æŒæœ‰ bpm çš„é–çš„æ™‚å€™å°±æ›´æ–° <code>pin_count_</code> è·Ÿ <code>is_evictable_</code>ï¼Œæ‰€ä»¥å³ä½¿å…¶ä»–åŸ·è¡Œç·’æ’éšŠä¹Ÿä¸æœƒå°è‡´æˆ‘å€‘è¦çš„ frame è¢« evict æ‰ï¼Œåªæ˜¯æœƒåœ¨åŸ·è¡Œé †åºä¸Šæœ‰äº›ä¸åŒè€Œå·²ã€‚</p>
<p>ç¶œåˆä»¥ä¸Šçš„ä¸‰å€‹é™åˆ¶ï¼Œæˆ‘åœ¨å¯¦ä½œä¸Šæ¡å–çš„æ–¹æ³•æ˜¯åœ¨ <code>CheckedWritePage</code> ä¸­ä½¿ç”¨ <code>std::unique_lock</code> ä¾†å–å¾— bpm çš„é–ï¼Œæ¥è‘—åœ¨å‰µå»º <code>WritePageGuard</code> å‰è§£é–ï¼Œç„¶å¾Œåœ¨ <code>WritePageGuard</code> çš„ constructor å–å¾— frame çš„é–ï¼Œæœ€å¾Œåœ¨ <code>Drop()</code> çš„æ™‚å€™å…ˆé‡‹æ”¾ frame çš„é–ï¼Œå†ä½¿ç”¨ bpm çš„é–æ›´æ–° frame çš„ metadataã€‚</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=submit>Submit<a href=#submit class=hash-link aria-label="Direct link to Submit" title="Direct link to Submit">â€‹</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">make lru_k_replacer_test -j$(nproc) && ./test/lru_k_replacer_test</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">make disk_scheduler_test -j$(nproc) && ./test/disk_scheduler_test</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">make page_guard_test -j$(nproc) && ./test/page_guard_test</span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#F8F8F2><span class="token plain">make buffer_pool_manager_test -j$(nproc) && ./test/buffer_pool_manager_test</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">make format && make check-format && make check-lint &&make check-clang-tidy-p1</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#F8F8F2;--prism-background-color:#282A36><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#F8F8F2;background-color:#282A36><code class=codeBlockLines_e6Vv><span class=token-line style=color:#F8F8F2><span class="token plain">make submit-p1</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=takeaways>Takeaways<a href=#takeaways class=hash-link aria-label="Direct link to Takeaways" title="Direct link to Takeaways">â€‹</a></h2>
<p>ç¬¬ä¸€æ¬¡å¯«é€™å€‹ä½œæ¥­çš„æ™‚å€™é‚„æ˜¯ 2023 fall çš„ç‰ˆæœ¬ï¼Œæƒ³èªªæ”¹æˆ 2024 fall çš„ç‰ˆæœ¬æ‡‰è©²ä¸€å¤©å°±å¯ä»¥äº†ï¼Œçµæœç«Ÿç„¶èŠ±äº†ä¸€å€‹ç¦®æ‹œæ‰å¼„å®Œ ğŸ« </p>
<p>ä¸»è¦æ˜¯å› ç‚ºæ–°å¢çš„ PageGuard å°è‡´å¯¦ä½œä¸Šè·ŸåŸæœ¬çš„å·®çš„æœ‰é»å¤šï¼Œä½†æˆ‘ç›¸ä¿¡é€™å€‹ class æ‡‰è©²æœƒè®“å¾Œé¢çš„ project å¯¦ä½œä¸Šæ›´ç°¡å–® (å§?)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=references>References<a href=#references class=hash-link aria-label="Direct link to References" title="Direct link to References">â€‹</a></h2>
<ul>
<li><a href=https://zhuanlan.zhihu.com/p/1657237277 target=_blank rel="noopener noreferrer">CMU 15445 2024 Fall Project 1 è®°å½•</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/828933572 target=_blank rel="noopener noreferrer">CMU Fall 2024 15-445 P1&P2[ä¼˜åŒ– P2]</a></li>
<li><a href=https://4ever-xxxl.github.io/cmu-15445-project-1/ target=_blank rel="noopener noreferrer">CMU 15445 Project 1</a></li>
<li><a href=https://www.aneureka.com/posts/cmu-15445-p1-opt target=_blank rel="noopener noreferrer">CMU 15-445 2023 P1 ä¼˜åŒ–æ”»ç•¥</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/679980578 target=_blank rel="noopener noreferrer">CMU15-445 2023 Fall Project0~4 é€šå…³æ€»ç»“</a></li>
</ul></div><div style=margin-top:32px></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/RulerChen-Website/en/docs/tags/cmu-15-445/>CMU15-445</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/RulerChen-Website/en/docs/tags/cmu-15-445-projects/>CMU15-445 Projects</a></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/RulerChen/RulerChen-Website/tree/main/docs/CMU15-445/p1.mdx target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated>Last updated<!-- --> on <b><time datetime=2025-09-21T12:59:00.000Z itemprop=dateModified>Sep 21, 2025</time></b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/RulerChen-Website/en/docs/CMU15-445/p0/><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>P0 - C++ Primer</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/RulerChen-Website/en/docs/CMU15-445/p2/><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>P2 - B+ Tree</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#background class="table-of-contents__link toc-highlight">Background</a><li><a href=#task-1---lru-k-replacement-policy class="table-of-contents__link toc-highlight">Task 1 - LRU-K Replacement Policy</a><li><a href=#task-2---disk-scheduler class="table-of-contents__link toc-highlight">Task 2 - Disk Scheduler</a><li><a href=#task-3---buffer-pool-manager class="table-of-contents__link toc-highlight">Task 3 - Buffer Pool Manager</a><li><a href=#submit class="table-of-contents__link toc-highlight">Submit</a><li><a href=#takeaways class="table-of-contents__link toc-highlight">Takeaways</a><li><a href=#references class="table-of-contents__link toc-highlight">References</a></ul></div></div></div></div></main></div></div></div></div>