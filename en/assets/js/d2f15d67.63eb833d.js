"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["3672"],{8531:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>i,default:()=>h,toc:()=>t,metadata:()=>c,assets:()=>a,contentTitle:()=>d});var c=JSON.parse('{"id":"CMU15-445/p1","title":"P1 - Buffer Pool Manager","description":"Buffer Pool Manager","source":"@site/docs/CMU15-445/p1.mdx","sourceDirName":"CMU15-445","slug":"/CMU15-445/p1","permalink":"/RulerChen-Website/en/docs/CMU15-445/p1","draft":false,"unlisted":false,"editUrl":"https://github.com/RulerChen/RulerChen-Website/tree/main/docs/CMU15-445/p1.mdx","tags":[{"inline":true,"label":"CMU15-445","permalink":"/RulerChen-Website/en/docs/tags/cmu-15-445"},{"inline":true,"label":"CMU15-445 Projects","permalink":"/RulerChen-Website/en/docs/tags/cmu-15-445-projects"}],"version":"current","lastUpdatedAt":1758250099000,"sidebarPosition":101,"frontMatter":{"title":"P1 - Buffer Pool Manager","sidebar_position":101,"description":"Buffer Pool Manager","keywords":["CMU15-445/645","Buffer Pool Manager","CMU15-445/645 \u7B46\u8A18"],"tags":["CMU15-445","CMU15-445 Projects"]},"sidebar":"tutorialSidebar","previous":{"title":"P0 - C++ Primer","permalink":"/RulerChen-Website/en/docs/CMU15-445/p0"},"next":{"title":"P2 - B+ Tree","permalink":"/RulerChen-Website/en/docs/CMU15-445/p2"}}'),s=r(5893),l=r(65);let i={title:"P1 - Buffer Pool Manager",sidebar_position:"101",description:"Buffer Pool Manager",keywords:["CMU15-445/645","Buffer Pool Manager","CMU15-445/645 \u7B46\u8A18"],tags:["CMU15-445","CMU15-445 Projects"]},d=void 0,a={},t=[{value:"Background",id:"background",level:2},{value:"Task 1 - LRU-K Replacement Policy",id:"task-1---lru-k-replacement-policy",level:2},{value:"Task 2 - Disk Scheduler",id:"task-2---disk-scheduler",level:2},{value:"Task 3 - Buffer Pool Manager",id:"task-3---buffer-pool-manager",level:2},{value:"Submit",id:"submit",level:2},{value:"Takeaways",id:"takeaways",level:2},{value:"References",id:"references",level:2}];function o(e){let n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.a)(),...e.components},{Head:r,ImageModal:c}=n;return r||j("Head",!0),c||j("ImageModal",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r,{children:(0,s.jsx)("title",{children:"CMU 15-445 2024Fall P1 Buffer Pool Manager"})}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u9019\u500B project \u4E2D\uFF0C\u6211\u5011\u9700\u8981\u5BE6\u73FE\u4E00\u500B buffer pool manager\uFF0C\u7E3D\u5171\u6709 3 \u500B task :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"LRU-K Replacement Policy"}),"\n",(0,s.jsx)(n.li,{children:"Disk Scheduler"}),"\n",(0,s.jsx)(n.li,{children:"Buffer Pool Manager"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u6211\u63A1\u53D6\u7684\u505A\u6CD5\u90FD\u662F\u53EA\u6C42\u901A\u904E\u4E0D\u6C42\u6548\u80FD\uFF0C\u5982\u679C\u60F3\u8981\u9032\u884C\u6548\u80FD\u512A\u5316\uFF0C\u53EF\u4EE5\u53C3\u8003\u6700\u4E0B\u65B9 References \u4E2D\u7684\u6587\u7AE0\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"background",children:"Background"}),"\n",(0,s.jsx)(n.p,{children:"\u9019\u500B project \u5C31\u662F\u8981\u5BE6\u4F5C buffer pool manager\uFF0C\u4E3B\u8981\u662F\u8CA0\u8CAC\u628A\u786C\u789F\u4E0A\u7684 page load \u5230\u8A18\u61B6\u9AD4\u4E2D\uFF0C\u4E26\u4E14\u63D0\u4F9B\u4E00\u500B\u4ECB\u9762\u8B93\u4E0A\u5C64\u53EF\u4EE5\u8B80\u53D6 / \u5BEB\u5165 page\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u958B\u59CB\u4E4B\u524D\uFF0C\u6211\u5011\u53EF\u4EE5\u5148\u4F86\u770B\u4E00\u4E0B bustub \u7684 IO \u67B6\u69CB\u5716 :"}),"\n",(0,s.jsx)(c,{src:"/img/cmu15-445/p1/IO workflow.webp",caption:"Bustub IO Workflow"}),"\n",(0,s.jsx)(n.p,{children:"\u7528\u6587\u5B57\u4F86\u63CF\u8FF0\u7684\u8A71\uFF0C\u5927\u81F4\u6D41\u7A0B\u5982\u4E0B :"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\u4E0A\u5C64\u547C\u53EB ",(0,s.jsx)(n.code,{children:"BufferPoolManager"})," \u7684 API \u4F86\u7372\u5F97 ",(0,s.jsx)(n.code,{children:"PageGuard"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"BufferPoolManager"})," \u6703\u5148\u6AA2\u67E5 page \u662F\u5426\u5728 buffer pool \u4E2D\uFF0C\u4E26\u628A metadata \u653E\u5728 ",(0,s.jsx)(n.code,{children:"FrameHeader"})," \u4E2D (\u5305\u542B pin_count\u3001is_dirty \u7B49\u7B49)"]}),"\n",(0,s.jsxs)(n.li,{children:["\u5982\u679C page \u4E0D\u5728 buffer pool \u4E2D\uFF0C",(0,s.jsx)(n.code,{children:"BufferPoolManager"})," \u6703\u5148\u6AA2\u67E5 free list \u662F\u5426\u6709\u7A7A\u9593\uFF0C\u5982\u679C\u6C92\u6709\u7684\u8A71\u5C31\u547C\u53EB ",(0,s.jsx)(n.code,{children:"LRUKReplacer"})," \u4F86\u627E\u4E00\u500B page \u4F86 evict\uFF0C",(0,s.jsx)(n.code,{children:"LRUKReplacer"})," \u6703\u6839\u64DA ",(0,s.jsx)(n.code,{children:"LRUKNode"})," \u4E2D\u7684\u6B77\u53F2\u7D00\u9304\u4F86\u6C7A\u5B9A\u8981 evict \u54EA\u500B page"]}),"\n",(0,s.jsxs)(n.li,{children:["\u5982\u679C\u8981 evict \u7684 page \u662F dirty \u7684\u8A71 (\u6216\u5176\u4ED6\u9700\u8981 flush \u7684\u60C5\u6CC1)\uFF0C\u5C31\u6703\u50B3\u9001\u4E00\u500B ",(0,s.jsx)(n.code,{children:"DiskRequest"})," \u7D66 ",(0,s.jsx)(n.code,{children:"DiskScheduler"}),"\uFF0C",(0,s.jsx)(n.code,{children:"DiskScheduler"})," \u6703\u628A request \u653E\u5230 queue \u4E2D\uFF0C\u4E26\u7531\u80CC\u666F\u7684 worker thread \u4F86\u8655\u7406"]}),"\n",(0,s.jsxs)(n.li,{children:["\u63A5\u8457 worker thread \u6703\u547C\u53EB ",(0,s.jsx)(n.code,{children:"DiskManager"})," \u4F86\u8B80\u53D6 / \u5BEB\u5165\u8CC7\u6599\u5230\u786C\u789F"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"task-1---lru-k-replacement-policy",children:"Task 1 - LRU-K Replacement Policy"}),"\n",(0,s.jsxs)(n.p,{children:["Task 1 \u7684\u76EE\u6A19\u662F\u5BE6\u73FE LRU-K replacement policy\uFF0C\u4E3B\u8981\u5305\u62EC ",(0,s.jsx)(n.code,{children:"LRUKReplacer"})," \u8DDF ",(0,s.jsx)(n.code,{children:"LRUKNode"})," \u5169\u500B class\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u57FA\u672C\u4E0A\u5C31\u662F\u7DAD\u8B77 ",(0,s.jsx)(n.code,{children:"node_store_"})," \u8DDF ",(0,s.jsx)(n.code,{children:"LRUKNode"})," \u4E2D\u7684 ",(0,s.jsx)(n.code,{children:"history_"})," \u5C31\u597D\uFF0C\u53EF\u4EE5\u9806\u4FBF\u5C0D ",(0,s.jsx)(n.code,{children:"LRUKNode"})," \u5BEB\u4E00\u4E9B get function \u4F86\u65B9\u4FBF\u53D6\u5F97\u8CC7\u6599\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"LRU-K \u7684\u908F\u8F2F\u5982\u4E0B :"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\u7576\u4E00\u500B page \u88AB access \u7684\u6642\u5019\uFF0C\u5C31\u6703\u628A\u7576\u524D\u7684 timestamp \u52A0\u5230 ",(0,s.jsx)(n.code,{children:"history_"})," \u4E2D\uFF0C\u7576 ",(0,s.jsx)(n.code,{children:"history_"})," \u7684\u5927\u5C0F\u8D85\u904E K \u7684\u6642\u5019\uFF0C\u5C31\u6703\u628A\u6700\u65E9\u7684 timestamp \u79FB\u9664"]}),"\n",(0,s.jsxs)(n.li,{children:["\u7576\u8981 evict \u7684\u6642\u5019\uFF0C\u6703\u5148\u627E\u51FA\u6240\u6709 ",(0,s.jsx)(n.code,{children:"IsEvictable"})," \u7684 node\uFF0C\u7136\u5F8C\u5206\u6210\u5169\u7D44\uFF0C\u4E00\u7D44\u662F ",(0,s.jsx)(n.code,{children:"history_"})," \u4E2D\u6709 K \u500B timestamp \u7684\uFF0C\u53E6\u4E00\u7D44\u662F\u4E0D\u6EFF K \u500B\u7684"]}),"\n",(0,s.jsx)(n.li,{children:"\u6703\u512A\u5148\u6392\u9664\u4E0D\u6EFF K \u500B timestamp \u7684 node\uFF0C\u627E\u51FA\u9019\u7D44\u4E2D\u6700\u5F8C\u4E00\u500B timestamp \u6700\u65E9\u7684 node \u4F86 evict"}),"\n",(0,s.jsx)(n.li,{children:"\u5982\u679C\u6240\u6709 node \u90FD\u6EFF K \u500B timestamp \u7684\u8A71\uFF0C\u5C31\u5728\u9019\u7D44\u4E2D\u627E\u51FA\u6700\u5F8C\u4E00\u500B timestamp \u6700\u65E9\u7684 node \u4F86 evict"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u5BE6\u4F5C\u4E0A\u5927\u81F4\u5982\u4E0B\uFF0C\u5176\u5BE6\u90FD\u975E\u5E38\u76F4\u89C0\uFF0C\u6C92\u6709\u7279\u5225\u9700\u8981\u6CE8\u610F\u7684\u5730\u65B9 :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Evict"})," : \u4E3B\u8981\u662F\u5BE6\u4F5C\u4E0A\u9762\u63D0\u5230\u7684\u908F\u8F2F"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"RecordAccess"})," : \u66F4\u65B0 ",(0,s.jsx)(n.code,{children:"history_"})," \u4E2D\u7684\u8CC7\u6599"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"SetEvictable"})," : \u5224\u65B7 ",(0,s.jsx)(n.code,{children:"IsEvictable"})," \u7684\u60C5\u6CC1\u4E26\u522A\u9664\u5373\u53EF"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Remove"})," : \u6AA2\u67E5 ",(0,s.jsx)(n.code,{children:"IsEvictable"})," \u4E4B\u5F8C\u5C31\u53EF\u4EE5\u76F4\u63A5\u522A\u9664"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Size"})," : \u76F4\u63A5\u56DE\u50B3 ",(0,s.jsx)(n.code,{children:"curr_size_"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"task-2---disk-scheduler",children:"Task 2 - Disk Scheduler"}),"\n",(0,s.jsxs)(n.p,{children:["Task 2 \u7684\u76EE\u6A19\u662F\u5BE6\u73FE disk scheduler\uFF0C\u4E3B\u8981\u662F\u8981\u5BE6\u4F5C ",(0,s.jsx)(n.code,{children:"DiskScheduler"})," \u4E2D\u7684\u5169\u500B function :"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Schedule"})," : \u53EA\u9700\u8981\u5C07 r \u4E1F\u5230 ",(0,s.jsx)(n.code,{children:"request_queue_"})," \u4E2D\u5373\u53EF"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"StartWorkerThread"})," : \u8A2D\u8A08\u4E00\u500B while \u8FF4\u5708\u4E26\u57F7\u884C request\uFF0C\u6700\u5F8C\u518D\u8A2D\u5B9A callback \u70BA true \u5373\u53EF\uFF0C\u62FF\u5230 ",(0,s.jsx)(n.code,{children:"std::nullopt"})," \u5C31\u53EF\u4EE5\u8DF3\u51FA\u8FF4\u5708"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u4EE5\u53CA\u8981\u6CE8\u610F\u8A3B\u89E3\u6389\u5EFA\u69CB\u5B50\u4E2D\u7684 throw error\uFF0C\u9019\u6A23\u624D\u80FD\u6B63\u5E38\u57F7\u884C test\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"task-3---buffer-pool-manager",children:"Task 3 - Buffer Pool Manager"}),"\n",(0,s.jsxs)(n.p,{children:["Task 3 \u7684\u76EE\u6A19\u662F\u5BE6\u4F5C buffer pool manager\uFF0C\u4E3B\u8981\u6703\u7528\u5230\u7684 class \u6709 ",(0,s.jsx)(n.code,{children:"PageGuard"}),"\u3001",(0,s.jsx)(n.code,{children:"BufferPoolManager"}),"\u3001",(0,s.jsx)(n.code,{children:"FrameHeader"}),"\u3002\n\u9019\u500B task \u76F8\u5C0D\u65BC\u524D\u5169\u500B\u8981\u82B1\u883B\u591A\u6642\u9593\u601D\u8003\u7684\uFF0C\u6211\u8A8D\u70BA\u53EF\u4EE5\u5148\u601D\u8003\u5728\u55AE\u7DDA\u7A0B\u4E0B\u7684\u908F\u8F2F\uFF0C\u6700\u5F8C\u518D\u4F86\u8655\u7406\u6709\u95DC\u9396\u7684\u554F\u984C\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"PageGuard"})," \u662F\u4E00\u500B\u53EF\u4EE5\u5C0D frame \u9032\u884C\u8B80\u5BEB\u7684 class\uFF0C\u5206\u6210 ",(0,s.jsx)(n.code,{children:"ReadPageGuard"})," \u8DDF ",(0,s.jsx)(n.code,{children:"WritePageGuard"})," \u5169\u500B class\uFF0C\u53EA\u6709\u62FF\u5230 ",(0,s.jsx)(n.code,{children:"PageGuard"})," \u624D\u80FD\u5C0D frame \u9032\u884C\u8B80\u5BEB\uFF0C\u5982 ",(0,s.jsx)(n.code,{children:"WritePageGuard::GetDataMut()"})," \u6703\u56DE\u50B3\u53EF\u4FEE\u6539\u7684 ",(0,s.jsx)(n.code,{children:"char[]"}),"\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u540C\u6642\uFF0C\u9019\u500B class \u9084\u9700\u8981\u642D\u914D ",(0,s.jsx)(n.code,{children:"FrameHeader"})," \u4E2D\u7684 ",(0,s.jsx)(n.code,{children:"rwlatch_"})," \u4F86\u78BA\u4FDD\u591A\u7DDA\u7A0B\u4E0B\u7684\u5B89\u5168\u6027\uFF0C\u6211\u5011\u6703\u5728\u5F8C\u9762\u8A0E\u8AD6\u9019\u500B\u90E8\u5206\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5169\u500B class \u7684\u908F\u8F2F\u5927\u81F4\u76F8\u540C (\u53EA\u6709\u9396\u7684\u7A2E\u985E\u4E0D\u540C\u800C\u5DF2)\uFF0C\u9019\u88E1\u4EE5 ",(0,s.jsx)(n.code,{children:"ReadPageGuard"})," \u70BA\u4F8B\uFF0C\u4E3B\u8981\u5305\u542B\u4EE5\u4E0B\u5E7E\u500B function :"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReadPageGuard"})," : \u53D6\u5F97 frame_->rwlatch \u7684\u9396\uFF0C\u4E26\u628A is_valid \u8A2D\u5B9A\u70BA true"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReadPageGuard(ReadPageGuard &&that)"})," : ",(0,s.jsx)(n.code,{children:"PageGuard"})," \u53EA\u80FD\u88AB move \u4E0D\u80FD\u88AB copy (\u9019\u662F\u70BA\u4E86\u907F\u514D\u8CC7\u6E90\u7BA1\u7406\u4E0A\u7684\u554F\u984C)\uFF0C\u6240\u4EE5\u6211\u5011\u9700\u8981\u5BE6\u4F5C move constructor\uFF0C\u4E3B\u8981\u662F\u628A that \u7684\u8CC7\u6599\u642C\u904E\u4F86\uFF0C\u7136\u5F8C\u628A that \u7684 is_valid \u8A2D\u5B9A\u70BA false"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"operator="})," : \u985E\u4F3C\u524D\u9762"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Drop"})," : \u5148\u6AA2\u67E5 is_valid \u662F\u5426\u70BA true\uFF0C\u5982\u679C\u662F\u7684\u8A71\u8655\u7406 pin_count \u8DDF SetEvictable \u7684\u60C5\u6CC1\uFF0C\u7136\u5F8C\u518D\u628A is_valid \u8A2D\u5B9A\u70BA false"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"BufferPoolManager"})," \u5247\u662F\u7528\u4F86\u7BA1\u7406 buffer pool \u7684 class\uFF0C\u4E3B\u8981\u7DAD\u8B77 page \u8DDF frame \u7684\u5C0D\u61C9\u95DC\u4FC2 (",(0,s.jsx)(n.code,{children:"page_table_"}),")\uFF0C\u9664\u6B64\u4E4B\u5916\u4E5F\u5305\u542B\u4E86 ",(0,s.jsx)(n.code,{children:"replacer_"})," \u8DDF ",(0,s.jsx)(n.code,{children:"disk_scheduler_"})," \u4F86\u505A\u9801\u9762\u66FF\u63DB\u4EE5\u53CA\u786C\u789F\u7684\u8B80\u5BEB\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u4E3B\u8981\u9700\u8981\u5BE6\u4F5C\u7684 function \u5982\u4E0B :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"NewPage"})," : \u628A ",(0,s.jsx)(n.code,{children:"next_page_id"})," +1 \u4E4B\u5F8C\u4F7F\u7528 ",(0,s.jsx)(n.code,{children:"disk_scheduler_->IncreaseDiskSpace"})," \u65B0\u589E page \u5373\u53EF"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"DeletePage"})," : \u5148\u78BA\u5B9A\u9019\u500B page \u6709\u5728 ",(0,s.jsx)(n.code,{children:"page_table"})," \u4E2D\uFF0C\u63A5\u8457\u518D\u6AA2\u67E5 pin_count \u662F\u5426\u70BA 0\uFF0C\u7136\u5F8C\u518D\u6AA2\u67E5 is_dirty \u770B\u662F\u5426\u9700\u8981 FlushPage\uFF0C\u6700\u5F8C\u518D\u547C\u53EB ",(0,s.jsx)(n.code,{children:"FrameHeader->Reset"})," \u5373\u53EF"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"CheckedWritePage"})," & ",(0,s.jsx)(n.code,{children:"CheckedReadPage"})," : \u9019\u5169\u500B\u51FD\u6578\u662F\u9019\u500B task \u6700\u91CD\u8981\u7684\u51FD\u6578\uFF0C\u5BE6\u4F5C\u4E0A\u4E5F\u975E\u5E38\u985E\u4F3C\uFF0C\u4E3B\u8981\u908F\u8F2F\u5982\u4E0B :","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5982\u679C\u9019\u500B page \u5DF2\u7D93\u5728 buffer pool \u4E2D\u4E86\uFF0C\u90A3\u5C31\u8981\u66F4\u65B0\u5B83\u7684 metadata (pin_count, evictable, recordaccess)"}),"\n",(0,s.jsxs)(n.li,{children:["\u5982\u679C ",(0,s.jsx)(n.code,{children:"page_id"})," \u4E0D\u5728 buffer pool \u4E2D\uFF0C\u4F46\u662F ",(0,s.jsx)(n.code,{children:"free_frame"})," \u4E2D\u6709\u7A7A\u9593\uFF0C\u90A3\u5C31\u53EF\u4EE5 pop_front \u4E00\u500B frame\uFF0C\u7136\u5F8C\u66F4\u65B0 metadata"]}),"\n",(0,s.jsxs)(n.li,{children:["\u5982\u679C ",(0,s.jsx)(n.code,{children:"page_id"})," \u4E0D\u5728 buffer pool \u4E2D\uFF0C\u4E14 ",(0,s.jsx)(n.code,{children:"free_frame"})," \u4E5F\u6C92\u6709\u7A7A\u9593\uFF0C\u90A3\u6211\u5011\u5C31\u8981\u4F7F\u7528 ",(0,s.jsx)(n.code,{children:"replacer_"})," \u4F86 evict \u4E00\u500B frame\uFF0C\u7136\u5F8C\u4E00\u6A23\u66F4\u65B0 metadata"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FlushPage"})," : \u6AA2\u67E5 ",(0,s.jsx)(n.code,{children:"page_id"})," \u662F\u5426\u5728 ",(0,s.jsx)(n.code,{children:"page_table"})," \u4E2D\uFF0C\u7136\u5F8C\u6AA2\u67E5 ",(0,s.jsx)(n.code,{children:"is_dirty"})," \uFF0C\u53EF\u4EE5\u4F7F\u7528 ",(0,s.jsx)(n.code,{children:"disk_scheduler_"})," \u4F86\u628A\u8CC7\u6599\u5BEB\u56DE\u786C\u789F\uFF0C\u9019\u500B\u51FD\u6578\u57FA\u672C\u53EF\u4EE5\u5047\u8A2D\u547C\u53EB\u5B83\u7684\u4EBA\u90FD\u6709 bpm \u9396\uFF0C\u6240\u4EE5\u4E0D\u9700\u8981\u518D\u7372\u53D6"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FlushAllPages"})," : \u904D\u6B77 ",(0,s.jsx)(n.code,{children:"page_table"})," \u4E2D\u7684\u8CC7\u6599\uFF0C\u7136\u5F8C\u4F7F\u7528 ",(0,s.jsx)(n.code,{children:"FlushPage"})," \u4F86\u5BEB\u56DE\u786C\u789F"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GetPinCount"})," : \u6AA2\u67E5 ",(0,s.jsx)(n.code,{children:"page_id"})," \u662F\u5426\u5728 ",(0,s.jsx)(n.code,{children:"page_table"})," \u4E2D\uFF0C\u7136\u5F8C\u56DE\u50B3 ",(0,s.jsx)(n.code,{children:"pin_count"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u8A0E\u8AD6\u5B8C\u57FA\u672C\u529F\u80FD\u4E4B\u5F8C\u5C31\u53EF\u4EE5\u958B\u59CB\u601D\u8003 concurrency \u7684\u554F\u984C\u3002\n\u9019\u500B task \u6709\u5169\u500B\u9396\uFF0C\u4E00\u500B\u662F bpm \u7684\u9396\uFF0C\u53E6\u4E00\u500B\u662F frame \u7684\u9396\uFF0C\u6211\u5011\u9700\u8981\u78BA\u4FDD\u9019\u5169\u500B\u9396\u5728\u4F7F\u7528\u4E0A\u4E0D\u6703\u767C\u751F deadlock\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u9019\u90E8\u5206\u6211\u89BA\u5F97 ",(0,s.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/828933572",children:"\u9019\u7BC7\u6587\u7AE0"})," \u6709\u5F88\u8A73\u7D30\u7684\u8AAA\u660E\uFF0C\u6211\u4E5F\u662F\u53C3\u8003\u9019\u7BC7\u6587\u7AE0\u7684\u505A\u6CD5\u4F86\u5BE6\u4F5C\uFF0C\u9019\u88E1\u5C31\u7C21\u55AE\u8AAA\u660E\u4E00\u4E0B\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u9019\u7BC7\u6587\u7AE0\u5217\u51FA\u4E86\u4E09\u500B\u9700\u8981\u6CE8\u610F\u7684\u5730\u65B9 :"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pin_count_"})," \u8DDF ",(0,s.jsx)(n.code,{children:"rwlatch_"})," \u7684\u9806\u5E8F\u8981\u9075\u5B88 pin -> lock -> unlock -> unpin \u7684\u9806\u5E8F"]}),"\n",(0,s.jsxs)(n.li,{children:["\u7528 ",(0,s.jsx)(n.code,{children:"bpm_latch_"})," \u4FDD\u8B77 ",(0,s.jsx)(n.code,{children:"pin_count_"})," \u8DDF ",(0,s.jsx)(n.code,{children:"SetEvictable"})," \u7684\u66F4\u65B0"]}),"\n",(0,s.jsxs)(n.li,{children:["\u7372\u53D6 ",(0,s.jsx)(n.code,{children:"rwlatch_"})," \u7684\u6642\u5019\u4E0D\u80FD\u540C\u6642\u6301\u6709 ",(0,s.jsx)(n.code,{children:"bpm_latch_"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u6709\u95DC\u65BC\u7B2C\u4E00\u9EDE\u53EF\u4EE5\u7528\u53CD\u4F8B\u4F86\u8AAA\u660E\u3002\n\u5982\u679C\u9806\u5E8F\u662F\u5148 lock \u5728 pin \u7684\u8A71\uFF0C\u4EE3\u8868\u9806\u5E8F\u5982\u4E0B :"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"T1 \u62FF\u5230 frame 0 \u7684\u9396"}),"\n",(0,s.jsxs)(n.li,{children:["T1 \u57F7\u884C ",(0,s.jsx)(n.code,{children:"pin_count_++"})]}),"\n",(0,s.jsxs)(n.li,{children:["T1 \u505A\u4E86\u4E00\u4E9B\u4E8B\u60C5\u5F8C\uFF0C ",(0,s.jsx)(n.code,{children:"pin_count--"})]}),"\n",(0,s.jsx)(n.li,{children:"T1 \u653E\u6389 frame 0 \u7684\u9396"}),"\n",(0,s.jsx)(n.li,{children:"T2 \u62FF\u5230 frame 0 \u7684\u9396"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u4ED4\u7D30\u601D\u8003\u7684\u8A71\u53EF\u4EE5\u767C\u73FE\uFF0CT1 \u5728\u7B2C 3 \u6B65\u9A5F\u7684\u6642\u5019\uFF0C",(0,s.jsx)(n.code,{children:"pin_count_"})," \u53EF\u80FD\u6703\u8B8A\u6210 0\uFF0C\u4EE3\u8868\u9019\u6BB5\u6642\u9593\u958B\u59CB\u5230 T2 \u62FF\u5230\u9396\u4E4B\u524D\uFF0C\u9019\u500B frame \u53EF\u80FD\u6703\u88AB evict \u6389\uFF0C\u5C0E\u81F4 T2 \u62FF\u5230\u7684 frame \u662F\u5DF2\u7D93\u88AB evict \u6389\u7684 frame\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u7B2C\u4E8C\u9EDE\u7406\u89E3\u8D77\u4F86\u6BD4\u8F03\u7C21\u55AE\uFF0C\u5C31\u662F\u56E0\u70BA ",(0,s.jsx)(n.code,{children:"pin_count_"})," \u8DDF ",(0,s.jsx)(n.code,{children:"is_evictable_"})," \u9700\u8981\u662F\u539F\u5B50\u64CD\u4F5C\uFF0C\u6240\u4EE5\u9700\u8981\u7528 ",(0,s.jsx)(n.code,{children:"bpm_latch_"})," \u4F86\u4FDD\u8B77\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u7B2C\u4E09\u9EDE\u53EF\u4EE5\u7528\u6E2C\u8A66\u6848\u4F8B ",(0,s.jsx)(n.code,{children:"DeadlockTest"})," \u4F86\u89E3\u91CB\uFF0C\u9019\u500B\u6E2C\u8A66\u5982\u4E0B :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",metastring:'title="test/buffer/buffer_pool_manager_test.cpp"',children:'TEST(BufferPoolManagerTest, DeadlockTest) {\n  auto disk_manager = std::make_shared<DiskManager>(db_fname);\n  auto bpm = std::make_shared<BufferPoolManager>(FRAMES, disk_manager.get(), K_DIST);\n\n  auto pid0 = bpm->NewPage();\n  auto pid1 = bpm->NewPage();\n\n  auto guard0 = bpm->WritePage(pid0);\n\n  // A crude way of synchronizing threads, but works for this small case.\n  std::atomic<bool> start = false;\n\n  auto child = std::thread([&]() {\n    // Acknowledge that we can begin the test.\n    start.store(true);\n\n    // Attempt to write to page 0.\n    auto guard0 = bpm->WritePage(pid0);\n  });\n\n  // Wait for the other thread to begin before we start the test.\n  while (!start.load()) {\n  }\n\n  // Make the other thread wait for a bit.\n  // This mimics the main thread doing some work while holding the write latch on page 0.\n  std::this_thread::sleep_for(std::chrono::milliseconds(1000));\n\n  // If your latching mechanism is incorrect, the next line of code will deadlock.\n  // Think about what might happen if you hold a certain "all-encompassing" latch for too long...\n\n  // While holding page 0, take the latch on page 1.\n  auto guard1 = bpm->WritePage(pid1);\n\n  // Let the child thread have the page 0 since we\'re done with it.\n  guard0.Drop();\n\n  child.join();\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u5148\u7C21\u55AE\u6558\u8FF0\u4E00\u4E0B\u9019\u500B Test \u7684\u908F\u8F2F\uFF0C\u9996\u5148\u4E3B\u57F7\u884C\u7DD2\u6703\u5148\u53D6\u5F97 frame 0 \u7684\u7368\u4F54\u9396\uFF0C\u63A5\u8457\u555F\u52D5\u4E00\u500B\u5B50\u57F7\u884C\u7DD2\u4E5F\u4F86\u8B80\u53D6 frame 0 \u7684\u7368\u4F54\u9396\uFF0C\u9019\u6642\u5019\u4E3B\u57F7\u884C\u7DD2\u6703\u5148\u7761 1 \u79D2\u9418\uFF0C\u7136\u5F8C\u518D\u53D6\u5F97 frame 1 \u7684\u7368\u4F54\u9396\uFF0C\u6700\u5F8C\u4E3B\u57F7\u884C\u7DD2\u518D\u91CB\u653E frame 0 \u7684\u7368\u4F54\u9396\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u5982\u679C\u6211\u5011\u76F4\u63A5\u5728 ",(0,s.jsx)(n.code,{children:"CheckedWritePage"})," \u4E2D\u4F7F\u7528 ",(0,s.jsx)(n.code,{children:"std::scoped_lock"})," \u4F86\u9396\u4F4F bpm \u7684\u9396\uFF0C\u90A3\u9EBC\u9019\u500B\u6E2C\u8A66\u5C31\u6703\u6B7B\u9396\uFF0C\u6D41\u7A0B\u5982\u4E0B :"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u4E3B\u57F7\u884C\u7DD2\u53D6\u5F97 bpm \u7684\u9396"}),"\n",(0,s.jsx)(n.li,{children:"\u4E3B\u57F7\u884C\u7DD2\u53D6\u5F97 frame 0 \u7684\u7368\u4F54\u9396"}),"\n",(0,s.jsx)(n.li,{children:"\u4E3B\u57F7\u884C\u7DD2\u653E\u68C4 bpm \u7684\u9396"}),"\n",(0,s.jsx)(n.li,{children:"\u5B50\u57F7\u884C\u7DD2\u53D6\u5F97 bpm \u7684\u9396"}),"\n",(0,s.jsx)(n.li,{children:"\u5B50\u57F7\u884C\u7DD2\u7B49\u5F85 frame 0 \u7684\u7368\u4F54\u9396"}),"\n",(0,s.jsx)(n.li,{children:"\u4E3B\u57F7\u884C\u7DD2\u7B49\u5F85 bpm \u7684\u9396 (\u6E96\u5099\u8B80\u53D6 frame 1)"}),"\n",(0,s.jsx)(n.li,{children:"\u7531\u65BC\u5169\u908A\u90FD\u5728\u7B49\u5F85\u5C0D\u65B9\u7684\u9396\uFF0C\u6240\u4EE5\u5C31\u6703\u6B7B\u9396"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u7531\u4E0A\u9762\u7684\u7BC4\u4F8B\u6211\u5011\u53EF\u4EE5\u77E5\u9053\uFF0C\u6211\u5011\u5FC5\u9808\u8981\u5728\u53D6\u5F97 frame \u7684\u9396\u4E4B\u524D\u653E\u6389 bpm \u7684\u9396\uFF0C\u9019\u6A23\u624D\u80FD\u907F\u514D\u6B7B\u9396\u7684\u554F\u984C\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u4F46\u9019\u6A23\u9084\u6709\u4E00\u500B\u7591\u60D1\u662F\uFF0C\u5047\u8A2D\u6211\u5011\u5728\u53D6\u5F97 frame \u7684\u9396\u4E4B\u524D\u653E\u6389 bpm \u7684\u9396\uFF0C\u90A3\u9EBC\u5728\u9019\u6BB5\u6642\u9593\u5167\uFF0C\u5176\u4ED6\u7684\u57F7\u884C\u7DD2\u5C31\u6709\u53EF\u80FD\u6703\u63D2\u968A\uFF0C\u9019\u6A23\u6703\u4E0D\u6703\u5C0E\u81F4\u6211\u5011\u53D6\u5F97\u7684 frame \u4E0D\u662F\u6211\u5011\u60F3\u8981\u7684 frame \u5462?"}),"\n",(0,s.jsxs)(n.p,{children:["\u7B54\u6848\u662F\u4E0D\u6703\uFF0C\u56E0\u70BA\u6211\u5011\u6703\u5728\u6301\u6709 bpm \u7684\u9396\u7684\u6642\u5019\u5C31\u66F4\u65B0 ",(0,s.jsx)(n.code,{children:"pin_count_"})," \u8DDF ",(0,s.jsx)(n.code,{children:"is_evictable_"}),"\uFF0C\u6240\u4EE5\u5373\u4F7F\u5176\u4ED6\u57F7\u884C\u7DD2\u63D2\u968A\u4E5F\u4E0D\u6703\u5C0E\u81F4\u6211\u5011\u8981\u7684 frame \u88AB evict \u6389\uFF0C\u53EA\u662F\u6703\u5728\u57F7\u884C\u9806\u5E8F\u4E0A\u6709\u4E9B\u4E0D\u540C\u800C\u5DF2\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u7D9C\u5408\u4EE5\u4E0A\u7684\u4E09\u500B\u9650\u5236\uFF0C\u6211\u5728\u5BE6\u4F5C\u4E0A\u63A1\u53D6\u7684\u65B9\u6CD5\u662F\u5728 ",(0,s.jsx)(n.code,{children:"CheckedWritePage"})," \u4E2D\u4F7F\u7528 ",(0,s.jsx)(n.code,{children:"std::unique_lock"})," \u4F86\u53D6\u5F97 bpm \u7684\u9396\uFF0C\u63A5\u8457\u5728\u5275\u5EFA ",(0,s.jsx)(n.code,{children:"WritePageGuard"})," \u524D\u89E3\u9396\uFF0C\u7136\u5F8C\u5728 ",(0,s.jsx)(n.code,{children:"WritePageGuard"})," \u7684 constructor \u53D6\u5F97 frame \u7684\u9396\uFF0C\u6700\u5F8C\u5728 ",(0,s.jsx)(n.code,{children:"Drop()"})," \u7684\u6642\u5019\u5148\u91CB\u653E frame \u7684\u9396\uFF0C\u518D\u4F7F\u7528 bpm \u7684\u9396\u66F4\u65B0 frame \u7684 metadata\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"submit",children:"Submit"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"make lru_k_replacer_test -j$(nproc) && ./test/lru_k_replacer_test\n\nmake disk_scheduler_test -j$(nproc) && ./test/disk_scheduler_test\n\nmake page_guard_test -j$(nproc) && ./test/page_guard_test\n\nmake buffer_pool_manager_test -j$(nproc) && ./test/buffer_pool_manager_test\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"make format && make check-format && make check-lint &&make check-clang-tidy-p1\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"make submit-p1\n"})}),"\n",(0,s.jsx)(n.h2,{id:"takeaways",children:"Takeaways"}),"\n",(0,s.jsx)(n.p,{children:"\u7B2C\u4E00\u6B21\u5BEB\u9019\u500B\u4F5C\u696D\u7684\u6642\u5019\u9084\u662F 2023 fall \u7684\u7248\u672C\uFF0C\u60F3\u8AAA\u6539\u6210 2024 fall \u7684\u7248\u672C\u61C9\u8A72\u4E00\u5929\u5C31\u53EF\u4EE5\u4E86\uFF0C\u7D50\u679C\u7ADF\u7136\u82B1\u4E86\u4E00\u500B\u79AE\u62DC\u624D\u5F04\u5B8C \uD83E\uDEE0"}),"\n",(0,s.jsx)(n.p,{children:"\u4E3B\u8981\u662F\u56E0\u70BA\u65B0\u589E\u7684 PageGuard \u5C0E\u81F4\u5BE6\u4F5C\u4E0A\u8DDF\u539F\u672C\u7684\u5DEE\u7684\u6709\u9EDE\u591A\uFF0C\u4F46\u6211\u76F8\u4FE1\u9019\u500B class \u61C9\u8A72\u6703\u8B93\u5F8C\u9762\u7684 project \u5BE6\u4F5C\u4E0A\u66F4\u7C21\u55AE (\u5427?)"}),"\n",(0,s.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/1657237277",children:"CMU 15445 2024 Fall Project 1 \u8BB0\u5F55"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/828933572",children:"CMU Fall 2024 15-445 P1&P2[\u4F18\u5316 P2]"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://4ever-xxxl.github.io/cmu-15445-project-1/",children:"CMU 15445 Project 1"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.aneureka.com/posts/cmu-15445-p1-opt",children:"CMU 15-445 2023 P1 \u4F18\u5316\u653B\u7565"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/679980578",children:"CMU15-445 2023 Fall Project0~4 \u901A\u5173\u603B\u7ED3"})}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,l.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}function j(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},65:function(e,n,r){r.d(n,{Z:()=>d,a:()=>i});var c=r(7294);let s={},l=c.createContext(s);function i(e){let n=c.useContext(l);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),c.createElement(l.Provider,{value:n},e.children)}}}]);