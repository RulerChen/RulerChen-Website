"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8098],{217:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"CMU15-445/p2","title":"P2 - B+ Tree","description":"B+ tree Index","source":"@site/docs/CMU15-445/p2.mdx","sourceDirName":"CMU15-445","slug":"/CMU15-445/p2","permalink":"/RulerChen-Website/en/docs/CMU15-445/p2","draft":false,"unlisted":false,"editUrl":"https://github.com/RulerChen/RulerChen-Website/tree/main/docs/CMU15-445/p2.mdx","tags":[{"inline":true,"label":"CMU15-445","permalink":"/RulerChen-Website/en/docs/tags/cmu-15-445"},{"inline":true,"label":"CMU15-445 Projects","permalink":"/RulerChen-Website/en/docs/tags/cmu-15-445-projects"}],"version":"current","lastUpdatedAt":1758434181000,"sidebarPosition":102,"frontMatter":{"title":"P2 - B+ Tree","sidebar_position":102,"description":"B+ tree Index","keywords":["CMU15-445/645","B+ Tree","CMU15-445/645 \u7b46\u8a18"],"tags":["CMU15-445","CMU15-445 Projects"]},"sidebar":"tutorialSidebar","previous":{"title":"P1 - Buffer Pool Manager","permalink":"/RulerChen-Website/en/docs/CMU15-445/p1"},"next":{"title":"P3 - Query Execution","permalink":"/RulerChen-Website/en/docs/CMU15-445/p3"}}');var s=r(4848),i=r(8453);const a={title:"P2 - B+ Tree",sidebar_position:"102",description:"B+ tree Index",keywords:["CMU15-445/645","B+ Tree","CMU15-445/645 \u7b46\u8a18"],tags:["CMU15-445","CMU15-445 Projects"]},l=void 0,c={},d=[{value:"Background",id:"background",level:2},{value:"Task 1 - B+Tree Pages",id:"task-1---btree-pages",level:2},{value:"Task 2 - B+Tree Operations",id:"task-2---btree-operations",level:2},{value:"Point Search",id:"point-search",level:3},{value:"Insertion",id:"insertion",level:3},{value:"Deletion",id:"deletion",level:3},{value:"Task 3 - Index Iterator",id:"task-3---index-iterator",level:2},{value:"Task 4 - Concurrency Control",id:"task-4---concurrency-control",level:2},{value:"Submit",id:"submit",level:2},{value:"Takeaways",id:"takeaways",level:2},{value:"References",id:"references",level:2}];function o(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components},{Head:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Head",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r,{children:(0,s.jsx)("title",{children:"CMU 15-445 2024Fall P2 B+ Tree"})}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u9019\u500b project \u4e2d\uff0c\u6211\u5011\u9700\u8981\u5be6\u73fe B+ tree index\uff0c\u7e3d\u5171\u6709 4 \u500b task :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"B+Tree Pages"}),"\n",(0,s.jsx)(n.li,{children:"B+Tree Operations (Insertion, Deletion, and Point Search)"}),"\n",(0,s.jsx)(n.li,{children:"Index Iterator"}),"\n",(0,s.jsx)(n.li,{children:"Concurrency Control"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"background",children:"Background"}),"\n",(0,s.jsx)(n.p,{children:"\u9019\u500b project \u7684\u80cc\u666f\u77e5\u8b58\u61c9\u8a72\u662f\u76f8\u5c0d\u597d\u7406\u89e3\u7684\uff0c\u53ef\u4ee5\u53c3\u8003\u4e0a\u8ab2\u8b1b\u7fa9\u4f86\u719f\u6089 B+ tree \u7684\u7d50\u69cb\u4ee5\u53ca\u64cd\u4f5c\u65b9\u5f0f\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"task-1---btree-pages",children:"Task 1 - B+Tree Pages"}),"\n",(0,s.jsxs)(n.p,{children:["B+ tree \u4e2d\u7e3d\u5171\u6709\u56db\u7a2e page\uff0c\u5206\u5225\u662f ",(0,s.jsx)(n.code,{children:"BPlusTreePage"}),"\u3001",(0,s.jsx)(n.code,{children:"BPlusTreeInternalPage"}),"\u3001",(0,s.jsx)(n.code,{children:"BPlusTreeLeafPage"})," \u4ee5\u53ca ",(0,s.jsx)(n.code,{children:"BPlusTreeHeaderPage"}),"\u3002\n\u9019\u500b task \u53ea\u9700\u8981\u6309\u7167\u8981\u6c42\u8b80\u61c2\u9019\u5e7e\u500b page \u5728\u5e79\u9ebc\u4ee5\u53ca\u5be6\u4f5c\u4e00\u4e9b\u5982\u521d\u59cb\u5316 size \u8ddf type \u4e4b\u985e\u7684\u6771\u897f\u800c\u5df2\uff0c\u9019\u88e1\u5c31\u4e0d\u591a\u8aaa\u660e\u4e86\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u5728 bustub \u4e2d\uff0c\u6bcf\u4e00\u500b page \u7684\u5927\u5c0f\u90fd\u662f 4 kb\uff0c\u4e0b\u9762\u662f\u9019\u56db\u7a2e page \u7684\u7d50\u69cb :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"BPlusTreePage"})," : B+ tree page \u7684 base class\uff0c\u5305\u542b\u4e86\u4e00\u4e9b\u5171\u7528\u7684\u65b9\u6cd5\u53ca\u5c6c\u6027 (page type, size, max size) \u5171 12 bytes"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"BPlusTreeInternalPage"})," : B+ tree \u7684 internal page\uff0c\u5305\u542b\u4e86 key \u8ddf child page id \u7684 mapping\uff0c\u9700\u8981\u6ce8\u610f ",(0,s.jsx)(n.code,{children:"key_array_[0]"})," \u662f\u7121\u610f\u7fa9\u7684"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"BPlusTreeLeafPage"})," : B+ tree \u7684 leaf page\uff0c\u5305\u542b\u4e86 key \u8ddf RID \u7684 mapping\uff0c\u4e26\u4e14\u6709\u4e00\u500b\u6307\u5411\u4e0b\u4e00\u500b leaf page \u7684\u6307\u6a19 ",(0,s.jsx)(n.code,{children:"next_page_id_"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"BPlusTreeHeaderPage"})," : B+ tree \u7684 header page\uff0c\u76ee\u524d\u53ea\u5305\u542b\u4e86 ",(0,s.jsx)(n.code,{children:"root_page_id_"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"task-2---btree-operations",children:"Task 2 - B+Tree Operations"}),"\n",(0,s.jsxs)(n.p,{children:["\u9664\u4e86\u4e0a\u9762\u63d0\u5230\u7684\u5e7e\u500b class \u5916\uff0c\u4e5f\u53ef\u4ee5\u770b\u4e00\u4e0b ",(0,s.jsx)(n.code,{children:"Context"})," \u9019\u500b class \u4f86\u5e6b\u52a9\u6211\u5011\u7ba1\u7406 PageGuard\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"point-search",children:"Point Search"}),"\n",(0,s.jsxs)(n.p,{children:["Search \u7684\u90e8\u5206\u61c9\u8a72\u662f\u88e1\u9762\u6700\u7c21\u55ae\u7684\uff0c\u5f9e root page \u958b\u59cb\u7528 binary search \u7684\u65b9\u6cd5\u4e00\u76f4\u5f80\u4e0b\u641c\u5c0b\uff0c\u76f4\u5230\u627e\u5230 leaf page \u70ba\u6b62\uff0c\u53ef\u4ee5\u628a\u4e2d\u9014\u7684\u7bc0\u9ede\u90fd\u653e\u5230 ",(0,s.jsx)(n.code,{children:"Context"})," \u4e2d\u7684 ",(0,s.jsx)(n.code,{children:"read_set_"})," \u4e2d\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"insertion",children:"Insertion"}),"\n",(0,s.jsx)(n.p,{children:"Insert \u4e3b\u8981\u53ef\u4ee5\u5206\u6210\u4e09\u7a2e\u60c5\u6cc1\u4f86\u8a0e\u8ad6 :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5982\u679c\u662f\u7a7a\u7684 B+ tree\uff0c\u76f4\u63a5\u5efa\u7acb root page \u4e26\u63d2\u5165 key"}),"\n",(0,s.jsx)(n.li,{children:"\u5982\u679c\u6700\u5f8c\u7684\u7bc0\u9ede\u6c92\u6709 overflow\uff0c\u76f4\u63a5\u63d2\u5165 key"}),"\n",(0,s.jsx)(n.li,{children:"\u5982\u679c\u6700\u5f8c\u7684\u7bc0\u9ede overflow\uff0c\u5247\u9700\u8981\u5206\u88c2\u7bc0\u9ede\u4e26\u5c07\u65b0\u7684 key \u63d2\u5165\u5230 parent page \u4e2d\uff0c\u9700\u8981\u905e\u8ff4\u7684\u505a\u9019\u4ef6\u4e8b\u76f4\u5230\u6c92\u6709 overflow \u70ba\u6b62\uff0c\u4e5f\u6709\u53ef\u80fd\u6703\u9700\u8981\u5efa\u7acb\u65b0\u7684 root page"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"deletion",children:"Deletion"}),"\n",(0,s.jsx)(n.p,{children:"Delete \u7684\u60c5\u6cc1\u662f\u4e09\u7a2e\u64cd\u4f5c\u88e1\u9762\u6700\u8907\u96dc\u7684\uff0c\u6211\u662f\u6309\u7167\u4ee5\u4e0b\u7684\u9806\u5e8f\u5be6\u4f5c\u7684 :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5148\u522a\u9664 key\uff0c\u5982\u679c\u6c92\u6709 underflow\uff0c\u5247\u76f4\u63a5\u7d50\u675f (\u8981\u7279\u5225\u6ce8\u610f\u662f root page \u7684\u60c5\u6cc1\uff0c\u5982\u679c\u662f root page \u4e26\u4e14\u6c92\u6709 key \u4e86\uff0c\u5247\u9700\u8981\u5c07\u6574\u500b B+ tree \u6e05\u7a7a)"}),"\n",(0,s.jsx)(n.li,{children:"\u5982\u679c\u6709 underflow\uff0c\u5247\u9700\u8981\u6aa2\u67e5 sibling page \u662f\u5426\u53ef\u4ee5\u501f key\uff0c\u5982\u679c\u53ef\u4ee5\u501f key\uff0c\u5247\u5f9e sibling page \u4e2d\u501f\u4e00\u500b key \u4e26\u66f4\u65b0 parent page \u7684 key\uff0c\u9019\u7a2e\u65b9\u5f0f\u4e0d\u9700\u8981\u7e7c\u7e8c\u66f4\u65b0\u7236\u7bc0\u9ede"}),"\n",(0,s.jsx)(n.li,{children:"\u5982\u679c sibling page \u4e0d\u80fd\u501f key\uff0c\u5247\u9700\u8981 merge sibling page\uff0c\u4e26\u5c07 parent page \u4e2d\u7684 key \u522a\u9664\uff0c\u7136\u5f8c\u518d\u6aa2\u67e5 parent page \u662f\u5426 underflow\uff0c\u5982\u679c parent page underflow\uff0c\u5247\u9700\u8981\u7e7c\u7e8c\u5f80\u4e0a\u8655\u7406"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"task-3---index-iterator",children:"Task 3 - Index Iterator"}),"\n",(0,s.jsxs)(n.p,{children:["\u9019\u500b\u90e8\u5206\u611f\u89ba\u4e5f\u6c92\u4ec0\u9ebc\u7279\u5225\u7684\uff0c\u5c31\u662f\u4e00\u76f4\u8b80\u53d6\u4e0b\u4e00\u500b page\uff0c\u9700\u8981\u81ea\u5df1\u6c7a\u5b9a\u4e00\u4e0b ",(0,s.jsx)(n.code,{children:"IsEnd()"})," \u60f3\u8981\u5be6\u4f5c\u6210\u4ec0\u9ebc\u6a23\u5b50\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u81ea\u5df1\u7684\u505a\u6cd5\u662f\u8868\u793a\u6210 ",(0,s.jsx)(n.code,{children:"read_page->GetNextPageId() == INVALID_PAGE_ID && index_ >= read_page->GetSize()"}),"\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"task-4---concurrency-control",children:"Task 4 - Concurrency Control"}),"\n",(0,s.jsx)(n.p,{children:"Latch crabbing \u7684\u90e8\u5206\u53ef\u4ee5\u53c3\u8003\u4e0a\u8ab2\u8b1b\u7fa9\uff0c\u57fa\u672c\u4e0a\u5c31\u662f\u6aa2\u67e5\u5b50\u7bc0\u9ede\u662f\u4e0d\u662f\u5b89\u5168\u7684\uff0c\u5982\u679c\u662f\u5b89\u5168\u7684\u5c31\u53ef\u4ee5\u653e\u6389\u7236\u7bc0\u9ede\u7684\u9396\uff0c\u7136\u5f8c\u7e7c\u7e8c\u5f80\u4e0b\u8d70\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u9019\u88e1\u6211\u53ef\u4ee5\u5206\u4eab\u4e00\u500b\u932f\u8aa4\u5be6\u4f5c\uff0c\u9019\u662f\u6211\u5728\u5be6\u4f5c insert \u7684\u6642\u5019\u9047\u5230\u7684\u554f\u984c :"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"if (IsEmpty()) {\n  WritePageGuard header_guard = bpm_->WritePage(header_page_id_);\n  auto header_page = header_guard.AsMut<BPlusTreeHeaderPage>();\n\n  auto root_page_id = bpm_->NewPage();\n  WritePageGuard root_guard = bpm_->WritePage(root_page_id);\n  auto root_page = root_guard.AsMut<LeafPage>();\n  return root_page->Insert(key, value, comparator_);\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4e0a\u9762\u9019\u500b\u5728 ",(0,s.jsx)(n.code,{children:"IsEmpty()"})," \u7684\u6642\u5019\u662f\u6703\u53bb\u62ff ",(0,s.jsx)(n.code,{children:"header_guard"})," \u7684\uff0c\u4f46\u662f\u4ed6\u8ddf\u4e0b\u9762\u7684 ",(0,s.jsx)(n.code,{children:"header_guard"})," \u662f\u4e0d\u9023\u7e8c\u7684\uff0c\u9019\u4e2d\u9593\u5c31\u6709\u53ef\u80fd\u7522\u751f\u932f\u8aa4\u3002\n\u56e0\u6b64\u8981\u76e1\u91cf\u907f\u514d\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"IsEmpty()"})," \u4f86\u6aa2\u67e5\u6574\u500b\u6a39\u662f\u5426\u70ba\u7a7a\uff0c\u6539\u6210\u76f4\u63a5\u5728\u88e1\u9762\u62ff ",(0,s.jsx)(n.code,{children:"header_guard"})," \u5224\u65b7\u624d\u662f\u5c0d\u7684\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u984c\u5916\u8a71\uff0ccontention test \u4f3c\u4e4e\u53ea\u91dd\u5c0d ",(0,s.jsx)(n.code,{children:"Insert"})," \u7684\u90e8\u5206\u9032\u884c\u6e2c\u8a66\uff0c\u56e0\u6b64\u5728 ",(0,s.jsx)(n.code,{children:"Insert"})," \u7684\u6642\u5019\u8981\u7279\u5225\u6ce8\u610f latch crabbing \u7684\u5be6\u4f5c\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"submit",children:"Submit"}),"\n",(0,s.jsx)(n.p,{children:"\u9019\u500b project \u63d0\u4f9b\u4e86\u7dda\u4e0a\u7684 B+ tree visualizer\uff0c\u53ef\u4ee5\u7528\u4f86\u6aa2\u67e5\u81ea\u5df1\u7684 B+ tree \u662f\u5426\u6b63\u78ba :"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"make b_plus_tree_printer -j\n./bin/b_plus_tree_printer\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4e26\u900f\u904e\u9019\u500b",(0,s.jsx)(n.a,{href:"http://dreampuf.github.io/GraphvizOnline/",children:"\u7dda\u4e0a B+ tree visualizer"})," \u4f86\u6aa2\u67e5\u81ea\u5df1\u7684 B+ tree \u662f\u5426\u6b63\u78ba\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"make b_plus_tree_insert_test -j$(nproc) && ./test/b_plus_tree_insert_test\n\nmake b_plus_tree_sequential_scale_test -j$(nproc) && ./test/b_plus_tree_sequential_scale_test\n\nmake b_plus_tree_delete_test -j$(nproc) && ./test/b_plus_tree_delete_test\n\nmake b_plus_tree_contention_test -j$(nproc) && ./test/b_plus_tree_contention_test\n\nmake b_plus_tree_concurrent_test -j$(nproc) && ./test/b_plus_tree_concurrent_test\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"make format && make check-format && make check-lint && make check-clang-tidy-p2\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"make submit-p2\n"})}),"\n",(0,s.jsx)(n.h2,{id:"takeaways",children:"Takeaways"}),"\n",(0,s.jsx)(n.p,{children:"\u9019\u500b project \u5728\u5beb\u7684\u6642\u5019\u611f\u89ba\u82b1\u4e86\u5f88\u591a\u6642\u9593\uff0c\u4f46\u771f\u7684\u5230\u8981\u5beb\u7e3d\u7d50\u7684\u6642\u5019\uff0c\u537b\u53c8\u767c\u73fe\u597d\u50cf\u90fd\u662f\u4e00\u4e9b\u5c0f\u7d30\u7bc0\u800c\u5df2\u4e0d\u77e5\u9053\u8981\u5beb\u5565\u54c8\u54c8\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u9084\u6709\u4e00\u500b\u554f\u984c\u662f\u5728\u65bc contention test \u90a3\u908a\u6211\u5728 gradescope \u4e0a\u9762\u4e00\u76f4\u5230\u4e0d\u4e86 [2.5,3.5] \u7684\u7bc4\u570d (\u5927\u6982\u90fd\u5728 2.3 \u5de6\u53f3)\uff0c\u611f\u89ba\u61c9\u8a72\u6709\u751a\u9ebc\u6c92\u6709\u6ce8\u610f\u5230\u7684\u7d30\u7bc0\u4f46\u4e5f\u6709\u9ede\u61f6\u5f97\u7e7c\u7e8c debug \u4e0b\u53bb\u4e86\uff0c\u7e3d\u4e4b\u9019\u500b project \u5c31\u662f\u9019\u6a23\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.aneureka.com/posts/cmu-15445-p2-opt",children:"CMU 15-445 2023 P2 \u4f18\u5316\u653b\u7565"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/828933572",children:"CMU Fall 2024 15-445 P1&P2[\u4f18\u5316 P2]"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7526343800874565670",children:"CMU15445-2024fall-project2\u8e29\u5751\u7ecf\u5386"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>l});var t=r(6540);const s={},i=t.createContext(s);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);