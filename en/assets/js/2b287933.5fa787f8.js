"use strict";(self.webpackChunkrulerchen_website=self.webpackChunkrulerchen_website||[]).push([["4960"],{6260:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>c,toc:()=>h,default:()=>a,metadata:()=>s,assets:()=>t,contentTitle:()=>d});var s=JSON.parse('{"id":"SystemDesign/dropbox","title":"Design a Cloud Storage Service like Dropbox","description":"Design a Cloud Storage Service like Dropbox","source":"@site/docs/SystemDesign/dropbox.mdx","sourceDirName":"SystemDesign","slug":"/SystemDesign/dropbox","permalink":"/RulerChen-Website/en/docs/SystemDesign/dropbox","draft":false,"unlisted":false,"editUrl":"https://github.com/RulerChen/RulerChen-Website/tree/main/docs/SystemDesign/dropbox.mdx","tags":[{"inline":true,"label":"System Design","permalink":"/RulerChen-Website/en/docs/tags/system-design"}],"version":"current","lastUpdatedAt":1760847262000,"sidebarPosition":2,"frontMatter":{"title":"Design a Cloud Storage Service like Dropbox","sidebar_position":2,"description":"Design a Cloud Storage Service like Dropbox","keywords":["Cloud Storage","System Design"],"tags":["System Design"]},"sidebar":"tutorialSidebar","previous":{"title":"Design a URL Shortener like TinyURL","permalink":"/RulerChen-Website/en/docs/SystemDesign/tinyurl"},"next":{"title":"Shell Introduction","permalink":"/RulerChen-Website/en/docs/Other/shell"}}'),l=i(4848),r=i(4429);let c={title:"Design a Cloud Storage Service like Dropbox",sidebar_position:"2",description:"Design a Cloud Storage Service like Dropbox",keywords:["Cloud Storage","System Design"],tags:["System Design"]},d,t={},h=[{value:"Background",id:"background",level:2},{value:"Requirements",id:"requirements",level:2},{value:"Functional Requirements",id:"functional-requirements",level:3},{value:"Non-Functional Requirements",id:"non-functional-requirements",level:3},{value:"The Set up",id:"the-set-up",level:2},{value:"Back of the Envelope Estimation",id:"back-of-the-envelope-estimation",level:3},{value:"Assumptions",id:"assumptions",level:4},{value:"QPS",id:"qps",level:4},{value:"Storage",id:"storage",level:4},{value:"Bandwidth",id:"bandwidth",level:4},{value:"Schema Design",id:"schema-design",level:3},{value:"API Design",id:"api-design",level:3},{value:"1. Create Item (File / Folder)",id:"1-create-item-file--folder",level:4},{value:"2. Upload File",id:"2-upload-file",level:4},{value:"3. Chunk Upload Completion",id:"3-chunk-upload-completion",level:4},{value:"4. Get File Metadata",id:"4-get-file-metadata",level:4},{value:"5. Download File",id:"5-download-file",level:4},{value:"6. Share File",id:"6-share-file",level:4},{value:"7. Get History File Metadata",id:"7-get-history-file-metadata",level:4},{value:"8. Sync Notifications",id:"8-sync-notifications",level:4},{value:"High-Level Design",id:"high-level-design",level:2},{value:"User should be able to upload file from any device",id:"user-should-be-able-to-upload-file-from-any-device",level:3},{value:"User should be able to download file from any device",id:"user-should-be-able-to-download-file-from-any-device",level:3},{value:"User should be able to share file with other users",id:"user-should-be-able-to-share-file-with-other-users",level:3},{value:"File should be automatically synced to other devices and handle conflicts",id:"file-should-be-automatically-synced-to-other-devices-and-handle-conflicts",level:3},{value:"Local -&gt; Remote",id:"local---remote",level:4},{value:"Remote -&gt; Local",id:"remote---local",level:4},{value:"User should be able to access previous versions of files",id:"user-should-be-able-to-access-previous-versions-of-files",level:3},{value:"Deep Dives",id:"deep-dives",level:2},{value:"How to support large file upload?",id:"how-to-support-large-file-upload",level:3},{value:"How to chunk files efficiently?",id:"how-to-chunk-files-efficiently",level:3},{value:"How to scaling metadata database?",id:"how-to-scaling-metadata-database",level:3},{value:"How to scaling file change notification?",id:"how-to-scaling-file-change-notification",level:3},{value:"Final Design",id:"final-design",level:2},{value:"References",id:"references",level:2}];function o(e){let n={a:"a",code:"code",del:"del",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components},{Details:i,ImageModal:s}=n;return i||u("Details",!0),s||u("ImageModal",!0),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h2,{id:"background",children:"Background"}),"\n",(0,l.jsx)(n.p,{children:"Dropbox / Google Drive \u662F\u4E00\u7A2E\u96F2\u7AEF\u5132\u5B58\u670D\u52D9\uFF0C\u5141\u8A31\u4F7F\u7528\u8005\u4E0A\u50B3\u5404\u7A2E\u985E\u578B\u7684\u6A94\u6848\uFF0C\u5305\u62EC\u6587\u4EF6\u3001\u5716\u7247\u3001\u5F71\u7247\u7B49\uFF0C\u4E26\u8207\u5176\u4ED6\u4F7F\u7528\u8005\u5206\u4EAB\u9019\u4E9B\u6A94\u6848\uFF0C\u9084\u80FD\u5920\u5728\u4E0D\u540C\u7684\u88DD\u7F6E\u4E0A\u9032\u884C\u6A94\u6848\u540C\u6B65\uFF0C\u78BA\u4FDD\u4F7F\u7528\u8005\u5728\u4EFB\u4F55\u5730\u65B9\u90FD\u80FD\u5920\u5B58\u53D6\u6700\u65B0\u7248\u672C\u7684\u6A94\u6848\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,l.jsx)(n.h3,{id:"functional-requirements",children:"Functional Requirements"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4F7F\u7528\u8005\u53EF\u4EE5\u5728\u4EFB\u4F55\u88DD\u7F6E\u4E0A\u50B3\u8DDF\u4E0B\u8F09\u6A94\u6848"}),"\n",(0,l.jsx)(n.li,{children:"\u4F7F\u7528\u8005\u53EF\u4EE5\u8DDF\u5176\u4ED6\u4EBA\u5206\u4EAB\u6A94\u6848"}),"\n",(0,l.jsx)(n.li,{children:"\u6A94\u6848\u53EF\u4EE5\u81EA\u52D5\u540C\u6B65\u5230\u5176\u4ED6\u7684\u8A2D\u5099\u4E26\u8655\u7406\u885D\u7A81"}),"\n",(0,l.jsx)(n.li,{children:"\u53EF\u4EE5\u96E2\u7DDA\u4FEE\u6539\u6A94\u6848\uFF0C\u4E26\u5728\u91CD\u65B0\u9023\u7DDA\u5F8C\u81EA\u52D5\u540C\u6B65"}),"\n",(0,l.jsx)(n.li,{children:"\u7CFB\u7D71\u80FD\u5B58\u53D6\u904E\u53BB 30 \u5929\u5167\u7684\u6A94\u6848\u7248\u672C"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.del,{children:"\u91DD\u5C0D\u4E0D\u540C\u6A94\u6848 / \u8CC7\u6599\u593E\u53EF\u4EE5\u8A2D\u5B9A\u4E0D\u540C\u7684\u6B0A\u9650"})}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"non-functional-requirements",children:"Non-Functional Requirements"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u9AD8\u53EF\u7528\u6027 (\u53EF\u7528\u6027 > \u4E00\u81F4\u6027)"}),"\n",(0,l.jsx)(n.li,{children:"\u53EF\u4EE5\u652F\u6301\u8D85\u5927\u6A94\u6848\u4E0A\u50B3 (> 10GB)"}),"\n",(0,l.jsx)(n.li,{children:"\u53EF\u9760\u6027\uFF0C\u6A94\u6848\u4E00\u65E6\u4E0A\u50B3\u5C31\u4E0D\u6703\u907A\u5931"}),"\n",(0,l.jsx)(n.li,{children:"\u4F4E\u5EF6\u9072\uFF0C\u4E0B\u8F09 / \u4E0A\u50B3\u6A94\u6848\u7684\u5EF6\u9072\u76E1\u53EF\u80FD\u4F4E"}),"\n",(0,l.jsx)(n.li,{children:"\u53EF\u64F4\u5C55\u6027\uFF0C\u53EF\u4EE5\u652F\u6301\u5927\u91CF\u4F7F\u7528\u8005"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.del,{children:"\u5B89\u5168\u6027\uFF0C\u6A94\u6848\u61C9\u8A72\u88AB\u52A0\u5BC6"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"the-set-up",children:"The Set up"}),"\n",(0,l.jsx)(n.h3,{id:"back-of-the-envelope-estimation",children:"Back of the Envelope Estimation"}),"\n",(0,l.jsx)(n.h4,{id:"assumptions",children:"Assumptions"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"100M DAU"}),"\n",(0,l.jsx)(n.li,{children:"\u6BCF\u500B\u4F7F\u7528\u8005\u5E73\u5747\u6BCF\u5929\u4E0A\u50B3 10 \u500B\u6A94\u6848"}),"\n",(0,l.jsx)(n.li,{children:"\u6BCF\u500B\u6A94\u6848\u5E73\u5747\u5927\u5C0F 10MB"}),"\n",(0,l.jsx)(n.li,{children:"\u8B80\u5BEB\u6BD4\u4F8B 1:1"}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"qps",children:"QPS"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6BCF\u79D2\u5E73\u5747\u5BEB\u5165 / \u8B80\u53D6\u8ACB\u6C42\u6578: (100M * 10) / 86400 = 11754"}),"\n",(0,l.jsx)(n.li,{children:"\u9AD8\u5CF0\u671F\u5047\u8A2D\u662F\u5E73\u5747\u7684 5 \u500D: 11754 * 5 = 58770"}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"storage",children:"Storage"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6BCF\u5929\u4E0A\u50B3\u7684\u8CC7\u6599\u91CF: 100M * 10 * 10MB = 10PB"}),"\n",(0,l.jsx)(n.li,{children:"\u6BCF\u5E74\u4E0A\u50B3\u7684\u8CC7\u6599\u91CF: 10PB * 365 = 3.65EB"}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"bandwidth",children:"Bandwidth"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6BCF\u5929\u9700\u8981\u7684\u983B\u5BEC: 10PB"}),"\n",(0,l.jsx)(n.li,{children:"\u6BCF\u79D2\u7684\u4E0A\u50B3 / \u4E0B\u8F09\u6D41\u91CF: 10PB * 8 / 86400 = 926Gbps"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"schema-design",children:"Schema Design"}),"\n",(0,l.jsx)(n.p,{children:"\u9019\u88E1\u7684 item \u53EF\u4EE5\u662F\u6A94\u6848\u6216\u8CC7\u6599\u593E\uFF0Citem_version \u7528\u4F86\u8A18\u9304\u6A94\u6848\u7684\u4E0D\u540C\u7248\u672C\uFF0Cchunk \u7528\u4F86\u8A18\u9304\u6A94\u6848\u88AB\u5207\u6210\u7684\u591A\u500B chunk\uFF0Cshared_file \u7528\u4F86\u8A18\u9304\u6A94\u6848\u7684\u5206\u4EAB\u8CC7\u8A0A\u3002"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["item","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"item_id"}),"\n",(0,l.jsx)(n.li,{children:"owner_id"}),"\n",(0,l.jsx)(n.li,{children:"namespace_id"}),"\n",(0,l.jsx)(n.li,{children:"name"}),"\n",(0,l.jsx)(n.li,{children:"latest_version"}),"\n",(0,l.jsx)(n.li,{children:"item_type (file / folder)"}),"\n",(0,l.jsx)(n.li,{children:"parent_item_id (null if root)"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["item_version","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"item_id"}),"\n",(0,l.jsx)(n.li,{children:"version_number"}),"\n",(0,l.jsx)(n.li,{children:"namespace_id"}),"\n",(0,l.jsx)(n.li,{children:"chunks (list of chunk checksums)"}),"\n",(0,l.jsx)(n.li,{children:"status (pending / succeed / failed)"}),"\n",(0,l.jsx)(n.li,{children:"size (in bytes)"}),"\n",(0,l.jsx)(n.li,{children:"checksum (SHA256 of the whole file)"}),"\n",(0,l.jsx)(n.li,{children:"created_at"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["chunk","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"checksum (SHA256)"}),"\n",(0,l.jsx)(n.li,{children:"status (pending / succeed / failed)"}),"\n",(0,l.jsx)(n.li,{children:"size (in bytes)"}),"\n",(0,l.jsx)(n.li,{children:"access_url (URL to access the chunk in the storage service)"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["shared_file","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"shared_with_user_id"}),"\n",(0,l.jsx)(n.li,{children:"item_id"}),"\n",(0,l.jsx)(n.li,{children:"permissions (e.g., read, write)"}),"\n",(0,l.jsx)(n.li,{children:"shared_at"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u9664\u6B64\u4E4B\u5916\uFF0C\u9084\u9700\u8981\u4E00\u500B\u7528\u65BC\u5132\u5B58\u8B8A\u66F4\u7684\u8868\uFF0C\u7528\u4F86\u5E6B\u52A9\u4F7F\u7528\u8005\u5728\u91CD\u65B0\u9023\u7DDA\u5F8C\u540C\u6B65\u6A94\u6848\u3002"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["file_changes","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"change_id"}),"\n",(0,l.jsx)(n.li,{children:"user_id"}),"\n",(0,l.jsx)(n.li,{children:"item_id"}),"\n",(0,l.jsx)(n.li,{children:"version_number"}),"\n",(0,l.jsx)(n.li,{children:"change_type (created / updated / deleted)"}),"\n",(0,l.jsx)(n.li,{children:"timestamp"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"api-design",children:"API Design"}),"\n",(0,l.jsx)(n.h4,{id:"1-create-item-file--folder",children:"1. Create Item (File / Folder)"}),"\n",(0,l.jsxs)(i,{children:[(0,l.jsx)("summary",{children:"\u5EFA\u7ACB\u65B0\u7684\u6A94\u6848\u6216\u8CC7\u6599\u593E"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-http",children:'POST /api/items\n{\n    "name": "file.txt",\n    "item_type": "file",\n    "parent_item_id": "folder_123"\n}\nResponse: HTTP 201 Created\n{\n    "item_id": "item_123",\n    "name": "file.txt",\n    "item_type": "file",\n    "parent_item_id": "folder_123",\n    "owner_id": "user_456",\n    "latest_version": 1\n}\n'})})]}),"\n",(0,l.jsx)(n.h4,{id:"2-upload-file",children:"2. Upload File"}),"\n",(0,l.jsxs)(i,{children:[(0,l.jsx)("summary",{children:"\u4E0A\u50B3\u6A94\u6848\uFF0C\u6A94\u6848\u6703\u5728\u5BA2\u6236\u7AEF\u88AB\u5207\u6210\u591A\u500B chunk \u4E26\u767C\u9001\u7D66\u5F8C\u7AEF\uFF0C\u5F8C\u7AEF\u6703\u56DE\u50B3\u9700\u8981\u4E0A\u50B3\u7684 chunk \u7684 pre-signed URL"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-http",children:'POST /api/items/{item_id}/upload\n{\n    "base_version": 1,\n    "size": 10485760, \n    "chunks": [\n        {\n            "checksum": "abc123",\n            "size": 5242880\n        },\n        {\n            "checksum": "def456",\n            "size": 5242880\n        }\n    ]\n}\nResponse: HTTP 200 OK\n{\n    "item_id": "item_123",\n    "version_number": 2,\n    "chunks": [\n        {\n            "checksum": "abc123",\n            "upload_url": "https://storage-service.com/upload/abc123"\n        }\n    ]\n}\n'})})]}),"\n",(0,l.jsx)(n.h4,{id:"3-chunk-upload-completion",children:"3. Chunk Upload Completion"}),"\n",(0,l.jsxs)(i,{children:[(0,l.jsx)("summary",{children:"\u6BCF\u500B chunk \u4E0A\u50B3\u5B8C\u6210\u5F8C\uFF0C\u5BA2\u6236\u7AEF\u6703\u901A\u77E5\u5F8C\u7AEF\u8A72 chunk \u5DF2\u7D93\u4E0A\u50B3\u5B8C\u6210"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-http",children:'PATCH /api/items/{item_id}/version/{version_number}/chunks/complete\n{\n    "completed_chunks": [\n        {\n            "checksum": "abc123",\n            "status": "succeed"\n        },\n        {\n            "checksum": "def456",\n            "status": "succeed"\n        }\n    ]\n}\nResponse: HTTP 200 OK\n{\n    "item_id": "item_123",\n    "version_number": 2,\n    "status": "pending",\n    "chunks": [\n        {\n            "checksum": "abc123",\n            "status": "succeed"\n        },\n        {\n            "checksum": "def456",\n            "status": "succeed"\n        }\n    ]\n}\n'})})]}),"\n",(0,l.jsx)(n.h4,{id:"4-get-file-metadata",children:"4. Get File Metadata"}),"\n",(0,l.jsxs)(i,{children:[(0,l.jsx)("summary",{children:"\u56DE\u50B3\u76EE\u524D\u6700\u65B0\u7684\u53EF\u7528\u7248\u672C\u7684\u6A94\u6848 metadata\uFF0C\u5305\u62EC\u7248\u672C\u865F\u3001\u5927\u5C0F\u3001checksum \u4EE5\u53CA chunk \u72C0\u614B"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-http",children:'GET /api/items/{item_id}/metadata\nResponse: HTTP 200 OK\n{\n    "item_id": "item_123",\n    "version_number": 2,\n    "size": 10485760,\n    "checksum": "overall_checksum",\n    "chunks": [\n        {\n            "checksum": "abc123",\n            "status": "succeed"\n        },\n        {\n            "checksum": "def456",\n            "status": "succeed"\n        }\n    ]\n}\n'})})]}),"\n",(0,l.jsx)(n.h4,{id:"5-download-file",children:"5. Download File"}),"\n",(0,l.jsxs)(i,{children:[(0,l.jsx)("summary",{children:"\u56DE\u50B3\u6240\u6709\u9700\u8981\u7684 chunk \u7684 access URL \u4EE5\u4F9B\u4E0B\u8F09"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-http",children:'GET /api/items/{item_id}/versions/{version_number}\n{\n    "chunks": [\n        "abc123"\n    ]\n}\nResponse: HTTP 200 OK\n{\n    "item_id": "item_123",\n    "version_number": 2,\n    "chunk_access_urls": [\n        {\n            "checksum": "abc123",\n            "access_url": "https://storage-service.com/download/abc123"\n        }\n    ]\n}\n'})})]}),"\n",(0,l.jsx)(n.h4,{id:"6-share-file",children:"6. Share File"}),"\n",(0,l.jsxs)(i,{children:[(0,l.jsx)("summary",{children:"\u5C07\u6A94\u6848\u5206\u4EAB\u7D66\u5176\u4ED6\u4F7F\u7528\u8005\uFF0C\u4E26\u8A2D\u5B9A\u6B0A\u9650"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-http",children:'POST /api/items/{item_id}/shares\n{\n    "shared_with_user": [\n        {\n            "user_id": "user_456",\n            "permissions": "read"\n        },\n        {\n            "user_id": "user_789",\n            "permissions": "write"\n        }\n    ]\n}\nResponse: HTTP 200 OK\n{\n    "item_id": "item_123",\n    "shared_with_user": [\n        {\n            "user_id": "user_456",\n            "permissions": "read"\n        },\n        {\n            "user_id": "user_789",\n            "permissions": "write"\n        }\n    ],\n    "shared_at": "2023-10-01T12:00:00Z"\n}\n'})})]}),"\n",(0,l.jsx)(n.h4,{id:"7-get-history-file-metadata",children:"7. Get History File Metadata"}),"\n",(0,l.jsxs)(i,{children:[(0,l.jsx)("summary",{children:"\u7528\u65BC\u8ACB\u6C42\u7279\u5B9A\u7248\u672C\u6A94\u6848\u7684 metadata\uFF0C\u5305\u62EC\u7248\u672C\u865F\u3001\u5927\u5C0F\u3001checksum \u4EE5\u53CA chunk \u72C0\u614B"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-http",children:'GET /api/items/{item_id}/versions/{version_number}/metadata\nResponse: HTTP 200 OK\n{\n    "item_id": "item_123",\n    "version_number": 2,\n    "size": 10485760,\n    "checksum": "overall_checksum",\n    "chunks": [\n        {\n            "checksum": "abc123",\n            "status": "succeed"\n        },\n        {\n            "checksum": "def456",\n            "status": "succeed"\n        }\n    ]\n}\n'})})]}),"\n",(0,l.jsx)(n.h4,{id:"8-sync-notifications",children:"8. Sync Notifications"}),"\n",(0,l.jsxs)(i,{children:[(0,l.jsx)("summary",{children:"\u6AA2\u67E5\u5F9E\u4E0A\u6B21\u540C\u6B65\u4EE5\u4F86\u7684\u8B8A\u66F4"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-http",children:'GET /api/sync/changes?since_timestamp=2023-10-01T12:00:00Z\nResponse: HTTP 200 OK\n{\n    "changes": [\n        {\n            "item_id": "item_123",\n            "version_number": 2,\n            "change_type": "updated",\n            "timestamp": "2023-10-01T12:30:00Z"\n        },\n        {\n            "item_id": "item_456",\n            "version_number": 1,\n            "change_type": "created",\n            "timestamp": "2023-10-01T12:45:00Z"\n        }\n    ]\n}\n'})})]}),"\n",(0,l.jsx)(n.h2,{id:"high-level-design",children:"High-Level Design"}),"\n",(0,l.jsx)(s,{src:"/img/system-design/dropbox/image.webp",caption:"Dropbox High Level Design"}),"\n",(0,l.jsx)(n.h3,{id:"user-should-be-able-to-upload-file-from-any-device",children:"User should be able to upload file from any device"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5BA2\u6236\u7AEF\u7684 chunker \u5C07\u8981\u4E0A\u50B3\u7684\u6A94\u6848\u5207\u6210\u591A\u500B chunk"}),"\n",(0,l.jsxs)(n.li,{children:["\u5982\u679C\u662F\u65B0\u7684\u6A94\u6848\uFF0C\u5BA2\u6236\u7AEF\u6703\u767C\u9001 ",(0,l.jsx)(n.code,{children:"POST /api/items"})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\uFF0C\u5F8C\u7AEF\u6703\u5EFA\u7ACB\u4E00\u500B\u65B0\u7684 item \u4E26\u56DE\u50B3 item_id"]}),"\n",(0,l.jsx)(n.li,{children:"\u63A5\u8457\u5C07\u6240\u6709 chunk \u7684 checksum \u767C\u9001\u5230\u5F8C\u7AEF\uFF0C\u5F8C\u7AEF\u6703\u6AA2\u67E5\u54EA\u4E9B chunk \u5DF2\u7D93\u5B58\u5728\u4E26\u56DE\u50B3\u9700\u8981\u4E0A\u50B3\u7684 chunk \u7684 pre-signed URL"}),"\n",(0,l.jsx)(n.li,{children:"\u5BA2\u6236\u7AEF\u6839\u64DA\u56DE\u50B3\u7684 pre-signed URL \u4E0A\u50B3\u9700\u8981\u7684 chunk \u5230 blob storage \u4E2D"}),"\n",(0,l.jsxs)(n.li,{children:["\u4E00\u65E6\u6709 chunk \u4E0A\u50B3\u5B8C\u6210\uFF0C\u5BA2\u6236\u7AEF\u6703\u767C\u9001 ",(0,l.jsx)(n.code,{children:"PATCH /api/items/{item_id}/version/{version_number}/chunks/complete"})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\uFF0C\u544A\u77E5\u5F8C\u7AEF\u8A72 chunk \u5DF2\u7D93\u4E0A\u50B3\u5B8C\u6210"]}),"\n",(0,l.jsx)(n.li,{children:"\u5F8C\u7AEF\u900F\u904E\u8A72 chunk \u7684 checksum \u8DDF blob storage \u9032\u884C\u6BD4\u5C0D\uFF0C\u78BA\u4FDD chunk \u4E0A\u50B3\u6B63\u78BA\u7121\u8AA4"}),"\n",(0,l.jsx)(n.li,{children:"\u4E00\u65E6\u6240\u6709 chunk \u90FD\u4E0A\u50B3\u5B8C\u6210\uFF0C\u5F8C\u7AEF\u6703\u81EA\u52D5\u5224\u5B9A\u7248\u672C\u70BA\u6210\u529F\u4E26\u66F4\u65B0 item \u7684\u6700\u65B0\u72C0\u614B"}),"\n",(0,l.jsx)(n.li,{children:"\u5168\u90E8\u90FD\u5B8C\u6210\u5F8C\uFF0C\u5F8C\u7AEF\u6703\u50B3\u4E00\u500B\u8A0A\u606F\u7D66\u4E0B\u6E38\u7684\u670D\u52D9\uFF0C\u901A\u77E5\u6709\u65B0\u7684\u6A94\u6848\u7248\u672C\u53EF\u4EE5\u4F7F\u7528"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"user-should-be-able-to-download-file-from-any-device",children:"User should be able to download file from any device"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5BA2\u6236\u7AEF\u767C\u9001 ",(0,l.jsx)(n.code,{children:"GET /api/items/{item_id}/metadata"})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\u62FF\u6700\u65B0\u7248\u672C\u7684\u8CC7\u8A0A\uFF0C\u4E26\u6AA2\u67E5\u90A3\u4E9B chunk \u9700\u8981\u4E0B\u8F09"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5BA2\u6236\u7AEF\u767C\u9001 ",(0,l.jsx)(n.code,{children:"GET /api/items/{item_id}/versions/{version_number}"})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\uFF0C\u5F8C\u7AEF\u6703\u56DE\u50B3\u9700\u8981\u7684 chunk \u7684 access URL"]}),"\n",(0,l.jsx)(n.li,{children:"\u5BA2\u6236\u7AEF\u4F7F\u7528 access URL \u4E0B\u8F09 chunk\uFF0C\u4E26\u5728\u672C\u5730\u5408\u4F75\u6210\u5B8C\u6574\u7684\u6A94\u6848"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u9664\u6B64\u4E4B\u5916\uFF0C\u4E5F\u53EF\u4EE5\u642D\u914D CDN \u4F86\u52A0\u901F\u4E0B\u8F09\u901F\u5EA6\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"user-should-be-able-to-share-file-with-other-users",children:"User should be able to share file with other users"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5BA2\u6236\u7AEF\u767C\u9001 ",(0,l.jsx)(n.code,{children:"POST /api/items/{item_id}/shares"})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\uFF0C\u4E26\u8A2D\u5B9A\u5206\u4EAB\u7684\u4F7F\u7528\u8005\u548C\u6B0A\u9650"]}),"\n",(0,l.jsxs)(n.li,{children:["\u7576\u88AB\u5206\u4EAB\u7684\u4F7F\u7528\u8005\u767C\u9001\u8ACB\u6C42\u5230\u5F8C\u7AEF\u6642\uFF0C\u5F8C\u7AEF\u6703\u6AA2\u67E5 ",(0,l.jsx)(n.code,{children:"shared_file"})," \u8868\u4EE5\u78BA\u5B9A\u8A72\u4F7F\u7528\u8005\u662F\u5426\u6709\u5B58\u53D6\u6B0A\u9650"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"file-should-be-automatically-synced-to-other-devices-and-handle-conflicts",children:"File should be automatically synced to other devices and handle conflicts"}),"\n",(0,l.jsx)(n.p,{children:"\u6A94\u6848\u540C\u6B65\u4E3B\u8981\u5206\u6210\u5169\u500B\u65B9\u5411\uFF0C\u672C\u5730\u7AEF\u8B8A\u66F4\u540C\u6B65\u5230\u9060\u7AEF\u4EE5\u53CA\u9060\u7AEF\u8B8A\u66F4\u540C\u6B65\u5230\u672C\u5730\u7AEF\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u5982\u679C\u767C\u751F\u885D\u7A81\u7684\u8A71\uFF0C\u61C9\u8A72\u8981\u5728\u672C\u5730\u5275\u5EFA\u4E00\u500B\u65B0\u7684\u7248\u672C\uFF0C\u4E26\u4EA4\u7531\u4F7F\u7528\u8005\u4F86\u6C7A\u5B9A\u8981\u4FDD\u7559\u54EA\u4E00\u500B\u7248\u672C\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"local---remote",children:"Local -> Remote"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5BA2\u6236\u7AEF\u4F7F\u7528 OS \u7684 API \u76E3\u63A7\u6A94\u6848\u7CFB\u7D71\u7684\u8B8A\u5316 (\u4F8B\u5982 Linux \u7684 inotify, Windows \u7684 FileSystemWatcher, macOS \u7684 FSEvents)"}),"\n",(0,l.jsxs)(n.li,{children:["\u5728\u672C\u5730\u91CD\u65B0\u5207 chunk\uFF0C\u4E26\u547C\u53EB ",(0,l.jsx)(n.code,{children:"PATCH /api/items/{item_id}/versions/{version_number}/chunks"})," API \u4E0A\u50B3\u8B8A\u66F4\u7684 chunk\uFF0C\u5F8C\u7AEF\u6703\u6AA2\u67E5\u885D\u7A81\u4E26\u56DE\u50B3\u6240\u9700\u7684 chunk \u7684 pre-signed URL"]}),"\n",(0,l.jsx)(n.li,{children:"\u5BA2\u6236\u7AEF\u4F7F\u7528 pre-signed URL \u5C07 chunk \u4E0A\u50B3\u5230 blob storage"}),"\n",(0,l.jsxs)(n.li,{children:["\u4E0A\u50B3\u5B8C\u6210\u5F8C\uFF0C\u5BA2\u6236\u7AEF\u6703\u767C\u9001 ",(0,l.jsx)(n.code,{children:"PATCH /api/items/{item_id}/versions/{version_number}/chunks/complete"})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\u901A\u77E5 chunk \u4E0A\u50B3\u5B8C\u6210"]}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"remote---local",children:"Remote -> Local"}),"\n",(0,l.jsx)(n.p,{children:"\u5F9E\u9060\u7AEF\u66F4\u65B0\u6A94\u6848\u5230\u672C\u5730\u7AEF\u6709\u5E7E\u7A2E\u5E38\u898B\u7684\u65B9\u5F0F :"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Polling: \u5BA2\u6236\u7AEF\u6301\u7E8C\u767C\u9001\u8ACB\u6C42\u5230\u5F8C\u7AEF\uFF0C\u5F8C\u7AEF\u6703\u5728\u6709\u65B0\u7684\u7248\u672C\u6642\u56DE\u50B3\u6700\u65B0\u7248\u672C"}),"\n",(0,l.jsx)(n.li,{children:"WebSocket / SSE: \u5BA2\u6236\u7AEF\u8207\u5F8C\u7AEF\u5EFA\u7ACB WebSocket \u9023\u7DDA\uFF0C\u5F8C\u7AEF\u5728\u6709\u65B0\u7684\u7248\u672C\u6642\u4E3B\u52D5\u63A8\u9001\u901A\u77E5\u7D66\u5BA2\u6236\u7AEF"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u9019\u88E1\u6211\u8A8D\u70BA\u4F7F\u7528 WS / SSE \u6703\u6BD4\u8F03\u597D\uFF0C\u56E0\u70BA Polling \u7684\u958B\u92B7\u8F03\u9AD8\uFF0C\u4E14\u5927\u90E8\u5206\u6642\u9593\u90FD\u662F\u7A7A\u7B49\u3002\n\u5C0D\u65BC WS \u4F86\u8AAA\uFF0C\u6BCF\u500B\u9023\u63A5\u5927\u7D04\u9700\u8981\u6D88\u8017 50 KB \u7684\u8A18\u61B6\u9AD4\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"user-should-be-able-to-access-previous-versions-of-files",children:"User should be able to access previous versions of files"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5BA2\u6236\u7AEF\u767C\u9001 ",(0,l.jsx)(n.code,{children:"GET /api/items/{item_id}/versions/{version_number}/metadata"})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\u4F86\u62FF\u5230\u7279\u5B9A\u7248\u672C\u7684\u6A94\u6848 metadata"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5BA2\u6236\u7AEF\u767C\u9001 ",(0,l.jsx)(n.code,{children:"GET /api/items/{item_id}/versions/{version_number}"})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\u4F86\u62FF\u5230\u9700\u8981\u7684 chunk \u7684 access URL"]}),"\n",(0,l.jsx)(n.li,{children:"\u5BA2\u6236\u7AEF\u4F7F\u7528 access URL \u5F9E blob storage \u4E0B\u8F09 chunk\uFF0C\u4E26\u5728\u672C\u5730\u5408\u4F75\u6210\u5B8C\u6574\u7684\u6A94\u6848"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"deep-dives",children:"Deep Dives"}),"\n",(0,l.jsx)(n.h3,{id:"how-to-support-large-file-upload",children:"How to support large file upload?"}),"\n",(0,l.jsx)(n.p,{children:"\u5C0D\u65BC\u5927\u6A94\u6848\u4F86\u8AAA\uFF0C\u6211\u5011\u53EF\u4EE5\u5C07\u5B83\u5207\u6210\u591A\u500B chunk\uFF0C\u4E26\u4F7F\u7528\u5206\u6BB5\u4E0A\u50B3\u7684\u65B9\u5F0F\u4F86\u52A0\u901F\u4E0A\u50B3\u6D41\u7A0B\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u9019\u6A23\u505A\u6709\u5E7E\u500B\u597D\u8655 :"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5982\u679C\u4E0A\u50B3\u5230\u4E00\u534A\u7684\u6642\u5019\u65B7\u7DDA\u4E86\uFF0C\u53EA\u9700\u8981\u91CD\u65B0\u4E0A\u50B3\u672A\u5B8C\u6210\u7684 chunk \u5373\u53EF"}),"\n",(0,l.jsx)(n.li,{children:"\u53EF\u4EE5\u540C\u6642\u4E0A\u50B3\u591A\u500B chunk \u4F86\u63D0\u5347\u4E0A\u50B3\u901F\u5EA6"}),"\n",(0,l.jsx)(n.li,{children:"\u4F7F\u7528\u8005\u53EF\u4EE5\u96A8\u6642\u638C\u63E1\u4E0A\u50B3\u9032\u5EA6\uFF0C\u5C0D\u65BC\u4F7F\u7528\u8005\u9AD4\u9A57\u8F03\u597D"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u9019\u88E1\u6211\u5011\u4EE5 AWS S3 \u70BA\u4F8B\uFF0CS3 \u63D0\u4F9B\u4E86 ",(0,l.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/mpuoverview.html",children:"Multipart Upload"})," \u7684\u529F\u80FD\uFF0C\u53EF\u4EE5\u8B93\u6211\u5011\u8F15\u9B06\u5730\u5BE6\u73FE\u5206\u6BB5\u4E0A\u50B3\u3002"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u5BA2\u6236\u7AEF\u7372\u53D6\u6A94\u6848\uFF0C\u4E26\u6C7A\u5B9A\u8981\u5207\u6210\u591A\u5927\u7684 chunk \u4EE5\u53CA\u7E3D\u5171\u6709\u5E7E\u500B chunk (S3 \u652F\u63F4 5MB - 5GB\uFF0C\u6700\u591A 10,000 \u500B chunk)\uFF0C\u4E26\u767C\u9001 API \u544A\u8A34\u5F8C\u7AEF"}),"\n",(0,l.jsxs)(n.li,{children:["\u5F8C\u7AEF\u547C\u53EB ",(0,l.jsx)(n.code,{children:"CreateMultipartUpload"})," API \u4F86\u5F97\u5230\u4E00\u500B\u552F\u4E00\u7684 upload ID\uFF0C\u4E26\u70BA\u6BCF\u500B chunk \u7522\u751F\u4E00\u500B pre-signed URL (\u9810\u8A2D\u70BA 15 \u5206\u9418\u6709\u6548)\uFF0C\u7136\u5F8C\u56DE\u50B3\u7D66\u5BA2\u6236\u7AEF"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5BA2\u6236\u7AEF\u4F7F\u7528 ",(0,l.jsx)(n.code,{children:"UploadPart"})," API \u4E0A\u50B3\u6BCF\u500B chunk \u5230 S3\uFF0C\u4E26\u5728\u4E0A\u50B3\u5B8C\u6210\u5F8C\u5E36\u8457 partNumber \u8DDF ETag \u56DE\u50B3\u7D66\u5F8C\u7AEF"]}),"\n",(0,l.jsxs)(n.li,{children:["\u7576\u6240\u6709 chunk \u90FD\u4E0A\u50B3\u5B8C\u6210\u5F8C\uFF0C\u5BA2\u6236\u7AEF\u767C\u9001 API \u544A\u8A34\u5F8C\u7AEF\u6240\u6709 chunk \u90FD\u4E0A\u50B3\u5B8C\u6210\uFF0C\u5F8C\u7AEF\u6703\u547C\u53EB ",(0,l.jsx)(n.code,{children:"CompleteMultipartUpload"})," API \u4E26\u5E36\u8457 ",(0,l.jsx)(n.code,{children:"partNumber"})," \u8DDF ",(0,l.jsx)(n.code,{children:"ETag"})," \u4F86\u9A57\u8B49\u4E26\u5B8C\u6210\u6574\u500B\u4E0A\u50B3\u6D41\u7A0B\uFF0CS3 \u6703\u81EA\u52D5\u628A\u6240\u6709 chunk \u5408\u4F75\u6210\u4E00\u500B\u5B8C\u6574\u7684\u6A94\u6848"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5982\u679C\u5728\u4E0A\u50B3\u904E\u7A0B\u4E2D\u767C\u751F\u932F\u8AA4\uFF0C\u5BA2\u6236\u7AEF\u53EF\u4EE5\u547C\u53EB ",(0,l.jsx)(n.code,{children:"AbortMultipartUpload"})," API \u4F86\u53D6\u6D88\u6574\u500B\u4E0A\u50B3\u6D41\u7A0B\uFF0CS3 \u6703\u81EA\u52D5\u522A\u9664\u6240\u6709\u5DF2\u7D93\u4E0A\u50B3\u7684 chunk"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4F46\u4F7F\u7528 Multipart Upload \u4E5F\u6709\u4E00\u4E9B\u554F\u984C\uFF0C\u5C31\u662F\u5B83\u6703\u628A\u6240\u6709\u7684 chunk \u5728\u6700\u5F8C\u4E00\u6B21\u6027\u5408\u4F75\uFF0C\u9019\u6A23\u6703\u5C0E\u81F4\u6BCF\u6B21\u4FEE\u6539\u6642\u90FD\u9700\u8981\u91CD\u65B0\u4E0A\u50B3\u6574\u500B\u6A94\u6848\uFF0C\u55AA\u5931\u4E86\u4F7F\u7528 chunk \u53EF\u91CD\u8907\u5229\u7528\u7684\u512A\u52E2\u3002"}),"\n",(0,l.jsxs)(n.p,{children:["Dropbox \u63A1\u7528\u4E86\u81EA\u5DF1\u7684\u5132\u5B58\u7CFB\u7D71 ",(0,l.jsx)(n.a,{href:"https://dropbox.tech/infrastructure/inside-the-magic-pocket",children:"Magic Pocket"}),"\uFF0C\u5B83\u5B8C\u5168\u4EE5 chunk \u70BA\u55AE\u4F4D\u4F86\u5132\u5B58\u6A94\u6848\uFF0C\u4E26\u4E14\u53EF\u4EE5\u91CD\u8907\u4F7F\u7528\u5DF2\u7D93\u5B58\u5728\u7684 chunk\u3002"]}),"\n",(0,l.jsx)(n.h3,{id:"how-to-chunk-files-efficiently",children:"How to chunk files efficiently?"}),"\n",(0,l.jsx)(n.p,{children:"\u524D\u9762\u63D0\u5230\uFF0C\u6211\u5011\u6703\u5C07\u6A94\u6848\u5207\u6210\u591A\u500B chunk \u4F86\u4E0A\u50B3\uFF0C\u4F46\u986F\u7136\u76F4\u63A5\u4EE5\u56FA\u5B9A\u5927\u5C0F\u4F86\u5207 chunk \u4E26\u4E0D\u662F\u6700\u6709\u6548\u7387\u7684\u5206\u584A\u65B9\u5F0F\u3002\n\u5982\u679C\u4F7F\u7528\u8005\u5728\u6A94\u6848\u4E2D\u9593\u63D2\u5165\u6216\u522A\u9664\u4E86\u4E00\u4E9B\u8CC7\u6599\uFF0C\u9019\u6A23\u6703\u5C0E\u81F4\u5F8C\u9762\u7684\u6240\u6709 chunk \u90FD\u9700\u8981\u91CD\u65B0\u4E0A\u50B3\u3002"}),"\n",(0,l.jsxs)(n.p,{children:["\u70BA\u4E86\u89E3\u6C7A\u9019\u500B\u554F\u984C\uFF0C\u6211\u5011\u53EF\u4EE5\u4F7F\u7528 Content Defined Chunking (CDC) \u7684\u65B9\u5F0F\u4F86\u5207 chunk\uFF0C\u5E38\u898B\u7684\u5BE6\u4F5C\u662F ",(0,l.jsx)(n.a,{href:"https://www.usenix.org/conference/atc16/technical-sessions/presentation/xia",children:"FastCDC"}),"\u3002\nCDC \u7684\u57FA\u672C\u539F\u7406\u662F\u4E0D\u4F7F\u7528\u56FA\u5B9A\u5927\u5C0F\u4F86\u5207 chunk\uFF0C\u800C\u662F\u4F7F\u7528\u6EFE\u52D5\u54C8\u5E0C (rolling hash) \u4E26\u642D\u914D\u4E00\u4E9B\u65B7\u9EDE\u689D\u4EF6\u4F86\u6C7A\u5B9A chunk \u7684\u908A\u754C\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:["\u8209\u4F8B\u4F86\u8AAA\uFF0C\u6211\u5011\u4EE5 64 bytes \u4F86\u7576\u4F5C\u6211\u5011\u7684 windows\uFF0C\u6BCF\u6B21\u8B80\u53D6\u4E00\u500B byte \u5C31\u66F4\u65B0\u4E00\u6B21\u54C8\u5E0C\u503C (",(0,l.jsx)(n.code,{children:"HASH(b1, b2, ..., b64) -> HASH(b2, ..., b65)"}),")\uFF0C\u7136\u5F8C\u6AA2\u67E5\u54C8\u5E0C\u503C\u7684\u67D0\u4E9B\u4F4D\u5143\u662F\u5426\u7B26\u5408\u65B7\u9EDE\u689D\u4EF6 (\u4F8B\u5982\u6700\u5F8C 12 bits \u5168\u90E8\u70BA 0)\uFF0C\u5982\u679C\u7B26\u5408\u5C31\u5C07\u76EE\u524D\u7684\u8CC7\u6599\u5207\u6210\u4E00\u500B chunk\u3002\n\u9019\u4EE3\u8868 chunk \u7684\u5E73\u5747\u5927\u5C0F\u5927\u7D04\u662F 4KB (2^12)\uFF0C\u4E14\u80FD\u4FDD\u8B49\u4E00\u6B21\u66F4\u6539\u6700\u591A\u53EA\u6703\u5F71\u97FF\u5230\u81EA\u5DF1\u6216\u662F\u9130\u8FD1\u7684 chunk\uFF0C\u5927\u5E45\u6E1B\u5C11\u9700\u8981\u91CD\u65B0\u4E0A\u50B3\u7684\u8CC7\u6599\u91CF\u3002"]}),"\n",(0,l.jsx)(n.h3,{id:"how-to-scaling-metadata-database",children:"How to scaling metadata database?"}),"\n",(0,l.jsx)(n.p,{children:"\u4F9D\u64DA\u6211\u5011\u7684\u4F30\u7B97\uFF0C\u6BCF\u79D2\u5927\u7D04\u6709 60k \u7684\u8B80\u5BEB\u8ACB\u6C42\uFF0C\u5C0D\u65BC\u4E00\u822C\u7684\u95DC\u806F\u5F0F\u8CC7\u6599\u5EAB\u4F86\u8AAA\uFF0C\u9019\u6A23\u7684\u8CA0\u8F09\u662F\u975E\u5E38\u9AD8\u7684\uFF0C\u56E0\u6B64\u6211\u5011\u9700\u8981\u5C0D\u8CC7\u6599\u5EAB\u505A\u6C34\u5E73\u5206\u7247 (sharding)\u3002"}),"\n",(0,l.jsxs)(n.p,{children:["\u5C0D\u65BC ",(0,l.jsx)(n.code,{children:"item"})," \u8DDF ",(0,l.jsx)(n.code,{children:"item_version"})," \u9019\u5169\u500B\u8868\uFF0C\u6211\u5011\u5982\u679C\u7C21\u55AE\u7684\u4EE5 ",(0,l.jsx)(n.code,{children:"owner_id"})," \u4F86\u505A sharding \u7684\u8A71\uFF0C\u53EF\u80FD\u6703\u5C0E\u81F4\u67D0\u4E9B\u5927\u5BA2\u6236\u7684\u6240\u6709\u8CC7\u6599\u90FD\u96C6\u4E2D\u5728\u540C\u4E00\u500B shard \u4E0A\uFF0C\u9020\u6210 hotspot\u3002\n\u56E0\u6B64\u6211\u5011\u9700\u8981\u5F15\u5165\u4E00\u500B\u984D\u5916\u7684\u6B04\u4F4D (\u4F8B\u5982 ",(0,l.jsx)(n.code,{children:"namespace_id"}),")\uFF0C\u4F86\u9032\u884C\u5206\u7247\uFF0C\u4E26\u5EFA\u7ACB\u4E00\u500B\u8DEF\u7531\u7684\u670D\u52D9\u4F86\u6839\u64DA ",(0,l.jsx)(n.code,{children:"namespace_id"})," \u4F86\u6C7A\u5B9A\u8981\u5C07\u8ACB\u6C42\u5C0E\u5411\u54EA\u4E00\u500B shard\uFF0C\u4E26\u76E1\u91CF\u628A\u540C\u4E00\u4F7F\u7528\u8005\u7684 namespace_id \u7D81\u5B9A\u5230\u540C\u4E00\u500B shard \u4E0A\uFF0C\u9019\u6A23\u5C31\u80FD\u6E1B\u5C11\u8DE8 shard \u7684\u67E5\u8A62\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5C0D\u65BC ",(0,l.jsx)(n.code,{children:"chunk"})," \u8868\u4F86\u8AAA\uFF0C\u53EF\u4EE5\u8003\u616E\u8981\u4E0D\u8981\u628A chunk \u7D81\u5B9A\u5230\u67D0\u4E00\u500B file \u4E0A\uFF0C\u9019\u6A23\u5C31\u80FD\u4F9D\u64DA file_id \u4F86\u505A sharding\uFF0C\u5F9E\u800C\u78BA\u4FDD\u540C\u4E00\u500B\u6A94\u6848\u7684 chunk \u90FD\u5728\u540C\u4E00\u500B shard \u4E0A\uFF0C\u4F46\u9019\u6A23\u76F8\u5C0D\u7684 chunk \u5C31\u6703\u6BD4\u8F03\u96E3\u4EE5\u91CD\u8907\u4F7F\u7528\u3002\n\u5982\u679C\u89BA\u5F97\u9019\u6A23\u4E0D\u597D\u7684\u8A71\uFF0C\u4E5F\u53EF\u4EE5\u76F4\u63A5\u4F9D\u64DA checksum \u4F86\u505A sharding\uFF0C\u53EA\u662F\u76F8\u5C0D\u7684\u5C31\u9700\u8981\u67E5\u8A62\u591A\u500B shard \u4F86\u53D6\u5F97\u540C\u4E00\u500B\u6A94\u6848\u7684\u6240\u6709 chunk\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5C0D\u65BC ",(0,l.jsx)(n.code,{children:"shared_file"})," \u8868\u4F86\u8AAA\uFF0C\u6211\u8A8D\u70BA\u4E3B\u8981\u7684\u67E5\u8A62\u61C9\u8A72\u662F\u6839\u64DA ",(0,l.jsx)(n.code,{children:"shared_with_user_id"})," \u4F86\u67E5\u8A62\u6709\u54EA\u4E9B\u6A94\u6848\u662F\u5206\u4EAB\u7D66\u8A72\u4F7F\u7528\u8005\u7684\uFF0C\u56E0\u6B64\u53EF\u4EE5\u4F9D\u64DA ",(0,l.jsx)(n.code,{children:"shared_with_user_id"})," \u4F86\u505A sharding\u3002"]}),"\n",(0,l.jsx)(n.h3,{id:"how-to-scaling-file-change-notification",children:"How to scaling file change notification?"}),"\n",(0,l.jsx)(n.p,{children:"\u8B93\u6211\u5011\u5148\u4E86\u89E3\u4E00\u4E0B\u6574\u500B\u901A\u77E5\u7684\u6D41\u7A0B\u3002"}),"\n",(0,l.jsxs)(n.p,{children:["\u7576\u67D0\u500B\u6A94\u6848\u767C\u751F\u6539\u8B8A\u6642\uFF0Citem service \u6703\u8CA0\u8CAC\u5C07\u8B8A\u66F4\u7684\u8A0A\u606F\u50B3\u9001\u5230 kafka \u7684\u4E00\u500B topic \u4E2D\uFF0C\u9019\u500B\u8A0A\u606F\u6703\u5305\u542B\u6709\u95DC\u6A94\u6848\u8B8A\u66F4\u7684\u8A73\u7D30\u8CC7\u8A0A\uFF0C\u4F8B\u5982\u6A94\u6848 ID\u3001\u7248\u672C\u865F\u3001\u8B8A\u66F4\u7684\u4F7F\u7528\u8005\u7B49\u3002\n\u63A5\u8457\u4E0B\u6E38\u7684 change service \u6703\u8A02\u95B1\u9019\u500B topic\uFF0C\u4E26\u4E14\u6839\u64DA\u8A0A\u606F\u4E2D\u7684\u8CC7\u8A0A\u4F86\u628A\u8B8A\u66F4\u8A18\u9304\u5230 ",(0,l.jsx)(n.code,{children:"file_changes"})," \u8868\u4E2D\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5C0D\u65BC\u96E2\u7DDA\u7684\u4F7F\u7528\u8005\u4F86\u8AAA\uFF0C\u91CD\u65B0\u9023\u7DDA\u6642\u5BA2\u6236\u7AEF\u6703\u767C\u9001 ",(0,l.jsx)(n.code,{children:"GET /api/sync/changes?since_timestamp="})," \u8ACB\u6C42\u5230\u5F8C\u7AEF\uFF0C\u5F8C\u7AEF\u6703\u67E5\u8A62 ",(0,l.jsx)(n.code,{children:"file_changes"})," \u8868\u4E26\u56DE\u50B3\u6709\u8B8A\u52D5\u7684\u6A94\u6848\u7D66\u5BA2\u6236\u7AEF\uFF0C\u5BA2\u6236\u7AEF\u518D\u6839\u64DA\u9019\u4E9B\u8B8A\u66F4\u4F86\u4E0B\u8F09\u6700\u65B0\u7684\u6A94\u6848\u7248\u672C\u3002"]}),"\n",(0,l.jsx)(n.p,{children:"\u800C\u5C0D\u65BC\u5728\u7DDA\u7684\u4F7F\u7528\u8005\u4F86\u8AAA\uFF0Cchange service \u6703\u5C07\u8B8A\u66F4\u7684\u8A0A\u606F\u767C\u9001\u5230 kafka \u7684\u53E6\u4E00\u500B topic \u4E2D\uFF0C\u9019\u500B topic \u6703\u88AB\u4E00\u500B\u5C08\u9580\u8CA0\u8CAC\u901A\u77E5\u7684 consumer group \u8A02\u95B1\uFF0C\u9019\u500B consumer group \u6703\u5C07\u8A0A\u606F\u4E2D\u7684\u4F7F\u7528\u8005\u627E\u51FA\u4F86\uFF0C\u4E26\u4E14\u5411 redis pub/sub \u4E2D\u767C\u9001\u901A\u77E5\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",metastring:'title="Example kafka message"',children:'{\n    "event_id": "event_123",\n    "event_type": "file_updated",\n    "item_id": "item_123",\n    "version_number": 2,    \n    "user": ["user_456", "user_789"],\n    "updated_at": "2023-10-01T12:00:00Z"\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u5BA2\u6236\u7AEF\u6703\u9023\u7DDA\u5230\u96A8\u6A5F\u7684\u4E00\u53F0 WebSocket \u4F3A\u670D\u5668\uFF0C\u9019\u500B\u4F3A\u670D\u5668\u6703\u5728\u8A18\u61B6\u9AD4\u4E2D\u7D00\u9304\u6240\u6709\u9023\u7DDA\u5230\u9019\u53F0\u6A5F\u5668\u7684\u4F7F\u7528\u8005\u4E26\u8A02\u95B1 redis pub/sub\u3002\n\u7576\u6709\u65B0\u7684\u901A\u77E5\u6642\uFF0C\u4F3A\u670D\u5668\u6703\u6AA2\u67E5\u9019\u500B\u901A\u77E5\u7684\u4F7F\u7528\u8005\u662F\u5426\u6709\u9023\u7DDA\u5230\u81EA\u5DF1\u9019\u53F0\u4F3A\u670D\u5668\uFF0C\u5982\u679C\u6709\u7684\u8A71\u5C31\u76F4\u63A5\u767C\u9001\u901A\u77E5\u7D66\u5BA2\u6236\u7AEF\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"final-design",children:"Final Design"}),"\n",(0,l.jsx)(s,{src:"/img/system-design/dropbox/image-1.webp",caption:"Dropbox Final Design"}),"\n",(0,l.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.hellointerview.com/learn/system-design/problem-breakdowns/dropbox",children:"Design Dropbox"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://systemdesignschool.io/problems/dropbox/solution",children:"Dropbox System Design"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.youtube.com/watch?v=Qi3Kzq_rlKQ",children:"Design Dropbox/Google Drive"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://medium.com/@li.ying.explore/how-to-design-a-personal-cloud-storage-service-like-dropbox-48128a3609a7",children:"How to design a personal cloud storage service like Dropbox"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://restic.net/blog/2015-09-12/restic-foundation1-cdc/",children:"Foundation - Introducing Content Defined Chunking (CDC)"})}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u9664\u6B64\u4E4B\u5916\uFF0C",(0,l.jsx)(n.a,{href:"https://dropbox.tech/infrastructure",children:"Dropbox \u5B98\u65B9\u6280\u8853\u90E8\u843D\u683C"})," \u6709\u975E\u5E38\u591A\u7684\u6587\u7AE0\u53EF\u4EE5\u53C3\u8003 :"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.youtube.com/watch?v=PE4gwstWhmc",children:"How We've Scaled Dropbox"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.infoq.com/presentations/dropbox-infrastructure/",children:"Scaling Dropbox"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://dropbox.tech/infrastructure/inside-the-magic-pocket",children:"Inside the Magic Pocket"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.youtube.com/watch?v=i_400CkR0lk",children:"DropBox Magic Pocket - Blob Stores At Scale"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://dropbox.tech/infrastructure/streaming-file-synchronization",children:"Streaming File Synchronization"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://dropbox.tech/infrastructure/abstracting-cloud-storage-backends-with-object-store",children:"Everything in its write place: Cloud storage abstraction with Object Store"})}),"\n"]})]})}function a(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}function u(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},4429:function(e,n,i){i.d(n,{R:()=>c,x:()=>d});var s=i(6540);let l={},r=s.createContext(l);function c(e){let n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);