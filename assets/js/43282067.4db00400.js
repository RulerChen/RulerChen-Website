"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9130],{8721:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>a,toc:()=>o});var i=s(5893),t=s(1151);const r={title:"[PG] Postgres HA and Scale",sidebar_position:"20",description:"Postgres \u9ad8\u53ef\u7528\u6027",keywords:["Postgres","\u9ad8\u53ef\u7528\u6027"]},l=void 0,a={id:"PostgreSQL/pg-ha",title:"[PG] Postgres HA and Scale",description:"Postgres \u9ad8\u53ef\u7528\u6027",source:"@site/docs/PostgreSQL/pg-ha.mdx",sourceDirName:"PostgreSQL",slug:"/PostgreSQL/pg-ha",permalink:"/RulerChen-Website/docs/PostgreSQL/pg-ha",draft:!1,unlisted:!1,editUrl:"https://github.com/RulerChen/RulerChen-Website/tree/main/docs/PostgreSQL/pg-ha.mdx",tags:[],version:"current",lastUpdatedAt:1735184059e3,sidebarPosition:20,frontMatter:{title:"[PG] Postgres HA and Scale",sidebar_position:20,description:"Postgres \u9ad8\u53ef\u7528\u6027",keywords:["Postgres","\u9ad8\u53ef\u7528\u6027"]},sidebar:"tutorialSidebar",previous:{title:"[PG] Postgres Tuning",permalink:"/RulerChen-Website/docs/PostgreSQL/pg-tuning"},next:{title:"[CVE-2021-44228] log4j \u6f0f\u6d1e\u5fa9\u73fe",permalink:"/RulerChen-Website/docs/Security/log4j"}},c={},o=[{value:"Scaling PostgreSQL",id:"scaling-postgresql",level:2},{value:"Streaming Replication",id:"streaming-replication",level:2},{value:"Logical Replication",id:"logical-replication",level:2},{value:"PgBouncer",id:"pgbouncer",level:2},{value:"Partition",id:"partition",level:2},{value:"Sharding",id:"sharding",level:2},{value:"PostgreSQL High Availability",id:"postgresql-high-availability",level:2},{value:"Pgpool II",id:"pgpool-ii",level:2},{value:"Reference",id:"reference",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"scaling-postgresql",children:"Scaling PostgreSQL"}),"\n",(0,i.jsx)(n.p,{children:"\u7576\u6211\u5011\u7684\u8cc7\u6599\u5eab\u9700\u8981\u8655\u7406\u5927\u91cf\u7684\u8cc7\u6599\u6642\uff0c\u6211\u5011\u9996\u5148\u9700\u8981\u6aa2\u67e5\u6211\u5011\u7684\u8cc7\u6599\u5eab\u662f\u5426\u5df2\u7d93\u9054\u5230\u5176\u8655\u7406\u80fd\u529b\u7684\u6975\u9650\uff0c\u50cf\u662f SQL \u512a\u5316\u6216\u53c3\u6578\u8abf\u6574\u7b49\u7b49\uff0c\n\u5982\u679c\u9084\u662f\u6c92\u8fa6\u6cd5\u63d0\u4f9b\u8db3\u5920\u7684\u6548\u80fd\uff0c\u6211\u5011\u5c31\u9700\u8981\u8003\u616e\u64f4\u5145\u6211\u5011\u7684\u8cc7\u6599\u5eab\u3002"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Vertical Scaling"}),": \u589e\u52a0\u8cc7\u6e90\uff0c\u50cf\u662f CPU\u3001Memory\u3001Storage \u7b49\u7b49"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Horizontal Scaling"}),": \u589e\u52a0\u7bc0\u9ede\uff0c\u50cf\u662f\u589e\u52a0\u8cc7\u6599\u5eab\u7bc0\u9ede\u3001\u589e\u52a0\u8cc7\u6599\u5eab\u53e2\u96c6\u7b49\u7b49"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Scaling",src:s(4702).Z+"",width:"1654",height:"904"})}),"\n",(0,i.jsx)(n.h2,{id:"streaming-replication",children:"Streaming Replication"}),"\n",(0,i.jsx)(n.p,{children:"Streaming Replication \u662f PostgreSQL \u7528\u4f86\u5be6\u73fe\u9ad8\u53ef\u7528\u6027\u7684\u4e3b\u8981\u6a5f\u5236\uff0c\u5b83\u900f\u904e\u5c07\u4e3b\u7bc0\u9ede\u7684 WAL \u65e5\u8a8c\u50b3\u9001\u5230\u5f9e\u7bc0\u9ede\uff0c\u5f9e\u800c\u5be6\u73fe\u63a5\u8fd1\u5be6\u6642\u7684\u8cc7\u6599\u540c\u6b65\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u5728 postgres \u4e2d\uff0c\u9810\u8a2d\u7684\u57f7\u884c\u65b9\u5f0f\u662f\u975e\u540c\u6b65\u7684\uff0c\n\u4e5f\u5c31\u662f\u8aaa\u4e3b\u7bc0\u9ede\u5728\u57f7\u884c\u5b8c\u4e00\u500b transaction \u5f8c\uff0c\u4e0d\u9700\u8981\u7b49\u5f85\u5f9e\u7bc0\u9ede\u78ba\u8a8d\u6536\u5230 WAL \u65e5\u8a8c\uff0c\u5c31\u53ef\u4ee5\u7e7c\u7e8c\u57f7\u884c\u4e0b\u4e00\u500b transaction\uff0c\n\u9019\u7a2e\u65b9\u6cd5\u7684\u597d\u8655\u662f\u6548\u80fd\u8f03\u9ad8\uff0c\u7f3a\u9ede\u662f\u5982\u679c\u767c\u751f\u6545\u969c\uff0c\u53ef\u80fd\u6703\u56e0\u70ba WAL \u7f3a\u5c11\u800c\u5c0e\u81f4\u8cc7\u6599\u4e0d\u4e00\u81f4\u3002\n\u6211\u5011\u4e5f\u53ef\u4ee5\u8a2d\u7f6e\u70ba\u540c\u6b65\uff0c\u9019\u6a23\u4e3b\u7bc0\u9ede\u5728\u57f7\u884c\u5b8c\u5f8c\uff0c\u9700\u8981\u7b49\u5f85\u5f9e\u7bc0\u9ede\u78ba\u8a8d\u6536\u5230 WAL \u65e5\u8a8c\uff0c\u624d\u80fd\u7e7c\u7e8c\u57f7\u884c\uff0c\n\u9019\u7a2e\u65b9\u6cd5\u7684\u597d\u8655\u662f\u8cc7\u6599\u4e00\u81f4\u6027\u8f03\u9ad8\u4e14\u53ef\u4ee5\u4fdd\u8b49\u8cc7\u6599\u7684\u5b8c\u6574\u6027\uff0c\u7f3a\u9ede\u662f\u6548\u80fd\u8f03\u4f4e\u3002\n\u6211\u5011\u53ef\u4ee5\u91dd\u5c0d\u4e0d\u540c\u7684\u8cc7\u6599(table)\uff0c\u4f86\u9078\u64c7\u4e0d\u540c\u7684\u65b9\u5f0f\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Streaming Replication",src:s(9261).Z+"",width:"1052",height:"548"})}),"\n",(0,i.jsxs)(n.p,{children:["\u9996\u5148\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"initdb"})," \u4f86\u521d\u59cb\u5316\u8cc7\u6599\u5eab\u96c6\u7fa4\uff0c\u8cc7\u6599\u5eab\u96c6\u7fa4\u662f\u7531\u55ae\u500b\u8cc7\u6599\u5eab\u5be6\u4f8b\u6240\u7ba1\u7406\u7684\u8cc7\u6599\u5eab\u96c6\u5408\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run -d --name pg-ha1 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine\n\ndocker exec -it pg-ha1 /bin/bash\n\nsu postgres\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"initdb -D /tmp/primary_db/\nvi /tmp/primary_db/postgresql.conf\n\n# set listen_addresses to '*'\n# set port to 5433\npg_ctl -D /tmp/primary_db start\npsql --port=5433 postgres\ncreate user requser replication;\n\nvi /tmp/primary_db/pg_hba.conf\n\n# add the following line\nhost all requser 127.0.0.1/32 trust\n\npg_ctl -D /tmp/primary_db restart\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u8457\u6211\u5011\u5275\u5efa\u4e00\u500b replication \u7684\u8cc7\u6599\u5eab"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pg_basebackup -h localhost -U requser --checkpoint=fast -D /tmp/replica_db -R --slot=some_slot -C --port 5433\nvi /tmp/replica_db/postgresql.conf\n\n# set listen_addresses to '*'\n# set port to 5434\npg_ctl -D /tmp/replica_db start\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6700\u5f8c\u8b93\u6211\u5011\u4f86\u505a\u4e3b\u7bc0\u9ede\u7684\u6e2c\u8a66"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"psql postgres --port=5433\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"postgres=# SELECT * FROM pg_stat_replication;\n-- result\n-[ RECORD 1 ]----+------------------------------\npid              | 595\nusesysid         | 16384\nusename          | requser\napplication_name | walreceiver\nclient_addr      | ::1\nclient_hostname  |\nclient_port      | 49798\nbackend_start    | 2024-08-03 12:15:14.549951+00\nbackend_xmin     |\nstate            | streaming\nsent_lsn         | 0/3000148\nwrite_lsn        | 0/3000148\nflush_lsn        | 0/3000148\nreplay_lsn       | 0/3000148\nwrite_lag        |\nflush_lag        |\nreplay_lag       |\nsync_priority    | 0\nsync_state       | async\nreply_time       | 2024-08-03 12:33:45.648063+00\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5f9e\u7bc0\u9ede\u7684\u6e2c\u8a66"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"psql postgres --port=5434\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM pg_stat_wal_receiver;\n-- result\n-[ RECORD 1 ]---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\npid                   | 594\nstatus                | streaming\nreceive_start_lsn     | 0/3000000\nreceive_start_tli     | 1\nwritten_lsn           | 0/3000148\nflushed_lsn           | 0/3000148\nreceived_tli          | 1\nlast_msg_send_time    | 2024-08-03 12:36:45.703365+00\nlast_msg_receipt_time | 2024-08-03 12:36:45.70343+00\nlatest_end_lsn        | 0/3000148\nlatest_end_time       | 2024-08-03 12:15:14.551133+00\nslot_name             | some_slot\nsender_host           | localhost\nsender_port           | 5433\nconninfo              | user=requser passfile=/var/lib/postgresql/.pgpass channel_binding=prefer dbname=replication host=localhost port=5433 fallback_application_name=walreceiver sslmode=prefer sslcompression=0 sslcertmode=allow sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres gssdelegation=0 target_session_attrs=any load_balance_hosts=disable\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u8457\u6211\u5011\u5728\u4e3b\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b table\uff0c\u7136\u5f8c\u5728\u5f9e\u7bc0\u9ede\u4e0a\u67e5\u8a62\uff0c\u770b\u770b\u662f\u5426\u80fd\u5920\u67e5\u8a62\u5230\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE TABLE test_table (id SERIAL PRIMARY KEY, name VARCHAR(255));\nINSERT INTO test_table (name) VALUES ('test');\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM test_table;\n-- result\n id | name\n----+------\n  1 | test\n"})}),"\n",(0,i.jsx)(n.h2,{id:"logical-replication",children:"Logical Replication"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Logical Replication",src:s(9663).Z+"",width:"1138",height:"563"})}),"\n",(0,i.jsxs)(n.p,{children:["logical replication \u662f\u4e00\u7a2e\u900f\u904e\u5c07 SQL \u8a9e\u53e5\u4f86\u9032\u884c\u8907\u88fd\u7684\u65b9\u5f0f\uff0c\n\u9019\u7a2e\u65b9\u5f0f\u7684\u597d\u8655\u662f\u8cc7\u6599\u8907\u88fd\u7684\u6548\u80fd\u8f03\u9ad8\u9069\u7528\u65bc\u7db2\u8def\u74b0\u5883\u8f03\u5dee\u7684\u5730\u65b9\uff0c\u4e14\u53ef\u4ee5\u5728\u4e0d\u540c\u7248\u672c\u4e4b\u9593\u9032\u884c\u8907\u88fd\uff0c\n\u540c\u6642\u4e5f\u53ef\u4ee5\u9078\u64c7\u8907\u88fd\u7279\u5b9a\u7684\u8cc7\u6599\uff0c\n\u7f3a\u9ede\u662f\u7121\u6cd5\u57f7\u884c\u4e00\u4e9b DDL \u7684\u6307\u4ee4\uff0c\u50cf\u662f ",(0,i.jsx)(n.code,{children:"CREATE TABLE"})," \u6216\u662f ",(0,i.jsx)(n.code,{children:"ALTER TABLE"})," \u7b49\u7b49\uff0c\n\u540c\u6642 sequence \u7684\u503c\u9ed8\u8a8d\u4e5f\u4e0d\u6703\u8907\u88fd\uff0c\u9019\u4ee3\u8868\u5982\u679c\u9700\u8981 failover \u7684\u8a71\uff0c\u9700\u8981\u53e6\u5916\u8655\u7406 sequence \u7684\u503c\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u5148\u958b\u597d docker \u7684\u74b0\u5883"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run -d --name pg-ha2 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine\n\ndocker exec -it pg-ha2 /bin/bash\n\nsu postgres\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5275\u5efa\u8cc7\u6599\u5eab\u4e26\u4fee\u6539\u53c3\u6578"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"initdb -D /tmp/publish_db/\ninitdb -D /tmp/subscribe_db/\n\nvi /tmp/publish_db/postgresql.conf\n\n# set wal_level to logical\n# set port to 5433\npg_ctl -D /tmp/publish_db start\n\nvi /tmp/subscribe_db/postgresql.conf\n# set port to 5434\npg_ctl -D /tmp/subscribe_db start\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5275\u5efa\u597d\u8868\uff0c\u4e26\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"pg_dump"})," \u4f86\u9032\u884c\u8907\u88fd"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"psql postgres --port=5433\n\nCREATE DATABASE pub;\n\\c pub\nCREATE TABLE test_table (id SERIAL PRIMARY KEY, name VARCHAR(255));\nINSERT INTO test_table (name) VALUES ('test');\n\npsql postgres --port=5434\nCREATE DATABASE sub;\n\npg_dump -t test_table -p 5433 -s pub | psql -p 5434 -d sub\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5275\u5efa publication \u548c subscription"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE PUBLICATION test_publication FOR TABLE test_table;\nCREATE SUBSCRIPTION test_subscription CONNECTION 'host=localhost port=5433 user=postgres dbname=pub' PUBLICATION test_publication;\n\nSELECT * FROM test_table;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u63a5\u8457\u6211\u5011\u53ef\u4ee5\u900f\u904e ",(0,i.jsx)(n.code,{children:"pg_stat_replication"})," \u4f86\u67e5\u770b replication \u7684\u72c0\u614b\uff0c\n\u53ef\u4ee5\u95dc\u6ce8 lag \u7684\u90e8\u5206"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"write_lag"}),": \u4e3b\u7bc0\u9ede\u5beb\u5165 WAL \u7684\u6642\u9593"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"flush_lag"}),": \u4e3b\u7bc0\u9ede\u5c07 WAL \u5237\u65b0\u5230\u78c1\u76e4\u7684\u6642\u9593"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"replay_lag"}),": \u5f9e\u7bc0\u9ede\u61c9\u7528 WAL \u7684\u6642\u9593"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM pg_stat_replication;\n-- result\n-[ RECORD 1 ]----+------------------------------\npid              | 222\nusesysid         | 10\nusename          | postgres\napplication_name | test_subscription\nclient_addr      | ::1\nclient_hostname  |\nclient_port      | 36752\nbackend_start    | 2024-08-04 07:23:31.011034+00\nbackend_xmin     |\nstate            | streaming\nsent_lsn         | 0/196EA40\nwrite_lsn        | 0/196EA40\nflush_lsn        | 0/196EA40\nreplay_lsn       | 0/196EA40\nwrite_lag        |\nflush_lag        |\nreplay_lag       |\nsync_priority    | 0\nsync_state       | async\nreply_time       | 2024-08-04 07:41:12.252314+00\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6307\u4ee4\u4f86\u67e5\u770b publication \u548c subscription \u7684\u72c0\u614b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"\\dRp\n-- result\nList of publications\n-[ RECORD 1 ]----------------\nName       | test_publication\nOwner      | postgres\nAll tables | f\nInserts    | t\nUpdates    | t\nDeletes    | t\nTruncates  | t\nVia root   | f\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"\\dRs\n-- result\nList of subscriptions\n-[ RECORD 1 ]-------------------\nName        | test_subscription\nOwner       | postgres\nEnabled     | t\nPublication | {test_publication}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"pgbouncer",children:"PgBouncer"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"PgBouncer",src:s(911).Z+"",width:"994",height:"552"})}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u6b63\u5e38\u7684\u60c5\u6cc1\u4e0b\uff0cpostgres \u53ef\u4ee5\u5728\u4e00\u79d2\u9418\u8655\u7406 350 \u500b transaction\uff0c\n\u5982\u679c\u8d85\u904e\u7684\u8a71\uff0c\u6211\u5011\u53ef\u80fd\u9700\u8981\u8003\u616e\u4f7f\u7528 connection pool \u4f86\u9032\u884c\u512a\u5316\uff0c\n\u9019\u6a23\u53ef\u4ee5\u6e1b\u5c11\u6bcf\u6b21\u9023\u63a5\u8cc7\u6599\u5eab\u6642\u5275\u5efa process (fork) \u6240\u9700\u8981\u6d88\u8017\u7684\u8cc7\u6e90\u3002\nPgBouncer \u672c\u8eab\u6c92\u6709\u652f\u63f4 multi-host \u3001 failover \u4ee5\u53ca load balancing\uff0c\n\u6240\u4ee5\u5982\u679c\u9700\u8981\u9019\u6a23\u7684\u529f\u80fd\uff0c\u6211\u5011\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u7684\u5de5\u5177\u3002"}),"\n",(0,i.jsx)(n.p,{children:"pgbouncer \u5305\u542b\u4e09\u7a2e\u6a21\u5f0f :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"session"}),": \u9ed8\u8a8d\u548c\u6700\u5b89\u5168\u7684\u6a21\u5f0f\uff0cclient \u5728\u9023\u63a5\u671f\u9593\uff0c\u6703\u6301\u7e8c\u4fdd\u6301\u9023\u63a5\uff0c\u76f4\u5230 session \u7d50\u675f"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"transaction"}),": client \u50c5\u5728 transaction \u671f\u9593\u4fdd\u6301\u8207\u8cc7\u6599\u5eab\u7684\u9023\u63a5"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"statement"}),": \u6bcf\u500b SQL \u8a9e\u53e5\u57f7\u884c\u5f8c\uff0c\u9023\u63a5\u5c31\u6703\u8fd4\u56de\u5230\u6c60\u4e2d"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u5728 docker \u57f7\u884c\u6642\u9047\u5230\u5404\u7a2e\u6b0a\u9650\u554f\u984c\uff0c\u5f85\u4fee\u6539 ..."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run -d --name pg-ha3 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine\n\ndocker exec -it --user root pg-ha3 /bin/bash\n\nsu postgres\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"initdb -D /tmp/pgbouncer_db/\nvi /tmp/pgbouncer_db/postgresql.conf\n\n# set port to 5433\npg_ctl -D /tmp/pgbouncer_db start\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"exit # exit from postgres user\napk update && apk add pgbouncer\n\ncd etc/pgbouncer\ncp pgbouncer.ini pgbouncer.ini.bak\nvi pgbouncer.ini\n# set test_db= dbname=postgres host=localhost port=5433 auth_user=pguser\n# set logfile = /tmp/pgbouncer.log\n\npsql -p 5433 -U postgres\nCREATE USER pguser SUPERUSER;\n\npgbouncer pgbouncer.ini\n\n# adjust min_pool_size\u3001default_pool_size\u3001max_client_conn\n"})}),"\n",(0,i.jsx)(n.h2,{id:"partition",children:"Partition"}),"\n",(0,i.jsx)(n.p,{children:"\u5c0d\u65bc\u8cc7\u6599\u91cf\u5927\u7684\u8868\uff0c\u4e0d\u7ba1\u662f\u67e5\u8a62\u6216\u662f vacuum \u90fd\u6703\u9700\u8981\u8f03\u9577\u7684\u6642\u9593\uff0c\n\u9019\u6642\u5019\u6211\u5011\u53ef\u4ee5\u8003\u616e\u5c07\u8868\u9032\u884c\u5206\u5272\u63d0\u5347\u6548\u80fd\u3002\n\u5728\u65b0\u7248\u7684 postgres \u4e2d\uff0cpartition \u591a\u4f7f\u7528 declarative \u7684\u65b9\u5f0f\u4f86\u9032\u884c\u5206\u5272\uff0c\n\u800c\u4e0d\u662f inheritance \u7684\u65b9\u5f0f\u3002"}),"\n",(0,i.jsx)(n.p,{children:"partition \u7684\u65b9\u6cd5\u5927\u81f4\u6709\u4ee5\u4e0b\u56db\u7a2e :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Range Partition"}),": \u4f9d\u7167\u7bc4\u570d\u4f86\u9032\u884c\u5206\u5272\uff0c\u50cf\u662f\u6642\u9593\u3001\u6578\u503c\u7b49\u7b49"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"List Partition"}),": \u4f9d\u7167\u7279\u5b9a\u7684\u503c\u4f86\u9032\u884c\u5206\u5272"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Hash Partition"}),": \u4f9d\u7167 hash \u503c\u4f86\u9032\u884c\u5206\u5272"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Composite Partition"}),": \u7d50\u5408\u4ee5\u4e0a\u5169\u7a2e\u6216\u591a\u7a2e\u65b9\u5f0f\u4f86\u9032\u884c\u5206\u5272"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run -d --name pg-ha4 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine\n\ndocker exec -it pg-ha4 /bin/bash\n\npsql -U postgres -d postgres\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE TABLE customers (\n    id INT,\n    name TEXT,\n    age NUMERIC\n) PARTITION BY RANGE (age);\n\nCREATE TABLE customers_young PARTITION OF customers FOR VALUES FROM (MINVALUE) TO (25);\nCREATE TABLE customers_adult PARTITION OF customers FOR VALUES FROM (25) TO (65);\nCREATE TABLE customers_old PARTITION OF customers FOR VALUES FROM (65) TO (MAXVALUE);\n\nINSERT INTO customers (id, name, age) VALUES (1, 'John Doe', 20), (2, 'Jane Doe', 30), (3, 'John Smith', 60), (4, 'Jane Smith', 70);\n\nSELECT tableoid::regclass, * FROM customers;\n-- result\n    tableoid     | id |    name    | age\n-----------------+----+------------+-----\n customers_young |  1 | John Doe   |  20\n customers_adult |  2 | Jane Doe   |  30\n customers_adult |  3 | John Smith |  60\n customers_old   |  4 | Jane Smith |  70\n(4 rows)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"sharding",children:"Sharding"}),"\n",(0,i.jsx)(n.p,{children:"sharding \u662f\u5c07\u8cc7\u6599\u5206\u5272\u5230\u591a\u500b\u8cc7\u6599\u5eab\uff0c\u4ee5\u6e1b\u8f15\u55ae\u500b\u8cc7\u6599\u5eab\u7684\u8ca0\u64d4\u3002"}),"\n",(0,i.jsx)(n.p,{children:"sharding \u7684\u95dc\u9375\u5728\u65bc\u5982\u4f55\u9078\u64c7 sharding key\uff0c\n\u6211\u5011\u9700\u8981\u4f9d\u64da\u696d\u52d9\u5834\u666f\u4f86\u9078\u64c7\u5408\u9069\u7684 sharding key\uff0c\n\u4f86\u4fdd\u8b49\u6211\u5011\u7684\u67e5\u8a62\u6216\u5beb\u5165\u76e1\u91cf\u843d\u5728\u540c\u4e00\u500b\u8cc7\u6599\u5eab\u4e2d\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"postgresql-high-availability",children:"PostgreSQL High Availability"}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u6211\u5011\u9700\u8981\u8003\u616e\u5728\u5404\u7a2e\u4e0d\u540c\u7684\u74b0\u5883\u4e0b\u90fd\u80fd\u7a69\u5b9a\u5730\u63d0\u4f9b\u670d\u52d9\uff0c\n\u9019\u6642\u5019\u6211\u5011\u5c31\u9700\u8981\u8003\u616e\u9ad8\u53ef\u7528\u6027\u7684\u554f\u984c\u3002"}),"\n",(0,i.jsx)(n.p,{children:"HA \u4e3b\u8981\u5206\u70ba\u4e09\u500b\u6b65\u9a5f :"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"replication : \u4e3b\u7bc0\u9ede\u5c07\u8cc7\u6599\u8907\u88fd\u5230\u5f9e\u7bc0\u9ede\uff0c\u4ee5\u4fdd\u8b49\u8cc7\u6599\u7684\u4e00\u81f4\u6027"}),"\n",(0,i.jsx)(n.li,{children:"failover : \u7576\u4e3b\u7bc0\u9ede\u6545\u969c\u6642\uff0c\u5f9e\u7bc0\u9ede\u81ea\u52d5\u5347\u7d1a\u70ba\u4e3b\u7bc0\u9ede"}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"pg_ctl promote"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"pgpool II"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"PAF"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Patroni"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Repmgr"})}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"failback : \u7576\u4e3b\u7bc0\u9ede\u6062\u5fa9\u6b63\u5e38\u6642\uff0c\u5f9e\u7bc0\u9ede\u964d\u7d1a\u70ba\u5f9e\u7bc0\u9ede"}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"pg rewind"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"pgpool II"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"PAF"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Patroni"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Repmgr"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u8655\u7406 HA \u4e4b\u524d\u8981\u5148\u5b9a\u7fa9\u4e00\u4e9b\u554f\u984c"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\u8cc7\u6599\u7684\u91cd\u8981\u6027\n",(0,i.jsx)(n.img,{alt:"HA Problem",src:s(3676).Z+"",width:"1150",height:"600"})]}),"\n",(0,i.jsxs)(n.li,{children:["RTO(Recovery Time Objective) && RPO(Recovery Point Objective)\n",(0,i.jsx)(n.img,{alt:"HA Problem",src:s(428).Z+"",width:"903",height:"538"}),"\n",(0,i.jsx)(n.img,{alt:"HA Problem",src:s(1979).Z+"",width:"834",height:"548"})]}),"\n",(0,i.jsxs)(n.li,{children:["auto failover \u7684\u6a5f\u5236\n",(0,i.jsx)(n.img,{alt:"HA Problem",src:s(4286).Z+"",width:"1124",height:"552"}),"\n",(0,i.jsx)(n.img,{alt:"HA Problem",src:s(16).Z+"",width:"1084",height:"627"})]}),"\n",(0,i.jsxs)(n.li,{children:["cross-center replication\n",(0,i.jsx)(n.img,{alt:"HA Problem",src:s(791).Z+"",width:"1144",height:"575"})]}),"\n",(0,i.jsxs)(n.li,{children:["do we open replication for read\n",(0,i.jsx)(n.img,{alt:"HA Problem",src:s(6355).Z+"",width:"921",height:"572"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u89e3\u6c7a\u7684\u67b6\u69cb\u5716\u5927\u81f4\u5982\u4e0b"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"HA Problem",src:s(5960).Z+"",width:"1086",height:"630"})}),"\n",(0,i.jsx)(n.h2,{id:"pgpool-ii",children:"Pgpool II"}),"\n",(0,i.jsx)(n.p,{children:"pgpool \u662f\u4e00\u500b\u4f4d\u5728\u8cc7\u6599\u5eab\u8ddf\u5ba2\u6236\u7aef\u7684 middleware\uff0c\n\u53ef\u4ee5\u63d0\u4f9b load balancing\u3001failover\u3001connection pooling \u7b49\u529f\u80fd\uff0c\n\u662f\u4e00\u500b\u5f88\u597d\u7684 HA \u89e3\u6c7a\u65b9\u6848\u3002"}),"\n",(0,i.jsx)(n.p,{children:"docker \u958b\u767c\u65b9\u6cd5\u5f85\u88dc\u5145..."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run -d --name pg-ha5 -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:16-alpine\n\ndocker exec -it pg-ha5 /bin/bash\n\nsu postgres\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u8457\u9700\u8981\u8a2d\u5b9a streaming application\uff0c\u5982\u524d\u6240\u793a\n\u518d\u4f86\u5b89\u88dd pgpool"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"apk update && apk add pgpool-ii\n"})}),"\n",(0,i.jsx)(n.h2,{id:"reference",children:"Reference"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.udemy.com/course/postgresql-replication-high-availability-ha-and-scalability",children:"PostgreSQL Replication, High Availability HA and Scalability"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.interdb.jp/pg/index.html",children:"The Internals of PostgreSQL"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},9663:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-1-e2174585abf64dcc3e3f553d2f5e701a.png"},9261:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-10-6a666c38c2d3febb18a300499825faab.png"},16:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-11-6065b5f7679677d4f63bd6c496636501.png"},5960:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-12-42d8d39af659e187ed8625550f7b8c80.png"},911:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-2-ea84074f202988d0af69359a84ceb2b8.png"},3676:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-4-43ddab330de03fd9be5d3839420acb1a.png"},4286:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-5-188a8cfcf12935273ef3f49331db134a.png"},428:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-6-c45c5c7d2f3ce27138d4d9fd9596a702.png"},1979:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-7-cf637ecc909fb1861929e56a3baffe4c.png"},791:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-8-30da38745b6cb7a9f25fa250d4453c6b.png"},6355:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-9-bbf01b748da17a187599839ada5b5bbd.png"},4702:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-0c0bd50adc5761f6c79e1bb1a0ccff47.png"},1151:(e,n,s)=>{s.d(n,{Z:()=>a,a:()=>l});var i=s(7294);const t={},r=i.createContext(t);function l(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);