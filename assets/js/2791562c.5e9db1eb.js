"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["1515"],{77825:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>c,default:()=>p,toc:()=>l,metadata:()=>t,assets:()=>o,contentTitle:()=>i});var t=JSON.parse('{"id":"C++/smartpointer","title":"[C++] \u667A\u6167\u6307\u6A19 (Smart Pointer)","description":"C++ \u667A\u6167\u6307\u6A19","source":"@site/docs/C++/smartpointer.mdx","sourceDirName":"C++","slug":"/C++/smartpointer","permalink":"/RulerChen-Website/docs/C++/smartpointer","draft":false,"unlisted":false,"editUrl":"https://github.com/RulerChen/RulerChen-Website/tree/main/docs/C++/smartpointer.mdx","tags":[],"version":"current","lastUpdatedAt":1730105636000,"sidebarPosition":50,"frontMatter":{"title":"[C++] \u667A\u6167\u6307\u6A19 (Smart Pointer)","sidebar_position":50,"description":"C++ \u667A\u6167\u6307\u6A19","keywords":["C++","\u667A\u6167\u6307\u6A19","Smart Pointer"]},"sidebar":"tutorialSidebar","previous":{"title":"[C++] \u57FA\u672C\u4ECB\u7D39 (\u958B\u767C\u74B0\u5883\u3001\u7DE8\u8B6F\u3001Debugger)","permalink":"/RulerChen-Website/docs/C++/intro"},"next":{"title":"[C++] \u79FB\u52D5\u8A9E\u610F (Move Semantics)","permalink":"/RulerChen-Website/docs/C++/move"}}'),r=s(85893),d=s(50065);let c={title:"[C++] \u667A\u6167\u6307\u6A19 (Smart Pointer)",sidebar_position:"50",description:"C++ \u667A\u6167\u6307\u6A19",keywords:["C++","\u667A\u6167\u6307\u6A19","Smart Pointer"]},i=void 0,o={},l=[{value:"RAII",id:"raii",level:2},{value:"std::unique_ptr",id:"stdunique_ptr",level:2},{value:"std::shared_ptr",id:"stdshared_ptr",level:2},{value:"std::weak_ptr",id:"stdweak_ptr",level:2},{value:"\u53C3\u8003\u8CC7\u6599",id:"\u53C3\u8003\u8CC7\u6599",level:2}];function a(e){let n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,d.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"\u672C\u6587\u6703\u8B1B\u89E3 C++ \u4E2D\u667A\u6167\u6307\u6A19 (smart pointer) \u7684\u57FA\u672C\u6982\u5FF5\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"raii",children:"RAII"}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u9032\u5165\u667A\u6167\u6307\u6A19\u4E4B\u524D\uFF0C\u9700\u8981\u5148\u4E86\u89E3\u932F\u8AA4\u7684\u6307\u6A19\u4F7F\u7528\u65B9\u5F0F\uFF0C\u8209\u4F8B\u5982\u4E0B :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"#include <iostream>\n\nint main() {\n    int *p = new int(5);\n\n    int a = 5;\n    if (a == 5) {\n        throw 0;\n    }\n\n    // do something\n    delete p;\n    return 0;\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u4E0A\u9762\u7684\u7BC4\u4F8B\u4E2D\uFF0C\u6211\u5011\u53EF\u4EE5\u767C\u73FE\u7576 ",(0,r.jsx)(n.code,{children:"a == 5"})," \u6642\uFF0C\u6703\u62CB\u51FA\u4F8B\u5916\uFF0C\u4F46\u662F\u5728\u62CB\u51FA\u4F8B\u5916\u4E4B\u524D\uFF0C\u6211\u5011\u6C92\u6709\u91CB\u653E ",(0,r.jsx)(n.code,{children:"p"})," \u6240\u6307\u5411\u7684\u8A18\u61B6\u9AD4\u800C\u9020\u6210\u8A18\u61B6\u9AD4\u6D29\u6F0F (memory leak)\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u56E0\u6B64\u5728 C++ \u4E2D\uFF0C\u6700\u597D\u7684\u505A\u6CD5\u4E26\u975E\u662F\u624B\u52D5\u5728\u4F8B\u5916\u60C5\u6CC1\u4E2D\u91CB\u653E\u8A18\u61B6\u9AD4\uFF0C\u800C\u662F\u5728 constructor \u4E2D\u5206\u914D\u8A18\u61B6\u9AD4\uFF0C\u5728 destructor \u4E2D\u91CB\u653E\u8A18\u61B6\u9AD4\uFF0C\u4E5F\u5C31\u662F\u6240\u8B02\u7684 RAII (Resource Acquisition Is Initialization)\u3002"}),"\n",(0,r.jsx)(n.p,{children:"C++11 \u5F15\u5165\u4E86\u56DB\u7A2E\u667A\u6167\u6307\u6A19\u4F86\u89E3\u6C7A\u9019\u7A2E\u554F\u984C\uFF0C\u5206\u5225\u662F :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"std::unique_ptr"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"std::shared_ptr"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"std::weak_ptr"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"std::auto_ptr"}),"(\u5728 C++17 \u4E2D\u79FB\u9664)"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"stdunique_ptr",children:"std::unique_ptr"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"std::unique_ptr"})," \u662F\u4E00\u500B\u7368\u5360\u6240\u6709\u6B0A\u7684\u667A\u6167\u6307\u6A19\uFF0C\u7981\u6B62\u5176\u4ED6\u667A\u6167\u6307\u6A19\u6307\u5411\u540C\u4E00\u500B\u8A18\u61B6\u9AD4\u4F4D\u7F6E\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'#include <iostream>\n#include <memory> // for std::unique_ptr\n#include <utility> // for std::move\n\nclass Resource {\npublic:\n	Resource() { std::cout << "Resource acquired\\n"; }\n	~Resource() { std::cout << "Resource destroyed\\n"; }\n};\n\nint main() {\n	std::unique_ptr<Resource> res1{ new Resource{} }; // Resource created here\n	std::unique_ptr<Resource> res2{}; // Start as nullptr\n\n	std::cout << "res1 is " << (res1 ? "not null\\n" : "null\\n");\n	std::cout << "res2 is " << (res2 ? "not null\\n" : "null\\n");\n\n	// res2 = res1; // Won\'t compile: copy assignment is disabled\n	res2 = std::move(res1); // res2 assumes ownership, res1 is set to null\n\n	std::cout << "Ownership transferred\\n";\n\n	std::cout << "res1 is " << (res1 ? "not null\\n" : "null\\n");\n	std::cout << "res2 is " << (res2 ? "not null\\n" : "null\\n");\n\n	return 0;\n} // Resource destroyed here when res2 goes out of scope\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u800C\u5728 C++14 \u4E2D\uFF0C\u6211\u5011\u53EF\u4EE5\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"std::make_unique"})," \u4F86\u5EFA\u7ACB ",(0,r.jsx)(n.code,{children:"std::unique_ptr"}),"\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"std::unique_ptr<int> t = std::make_unique<int>(5);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u4E5F\u53EF\u4EE5\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"t.get()"})," \u4F86\u53D6\u5F97\u6307\u5411\u7684\u8A18\u61B6\u9AD4\u4F4D\u7F6E\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"stdshared_ptr",children:"std::shared_ptr"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"std::shared_ptr"})," \u662F\u4E00\u500B\u5171\u4EAB\u6240\u6709\u6B0A\u7684\u667A\u6167\u6307\u6A19\uFF0C\u5B83\u53EF\u4EE5\u8A18\u9304\u6709\u591A\u5C11\u500B ",(0,r.jsx)(n.code,{children:"std::shared_ptr"})," \u6307\u5411\u540C\u4E00\u500B\u8A18\u61B6\u9AD4\u4F4D\u7F6E\uFF0C\u5F9E\u800C\u907F\u514D\u986F\u6027\u7684\u8ABF\u7528 ",(0,r.jsx)(n.code,{children:"delete"}),"\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5728 ",(0,r.jsx)(n.code,{children:"shared_ptr"})," \u5167\u90E8\u6703\u7DAD\u8B77\u5169\u500B\u6307\u6A19\uFF0C\u4E00\u500B\u6307\u5411\u8A18\u61B6\u9AD4\u4F4D\u7F6E\uFF0C\u4E00\u500B\u6307\u5411 control block\uFF0Ccontrol block \u6703\u8A18\u9304\u6709\u591A\u5C11\u500B ",(0,r.jsx)(n.code,{children:"shared_ptr"})," \u6307\u5411\u540C\u4E00\u500B\u8A18\u61B6\u9AD4\u4F4D\u7F6E\u3002\n\u7576\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"shared_ptr"})," \u6642\uFF0C\u5169\u584A\u8A18\u61B6\u9AD4\u6703\u55AE\u7368\u5206\u914D\uFF0C\u800C\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"make_shared"})," \u6642\uFF0C\u5169\u584A\u8A18\u61B6\u9AD4\u6703\u4E00\u8D77\u5206\u914D\u4E26\u7372\u5F97\u66F4\u597D\u7684\u6548\u80FD\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u4F7F\u7528\u6642\uFF0C\u53EF\u4EE5\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"new"})," \u4F86\u5EFA\u7ACB ",(0,r.jsx)(n.code,{children:"std::shared_ptr"}),"\uFF0C\u4F46\u975E\u5FC5\u8981\u7684\u8A71\u8ACB\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"std::make_shared"})," \u4F86\u5EFA\u7ACB (\u7531\u65BC\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"new"})," \u6642\u6703\u7368\u7ACB\u5206\u914D control block\uFF0C\u6240\u4EE5\u53EF\u80FD\u5C0E\u81F4\u904E\u65E9\u522A\u9664)\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'#include <iostream>\n#include <memory> // for std::shared_ptr\n\nclass Resource {\npublic:\n	Resource() { std::cout << "Resource acquired\\n"; }\n	~Resource() { std::cout << "Resource destroyed\\n"; }\n};\n\nint main() {\n	// allocate a Resource object and have it owned by std::shared_ptr\n	Resource* res { new Resource };\n	std::shared_ptr<Resource> ptr1{ res };\n	{\n		std::shared_ptr<Resource> ptr2 { ptr1 }; // make another std::shared_ptr pointing to the same thing\n\n		std::cout << "Killing one shared pointer\\n";\n	} // ptr2 goes out of scope here, but nothing happens\n\n	std::cout << "Killing another shared pointer\\n";\n\n	return 0;\n} // ptr1 goes out of scope here, and the allocated Resource is destroyed\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"std::shared_ptr<int> t = std::make_shared<int>(5);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5728 ",(0,r.jsx)(n.code,{children:"std::shared_ptr"})," \u4E2D\uFF0C\u6211\u5011\u53EF\u4EE5\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"get()"})," \u4F86\u53D6\u5F97\u539F\u59CB\u7684\u6307\u6A19\uFF0C\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"use_count()"})," \u4F86\u53D6\u5F97\u6709\u591A\u5C11\u500B ",(0,r.jsx)(n.code,{children:"std::shared_ptr"})," \u6307\u5411\u540C\u4E00\u500B\u8A18\u61B6\u9AD4\u4F4D\u7F6E\uFF0C\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"reset()"})," \u4F86\u5C07\u8A08\u6578\u6E1B\u4E00\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"std::shared_ptr<int> t = std::make_shared<int>(5);\nstd::shared_ptr<int> t2 = t;\nstd::cout << t.use_count() << std::endl; // 2\nt2.reset();\nstd::cout << t.use_count() << std::endl; // 1\n"})}),"\n",(0,r.jsx)(n.h2,{id:"stdweak_ptr",children:"std::weak_ptr"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u524D\u9762\u6211\u5011\u5DF2\u7D93\u63D0\u5230\u904E\u95DC\u65BC ",(0,r.jsx)(n.code,{children:"std::shared_ptr"})," \u7684\u4F7F\u7528\u65B9\u5F0F\uFF0C\u4F46\u5982\u679C\u6211\u5011\u4ED4\u7D30\u89C0\u5BDF\uFF0C\u5C31\u6703\u767C\u73FE\u9019\u7A2E\u65B9\u5F0F\u4F9D\u7136\u6709\u554F\u984C\uFF0C\u8209\u4F8B\u5982\u4E0B :"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'struct A;\nstruct B;\n\nstruct A {\n    std::shared_ptr<B> pointer;\n    ~A() {\n        std::cout << "A destroyed" << std::endl;\n    }\n};\nstruct B {\n    std::shared_ptr<A> pointer;\n    ~B() {\n        std::cout << "B destroyed" << std::endl;\n    }\n};\nint main() {\n    auto a = std::make_shared<A>();\n    auto b = std::make_shared<B>();\n    a->pointer = b;\n    b->pointer = a;\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u4E0A\u9762\u7A0B\u5F0F\u78BC\u7684\u7D50\u679C\u5C31\u662F a \u8DDF b \u90FD\u4E0D\u6703\u88AB\u91CB\u653E\uFF0C\u56E0\u70BA a \u8DDF b \u4E92\u76F8\u6307\u5411\u5C0D\u65B9\uFF0C\u9020\u6210\u5FAA\u74B0\u5F15\u7528\uFF0C\u9019\u6642\u5019\u5C31\u53EF\u4EE5\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"std::weak_ptr"})," \u4F86\u89E3\u6C7A\u9019\u500B\u554F\u984C\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"std::weak_ptr"})," \u4E26\u4E0D\u6703\u8B93\u8A08\u6578\u589E\u52A0\uFF0C\u800C\u662F\u626E\u6F14\u4E00\u500B ",(0,r.jsx)(n.strong,{children:"\u89C0\u5BDF\u8005"})," \u7684\u89D2\u8272\uFF0C\u5728\u4E0A\u9762\u7684\u554F\u984C\u4E2D\uFF0C\u53EF\u4EE5\u5C07\u5176\u4E2D\u4E00\u500B ",(0,r.jsx)(n.code,{children:"std::shared_ptr"})," \u6539\u70BA ",(0,r.jsx)(n.code,{children:"std::weak_ptr"})," \u5C31\u53EF\u4EE5\u907F\u514D\u5FAA\u74B0\u5F15\u7528\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'struct A;\nstruct B;\n\nstruct A {\n    std::shared_ptr<B> pointer;\n    ~A() {\n        std::cout << "A destroyed" << std::endl;\n    }\n};\nstruct B {\n    std::weak_ptr<A> pointer;\n    ~B() {\n        std::cout << "B destroyed" << std::endl;\n    }\n};\nint main() {\n    auto a = std::make_shared<A>();\n    auto b = std::make_shared<B>();\n    a->pointer = b;\n    b->pointer = a;\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"weak_ptr"})," \u9084\u6709\u4E00\u500B\u7F3A\u9EDE\u662F\u5B83\u6C92\u6709 ",(0,r.jsx)(n.code,{children:"*"})," \u8DDF ",(0,r.jsx)(n.code,{children:"->"})," \u904B\u7B97\u5B50\uFF0C\u56E0\u6B64\u6C92\u8FA6\u6CD5\u76F4\u63A5\u5C0D\u8CC7\u6E90\u9032\u884C\u64CD\u4F5C\uFF0C\u5FC5\u9808\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"lock()"})," \u4F86\u53D6\u5F97 ",(0,r.jsx)(n.code,{children:"std::shared_ptr"}),"\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"std::shared_ptr<int> t = std::make_shared<int>(5);\nstd::weak_ptr<int> w = t;\nstd::shared_ptr<int> t2 = w.lock();\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u4E5F\u53EF\u4EE5\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"expired()"})," \u4F86\u5224\u65B7 ",(0,r.jsx)(n.code,{children:"std::weak_ptr"})," \u662F\u5426\u5DF2\u7D93\u5931\u6548\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"std::shared_ptr<int> t = std::make_shared<int>(5);\nstd::weak_ptr<int> w = t;\nstd::cout << w.expired() << std::endl; // 0\nt.reset();\nstd::cout << w.expired() << std::endl; // 1\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u53C3\u8003\u8CC7\u6599",children:"\u53C3\u8003\u8CC7\u6599"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://changkun.de/modern-cpp/zh-cn/05-pointers/",children:"Modern C++ Tutorial"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.learncpp.com/",children:"Learn C++"})}),"\n"]})]})}function p(e={}){let{wrapper:n}={...(0,d.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},50065:function(e,n,s){s.d(n,{Z:()=>i,a:()=>c});var t=s(67294);let r={},d=t.createContext(r);function c(e){let n=t.useContext(d);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),t.createElement(d.Provider,{value:n},e.children)}}}]);