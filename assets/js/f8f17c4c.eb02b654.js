"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2892],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,c=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=l(n),m=a,h=d["".concat(c,".").concat(m)]||d[m]||u[m]||s;return n?r.createElement(h,i(i({ref:t},p),{},{components:n})):r.createElement(h,i({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,i=new Array(s);i[0]=m;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o[d]="string"==typeof e?e:a,i[1]=o;for(var l=2;l<s;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},9777:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var r=n(7462),a=(n(7294),n(3905));const s={title:"\u5feb\u53d6",sidebar_position:"3",description:"Caching",keywords:["Next.js","\u5feb\u53d6","Caching"]},i=void 0,o={unversionedId:"Next.js/App Router/Data Fetching/Caching",id:"Next.js/App Router/Data Fetching/Caching",title:"\u5feb\u53d6",description:"Caching",source:"@site/docs/Next.js/App Router/Data Fetching/Caching.mdx",sourceDirName:"Next.js/App Router/Data Fetching",slug:"/Next.js/App Router/Data Fetching/Caching",permalink:"/RulerChen-Website/docs/Next.js/App Router/Data Fetching/Caching",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"\u5feb\u53d6",sidebar_position:3,description:"Caching",keywords:["Next.js","\u5feb\u53d6","Caching"]},sidebar:"tutorialSidebar",previous:{title:"\u7372\u53d6\u8cc7\u6599",permalink:"/RulerChen-Website/docs/Next.js/App Router/Data Fetching/Fetching"},next:{title:"\u91cd\u65b0\u9a57\u8b49\u8cc7\u6599",permalink:"/RulerChen-Website/docs/Next.js/App Router/Data Fetching/Revalidating Data"}},c={},l=[{value:"\u8acb\u6c42\u7de9\u5b58",id:"\u8acb\u6c42\u7de9\u5b58",level:2},{value:"<code>fetch()</code>",id:"fetch",level:3},{value:"React \u7684 <code>cache()</code>",id:"react-\u7684-cache",level:3},{value:"POST \u8acb\u6c42\u548c <code>cache()</code>",id:"post-\u8acb\u6c42\u548c-cache",level:3},{value:"\u4f7f\u7528 <code>cache()</code> \u505a\u9810\u52a0\u8f09",id:"\u4f7f\u7528-cache-\u505a\u9810\u52a0\u8f09",level:3},{value:"\u7d50\u5408 <code>cache()</code> \u3001 <code>preload()</code> \u548c <code>server-only</code>",id:"\u7d50\u5408-cache--preload-\u548c-server-only",level:3},{value:"\u6bb5\u7d1a\u7de9\u5b58",id:"\u6bb5\u7d1a\u7de9\u5b58",level:2}],p={toc:l},d="wrapper";function u(e){let{components:t,...n}=e;return(0,a.kt)(d,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://nextjs.org/_next/image?url=%2Fdocs%2Fdark%2Fdeduplicated-fetch-requests.png&w=1920&q=75&dpl=dpl_7yW8E4oiMnD57LWEXZ8RGJmNkSfQ",alt:null})),(0,a.kt)("h2",{id:"\u8acb\u6c42\u7de9\u5b58"},"\u8acb\u6c42\u7de9\u5b58"),(0,a.kt)("h3",{id:"fetch"},(0,a.kt)("inlineCode",{parentName:"h3"},"fetch()")),(0,a.kt)("p",null,"\u9810\u8a2d\u60c5\u6cc1\u4e0b\uff0c\u6240\u6709\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"fetch()")," \u8acb\u6c42\u90fd\u6703\u81ea\u52d5\u5feb\u53d6\u548c\u53bb\u91cd\u3002\n\u9019\u610f\u5473\u8457\u5982\u679c\u4f60\u767c\u51fa\u4e86\u5169\u6b21\u76f8\u540c\u7684\u8acb\u6c42\uff0c\u7b2c\u4e8c\u6b21\u8acb\u6c42\u5c07\u91cd\u8907\u4f7f\u7528\u7b2c\u4e00\u6b21\u8acb\u6c42\u7684\u7d50\u679c\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="app/page.tsx" showLineNumbers',title:'"app/page.tsx"',showLineNumbers:!0},'async function getComments() {\n  const res = await fetch("https://..."); // The result is cached\n  return res.json();\n}\n\n// This function is called twice, but the result is only fetched once\nconst comments = await getComments(); // cache MISS\n\n// The second call could be anywhere in your application\nconst comments = await getComments(); // cache HIT\n')),(0,a.kt)("p",null,"\u5982\u679c\u7b26\u5408\u4ee5\u4e0b\u60c5\u6cc1\uff0c\u8acb\u6c42\u4e0d\u6703\u88ab\u5feb\u53d6\uff1a"),(0,a.kt)("p",null,"\u4f7f\u7528\u52d5\u614b\u65b9\u6cd5\uff08\u4f8b\u5982 ",(0,a.kt)("inlineCode",{parentName:"p"},"next/headers"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"export const POST"),"\uff09\u4e26\u4e14 fetch \u662f\u4e00\u500b POST \u8acb\u6c42\uff08\u6216\u4f7f\u7528 Authorization \u6216 cookie headers\uff09\nfetchCache \u88ab\u914d\u7f6e\u70ba\u9810\u8a2d\u8df3\u904e\u5feb\u53d6\n\u5728\u55ae\u500b fetch \u4e0a\u914d\u7f6e\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"revalidate: 0")," \u6216 ",(0,a.kt)("inlineCode",{parentName:"p"},"cache: 'no-store'"),"\n\u4f7f\u7528 fetch \u9032\u884c\u7684\u8acb\u6c42\u53ef\u4ee5\u6307\u5b9a revalidate \u9078\u9805\u4f86\u63a7\u5236\u8acb\u6c42\u7684\u91cd\u65b0\u9a57\u8b49\u983b\u7387\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="app/page.tsx" showLineNumbers',title:'"app/page.tsx"',showLineNumbers:!0},'export default async function Page() {\n  // revalidate this data every 10 seconds at most\n  const res = await fetch("https://...", { next: { revalidate: 10 } });\n  const data = res.json();\n  // ...\n}\n')),(0,a.kt)("h3",{id:"react-\u7684-cache"},"React \u7684 ",(0,a.kt)("inlineCode",{parentName:"h3"},"cache()")),(0,a.kt)("p",null,"React \u5141\u8a31\u60a8\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"cache()")," \u51fd\u6578\u4f86\u5feb\u53d6\u4e26\u6d88\u9664\u91cd\u8907\u7684\u8acb\u6c42\uff0c\u5c07\u5305\u88dd\u51fd\u6578\u8abf\u7528\u7684\u7d50\u679c\u9032\u884c\u8a18\u61b6\u5316\u3002\u7576\u76f8\u540c\u7684\u51fd\u6578\u4f7f\u7528\u76f8\u540c\u7684\u53c3\u6578\u88ab\u8abf\u7528\u6642\uff0c\u5c07\u91cd\u7528\u7de9\u5b58\u7684\u503c\u800c\u4e0d\u662f\u91cd\u65b0\u904b\u884c\u8a72\u51fd\u6578\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="utils/getUser.ts" showLineNumbers',title:'"utils/getUser.ts"',showLineNumbers:!0},'import { cache } from "react";\n\nexport const getUser = cache(async (id: string) => {\n  const user = await db.user.findUnique({ id });\n  return user;\n});\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="app/user/[id]/layout.tsx" showLineNumbers',title:'"app/user/[id]/layout.tsx"',showLineNumbers:!0},'import { getUser } from "@utils/getUser";\n\nexport default async function UserLayout({ params: { id } }) {\n  const user = await getUser(id);\n  // ...\n}\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="app/user/[id]/posts.tsx" showLineNumbers',title:'"app/user/[id]/posts.tsx"',showLineNumbers:!0},'import { getUser } from "@utils/getUser";\n\nexport default async function Page({ params: { id } }: { params: { id: string } }) {\n  const user = await getUser(id);\n  // ...\n}\n')),(0,a.kt)("p",null,"\u5118\u7ba1\u4e0a\u8ff0\u793a\u4f8b\u4e2d ",(0,a.kt)("inlineCode",{parentName:"p"},"getUser()")," \u51fd\u6578\u88ab\u8abf\u7528\u4e86\u5169\u6b21\uff0c\u4f46\u53ea\u6703\u5411\u6578\u64da\u5eab\u767c\u9001\u4e00\u6b21\u67e5\u8a62\u3002\u9019\u662f\u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"p"},"getUser()")," \u51fd\u6578\u88ab\u5305\u88f9\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"cache()")," \u4e2d\uff0c\u56e0\u6b64\u7b2c\u4e8c\u6b21\u8acb\u6c42\u53ef\u4ee5\u91cd\u7528\u7b2c\u4e00\u6b21\u8acb\u6c42\u7684\u7d50\u679c\u3002"),(0,a.kt)("h3",{id:"post-\u8acb\u6c42\u548c-cache"},"POST \u8acb\u6c42\u548c ",(0,a.kt)("inlineCode",{parentName:"h3"},"cache()")),(0,a.kt)("p",null,"\u4f7f\u7528 fetch \u9032\u884c POST \u8acb\u6c42\u6642\uff0c\u6703\u81ea\u52d5\u9032\u884c\u53bb\u91cd\uff0c\u9664\u975e\u5b83\u5011\u4f4d\u65bc POST Route Handler \u5167\u90e8\u6216\u5728\u8b80\u53d6 ",(0,a.kt)("inlineCode",{parentName:"p"},"headers()/cookies()"),"\u4e4b\u5f8c\u3002\n\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u5728\u4e0a\u8ff0\u60c5\u6cc1\u4e0b\u4f7f\u7528 GraphQL \u548c POST \u8acb\u6c42\uff0c\u53ef\u4ee5\u4f7f\u7528 cache \u4f86\u9032\u884c\u8acb\u6c42\u53bb\u91cd\u3002cache \u7684\u53c3\u6578\u5fc5\u9808\u662f\u5e73\u9762\u7684\uff0c\u53ea\u5305\u542b\u57fa\u672c\u985e\u578b\u3002\n\u6df1\u5c64\u5c0d\u8c61\u4e0d\u6703\u9032\u884c\u53bb\u91cd\u5339\u914d\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="utils/getUser.ts" showLineNumbers',title:'"utils/getUser.ts"',showLineNumbers:!0},'import { cache } from "react";\n\nexport const getUser = cache(async (id: string) => {\n  const res = await fetch("...", { method: "POST", body: "..." });\n  // ...\n});\n')),(0,a.kt)("h3",{id:"\u4f7f\u7528-cache-\u505a\u9810\u52a0\u8f09"},"\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"h3"},"cache()")," \u505a\u9810\u52a0\u8f09"),(0,a.kt)("p",null,"\u6211\u5011\u5efa\u8b70\u5728\u57f7\u884c\u6578\u64da\u7372\u53d6\u7684\u5be6\u7528\u7a0b\u5e8f\u6216\u7d44\u4ef6\u4e2d\u9078\u64c7\u6027\u5730\u66b4\u9732 ",(0,a.kt)("inlineCode",{parentName:"p"},"preload()")," \u5c0e\u51fa\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="components/User.tsx" showLineNumbers',title:'"components/User.tsx"',showLineNumbers:!0},'import { getUser } from "@utils/getUser";\n\nexport const preload = (id: string) => {\n  // void evaluates the given expression and returns undefined\n  // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/void\n  void getUser(id);\n};\nexport default async function User({ id }: { id: string }) {\n  const result = await getUser(id);\n  // ...\n}\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="app/user/[id]/page.tsx" showLineNumbers',title:'"app/user/[id]/page.tsx"',showLineNumbers:!0},'import User, { preload } from "@components/User";\n\nexport default async function Page({ params: { id } }: { params: { id: string } }) {\n  preload(id); // starting loading the user data now\n  const condition = await fetchCondition();\n  return condition ? <User id={id} /> : null;\n}\n')),(0,a.kt)("h3",{id:"\u7d50\u5408-cache--preload-\u548c-server-only"},"\u7d50\u5408 ",(0,a.kt)("inlineCode",{parentName:"h3"},"cache()")," \u3001 ",(0,a.kt)("inlineCode",{parentName:"h3"},"preload()")," \u548c ",(0,a.kt)("inlineCode",{parentName:"h3"},"server-only")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="utils/getUser.ts" showLineNumbers',title:'"utils/getUser.ts"',showLineNumbers:!0},'import { cache } from "react";\nimport "server-only";\n\nexport const preload = (id: string) => {\n  void getUser(id);\n};\n\nexport const getUser = cache(async (id: string) => {\n  // ...\n});\n')),(0,a.kt)("p",null,"\u4f7f\u7528\u9019\u7a2e\u65b9\u6cd5\uff0c\u60a8\u53ef\u4ee5\u6025\u65bc\u7372\u53d6\u6578\u64da\uff0c\u7de9\u5b58\u97ff\u61c9\uff0c\u4e26\u78ba\u4fdd\u9019\u7a2e\u6578\u64da\u7372\u53d6\u50c5\u5728\u670d\u52d9\u5668\u4e0a\u767c\u751f\u3002"),(0,a.kt)("h2",{id:"\u6bb5\u7d1a\u7de9\u5b58"},"\u6bb5\u7d1a\u7de9\u5b58"),(0,a.kt)("p",null,"\u6bb5\u7d1a\u7de9\u5b58\u5141\u8a31\u60a8\u7de9\u5b58\u548c\u91cd\u65b0\u9a57\u8b49\u5728\u8def\u5f91\u6bb5\u4e2d\u4f7f\u7528\u7684\u6578\u64da\u3002"),(0,a.kt)("p",null,"\u6b64\u6a5f\u5236\u5141\u8a31\u8def\u5f91\u7684\u4e0d\u540c\u6bb5\u63a7\u5236\u6574\u500b\u8def\u5f91\u7684\u7de9\u5b58\u751f\u5b58\u671f\u3002\n\u8def\u5f91\u5c64\u6b21\u7d50\u69cb\u4e2d\u7684\u6bcf\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"page.tsx")," \u548c ",(0,a.kt)("inlineCode",{parentName:"p"},"layout.tsx")," \u90fd\u53ef\u4ee5\u5c0e\u51fa revalidate \u503c\uff0c\u4ee5\u8a2d\u7f6e\u8def\u5f91\u7684\u91cd\u65b0\u9a57\u8b49\u6642\u9593\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="app/page.tsx" showLineNumbers',title:'"app/page.tsx"',showLineNumbers:!0},"export const revalidate = 60; // revalidate this segment every 60 seconds\n")))}u.isMDXComponent=!0}}]);