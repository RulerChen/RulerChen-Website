"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2612],{848:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>l});var i=s(5893),t=s(1151);const r={title:"[PG] Postgres Tuning",sidebar_position:"10",description:"Postgres \u6027\u80fd\u8abf\u6821",keywords:["Postgres","\u8abf\u6821"]},c=void 0,a={id:"Database/pg-tuning",title:"[PG] Postgres Tuning",description:"Postgres \u6027\u80fd\u8abf\u6821",source:"@site/docs/Database/pg-tuning.mdx",sourceDirName:"Database",slug:"/Database/pg-tuning",permalink:"/RulerChen-Website/docs/Database/pg-tuning",draft:!1,unlisted:!1,editUrl:"https://github.com/RulerChen/RulerChen-Website/tree/main/docs/Database/pg-tuning.mdx",tags:[],version:"current",lastUpdatedAt:172256609e4,sidebarPosition:10,frontMatter:{title:"[PG] Postgres Tuning",sidebar_position:10,description:"Postgres \u6027\u80fd\u8abf\u6821",keywords:["Postgres","\u8abf\u6821"]},sidebar:"tutorialSidebar",previous:{title:"[Next.js] ESlint in Next.js 13.4",permalink:"/RulerChen-Website/docs/Next.js/EslintPrettier"},next:{title:"[PG] Postgres HA and Scale",permalink:"/RulerChen-Website/docs/Database/pg-ha"}},d={},l=[{value:"Environment Setup",id:"environment-setup",level:2},{value:"Postgres Architecture",id:"postgres-architecture",level:2},{value:"Process manager",id:"process-manager",level:3},{value:"Shared Memory",id:"shared-memory",level:3},{value:"Query processor",id:"query-processor",level:3},{value:"Checkpoint",id:"checkpoint",level:3},{value:"WAL writer",id:"wal-writer",level:3},{value:"Utility process",id:"utility-process",level:3},{value:"Vacuum",id:"vacuum",level:2},{value:"Index",id:"index",level:2},{value:"Index introduction",id:"index-introduction",level:3},{value:"Index use case",id:"index-use-case",level:3},{value:"Index cluster",id:"index-cluster",level:3},{value:"Statistics",id:"statistics",level:2},{value:"Query Plan",id:"query-plan",level:2},{value:"SQL Optimization",id:"sql-optimization",level:2},{value:"Join Order",id:"join-order",level:3},{value:"Avoid SELECT *",id:"avoid-select-",level:3},{value:"Avoid Order By",id:"avoid-order-by",level:3},{value:"Avoid Distinct",id:"avoid-distinct",level:3},{value:"Parallel Query",id:"parallel-query",level:3},{value:"Shared Buffer",id:"shared-buffer",level:2},{value:"Reference",id:"reference",level:2}];function o(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"environment-setup",children:"Environment Setup"}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u9019\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5011\u6703\u4f7f\u7528 docker \u4f86\u9032\u884c\u793a\u7bc4 :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run --name postgres-tuning -e POSTGRES_PASSWORD=postgres -d postgres:16-alpine\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it --user root postgres-tuning bash\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5982\u679c\u60f3\u8981\u5728\u5bb9\u5668\u4e2d\u4f7f\u7528 nano (\u5bb9\u5668\u4e2d\u9810\u8a2d\u53ef\u4ee5\u4f7f\u7528 vi)\uff0c\u53ef\u4ee5\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4 :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"apk update && apk add nano\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u8457\u9032\u5165\u5230 postgres \u4f7f\u7528\u8005\u4e2d :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"su postgres\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u8981\u96e2\u958b\u5bb9\u5668\uff0c\u53ef\u4ee5\u57f7\u884c ",(0,i.jsx)(n.code,{children:"exit"})," \u6307\u4ee4\u3002"]}),"\n",(0,i.jsx)(n.h2,{id:"postgres-architecture",children:"Postgres Architecture"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Postgres Architecture",src:s(9433).Z+"",width:"1173",height:"581"})}),"\n",(0,i.jsx)(n.h3,{id:"process-manager",children:"Process manager"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Postgres Architecture",src:s(2666).Z+"",width:"1108",height:"461"})}),"\n",(0,i.jsx)(n.p,{children:"postgres \u662f client-server \u7684\u67b6\u69cb\uff0cclient \u7aef\u53ef\u4ee5\u900f\u904e TCP/IP \u9023\u7dda\u5230 server \u7aef\uff0cserver \u7aef\u6703\u57f7\u884c client \u7aef\u767c\u9001\u7684\u6307\u4ee4\uff0c\u4e26\u56de\u50b3\u7d50\u679c\u3002\n\u5c0d\u65bc\u6bcf\u4e00\u500b client \u7aef\u9023\u7dda\uff0cpostgres \u90fd\u6703\u555f\u52d5\u4e00\u500b process \u4f86\u8655\u7406\u9019\u500b\u9023\u7dda\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"shared-memory",children:"Shared Memory"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Postgres Shared Buffer",src:s(6530).Z+"",width:"1117",height:"523"})}),"\n",(0,i.jsx)(n.p,{children:"postgres \u4e26\u4e0d\u6703\u76f4\u63a5\u8b80\u53d6\u78c1\u789f\u4e0a\u7684\u8cc7\u6599\uff0c\u800c\u662f\u5148\u5f9e shared buffer \u4e2d\u8b80\u53d6\u4f86\u6e1b\u5c11\u78c1\u789f I/O \u7684\u6b21\u6578\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"query-processor",children:"Query processor"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.img,{alt:"Postgres Query processor",src:s(4967).Z+"",width:"1153",height:"582"}),"\n",(0,i.jsx)(n.img,{alt:"Postgres Query processor",src:s(936).Z+"",width:"1165",height:"579"})]}),"\n",(0,i.jsx)(n.p,{children:"Query processor \u5206\u70ba\u4e94\u500b\u6b65\u9a5f"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Connection manager : \u7ba1\u7406 client \u7aef\u7684\u9023\u7dda"}),"\n",(0,i.jsx)(n.li,{children:"Query parser : \u89e3\u6790 client \u7aef\u767c\u9001\u7684\u6307\u4ee4"}),"\n",(0,i.jsx)(n.li,{children:"Query rewriter : \u5c07 view \u4e4b\u985e\u7684\u7269\u4ef6\u8f49\u63db\u6210\u57fa\u672c\u7684 SQL \u8a9e\u6cd5"}),"\n",(0,i.jsx)(n.li,{children:"Query planner : \u4f9d\u64da\u7d71\u8a08\u8cc7\u6599\uff0c\u9078\u64c7\u6700\u4f73\u7684\u57f7\u884c\u8a08\u756b"}),"\n",(0,i.jsx)(n.li,{children:"Query executor : \u57f7\u884c\u6307\u4ee4"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"checkpoint",children:"Checkpoint"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Postgres Checkpoint",src:s(1631).Z+"",width:"1139",height:"525"})}),"\n",(0,i.jsx)(n.p,{children:"\u7576\u8981\u57f7\u884c checkpoint \u6642\uff0c\u6703\u5c07 shared buffer \u4e2d\u7684\u8cc7\u6599\u5beb\u5165\u5230\u78c1\u789f\u4e0a\uff0c\n\u4e26\u4e14\u5c07 shared buffer \u548c WAL \u4e2d\u7684\u8cc7\u6599\u6a19\u8a18\u70ba\u4e7e\u6de8\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Postgres Checkpoint",src:s(5605).Z+"",width:"986",height:"544"})}),"\n",(0,i.jsx)(n.p,{children:"\u9019\u6a23\u7576\u8cc7\u6599\u5eab\u51fa\u73fe\u554f\u984c\u9700\u8981 recovery \u6642\uff0c\u53ef\u4ee5\u5f9e checkpoint \u7684\u4f4d\u7f6e\u958b\u59cb\u9032\u884c recovery\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u5e38\u898b\u7684\u53c3\u6578\u5305\u542b\u4ee5\u4e0b\uff0c\u6211\u5011\u9700\u8981\u4f9d\u64da\u5be6\u969b\u7684\u72c0\u6cc1\u9032\u884c\u8abf\u6574 :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"checkpoint_flush_after"})," : \u6bcf\u5beb\u5165\u591a\u5c11\u8cc7\u6599\u5f8c\u5c31\u9032\u884c flush"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"checkpoint_timeout"})," : \u8a2d\u5b9a checkpoint \u7684\u6642\u9593\u9593\u9694"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"checkpoint_completion_target"})," : \u8a2d\u5b9a\u5beb\u5165\u5fc5\u9808\u5728 checkpoint \u7684\u5e7e\u8db4\u5167\u5b8c\u6210\uff0c\u9810\u8a2d\u70ba 0.5"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"wal-writer",children:"WAL writer"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Postgres WAL writer",src:s(6507).Z+"",width:"1098",height:"555"})}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u8cc7\u6599\u88ab\u4fee\u6539\u6642\uff0c\u6703\u5148\u5beb\u5165\u5230 WAL \u7684 buffer \u4e2d\uff0c\n\u76f4\u5230\u88ab commit \u5f8c\u624d\u6703\u5beb\u5165\u5230\u78c1\u789f\u4e0a\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u540c\u6642\uff0cWAL \u4e5f\u6703\u88ab\u7528\u4f86\u9032\u884c crash recovery \u548c replication\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"utility-process",children:"Utility process"}),"\n",(0,i.jsx)(n.p,{children:"\u5728 Postgres \u4e2d\u6709\u5f88\u591a utility process \u6703\u5728\u80cc\u666f\u57f7\u884c\uff0c\u4f8b\u5982 :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Vacuum"})," : \u6e05\u7406 dead tuples"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Checkpointer"})," : \u57f7\u884c checkpoint"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"WAL Writer"})," : \u7d00\u9304 WAL \u7684\u8cc7\u6599"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Archiver"})," : \u5c07 WAL \u4e2d\u7684\u8cc7\u6599\u5beb\u5165\u5230\u78c1\u789f"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Stats Collector"})," : \u6536\u96c6\u7d71\u8a08\u8cc7\u6599"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"vacuum",children:"Vacuum"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 postgres \u4e2d\uff0c\u5982\u679c\u6211\u5011\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"DELETE"})," \u6216 ",(0,i.jsx)(n.code,{children:"UPDATE"})," \u6307\u4ee4\u4f86\u522a\u9664\u6216\u4fee\u6539\u8cc7\u6599\uff0c\n\u5be6\u969b\u4e0a\u4e26\u4e0d\u6703\u7acb\u5373\u5c07\u8cc7\u6599\u5f9e\u78c1\u789f\u4e0a\u522a\u9664\uff0c\u800c\u662f\u5c07\u8cc7\u6599\u6a19\u8a18\u70ba dead tuples (\u56e0\u70ba\u9700\u8981\u5728\u5931\u6557\u6642\u9032\u884c rollback)\uff0c\n\u9019\u6a23\u7684\u8cc7\u6599\u6703\u4f54\u7528\u78c1\u789f\u7a7a\u9593\uff0c\u4e26\u4e14\u5f71\u97ff\u67e5\u8a62\u6548\u80fd\uff0c\n\u800c ",(0,i.jsx)(n.code,{children:"VACUUM"})," \u6307\u4ee4\u53ef\u4ee5\u5c07\u88ab\u6a19\u8a18\u70ba\u5df2\u522a\u9664\u6216\u662f\u904e\u671f\u7684 tuple \u6a19\u8a18\u70ba\u53ef\u91cd\u7528\uff0c\n\u9019\u6a23\u7576\u4e0b\u4e00\u6b21\u6709\u8cc7\u6599\u9700\u8981\u5beb\u5165\u6642\uff0c\u6703\u8986\u84cb\u6389\u539f\u672c\u7684 dead tuples\uff0c\n\u56e0\u6b64\u5982\u679c\u6211\u5011\u518d\u6b21\u57f7\u884c ",(0,i.jsx)(n.code,{children:"UPDATE"}),"\uff0c\u8cc7\u6599\u8868\u7684\u5927\u5c0f\u4e5f\u4e0d\u6703\u589e\u52a0\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u6211\u5011\u60f3\u8981\u522a\u9664\u6240\u6709 dead tuples\uff0c\u53ef\u4ee5\u57f7\u884c ",(0,i.jsx)(n.code,{children:"VACUUM FULL"})," \u6307\u4ee4\uff0c\n\u9019\u6a23\u6703\u5c07\u6574\u5f35\u8868\u7684\u8cc7\u6599\u91cd\u65b0\u5beb\u5165\u5230\u78c1\u789f\u4e0a\uff0c\u4e26\u4e14\u91cb\u653e\u78c1\u789f\u7a7a\u9593\uff0c\n\u4f46\u662f\u9019\u6a23\u6703\u4f7f\u7528\u6392\u4ed6\u9396\u963b\u585e\u5176\u4ed6\u6307\u4ee4\u7684\u57f7\u884c\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u6211\u5011\u53ef\u4ee5\u900f\u904e\u4ee5\u4e0b\u7684\u7bc4\u4f8b\u4f86\u89c0\u5bdf ",(0,i.jsx)(n.code,{children:"VACUUM"})," \u7684\u5f71\u97ff :"]}),"\n",(0,i.jsx)(n.p,{children:"\u9996\u5148\u6211\u5011\u5148\u5275\u5efa 10 \u842c\u7b46\u8cc7\u6599\u4e26\u95dc\u9589 autovacuum"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"psql -U postgres -d postgres\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE TABLE test (id int) with (autovacuum_enabled = off);\nINSERT INTO test SELECT * FROM generate_series(1, 100000);\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u8457\u6211\u5011\u67e5\u8a62\u8cc7\u6599\u8868\u7684\u5927\u5c0f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT pg_size_pretty(pg_relation_size('test'));\n-- result\n pg_size_pretty\n----------------\n 3544 kB\n(1 row)\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u66f4\u65b0\u4e4b\u5f8c\u518d\u89c0\u5bdf\u8cc7\u6599\u8868\u7684\u5927\u5c0f\uff0c\u767c\u73fe\u5927\u5c0f\u5927\u7d04\u589e\u52a0\u4e86\u5169\u500d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"UPDATE test SET id = id + 1;\n\nSELECT pg_size_pretty(pg_relation_size('test'));\n-- result\n pg_size_pretty\n----------------\n 7080 kB\n(1 row)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u63a5\u8457\u57f7\u884c ",(0,i.jsx)(n.code,{children:"VACUUM"})," \u6307\u4ee4\uff0c\u5927\u5c0f\u4e26\u4e0d\u6703\u6e1b\u5c11\uff0c\u800c\u662f\u5c07 tuple \u6a19\u8a18\u70ba\u53ef\u91cd\u7528"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"VACUUM test;\n\nSELECT pg_size_pretty(pg_relation_size('test'));\n-- result\n pg_size_pretty\n----------------\n 7080 kB\n(1 row)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u518d\u57f7\u884c\u4e00\u6b21 ",(0,i.jsx)(n.code,{children:"UPDATE"})," \u6307\u4ee4\uff0c\u5927\u5c0f\u4e26\u4e0d\u6703\u589e\u52a0\uff0c\u56e0\u70ba\u4ed6\u8986\u84cb\u6389\u539f\u672c\u7684 dead tuples"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"UPDATE test SET id = id + 1;\n\nSELECT pg_size_pretty(pg_relation_size('test'));\n-- result\n pg_size_pretty\n----------------\n 7080 kB\n(1 row)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u6700\u5f8c\u57f7\u884c ",(0,i.jsx)(n.code,{children:"VACUUM FULL"})," \u6307\u4ee4\uff0c\u5927\u5c0f\u6703\u7e2e\u5c0f\u5230\u539f\u672c\u7684\u5927\u5c0f"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"VACUUM FULL test;\n\nSELECT pg_size_pretty(pg_relation_size('test'));\n-- result\n pg_size_pretty\n----------------\n 3544 kB\n(1 row)\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5982\u679c\u60f3\u8981\u6aa2\u67e5 table \u4e2d\u6709\u591a\u5c11 dead tuples \u53ef\u4ee5\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4 :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT relname, n_live_tup, n_dead_tup FROM pg_stat_user_tables WHERE relname = 'test';\n-- result\nrelname | n_live_tup | n_dead_tup\n---------+------------+------------\n test    |     100000 |     100000\n(1 row)\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u4e5f\u53ef\u4ee5\u900f\u904e\u4ee5\u4e0b\u6307\u4ee4\u4f86\u6aa2\u67e5 VACUUM \u7684\u53c3\u6578"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"select name,setting\nfrom pg_settings\nwhere name in ('autovacuum_max_workers','autovacuum_naptime','autovacuum_vacuum_scale_factor','autovacuum_vacuum_threshold');\n-- result\n              name              | setting\n--------------------------------+---------\n autovacuum_max_workers         | 3\n autovacuum_naptime             | 60\n autovacuum_vacuum_scale_factor | 0.2\n autovacuum_vacuum_threshold    | 50\n(4 rows)\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u53ef\u4ee5\u900f\u904e\u8abf\u6574\u53c3\u6578\u4f86\u63a7\u5236 VACUUM \u7684\u884c\u70ba\uff0c\u4f8b\u5982 :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"autovacuum_max_workers"})," : \u6700\u5927\u53ef\u4ee5\u540c\u6642\u904b\u884c vacuum \u7684 process \u6578\u91cf"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"autovacuum_naptime"})," : \u6bcf\u591a\u5c11\u79d2\u9700\u8981\u6aa2\u67e5\u662f\u5426\u9700\u8981\u57f7\u884c vacuum"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"autovacuum_vacuum_scale_factor"})," : \u6c7a\u5b9a\u89f8\u767c vacuum \u7684\u689d\u4ef6"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"autovacuum_vacuum_threshold"})," : \u6c7a\u5b9a\u89f8\u767c vacuum \u7684\u689d\u4ef6"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u800c\u89f8\u767c vacuum \u7684\u516c\u5f0f\u662f : dead tuples > autovacuum_vacuum_scale_factor * tuple count + autovacuum_vacuum_threshold"}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u6211\u5011\u7684\u8cc7\u6599\u91cf\u904e\u5927\uff0c",(0,i.jsx)(n.code,{children:"VACUUM"})," \u5728\u57f7\u884c\u4e00\u6bb5\u6642\u9593\u5f8c\u5c31\u6703\u9032\u5165\u5230 delay \u7684\u6642\u9593\uff0c\u8b93\u5176\u4ed6\u64cd\u4f5c\u53ef\u4ee5\u57f7\u884c\u3002\n\u5982\u679c\u4e00\u76f4\u7121\u6cd5\u5b8c\u6210\uff0c\u6211\u5011\u5c31\u9700\u8981\u53bb\u8abf\u6574 ",(0,i.jsx)(n.code,{children:"vacuum_cost_delay"})," \u7684\u6642\u9593\u3002"]}),"\n",(0,i.jsx)(n.h2,{id:"index",children:"Index"}),"\n",(0,i.jsx)(n.h3,{id:"index-introduction",children:"Index introduction"}),"\n",(0,i.jsx)(n.p,{children:"\u7d22\u5f15\u901a\u5e38\u662f\u8cc7\u6599\u5eab\u6548\u80fd\u7684\u74f6\u9838\uff0c\u56e0\u6b64\u6211\u5011\u9700\u8981\u9069\u7576\u7684\u5efa\u7acb\u7d22\u5f15\u4f86\u63d0\u9ad8\u67e5\u8a62\u6548\u80fd\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u5148\u5efa\u7acb\u7bc4\u4f8b\u8cc7\u6599\u8868"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE TABLE test_index (id serial, name text);\nINSERT INTO test_index (name) SELECT 'alice' FROM generate_series(1, 2500000);\nINSERT INTO test_index (name) SELECT 'bob' FROM generate_series(1, 2500000);\n\n-- \u958b\u555f\u8a08\u6642\n\\timing\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u8457\u5617\u8a66\u5728\u6c92\u6709\u7d22\u5f15\u7684\u60c5\u6cc1\u4e0b\u9032\u884c\u67e5\u8a62"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"EXPLAIN ANALYZE SELECT * FROM test_index WHERE id = 1000000;\n-- result\n                                                         QUERY PLAN\n-----------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..43392.60 rows=15606 width=36) (actual time=100.488..103.282 rows=1 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n   ->  Parallel Seq Scan on test_index  (cost=0.00..40832.00 rows=6502 width=36) (actual time=72.973..97.820 rows=0 loops=3)\n         Filter: (id = 1000000)\n         Rows Removed by Filter: 1666666\n Planning Time: 0.286 ms\n Execution Time: 103.303 ms\n(8 rows)\n\nTime: 104.655 ms\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u7d93\u7531\u4e0a\u9762\u7684\u67e5\u8a62\u8a08\u756b\u53ef\u4ee5\u770b\u5230\uff0cpostgres \u4f7f\u7528\u5169\u500b Workers \u548c Parallel Seq Scan \u4f86\u9032\u884c\u67e5\u8a62\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE INDEX idx_id ON test_index (id);\n\nEXPLAIN ANALYZE SELECT * FROM test_index WHERE id = 1000000;\n-- result\n                                                     QUERY PLAN\n---------------------------------------------------------------------------------------------------------------------\n Index Scan using idx_id on test_index  (cost=0.43..8.45 rows=1 width=9) (actual time=0.653..0.671 rows=1 loops=1)\n   Index Cond: (id = 1000000)\n Planning Time: 1.190 ms\n Execution Time: 0.739 ms\n(4 rows)\n\nTime: 3.408 ms\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\uff0c\u4f7f\u7528 index \u4e4b\u5f8c\u901f\u5ea6\u52a0\u5feb\u4e86\u8a31\u591a\uff0c\n\u4f46\u662f\u8981\u6ce8\u610f\u7684\u662f index \u6703\u4f54\u7528\u786c\u789f\u7a7a\u9593\uff0c\u4e26\u4e14\u5728\u5beb\u5165\u6642\u6703\u589e\u52a0\u984d\u5916\u7684\u958b\u92b7\uff0c\n\u56e0\u6b64\u6211\u5011\u9700\u8981\u89c0\u5bdf index \u548c table \u7684\u5927\u5c0f\uff0c\u4e26\u4e14\u5728\u9069\u7576\u7684\u6642\u6a5f\u4f7f\u7528\u7d22\u5f15\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"\\di+\n-- result\n                                           List of relations\n Schema |   Name   | Type  |  Owner   |   Table    | Persistence | Access method |  Size  | Description\n--------+----------+-------+----------+------------+-------------+---------------+--------+-------------\n public |  idx_id  | index | postgres | test_index | permanent   | btree         | 107 MB |\n(1 row)\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"\\dt+\n-- result\n                                      List of relations\n Schema |    Name    | Type  |  Owner   | Persistence | Access method |  Size  | Description\n--------+------------+-------+----------+-------------+---------------+--------+-------------\n public | test_index | table | postgres | permanent   | heap          | 192 MB |\n(1 row)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"index-use-case",children:"Index use case"}),"\n",(0,i.jsx)(n.p,{children:"\u9664\u4e86\u5728\u67e5\u8a62\u7684\u6642\u5019\u53ef\u4ee5\u4f7f\u7528 index \u4f86\u63d0\u9ad8\u67e5\u8a62\u6027\u80fd\uff0c\u5728\u505a join \u7684\u6642\u5019\u4e5f\u53ef\u4ee5\u4f7f\u7528 index \u4f86\u63d0\u9ad8\u6027\u80fd\uff0c\n\u6211\u5011\u53ef\u4ee5\u5728 foreign key \u4e0a\u5efa\u7acb index \uff0c\n\u9019\u6a23\u9664\u4e86\u53ef\u4ee5\u63d0\u9ad8 join \u7684\u6548\u7387\u5916\uff0c\n\u5728 parent table \u8b8a\u52d5\u6642\uff0c\u4e5f\u53ef\u4ee5\u63d0\u9ad8\u6548\u80fd\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u81f3\u65bc index \u7684\u4e0b\u6cd5\uff0c\u6211\u5011\u9664\u4e86\u91dd\u5c0d\u5168\u8868\u5efa\u7acb index \u5916\uff0c\u4e5f\u53ef\u4ee5\u91dd\u5c0d\u67d0\u4e9b\u7279\u5b9a\u7684\u503c\u4f86\u5efa\u7acb index (partial index)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE INDEX idx_name_res ON test_index(name) WHERE name not in ('alice', 'bob');\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u9084\u6709\u4e00\u7a2e index \u7684\u6a21\u5f0f\u53eb\u505a combination index\uff0c\u9019\u7a2e index \u53ef\u4ee5\u5c07\u591a\u500b\u6b04\u4f4d\u7d44\u5408\u8d77\u4f86\u5efa\u7acb index\uff0c\n\u9019\u6a23\u53ef\u4ee5\u63d0\u9ad8\u67e5\u8a62\u6548\u80fd\uff0c\u4f46\u540c\u6642\u4e5f\u6703\u589e\u52a0 index \u7684\u5927\u5c0f\uff0c\n\u4e26\u4e14\u5982\u679c\u6211\u5011\u4e0d\u5c0d\u7b2c\u4e00\u500b\u6b04\u4f4d\u641c\u5c0b\u6642\uff0c\u9019\u500b index \u5c31\u6703\u5931\u6548\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE INDEX idx_name_res2 ON test_index(name, id);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"index-cluster",children:"Index cluster"}),"\n",(0,i.jsx)(n.p,{children:"\u9664\u6b64\u4e4b\u5916 correlation \u4e5f\u53ef\u4ee5\u7528\u4f86\u63d0\u9ad8\u67e5\u8a62\u6548\u80fd\uff0c\n\u7531\u65bc\u8cc7\u6599\u7684\u7269\u7406\u4f4d\u7f6e\u63a5\u8fd1\uff0c\u53ef\u4ee5\u6e1b\u5c11 I/O \u7684\u6b21\u6578\uff0c\u9032\u800c\u63d0\u9ad8\u67e5\u8a62\u6548\u80fd\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u4e0b\u4f86\u6211\u5011\u900f\u904e\u5169\u500b\u7bc4\u4f8b\u4f86\u8aaa\u660e correlation \u7684\u5f71\u97ff\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE TABLE t_test (id serial, name text);\nINSERT INTO t_test (name) SELECT 'alice' FROM generate_series(1, 500000);\nCREATE INDEX t_test_idx ON t_test (id);\nVACUUM ANALYZE t_test;\nEXPLAIN (ANALYZE true, BUFFERS true, TIMING true) SELECT * FROM t_test WHERE id < 10000;\n-- result\nQUERY PLAN\n----------------------------------------------------------------------------------------------------------------------------\n Index Scan using t_test_idx on t_test  (cost=0.42..321.59 rows=9324 width=10) (actual time=0.054..1.826 rows=9999 loops=1)\n   Index Cond: (id < 10000)\n   Buffers: shared hit=55 read=30\n Planning:\n   Buffers: shared hit=17 read=1\n Planning Time: 0.321 ms\n Execution Time: 2.325 ms\n(7 rows)\n\nTime: 3.179 ms\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE TABLE t_random as SELECT * FROM t_test ORDER BY random();\nCREATE INDEX t_random_idx ON t_random (id);\nVACUUM ANALYZE t_random;\nEXPLAIN (ANALYZE true, BUFFERS true, TIMING true) SELECT * FROM t_random WHERE id < 10000;\n-- result\nQUERY PLAN\n------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on t_random  (cost=191.22..3070.30 rows=10167 width=10) (actual time=1.065..3.621 rows=9999 loops=1)\n   Recheck Cond: (id < 10000)\n   Heap Blocks: exact=2636\n   Buffers: shared hit=2636 read=30\n   ->  Bitmap Index Scan on t_random_idx  (cost=0.00..188.68 rows=10167 width=0) (actual time=0.789..0.789 rows=9999 loops=1)\n         Index Cond: (id < 10000)\n         Buffers: shared read=30\n Planning:\n   Buffers: shared hit=9\n Planning Time: 0.095 ms\n Execution Time: 4.446 ms\n(11 rows)\n\nTime: 4.959 ms\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230 Buffer \u7684 shared hit \u76f8\u5dee\u5f88\u591a\uff0c\u9032\u800c\u5f71\u97ff\u4e86\u6548\u80fd\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u53ef\u4ee5\u900f\u904e\u4ee5\u4e0b\u7684\u7bc4\u4f8b\u4f86\u67e5\u770b correlation \u7684\u6578\u503c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT tablename, attname, correlation FROM pg_stats WHERE tablename IN ('t_test', 't_random') ORDER BY 1, 2;\n-- result\ntablename | attname | correlation\n-----------+---------+-------------\n t_random  | id      | 0.012932359\n t_random  | name    |           1\n t_test    | id      |           1\n t_test    | name    |           1\n(4 rows)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u8981\u89e3\u6c7a\u9019\u500b\u554f\u984c\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"CLUSTER"})," \u6307\u4ee4\u4f86\u5c07\u8cc7\u6599\u6309\u7167 index \u7684\u9806\u5e8f\u91cd\u65b0\u6392\u5217\uff0c\u4f86\u63d0\u9ad8\u67e5\u8a62\u6548\u80fd\uff0c\n\u4f46\u9019\u500b\u65b9\u5f0f\u6703\u9020\u6210\u9396\u8868\uff0c\u4e14\u53ea\u80fd\u4f9d\u64da\u4e00\u500b index \u4f86\u9032\u884c\u6392\u5e8f\uff0c\u540c\u6642\u7576\u65b0\u7684\u8cc7\u6599\u9032\u5165\u6642\uff0c\u4e5f\u4e0d\u6703\u81ea\u52d5\u91cd\u65b0\u6392\u5e8f\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CLUSTER t_random USING t_random_idx;\nANALYZE;\nSELECT tablename, attname, correlation FROM pg_stats WHERE tablename IN ('t_test', 't_random') ORDER BY 1, 2;\n-- result\ntablename | attname | correlation\n-----------+---------+-------------\n t_random  | id      |           1\n t_random  | name    |           1\n t_test    | id      |           1\n t_test    | name    |           1\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5728 postgres \u4e2d\uff0c\u6709\u4e00\u500b\u53eb\u505a fill factor \u7684\u53c3\u6578\uff0c\u9810\u8a2d\u662f 100%\uff0c\n\u9019\u500b\u53c3\u6578\u6703\u6c7a\u5b9a page \u88ab\u586b\u6eff\u7684\u7a0b\u5ea6\uff0c\u5982\u679c\u6211\u5011\u5c07 fill factor \u8a2d\u5b9a\u70ba 90%\uff0c\u90a3\u9ebc\u7576 page \u88ab\u586b\u6eff 90% \u6642\uff0c\n\u5c31\u4e0d\u6703\u518d\u5beb\u5165\u65b0\u7684\u8cc7\u6599\uff0c\n\u628a\u7a7a\u9593\u9810\u7559\u7d66\u66f4\u65b0\u548c\u522a\u9664\u7684\u8cc7\u6599\uff0c\n\u4f7f\u4e4b\u8b8a\u6210 HOT update\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u53ef\u4ee5\u900f\u904e\u4ee5\u4e0b\u7bc4\u4f8b\u4f86\u5ba3\u544a fill factor \u7684\u503c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE TABLE test_fillfactor (id serial, name text) WITH (fillfactor = 90);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"statistics",children:"Statistics"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 postgres \u4e2d\uff0c\u7d71\u8a08\u8cc7\u6599\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u5b83\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u4e86\u89e3\u8cc7\u6599\u5eab\u7684\u72c0\u6cc1\uff0c\u4e26\u4e14\u63d0\u4f9b\u6700\u4f73\u5316\u7684\u5efa\u8b70\u3002\n\u6211\u5011\u53ef\u4ee5\u900f\u904e ",(0,i.jsx)(n.code,{children:"pg_stat_statements"})," \u4f86\u67e5\u770b\u7d71\u8a08\u8cc7\u6599\uff0c\u9019\u500b view \u6703\u8a18\u9304\u6240\u6709\u57f7\u884c\u7684 SQL \u8a9e\u53e5\uff0c\u4e26\u4e14\u63d0\u4f9b\u57f7\u884c\u6642\u9593\u3001\u57f7\u884c\u6b21\u6578\u3001\u8b80\u53d6\u7684\u8cc7\u6599\u91cf\u7b49\u8cc7\u8a0a\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u9996\u5148\u6211\u5011\u9700\u8981\u555f\u52d5\u9019\u500b extension\uff0c\u6211\u5011\u5148\u5275\u5efa\u4e00\u500b\u65b0\u7684\u8cc7\u6599\u5eab\u4e26\u4f7f\u7528 pgbench \u751f\u6210\u4e00\u4e9b\u5047\u8cc7\u6599"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"su postgres\n\ncreatedb benchdb\n\npgbench -i benchdb\n\npgbench -c 10 -t 100000 benchdb\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u8457\u9700\u8981\u8abf\u6574 postgresql.conf \u4f86\u555f\u52d5\u9019\u500b extension"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd /var/lib/postgresql/data\nnano postgresql.conf\n# change shared_preload_libraries = 'pg_stat_statements'\n\n# restart docker\ndocker restart postgres-tuning\ndocker exec -it --user root postgres-tuning bash\n\npsql -U postgres -d benchdb\nCREATE EXTENSION pg_stat_statements;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u63a5\u8457\u6211\u5011\u53ef\u80fd\u9700\u8981\u8abf\u6574\u4e00\u4e0b\u986f\u793a\u65b9\u5f0f\uff0c\u8f38\u5165 ",(0,i.jsx)(n.code,{children:"\\x"})," \u4f86\u986f\u793a\u55ae\u884c\uff0c\n\u63a5\u8457\u67e5\u770b ",(0,i.jsx)(n.code,{children:"pg_stat_statements"})," \u7684\u8cc7\u6599"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM pg_stat_statements;\n-- result\n-[ RECORD 1 ]----------+------------------------------------\nuserid                 | 10\ndbid                   | 16411\ntoplevel               | t\nqueryid                | -8553890797533947962\nquery                  | CREATE EXTENSION pg_stat_statements\nplans                  | 0\ntotal_plan_time        | 0\nmin_plan_time          | 0\nmax_plan_time          | 0\nmean_plan_time         | 0\nstddev_plan_time       | 0\ncalls                  | 1\ntotal_exec_time        | 36.871701\nmin_exec_time          | 36.871701\nmax_exec_time          | 36.871701\nmean_exec_time         | 36.871701\nstddev_exec_time       | 0\nrows                   | 0\nshared_blks_hit        | 2653\nshared_blks_read       | 131\nshared_blks_dirtied    | 60\nshared_blks_written    | 7\nlocal_blks_hit         | 0\nlocal_blks_read        | 0\nlocal_blks_dirtied     | 0\nlocal_blks_written     | 0\ntemp_blks_read         | 0\ntemp_blks_written      | 0\n--More--\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u9019\u500b view \u6703\u8a18\u9304\u76f8\u540c\u7684 SQL \u8a9e\u53e5\u4e26\u751f\u6210\u7d71\u8a08\u8cc7\u6599(\u4e0d\u540c\u53c3\u6578\u7b97\u540c\u4e00\u8a9e\u53e5)\uff0c\n\u6211\u5011\u53ef\u4ee5\u91cd\u9ede\u95dc\u6ce8\u4e00\u4e0b\u6578\u64da\uff0c\u5305\u542b :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"mean_exec_time"})," : \u5e73\u5747\u57f7\u884c\u6642\u9593"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"stddev_exec_time"})," : \u57f7\u884c\u6642\u9593\u7684\u6a19\u6e96\u5dee\uff0c\u53ef\u4ee5\u5224\u65b7\u67e5\u8a62\u662f\u5426\u7a69\u5b9a"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"shared_blks_hit"})," : \u5f9e shared buffer \u4e2d\u8b80\u53d6\u7684\u8cc7\u6599\u91cf"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"shared_blks_read"})," : \u5f9e disk \u4e2d\u8b80\u53d6\u7684\u8cc7\u6599\u91cf"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"temp_blks_read"})," : \u5f9e temp disk \u4e2d\u8b80\u53d6\u7684\u8cc7\u6599\u91cf\uff0c\u5982\u679c\u9019\u500b\u6578\u503c\u5f88\u5927\uff0c\u8868\u793a\u9019\u500b\u67e5\u8a62\u53ef\u80fd\u6709 IO \u554f\u984c"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"temp_blks_written"})," : \u5beb\u5165 temp disk \u7684\u8cc7\u6599\u91cf"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"blk_read_time"})," : \u8b80\u53d6 disk \u7684\u6642\u9593"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"blk_write_time"})," : \u5beb\u5165 disk \u7684\u6642\u9593"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u7684\u6307\u4ee4\u4f86\u67e5\u8a62\u524d 10 \u500b\u57f7\u884c\u6642\u9593\u6700\u9577\u7684 SQL \u8a9e\u53e5\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT\n    round((100 * total_exec_time / sum(total_exec_time) OVER ())::numeric, 2) AS percent,\n    round(total_exec_time::numeric, 2) AS total,\n    calls,\n    round(mean_exec_time::numeric, 2) AS mean,\n    substring(query, 1, 200) AS query\nFROM pg_stat_statements\nORDER BY total_exec_time DESC\nLIMIT 10;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u9664\u4e86\u5b89\u88dd\u9019\u500b extension \u4e4b\u5916\uff0c\u6211\u5011\u4e5f\u53ef\u4ee5\u900f\u904e\u7cfb\u7d71\u5167\u5efa\u7684 ",(0,i.jsx)(n.code,{children:"pg_stat_sys_table"})," \u548c ",(0,i.jsx)(n.code,{children:"pg_stat_user_table"})," \u4f86\u67e5\u770b\u7cfb\u7d71\u548c\u4f7f\u7528\u8005\u8868\u7684\u7d71\u8a08\u8cc7\u6599\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"psql -d benchdb\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM pg_stat_user_tables;\n-- result\n-[ RECORD 1 ]-------+------------------------------\nrelid               | 24650\nschemaname          | public\nrelname             | pgbench_branches\nseq_scan            | 5296\nlast_seq_scan       | 2024-07-31 03:16:49.550047+00\nseq_tup_read        | 5296\nidx_scan            | 59414\nlast_idx_scan       | 2024-07-31 03:16:49.729185+00\nidx_tup_fetch       | 59414\nn_tup_ins           | 1\nn_tup_upd           | 64707\nn_tup_del           | 0\nn_tup_hot_upd       | 64424\nn_tup_newpage_upd   | 283\nn_live_tup          | 1\nn_dead_tup          | 19\nn_mod_since_analyze | 0\nn_ins_since_vacuum  | 0\nlast_vacuum         | 2024-07-31 03:16:49.548988+00\nlast_autovacuum     |\nlast_analyze        | 2024-07-31 03:15:09.69068+00\nlast_autoanalyze    | 2024-07-31 03:16:56.637775+00\nvacuum_count        | 3\nautovacuum_count    | 0\nanalyze_count       | 1\nautoanalyze_count   | 1\n--More--\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u53ef\u4ee5\u95dc\u6ce8\u4e00\u4e9b\u53c3\u6578\uff0c\u4f8b\u5982 :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"seq_scan"})," : \u4f7f\u7528 sequential scan \u7684\u6b21\u6578"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"idx_scan"})," : \u4f7f\u7528 index scan \u7684\u6b21\u6578"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"n_live_tup"})," : \u8868\u4e2d\u5b58\u6d3b\u7684 tuple \u6578\u91cf"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"n_dead_tup"})," : \u88ab\u522a\u9664\u7684 tuple \u6578\u91cf"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u63d0\u4f9b\u7684 SQL \u4f86\u5e6b\u52a9\u6211\u5011\u7372\u5f97\u4e00\u4e9b\u6709\u7528\u7684\u8cc7\u8a0a :"}),"\n",(0,i.jsx)(n.p,{children:"\u90a3\u4e9b table \u4f7f\u7528 index scan \u7684\u6bd4\u4f8b\u6700\u591a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT  schemaname,\n        relname,\n        seq_scan,\n        idx_scan,\n        cast(idx_scan AS numeric) / (idx_scan + seq_scan) AS idx_scan_pct\nFROM pg_stat_user_tables\nWHERE (idx_scan + seq_scan) > 0\nORDER BY idx_scan_pct;\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5be6\u969b\u8b80\u53d6\u7684\u8cc7\u6599\u91cf\u6709\u591a\u5c11\u662f\u5f9e\u7d22\u5f15\u7372\u53d6\u7684"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT  relname, seq_tup_read,\n        idx_tup_fetch,\n        cast(idx_tup_fetch AS numeric) / (idx_tup_fetch + seq_tup_read) AS idx_tup_pct\nFROM pg_stat_user_tables\nWHERE (idx_tup_fetch + seq_tup_read) > 0\nORDER BY idx_tup_pct;\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u544a\u8a34\u6211\u5011\u90a3\u4e9b\u8868\u7d93\u5e38\u9032\u884c\u5168\u8868\u6383\u63cf\uff0c\u53ef\u80fd\u9700\u8981\u5efa\u7acb index"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT schemaname,\n       relname,\n       seq_scan,\n       seq_tup_read,\n       seq_tup_read / seq_scan AS avg,\n       idx_scan\nFROM   pg_stat_user_tables\nWHERE  seq_scan > 0\nORDER BY seq_tup_read DESC\nLIMIT  25;\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u90a3\u4e9b\u8868\u5e38\u5e38\u9032\u884c\u5beb\u5165\uff0c\u90a3\u4e9b\u8868\u5e38\u5e38\u9032\u884c\u66f4\u65b0\u6216\u522a\u9664"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT  relname,\n        cast(n_tup_ins AS numeric) / (n_tup_ins + n_tup_upd + n_tup_del) AS ins_pct,\n        cast(n_tup_upd AS numeric) / (n_tup_ins + n_tup_upd + n_tup_del) AS upd_pct,\n        cast(n_tup_del AS numeric) / (n_tup_ins + n_tup_upd + n_tup_del) AS del_pct\nFROM pg_stat_user_tables\nORDER BY relname;\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u544a\u8a34\u6211\u5011\u90a3\u4e9b\u8868\u5e38\u5e38\u9032\u884c HOT \u66f4\u65b0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT  relname,\n        n_tup_upd,\n        n_tup_hot_upd,\n        cast(n_tup_hot_upd AS numeric) / n_tup_upd AS hot_pct\nFROM pg_stat_user_tables\nWHERE n_tup_upd > 0\nORDER BY hot_pct;\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u544a\u8a34\u6211\u5011 index \u4f7f\u7528\u7387\u548c\u5927\u5c0f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT  schemaname,\n        relname,\n        indexrelname,\n        idx_scan,\n        pg_size_pretty(pg_relation_size(indexrelid)) AS idx_size\nFROM pg_stat_user_indexes;\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u8a55\u4f30\u7d22\u5f15\u7684\u6548\u7387\uff0c\u9ad8 avg_tuples \u503c\u8868\u793a\u8a72\u7d22\u5f15\u5728\u6bcf\u6b21\u6383\u63cf\u6642\u80fd\u5920\u7372\u53d6\u8f03\u591a\u7684\u76f8\u95dc\u6578\u64da"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT  indexrelname,\n        cast(idx_tup_read AS numeric) / idx_scan AS avg_tuples,\n        idx_scan,\n        idx_tup_read\nFROM pg_stat_user_indexes\nWHERE idx_scan > 0;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"query-plan",children:"Query Plan"}),"\n",(0,i.jsx)(n.p,{children:"postgres \u63d0\u4f9b\u4e86\u56db\u7a2e scan \u7684\u65b9\u5f0f\uff0c\u5206\u5225\u662f :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Seq Scan : \u5168\u8868\u6383\u63cf"}),"\n",(0,i.jsx)(n.li,{children:"Index Scan : \u7d22\u5f15\u6383\u63cf"}),"\n",(0,i.jsx)(n.li,{children:"Index Only Scan : \u53ea\u8b80\u53d6\u7d22\u5f15\u7684\u8cc7\u6599"}),"\n",(0,i.jsx)(n.li,{children:"Bitmap Scan : \u4f4d\u5716\u6383\u63cf"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u8a73\u7d30\u7684\u8aaa\u660e\u53ef\u4ee5\u53c3\u8003 ",(0,i.jsx)(n.a,{href:"https://oldmo860617.medium.com/%E4%BB%A5-postgressql-%E7%82%BA%E4%BE%8B%E4%BA%86%E8%A7%A3%E8%B3%87%E6%96%99%E5%BA%AB%E7%9A%84-query-plans-abd8b5f54c66",children:"\u4ee5 PostgreSQL \u70ba\u4f8b\u4e86\u89e3\u8cc7\u6599\u5eab\u7684 Query Plans"})]}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 postgres \u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"EXPLAIN ANALYZE"})," \u6307\u4ee4\u4f86\u67e5\u770b\u67e5\u8a62\u7684\u57f7\u884c\u8a08\u5283\uff0c\u9019\u500b\u6307\u4ee4\u6703\u544a\u8a34\u6211\u5011\u67e5\u8a62\u7684\u57f7\u884c\u6d41\u7a0b\uff0c\n\u4ee5\u53ca\u6bcf\u500b\u6b65\u9a5f\u7684\u57f7\u884c\u6642\u9593\u548c\u8cc7\u6599\u91cf\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"EXPLAIN (analyze, verbose, costs, timing, buffers) SELECT * FROM pgbench_tellers;\n-- result\n                                                     QUERY PLAN\n---------------------------------------------------------------------------------------------------------------------\n Seq Scan on public.pgbench_tellers  (cost=0.00..12.10 rows=10 width=352) (actual time=0.009..0.016 rows=10 loops=1)\n   Output: tid, bid, tbalance, filler\n   Buffers: shared hit=12\n Query Identifier: 8245021215169886143\n Planning Time: 0.038 ms\n Execution Time: 0.027 ms\n(6 rows)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u9019\u6a23\u7684\u57f7\u884c\u7d50\u679c\u4ee3\u8868\u9019\u500b\u57f7\u884c\u53ea\u6709\u4e00\u500b node \uff0c\u4e26\u4e14\u662f\u4f7f\u7528 sequential scan \u7684\u65b9\u5f0f\u4f86\u9032\u884c\u6383\u63cf\uff0c\n\u5176\u4e2d ",(0,i.jsx)(n.code,{children:"cost"})," \u7684\u7b2c\u4e00\u500b\u6578\u5b57\u4ee3\u8868\u8f38\u51fa\u968e\u6bb5\u958b\u59cb\u4e4b\u524d\u82b1\u8cbb\u7684\u6642\u9593\uff0c\u4f8b\u5982\uff0c\u5728\u6392\u5e8f\u7bc0\u9ede\u4e2d\u9032\u884c\u6392\u5e8f\u7684\u6642\u9593\uff0c\n\u7b2c\u4e8c\u500b\u6578\u5b57\u4ee3\u8868\u9019\u500b node \u7684\u7e3d\u6210\u672c\uff0c",(0,i.jsx)(n.code,{children:"row"})," \u4ee3\u8868\u9810\u671f\u6703\u56de\u50b3\u7684\u884c\u6578\uff0c",(0,i.jsx)(n.code,{children:"width"})," \u4ee3\u8868\u6bcf\u500b row \u7684\u5e73\u5747\u6709\u591a\u5c11 bytes\uff0c\n",(0,i.jsx)(n.code,{children:"loops"})," \u4ee3\u8868\u5faa\u74b0\u7684\u6b21\u6578\uff0c\u5982\u679c\u6709 join \u7684\u8a71\u5c31\u6709\u53ef\u80fd\u5927\u65bc 1\u3002"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"cost estimate",src:s(215).Z+"",width:"541",height:"410"})}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u53ef\u4ee5\u4f9d\u64da\u4e0a\u9762\u9019\u5f35\u5716\u4f86\u8a08\u7b97 query \u7684 cost\uff0c\u9032\u800c\u7522\u751f\u6700\u597d\u7684\u57f7\u884c\u8a08\u5283\u3002"}),"\n",(0,i.jsxs)(n.p,{children:["\u6211\u5011\u4e5f\u53ef\u4ee5\u5728 postgres \u4e2d\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"pg_class"})," \u4f86\u67e5\u770b table \u7684\u76f8\u95dc\u8cc7\u8a0a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT  relpages,\n        current_setting('seq_page_cost') AS seq_page_cost,\n        relpages * current_setting('seq_page_cost')::decimal AS page_cost,\n        reltuples,\n        current_setting('cpu_tuple_cost') AS cpu_tuple_cost,\n        relpages * current_setting('cpu_tuple_cost')::decimal AS tuple_cost\nFROM pg_class\nWHERE relname = 'pgbench_tellers';\n-- result\nrelpages | seq_page_cost | page_cost | reltuples | cpu_tuple_cost | tuple_cost\n----------+---------------+-----------+-----------+----------------+------------\n        7 | 1             |         7 |        10 | 0.01           |       0.07\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u5011\u4e5f\u6709\u53ef\u80fd\u9047\u5230 query plan \u4f30\u8a08\u7684\u503c\u8207\u5be6\u969b\u76f8\u5dee\u5f88\u5927\u7684\u60c5\u6cc1\uff0c\u4f8b\u5982\u4ee5\u4e0b\u7684\u4f8b\u5b50 :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE TABLE test_estimate as SELECT * FROM generate_series(1, 10000) as id;\nEXPLAIN ANALYZE SELECT * FROM test_estimate WHERE cos(id) < 4;\n-- result\n                                                   QUERY PLAN\n----------------------------------------------------------------------------------------------------------------\n Seq Scan on test_estimate  (cost=0.00..220.00 rows=3333 width=4) (actual time=0.070..0.924 rows=10000 loops=1)\n   Filter: (cos((id)::double precision) < '4'::double precision)\n Planning Time: 0.792 ms\n Execution Time: 1.224 ms\n(4 rows)\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\u4f30\u8a08\u7684 row \u8ddf\u5be6\u969b\u7684 row \u76f8\u5dee\u5f88\u5927\uff0c\u9019\u6642\u5019\u6211\u5011\u53ef\u80fd\u5c31\u9700\u8981\u4f7f\u7528 index \u6216\u662f\u5176\u4ed6\u7684\u624b\u6bb5\u4f86\u89e3\u6c7a\u9019\u500b\u554f\u984c\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"CREATE INDEX idx_test_estimate ON test_estimate (cos(id));\nANALYZE test_estimate;\nEXPLAIN ANALYZE SELECT * FROM test_estimate WHERE cos(id) > 4;\n-- result\n                                                   QUERY PLAN\n-----------------------------------------------------------------------------------------------------------------\n Seq Scan on test_estimate  (cost=0.00..220.00 rows=10000 width=4) (actual time=0.015..1.638 rows=10000 loops=1)\n   Filter: (cos((id)::double precision) < '4'::double precision)\n Planning Time: 0.325 ms\n Execution Time: 2.052 ms\n(4 rows)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"sql-optimization",children:"SQL Optimization"}),"\n",(0,i.jsx)(n.h3,{id:"join-order",children:"Join Order"}),"\n",(0,i.jsx)(n.p,{children:"postgres \u6703\u5728 join \u7684\u6642\u5019\u5617\u8a66\u4e0d\u540c\u7684 join order \u4f86\u627e\u5230\u6700\u512a\u7684\u57f7\u884c\u8a08\u5283\uff0c\n\u9810\u8a2d\u662f 8 \u6b21\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u5176\u8a2d\u7f6e\u70ba 1 \u4f86\u5f37\u5236\u4f7f\u7528\u624b\u52d5\u7684 join order\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM pg_settings WHERE name = 'join_collapse_limit';\nSET join_collapse_limit = 1;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"avoid-select-",children:"Avoid SELECT *"}),"\n",(0,i.jsxs)(n.p,{children:["\u6e1b\u5c11\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"SELECT *"}),"\uff0c\u53ef\u4ee5\u8b93 index scan \u8b8a\u6210 index onlay scan\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"avoid-order-by",children:"Avoid Order By"}),"\n",(0,i.jsx)(n.p,{children:"\u7531\u65bc postgres \u5728\u57f7\u884c order by \u7684\u6642\u5019\uff0c\u6703\u9700\u8981\u984d\u5916\u958b\u555f\u4e00\u500b\u6392\u5e8f\u7684 buffer\uff0c\n\u9019\u6a23\u6703\u5c0e\u81f4\u8a18\u61b6\u9ad4\u4f7f\u7528\u91cf\u589e\u52a0\uff0c\u9032\u800c\u5f71\u97ff\u6548\u80fd\uff0c\u56e0\u6b64\u6211\u5011\u61c9\u8a72\u76e1\u91cf\u907f\u514d\u4f7f\u7528 order by\uff0c \u4f46\u5982\u679c\u6709 index \u5247\u53ef\u4ee5\u5927\u5e45\u6e1b\u5c11\u9019\u500b\u554f\u984c\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"avoid-distinct",children:"Avoid Distinct"}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u4f7f\u7528 distinct \u6642\uff0c postgres \u9700\u8981\u7522\u751f\u4e00\u500b\u984d\u5916\u7684 Unique node \u4f86\u8655\u7406\uff0c\n\u9019\u6a23\u6703\u5c0e\u81f4\u8a18\u61b6\u9ad4\u4f7f\u7528\u91cf\u589e\u52a0\uff0c\u9032\u800c\u5f71\u97ff\u6548\u80fd\uff0c\u56e0\u6b64\u6211\u5011\u61c9\u8a72\u76e1\u91cf\u907f\u514d\u4f7f\u7528 distinct\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"parallel-query",children:"Parallel Query"}),"\n",(0,i.jsx)(n.p,{children:"postgres \u53ef\u4ee5\u4f7f\u7528\u5e73\u884c\u7684\u65b9\u5f0f\u4f86\u57f7\u884c query\uff0c\u9019\u6a23\u53ef\u4ee5\u5927\u5e45\u6e1b\u5c11\u57f7\u884c\u6642\u9593\uff0c\n\u53ef\u4ee5\u900f\u904e\u4ee5\u4e0b\u6307\u4ee4\u4f86\u67e5\u770b\u76f8\u95dc\u7684\u8a2d\u7f6e"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SHOW max_worker_processes;\nSHOW max_parallel_workers_per_gather;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"shared-buffer",children:"Shared Buffer"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.img,{alt:"shared buffer",src:s(502).Z+"",width:"698",height:"550"}),"\n",(0,i.jsx)(n.img,{alt:"shared buffer",src:s(7969).Z+"",width:"914",height:"524"})]}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u4e0d\u7279\u5225\u91dd\u5c0d\u67d0\u500b table \u7684\u60c5\u6cc1\u4e0b\uff0c\u6211\u5011\u53ef\u4ee5\u5c07 shared buffer \u8a2d\u7f6e\u70ba RAM \u6578\u91cf\u7684 25%\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"reference",children:"Reference"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.udemy.com/course/postgresql-high-performance-tuning-guide",children:"PostgreSQL High Performance Tuning Guide"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.interdb.jp/pg/index.html",children:"The Internals of PostgreSQL"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://oldmo860617.medium.com/%E4%BB%A5-postgressql-%E7%82%BA%E4%BE%8B%E4%BA%86%E8%A7%A3%E8%B3%87%E6%96%99%E5%BA%AB%E7%9A%84-query-plans-abd8b5f54c66",children:"\u4ee5 PostgreSQL \u70ba\u4f8b\u4e86\u89e3\u8cc7\u6599\u5eab\u7684 Query Plans"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},2666:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-1-4bdcf0170b7e0dca0d7d064608e95fde.png"},215:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-10-0a69563c3c7b822098c3ff6769883c4b.png"},502:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-11-412204ea9bd5a0a1a7ac5d508fd76959.png"},7969:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-12-8145bc90aeb938ca2ccd3b6241869632.png"},6530:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-2-1106f184584dfb51593154d604765950.png"},4967:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-3-b4a13be1b1cacf60064e19d7737306db.png"},936:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-4-f0e068de4b1007214cabc5808110beb1.png"},5605:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-6-aee1e560f4c7a049695159320e420747.png"},1631:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-7-e5d2cd289ef5513eff554deff75dee31.png"},6507:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-8-c403fed56482ad32d569e3d31601f818.png"},9433:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/image-61acbff2d42b7c1d4d512924cd7512a1.png"},1151:(e,n,s)=>{s.d(n,{Z:()=>a,a:()=>c});var i=s(7294);const t={},r=i.createContext(t);function c(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);