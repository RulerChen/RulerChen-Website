"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["5103"],{5187:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>s,toc:()=>t,default:()=>x,metadata:()=>l,assets:()=>o,contentTitle:()=>c});var l=JSON.parse('{"id":"CMU15-445/p3","title":"P3 - Query Execution","description":"Query Execution","source":"@site/docs/CMU15-445/p3.mdx","sourceDirName":"CMU15-445","slug":"/CMU15-445/p3","permalink":"/RulerChen-Website/docs/CMU15-445/p3","draft":false,"unlisted":false,"editUrl":"https://github.com/RulerChen/RulerChen-Website/tree/main/docs/CMU15-445/p3.mdx","tags":[{"inline":true,"label":"CMU15-445","permalink":"/RulerChen-Website/docs/tags/cmu-15-445"},{"inline":true,"label":"CMU15-445 Projects","permalink":"/RulerChen-Website/docs/tags/cmu-15-445-projects"}],"version":"current","lastUpdatedAt":1758458745000,"sidebarPosition":103,"frontMatter":{"title":"P3 - Query Execution","sidebar_position":103,"description":"Query Execution","keywords":["CMU15-445/645","Query Execution","CMU15-445/645 \u7B46\u8A18"],"tags":["CMU15-445","CMU15-445 Projects"]},"sidebar":"tutorialSidebar","previous":{"title":"P2 - B+ Tree","permalink":"/RulerChen-Website/docs/CMU15-445/p2"},"next":{"title":"P4 - Concurrency Control","permalink":"/RulerChen-Website/docs/CMU15-445/p4"}}'),d=i(4848),r=i(4429);let s={title:"P3 - Query Execution",sidebar_position:"103",description:"Query Execution",keywords:["CMU15-445/645","Query Execution","CMU15-445/645 \u7B46\u8A18"],tags:["CMU15-445","CMU15-445 Projects"]},c,o={},t=[{value:"Background",id:"background",level:2},{value:"SQL Query Journey",id:"sql-query-journey",level:3},{value:"Entrypoint",id:"entrypoint",level:4},{value:"Parser",id:"parser",level:4},{value:"Binder",id:"binder",level:4},{value:"Planner",id:"planner",level:4},{value:"Optimizer",id:"optimizer",level:4},{value:"Executor",id:"executor",level:4},{value:"Storage Structure",id:"storage-structure",level:3},{value:"Task 1 - Access Method Executors",id:"task-1---access-method-executors",level:2},{value:"SeqScan",id:"seqscan",level:3},{value:"Insert",id:"insert",level:3},{value:"Update",id:"update",level:3},{value:"Delete",id:"delete",level:3},{value:"IndexScan",id:"indexscan",level:3},{value:"IndexScan Optimizer",id:"indexscan-optimizer",level:3},{value:"Task 2 - Aggregation &amp; Join Executors",id:"task-2---aggregation--join-executors",level:2},{value:"Aggregation",id:"aggregation",level:3},{value:"NestedLoopJoin",id:"nestedloopjoin",level:3},{value:"NestedIndexJoin",id:"nestedindexjoin",level:3},{value:"Task 3 - HashJoin Executor and Optimization",id:"task-3---hashjoin-executor-and-optimization",level:2},{value:"HashJoin",id:"hashjoin",level:3},{value:"HashJoin Optimizer",id:"hashjoin-optimizer",level:3},{value:"Task 4 - External Merge Sort + Limit Executors",id:"task-4---external-merge-sort--limit-executors",level:2},{value:"External Merge Sort",id:"external-merge-sort",level:3},{value:"Limit",id:"limit",level:3},{value:"Submit",id:"submit",level:2},{value:"Takeaways",id:"takeaways",level:2},{value:"References",id:"references",level:2}];function a(e){let n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components},{Head:i,ImageModal:l}=n;return i||h("Head",!0),l||h("ImageModal",!0),(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(i,{children:(0,d.jsx)("title",{children:"CMU 15-445 2024Fall P3 Query Execution"})}),"\n",(0,d.jsx)(n.p,{children:"\u5728\u9019\u500B project \u4E2D\uFF0C\u6211\u5011\u9700\u8981\u5BE6\u73FE\u4E00\u500B query execution engine\uFF0C\u7E3D\u5171\u6709 4 \u500B task :"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"Access Method Executors"}),"\n",(0,d.jsx)(n.li,{children:"Aggregation & Join Executors"}),"\n",(0,d.jsx)(n.li,{children:"HashJoin Executor and Optimization"}),"\n",(0,d.jsx)(n.li,{children:"External Merge Sort + Limit Executors"}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"background",children:"Background"}),"\n",(0,d.jsx)(n.p,{children:"\u9019\u500B project \u7684\u80CC\u666F\u77E5\u8B58\u76F8\u5C0D\u6BD4\u8F03\u8907\u96DC\uFF0C\u9700\u8981\u5927\u91CF\u95B1\u8B80\u7A0B\u5F0F\u78BC\u4F86\u4E86\u89E3\u6574\u500B\u7D50\u69CB\u3002"}),"\n",(0,d.jsx)(n.p,{children:"\u6211\u6703\u4ECB\u7D39\u4E00\u4E0B\u6574\u500B SQL \u5F9E\u8F38\u5165\u5230\u57F7\u884C\u7684\u6D41\u7A0B\u4EE5\u53CA\u8CC7\u6599\u5132\u5B58\u7684\u7D50\u69CB\u4F86\u65B9\u4FBF\u5927\u5BB6\u7406\u89E3\u3002\n\u5982\u679C\u9084\u662F\u6709\u5361\u4F4F\u7684\u8A71\uFF0C\u6211\u5EFA\u8B70\u53EF\u4EE5\u5148\u53BB\u770B\u4E00\u4E9B\u5DF2\u7D93\u5BE6\u73FE\u597D\u7684 Executor \u4F86\u4E86\u89E3\u6574\u500B\u6D41\u7A0B\u3002"}),"\n",(0,d.jsx)(n.h3,{id:"sql-query-journey",children:"SQL Query Journey"}),"\n",(0,d.jsx)(n.p,{children:"\u9019\u908A\u6703\u7528\u4E00\u500B\u7C21\u55AE\u7684 SQL \u7576\u4F5C\u7BC4\u4F8B\uFF0C\u7C21\u55AE\u4ECB\u7D39\u4E00\u4E0B bustub \u4E2D SQL \u662F\u600E\u9EBC\u88AB\u57F7\u884C\u7684\u3002\n\u7BC4\u4F8B\u9019\u90E8\u5206\u6211\u662F\u7528 AI \u5E6B\u5FD9\u751F\u6210\u7684\uFF0C\u4E0D\u4E00\u5B9A\u662F\u771F\u6B63\u7684\u6B04\u4F4D\u4F46\u80FD\u4E86\u89E3\u610F\u601D\u5C31\u597D :"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-sql",children:"SELECT s.id, s.name, e.course\nFROM student s\nJOIN enrollment e ON s.id = e.sid\nWHERE s.age > 18\nLIMIT 10;\n"})}),"\n",(0,d.jsx)(l,{src:"/img/cmu15-445/p3/image.webp",caption:"SQL Query Journey"}),"\n",(0,d.jsx)(n.h4,{id:"entrypoint",children:"Entrypoint"}),"\n",(0,d.jsxs)(n.p,{children:["Shell \u7684\u5165\u53E3\u9EDE\u5728 ",(0,d.jsx)(n.code,{children:"src/tools/shell/shell.cpp"}),"\uFF0C\u8CA0\u8CAC\u5275\u5EFA ",(0,d.jsx)(n.code,{children:"BustubInstance"})," \u5BE6\u4F8B\u4E26\u547C\u53EB ",(0,d.jsx)(n.code,{children:"bustub->ExecuteSql()"})," \u4F86\u57F7\u884C SQL\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"BustubInstance"})," \u7684 ",(0,d.jsx)(n.code,{children:"ExecuteSql()"})," \u51FD\u6578\u662F\u57F7\u884C SQL \u7684\u4E3B\u8981\u5165\u53E3\uFF0C\u5B83\u6703\u547C\u53EB ",(0,d.jsx)(n.code,{children:"ExecuteSqlTxn()"})," \u4F86\u57F7\u884C\u67E5\u8A62\uFF0C\u5982\u679C\u51FA\u73FE\u932F\u8AA4\u5247\u6703\u547C\u53EB ",(0,d.jsx)(n.code,{children:"Abort()"}),"\u3002"]}),"\n",(0,d.jsx)(n.h4,{id:"parser",children:"Parser"}),"\n",(0,d.jsxs)(n.p,{children:["\u9996\u5148 query \u6703\u5148\u9032\u5165 parser\uFF0Cparser \u7684\u4F5C\u7528\u662F\u5C07 SQL \u89E3\u6790\u6210 AST\uFF0C\u9019\u90E8\u5206 bustub \u662F\u4F7F\u7528\u7B2C\u4E09\u65B9\u7684\u5DE5\u5177 ",(0,d.jsx)(n.code,{children:"libpg_query"})," \u4F86\u5B8C\u6210\u7684\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u5728 ",(0,d.jsx)(n.code,{children:"ExecuteSqlTxn()"})," \u4E2D bustub \u6703\u547C\u53EB ",(0,d.jsx)(n.code,{children:"ParseAndSave()"})," \u4F86\u5C07 SQL \u89E3\u6790\u6210 AST\uFF0C\u4E26\u628A\u7D50\u679C\u5B58\u5230 ",(0,d.jsx)(n.code,{children:"statement_nodes_"})," \u4E2D\u3002"]}),"\n",(0,d.jsx)(n.p,{children:"\u4EE5\u4E0A\u9762\u7684 SQL \u70BA\u4F8B\uFF0C\u89E3\u6790\u5F8C\u7684 AST \u53EF\u80FD\u6703\u9577\u9019\u6A23 :"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:'PGSelectStmt {\n  targetList: [\n    PGResTarget { name: "id", val: PGColumnRef { fields: ["s", "id"] } },\n    PGResTarget { name: "name", val: PGColumnRef { fields: ["s", "name"] } },\n    PGResTarget { name: "course", val: PGColumnRef { fields: ["e", "course"] } }\n  ],\n  fromClause: [\n    PGJoinExpr {\n      jointype: JOIN_INNER,\n      larg: PGRangeVar { relname: "student", alias: "s" },\n      rarg: PGRangeVar { relname: "enrollment", alias: "e" },\n      quals: PGAExpr { op: "=", lexpr: "s.id", rexpr: "e.sid" }\n    }\n  ],\n  whereClause: PGAExpr { op: ">", lexpr: "s.age", rexpr: 18 },\n  limitCount: 10\n}\n'})}),"\n",(0,d.jsx)(n.h4,{id:"binder",children:"Binder"}),"\n",(0,d.jsx)(n.p,{children:"\u63A5\u8457\u9019\u500B AST \u5C31\u6703\u4EA4\u7D66 binder\uFF0Cbinder \u7684\u4F5C\u7528\u662F\u900F\u904E Catalog \u5C07 AST \u4E2D\u7684\u540D\u7A31\u7D81\u5B9A\u5230\u5BE6\u969B\u7684\u8CC7\u6599\u5EAB\u7269\u4EF6\u4E0A\u3002"}),"\n",(0,d.jsxs)(n.p,{children:["\u5728 ",(0,d.jsx)(n.code,{children:"ExecuteSqlTxn()"})," \u4E2D\uFF0C",(0,d.jsx)(n.code,{children:"BindStatement()"})," \u51FD\u6578\u6703\u8CA0\u8CAC\u9019\u500B\u5DE5\u4F5C\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u4EE5\u4E0A\u9762\u7684 SQL \u70BA\u4F8B\uFF0C\u7D81\u5B9A\u4E4B\u5F8C\u7684 AST \u53EF\u80FD\u6703\u9577\u9019\u6A23\uFF0C\u53EF\u4EE5\u770B\u5230\u5B83\u5DF2\u7D93\u6709 ",(0,d.jsx)(n.code,{children:"table_oid"})," \u8DDF ",(0,d.jsx)(n.code,{children:"col_idx"})," \u4E86 :"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:'SelectStatement {\n  select_list_: [\n    BoundColumnRef { col_name: "id", type: INTEGER, table_oid: 1, col_idx: 0 },\n    BoundColumnRef { col_name: "name", type: VARCHAR, table_oid: 1, col_idx: 1 },\n    BoundColumnRef { col_name: "course", type: VARCHAR, table_oid: 2, col_idx: 1 }\n  ],\n  table_: BoundJoinRef {\n    type: INNER_JOIN,\n    left: BoundBaseTableRef { \n      table: "student", \n      alias: "s", \n      oid: 1,\n      schema: [id:INTEGER, name:VARCHAR, age:INTEGER]\n    },\n    right: BoundBaseTableRef { \n      table: "enrollment", \n      alias: "e", \n      oid: 2,\n      schema: [sid:INTEGER, course:VARCHAR]\n    },\n    condition: BoundBinaryOp {\n      op_type: EQUAL,\n      left: BoundColumnRef { col_name: "id", table_oid: 1, col_idx: 0 },\n      right: BoundColumnRef { col_name: "sid", table_oid: 2, col_idx: 0 }\n    }\n  },\n  where_: BoundBinaryOp {\n    op_type: GREATER_THAN,\n    left: BoundColumnRef { col_name: "age", table_oid: 1, col_idx: 2 },\n    right: BoundConstant { value: 18, type: INTEGER }\n  },\n  limit_: BoundConstant { value: 10, type: INTEGER }\n}\n'})}),"\n",(0,d.jsx)(n.h4,{id:"planner",children:"Planner"}),"\n",(0,d.jsx)(n.p,{children:"\u7D81\u5B9A\u597D\u7269\u4EF6\u4E4B\u5F8C\u5C31\u6703\u4EA4\u7D66 planner\uFF0Cplanner \u7684\u4F5C\u7528\u662F\u5C07\u7D81\u5B9A\u597D\u7684 AST \u8F49\u63DB\u6210\u57F7\u884C\u8A08\u5283 (PlanNode)\u3002"}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"Planner"})," \u7684 ",(0,d.jsx)(n.code,{children:"PlanQuery()"})," \u51FD\u6578\u6703\u5C07 ",(0,d.jsx)(n.code,{children:"Binder"})," \u8F49\u63DB\u70BA ",(0,d.jsx)(n.code,{children:"PlanNode"}),"\uFF0C\u9019\u662F\u4E00\u500B\u6A39\u72C0\u7D50\u69CB\uFF0C\u8868\u793A SQL \u8A9E\u53E5\u7684\u57F7\u884C\u8A08\u5283\u3002"]}),"\n",(0,d.jsx)(n.p,{children:"\u4EE5\u4E0A\u9762\u7684 SQL \u70BA\u4F8B\uFF0C\u8F49\u63DB\u5F8C\u7684\u57F7\u884C\u8A08\u5283\u53EF\u80FD\u6703\u9577\u9019\u6A23 :"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"LimitPlanNode {\n  limit_: 10,\n  child_: ProjectionPlanNode {\n    expressions_: [\n      ColumnValueExpression { col_idx: 0 }, // s.id\n      ColumnValueExpression { col_idx: 1 }, // s.name  \n      ColumnValueExpression { col_idx: 4 }  // e.course (after join)\n    ],\n    output_schema_: Schema([id:INTEGER, name:VARCHAR, course:VARCHAR]),\n    child_: FilterPlanNode {\n      predicate_: ComparisonExpression {\n        op_: GREATER_THAN,\n        left_: ColumnValueExpression { col_idx: 2 }, // s.age\n        right_: ConstantValueExpression { value: 18 }\n      },\n      child_: NestedLoopJoinPlanNode {\n        join_type_: INNER,\n        join_predicate_: ComparisonExpression {\n          op_: EQUAL,\n          left_: ColumnValueExpression { col_idx: 0 }, // s.id\n          right_: ColumnValueExpression { col_idx: 3 }  // e.sid\n        },\n        output_schema_: Schema([id:INTEGER, name:VARCHAR, age:INTEGER, sid:INTEGER, course:VARCHAR]),\n        left_child_: SeqScanPlanNode {\n          table_oid_: 1, // student table\n          output_schema_: Schema([id:INTEGER, name:VARCHAR, age:INTEGER])\n        },\n        right_child_: SeqScanPlanNode {\n          table_oid_: 2, // enrollment table\n          output_schema_: Schema([sid:INTEGER, course:VARCHAR])\n        }\n      }\n    }\n  }\n}\n"})}),"\n",(0,d.jsx)(n.h4,{id:"optimizer",children:"Optimizer"}),"\n",(0,d.jsx)(n.p,{children:"\u63A5\u8457\u5C31\u6703\u4EA4\u7D66 optimizer \u4F86\u512A\u5316\u57F7\u884C\u8A08\u5283\uFF0C\u9019\u88E1 bustub \u63A1\u7528\u7684\u662F rule-based \u7684\u65B9\u5F0F\uFF0C\u4E5F\u5C31\u662F\u5B83\u6703\u4E00\u689D\u4E00\u689D\u898F\u5247\u7684\u5957\u7528\u5230\u57F7\u884C\u8A08\u5283\u4E0A\u3002"}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"Optimizer"})," \u7684 ",(0,d.jsx)(n.code,{children:"Optimize()"})," \u51FD\u6578\u6703\u6AA2\u67E5\u9019\u4E9B\u898F\u5247\u4E26\u5957\u7528\u5230 ",(0,d.jsx)(n.code,{children:"PlanNode"})," \u4E0A\uFF0C\u6BD4\u5982\u8AAA\u6211\u5011\u8981\u5BE6\u4F5C\u7684 ",(0,d.jsx)(n.code,{children:"OptimizeNLJAsIndexJoin"}),"\u3002"]}),"\n",(0,d.jsx)(n.p,{children:"\u4EE5\u4E0A\u9762\u7684 SQL \u70BA\u4F8B\uFF0C\u512A\u5316\u5F8C\u7684\u57F7\u884C\u8A08\u5283\u53EF\u80FD\u6703\u9577\u9019\u6A23\uFF0C\u6539\u6210\u4F7F\u7528 NestedIndexJoin \u4E26\u505A\u4E86 predicate pushdown :"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:'LimitPlanNode {\n  limit_: 10,\n  child_: ProjectionPlanNode {\n    expressions_: [\n      ColumnValueExpression { col_idx: 0 },  // s.id\n      ColumnValueExpression { col_idx: 1 },  // s.name\n      ColumnValueExpression { col_idx: 4 }   // e.course\n    ],\n    child_: NestedIndexJoinPlanNode {        \n      outer_child_: FilterPlanNode {\n        predicate_: ComparisonExpression { op: GT, left: age, right: 18 },\n        child_: SeqScanPlanNode { table: "student" }\n      },\n      key_predicate_: ColumnValueExpression { col_idx: 0 },  // s.id\n      inner_table_oid_: 2,\n      index_oid_: 5,\n      index_name_: "enrollment_sid_idx"\n    }\n  }\n}\n'})}),"\n",(0,d.jsx)(n.h4,{id:"executor",children:"Executor"}),"\n",(0,d.jsxs)(n.p,{children:["\u6700\u5F8C\u5C31\u662F\u4EA4\u7D66 executor \u4F86\u5C07 ",(0,d.jsx)(n.code,{children:"PlanNode"})," \u8F49\u63DB\u6210\u5C0D\u61C9\u7684 ",(0,d.jsx)(n.code,{children:"Executor"}),"\uFF0C\u9019\u88E1 bustub \u63A1\u7528\u7684\u662F pull-based \u7684 volcano model\uFF0C\u4E5F\u5C31\u662F\u6BCF\u500B ",(0,d.jsx)(n.code,{children:"Executor"})," \u90FD\u6709 ",(0,d.jsx)(n.code,{children:"Init()"})," \u8DDF ",(0,d.jsx)(n.code,{children:"Next()"})," \u5169\u500B\u65B9\u6CD5\uFF0C\u4E26\u4E14\u4E0A\u5C64\u7684 ",(0,d.jsx)(n.code,{children:"Executor"})," \u6703\u4E0D\u65B7\u547C\u53EB\u4E0B\u5C64\u7684 ",(0,d.jsx)(n.code,{children:"Executor"})," \u7684 ",(0,d.jsx)(n.code,{children:"Next()"})," \u4F86\u53D6\u5F97\u8CC7\u6599\u76F4\u5230\u56DE\u50B3 false \u70BA\u6B62\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["Executor \u7684\u5165\u53E3\u9EDE\u5728 ",(0,d.jsx)(n.code,{children:"src/execution/executor_engine.cpp"}),"\uFF0C\u5B83\u6703\u547C\u53EB ",(0,d.jsx)(n.code,{children:"ExecutorFactory::CreateExecutor()"})," \u4F86\u905E\u8FF4\u5730\u91DD\u5C0D\u4E0D\u540C\u7A2E\u985E\u7684 ",(0,d.jsx)(n.code,{children:"PlanNode"})," \u5275\u5EFA\u5C0D\u61C9\u7684 ",(0,d.jsx)(n.code,{children:"Executor"}),"\u3002\n\u540C\u6642\u5B83\u4E5F\u6703\u547C\u53EB ",(0,d.jsx)(n.code,{children:"Init()"})," \u4F86\u521D\u59CB\u5316\u6574\u500B executor \u6A39\uFF0C\u6700\u5F8C\u547C\u53EB ",(0,d.jsx)(n.code,{children:"PollExecutor()"})," \u4F86\u4E0D\u65B7\u7684 pull \u8CC7\u6599\u76F4\u5230\u6C92\u6709\u8CC7\u6599\u70BA\u6B62\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u9664\u6B64\u4E4B\u5916\uFF0C",(0,d.jsx)(n.code,{children:"ExecutorContext"})," \u4E5F\u6703\u5728\u9019\u500B\u6642\u5019\u88AB\u5275\u5EFA\uFF0C\u5B83\u5305\u542B\u4E86 ",(0,d.jsx)(n.code,{children:"Transaction"}),"\u3001",(0,d.jsx)(n.code,{children:"Catalog"}),"\u3001",(0,d.jsx)(n.code,{children:"BufferPoolManager"})," \u7B49\u7B49\u57F7\u884C\u6642\u9700\u8981\u7684\u7269\u4EF6\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"storage-structure",children:"Storage Structure"}),"\n",(0,d.jsx)(n.p,{children:"\u5728\u4E86\u89E3\u4E86\u6574\u500B SQL \u7684\u57F7\u884C\u6D41\u7A0B\u4E4B\u5F8C\uFF0C\u6211\u5011\u9084\u9700\u8981\u4E86\u89E3\u4E00\u4E0B\u8CC7\u6599\u5EAB\u4E2D\u7684\u7D50\u69CB\u4EE5\u53CA\u9019\u4E9B\u7D50\u69CB\u662F\u5982\u4F55\u88AB\u5132\u5B58\u7684\u3002"}),"\n",(0,d.jsx)(l,{src:"/img/cmu15-445/p3/storage.webp",caption:"Storage Structure"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"Catalog"})," : \u6700\u9802\u5C64\u7684\u7D50\u69CB\uFF0C\u8CA0\u8CAC\u7BA1\u7406\u8CC7\u6599\u8868\u8DDF\u7D22\u5F15\uFF0C\u6709 ",(0,d.jsx)(n.code,{children:"CreateTable()"}),"\u3001",(0,d.jsx)(n.code,{children:"GetTable()"}),"\u3001",(0,d.jsx)(n.code,{children:"CreateIndex()"}),"\u3001",(0,d.jsx)(n.code,{children:"GetIndex()"})," \u7B49\u7B49\u65B9\u6CD5"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"TableInfo"})," : \u4EE3\u8868\u4E00\u500B\u8CC7\u6599\u8868\uFF0C\u5305\u542B\u4E86 ",(0,d.jsx)(n.code,{children:"Schema"}),"\u3001",(0,d.jsx)(n.code,{children:"TableHeap"}),"\u3001",(0,d.jsx)(n.code,{children:"TableOid"}),"\u3001",(0,d.jsx)(n.code,{children:"Name"})," \u7B49\u7B49\u8CC7\u8A0A"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"IndexInfo"})," : \u4EE3\u8868\u4E00\u500B\u7D22\u5F15\uFF0C\u5305\u542B\u4E86 ",(0,d.jsx)(n.code,{children:"Schema"}),"\u3001",(0,d.jsx)(n.code,{children:"Index"}),"\u3001",(0,d.jsx)(n.code,{children:"IndexOid"}),"\u3001",(0,d.jsx)(n.code,{children:"Name"})," \u7B49\u7B49\u8CC7\u8A0A"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"TableHeap"})," : \u4EE3\u8868 page \u7684\u5132\u5B58\u7D50\u69CB\uFF0C\u7DAD\u8B77 ",(0,d.jsx)(n.code,{children:"first_page_id_"})," \u8DDF ",(0,d.jsx)(n.code,{children:"last_page_id_"})," \u65B9\u4FBF\u63D2\u5165\u8DDF\u67E5\u8A62\u8CC7\u6599\uFF0C\u540C\u6642\u63D0\u4F9B\u4E86\u5F88\u591A\u5F88\u6709\u7528\u7684\u65B9\u6CD5\uFF0C\u4F8B\u5982 ",(0,d.jsx)(n.code,{children:"InsertTuple()"}),"\u3001",(0,d.jsx)(n.code,{children:"GetTuple()"}),"\u3001",(0,d.jsx)(n.code,{children:"UpdateTupleMeta()"}),"\u3001",(0,d.jsx)(n.code,{children:"UpdateTupleInPlaceWithLockAcquired()"})]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"TablePage"})," : \u4EE3\u8868\u4E00\u500B page\uFF0C\u63A1\u7528 slotted-page \u7684\u7D50\u69CB\u4F86\u5132\u5B58 tuple"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"Tuple"})," : \u4EE3\u8868\u4E00\u7B46\u8CC7\u6599\uFF0C\u5305\u542B\u4E86 ",(0,d.jsx)(n.code,{children:"RID"})," (\u7531 page id / slot num \u7D44\u6210) \u8DDF ",(0,d.jsx)(n.code,{children:"data"}),"\uFF0C",(0,d.jsx)(n.code,{children:"data"})," \u88E1\u9762\u6709\u591A\u500B ",(0,d.jsx)(n.code,{children:"Value"}),"\uFF0C",(0,d.jsx)(n.code,{children:"Value"})," \u53EF\u4EE5\u4EE3\u8868\u4E0D\u540C\u7684\u8CC7\u6599\u578B\u614B"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"TupleInfo"})," : \u4EE3\u8868 tuple \u5728 page \u4E2D\u7684 offset \u8DDF size \u4EE5\u53CA ",(0,d.jsx)(n.code,{children:"TupleMeta"}),"\uFF0C",(0,d.jsx)(n.code,{children:"TupleMeta"})," \u5305\u542B\u4E86 ",(0,d.jsx)(n.code,{children:"is_deleted_"})," \u8DDF ",(0,d.jsx)(n.code,{children:"ts_"})," (timestamp)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"Schema"})," : \u4EE3\u8868\u8CC7\u6599\u8868\u7684 schema\uFF0C\u5305\u542B\u4E86\u591A\u500B ",(0,d.jsx)(n.code,{children:"Column"})]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"Column"})," : \u4EE3\u8868\u4E00\u500B\u6B04\u4F4D\uFF0C\u5305\u542B\u4E86\u6B04\u4F4D\u540D\u7A31\u3001\u6B04\u4F4D\u985E\u578B\u3001\u6B04\u4F4D\u9577\u5EA6\u7B49\u7B49\u8CC7\u8A0A"]}),"\n"]}),"\n",(0,d.jsxs)(n.p,{children:["\u5728 executor \u4E2D\uFF0C\u5982\u679C\u6211\u5011\u8981\u8B80\u53D6\u8CC7\u6599\u8868\u7684\u8CC7\u6599\uFF0C\u901A\u5E38\u6703\u8981\u901A\u904E ",(0,d.jsx)(n.code,{children:"exec_ctx_->GetCatalog()"})," \u5148\u53D6\u5F97 ",(0,d.jsx)(n.code,{children:"Catalog"}),"\uFF0C\u7136\u5F8C\u518D\u7E7C\u7E8C\u5F80\u4E0B\u53D6\u5F97 ",(0,d.jsx)(n.code,{children:"TableInfo"}),"\u3001",(0,d.jsx)(n.code,{children:"TableHeap"})," \u7B49\u6211\u5011\u9700\u8981\u7684\u8CC7\u8A0A\u3002"]}),"\n",(0,d.jsx)(n.p,{children:"\u6574\u9AD4\u4F86\u8AAA\u55AE\u4E00\u7684\u51FD\u6578\u5BE6\u4F5C\u8D77\u4F86\u96E3\u5EA6\u61C9\u8A72\u4E0D\u662F\u592A\u9AD8\uFF0C\u6240\u4EE5\u4E0B\u9762\u6211\u5C31\u7C21\u55AE\u8AAA\u660E\u4E00\u4E0B\u6D41\u7A0B\u8DDF\u4E00\u4E9B\u53EF\u80FD\u6703\u7528\u5230\u7684\u65B9\u6CD5\u5C31\u597D\u3002"}),"\n",(0,d.jsx)(n.h2,{id:"task-1---access-method-executors",children:"Task 1 - Access Method Executors"}),"\n",(0,d.jsx)(n.h3,{id:"seqscan",children:"SeqScan"}),"\n",(0,d.jsxs)(n.p,{children:["\u4F7F\u7528 ",(0,d.jsx)(n.code,{children:"TableIterator"})," \u4F86\u6383\u63CF\uFF0C\u6CE8\u610F\u8DF3\u904E\u88AB\u522A\u9664\u7684\u8CC7\u6599\u8DDF WHERE \u689D\u4EF6\uFF0C\u53EF\u4EE5\u7528 ",(0,d.jsx)(n.code,{children:"Evaluate()"})," \u4F86\u5224\u65B7 WHERE \u689D\u4EF6\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"insert",children:"Insert"}),"\n",(0,d.jsxs)(n.p,{children:["\u9664\u4E86 ",(0,d.jsx)(n.code,{children:"TableHeap::InsertTuple()"})," \u4E4B\u5916\uFF0C\u9084\u9700\u8981\u65B0\u589E\u7D22\u5F15\uFF0C\u53EF\u4EE5\u7528 ",(0,d.jsx)(n.code,{children:"InsertEntry()"})," \u4F86\u65B0\u589E\u7D22\u5F15\uFF0Ckey \u53EF\u4EE5\u7528 ",(0,d.jsx)(n.code,{children:"KeyFromTuple()"})," \u4F86\u53D6\u5F97\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u9700\u8981\u6CE8\u610F\u8981\u6709\u4E00\u500B\u53C3\u6578\u8CA0\u8CAC\u8A18\u9304\u4E4B\u524D\u6709\u6C92\u6709\u56DE\u50B3\u904E\u7D50\u679C\u4E86\uFF0C\u56E0\u70BA\u4E0A\u5C64\u6703\u4E0D\u65B7\u547C\u53EB ",(0,d.jsx)(n.code,{children:"Next()"}),"\uFF0C\u5982\u679C\u5DF2\u7D93\u56DE\u50B3\u904E\u7D50\u679C\u4E86\u5C31\u8981\u56DE\u50B3 false\uFF0C\u5305\u62EC\u5F8C\u9762\u7684\u4E00\u4E9B executor \u4E5F\u662F\u4E00\u6A23\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"update",children:"Update"}),"\n",(0,d.jsxs)(n.p,{children:["\u5148\u628A\u820A\u7684 TupleMeta \u4F7F\u7528 ",(0,d.jsx)(n.code,{children:"UpdateTupleMeta()"})," \u6A19\u8A18\u70BA\u522A\u9664\uFF0C\u63A5\u8457\u628A index \u522A\u9664\uFF0C\u7136\u5F8C\u518D\u63D2\u5165\u65B0\u7684 tuple \u4E26\u63D2\u5165\u65B0\u7684\u7D22\u5F15\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"delete",children:"Delete"}),"\n",(0,d.jsx)(n.p,{children:"\u6C92\u5565\u7279\u5225\u597D\u8AAA\u7684\uFF0C\u5C31\u662F\u628A TupleMeta \u6A19\u8A18\u70BA\u522A\u9664\uFF0C\u7136\u5F8C\u522A\u9664\u7D22\u5F15\u3002"}),"\n",(0,d.jsx)(n.h3,{id:"indexscan",children:"IndexScan"}),"\n",(0,d.jsxs)(n.p,{children:["\u7528 ",(0,d.jsx)(n.code,{children:"pred_keys_"})," \u5224\u65B7\u662F\u9EDE\u67E5\u8A62\u9084\u662F\u7BC4\u570D\u67E5\u8A62\uFF0C\u5982\u679C\u662F\u9EDE\u67E5\u8A62\u5C31\u7528 ",(0,d.jsx)(n.code,{children:"ScanKey()"})," \u67E5\u8A62\u6BCF\u4E00\u500B key\uFF0C\u5982\u679C\u662F\u7BC4\u570D\u67E5\u8A62\u5C31\u76F4\u63A5\u7528 B+ tree \u7684\u8FED\u4EE3\u5668\u4F86\u6383\u63CF\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"indexscan-optimizer",children:"IndexScan Optimizer"}),"\n",(0,d.jsxs)(n.p,{children:["\u9996\u5148\u8981\u5148\u905E\u8FF4\u4F86\u904D\u6B77\u6574\u500B ",(0,d.jsx)(n.code,{children:"AbstractPlanNodeRef"}),"\uFF0C\u63A5\u8457\u6AA2\u67E5\u662F\u4E0D\u662F seq_scan + filter \u7684\u7D44\u5408\uFF0C\u4E26\u770B\u770B\u6709\u6C92\u6709 index \u53EF\u4EE5\u7528\u3002"]}),"\n",(0,d.jsx)(n.p,{children:"\u6709\u4E09\u7A2E\u60C5\u6CC1\u8981\u8655\u7406 :"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM t1 WHERE v1 = 1;\nSELECT * FROM t1 WHERE 2 = v1;\nSELECT * FROM t1 WHERE v1 = 1 OR v1 = 2;\n"})}),"\n",(0,d.jsxs)(n.p,{children:["\u5C0D\u65BC\u524D\u5169\u7A2E\u60C5\u6CC1\uFF0C\u6211\u5011\u9700\u8981\u6AA2\u67E5\u8B02\u8A5E\u662F\u5426\u70BA ",(0,d.jsx)(n.code,{children:"ComparisonExpression"}),"\uFF0C\u4E14\u6BD4\u8F03\u985E\u578B\u70BA Equal\u3002\n\u63A5\u8457\u6AA2\u67E5\u5DE6\u53F3\u5B50\u7BC0\u9EDE\uFF0C\u78BA\u4FDD\u4E00\u908A\u662F ",(0,d.jsx)(n.code,{children:"ColumnValueExpression"})," (\u8B8A\u6578)\uFF0C\u53E6\u4E00\u908A\u662F ",(0,d.jsx)(n.code,{children:"ConstantValueExpression"}),"(\u5E38\u6578)\u3002\n\u518D\u4F86\u6AA2\u67E5 ",(0,d.jsx)(n.code,{children:"ColumnValueExpression"})," \u7684 ",(0,d.jsx)(n.code,{children:"col_idx"})," \u662F\u5426\u8207\u67D0\u500B\u53EF\u7528\u7D22\u5F15\u7684\u7B2C\u4E00\u500B\u9375\u503C\u6B04\u4F4D\u76F8\u7B26\u3002\n\u6700\u5F8C\u6AA2\u67E5 ",(0,d.jsx)(n.code,{children:"GetTupleIdx() == 0"}),"\uFF0C\u9019\u500B\u6AA2\u67E5\u78BA\u4FDD\u4E86\u9019\u500B\u6B04\u4F4D\u5C6C\u65BC\u7576\u524D\u6B63\u5728\u6383\u63CF\u7684\u9019\u5F35\u8868\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u5C0D\u65BC\u7B2C\u4E09\u7A2E\u60C5\u6CC1\uFF0C\u6211\u5011\u9700\u8981\u905E\u8FF4\u5730\u5206\u6790\u3002\n\u5982\u679C\u8868\u9054\u5F0F\u662F\u4E00\u500B ",(0,d.jsx)(n.code,{children:"LogicExpression"})," \u4E14\u908F\u8F2F\u985E\u578B\u662F ",(0,d.jsx)(n.code,{children:"LogicType::Or"}),"\uFF0C\u90A3\u9EBC\u6211\u5011\u5C31\u905E\u8FF4\u5730\u5C0D\u5176\u5DE6\u53F3\u5B50\u8868\u9054\u5F0F\u61C9\u7528\u524D\u5169\u7A2E\u60C5\u6CC1\u7684\u5224\u65B7\u908F\u8F2F\u3002"]}),"\n",(0,d.jsx)(n.h2,{id:"task-2---aggregation--join-executors",children:"Task 2 - Aggregation & Join Executors"}),"\n",(0,d.jsx)(n.h3,{id:"aggregation",children:"Aggregation"}),"\n",(0,d.jsxs)(n.p,{children:["\u9996\u5148\u8981\u5B8C\u6210 ",(0,d.jsx)(n.code,{children:"CombineAggregateValues"})," \u4E2D\u5E7E\u7A2E\u51FD\u6578\u7684\u5BE6\u4F5C\uFF0C\u9019\u90E8\u5206\u6BD4\u8F03\u7C21\u55AE\uFF0C\u4E3B\u8981\u662F\u8981\u6CE8\u610F ",(0,d.jsx)(n.code,{children:"NULL"})," \u7684\u8655\u7406\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u9019\u500B executor \u662F\u4E00\u500B pipeline breaker\uFF0C\u6240\u4EE5\u5728 ",(0,d.jsx)(n.code,{children:"Init()"})," \u7684\u6642\u5019\u5C31\u8981\u628A\u6240\u6709\u8CC7\u6599\u90FD\u8B80\u9032\u4F86\u4E26\u8A08\u7B97\u597D\u7D50\u679C\uFF0C\u53EF\u4EE5\u5229\u7528 ",(0,d.jsx)(n.code,{children:"MakeAggregateKey"}),"\u3001",(0,d.jsx)(n.code,{children:"MakeAggregateValue"})," \u4E26\u4E1F\u5230 ",(0,d.jsx)(n.code,{children:"InsertCombine()"})," \u4F86\u505A\u3002\n\u6700\u5F8C\u8F38\u51FA\u7684\u6642\u5019\u8981\u628A ",(0,d.jsx)(n.code,{children:"AggregateKey"})," \u8DDF ",(0,d.jsx)(n.code,{children:"AggregateValue"})," \u7684\u689D\u4EF6\u4E5F\u4E00\u8D77\u8F38\u51FA\u65B9\u4FBF\u4E0A\u9762\u7684 ",(0,d.jsx)(n.code,{children:"Projection"})," \u4F7F\u7528\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u9700\u8981\u7279\u5225\u8655\u7406 empty input \u7684\u60C5\u6CC1\uFF0C\u53EF\u4EE5\u547C\u53EB ",(0,d.jsx)(n.code,{children:"GenerateInitialAggregateValue()"})," \u4F86\u7522\u751F\u521D\u59CB\u503C\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"nestedloopjoin",children:"NestedLoopJoin"}),"\n",(0,d.jsxs)(n.p,{children:["\u9700\u8981\u8655\u7406 INNER JOIN \u8DDF LEFT JOIN \u5169\u7A2E\u60C5\u6CC1\u3002\n\u9019\u88E1\u6211\u7684\u505A\u6CD5\u662F\u5148\u8B80\u5DE6\u908A\u7684\u4E00\u500B tuple\uFF0C\u7136\u5F8C\u91CD\u65B0 ",(0,d.jsx)(n.code,{children:"Init()"})," \u53F3\u908A\u7684 executor\uFF0C\u63A5\u8457\u4E0D\u65B7\u547C\u53EB\u53F3\u908A\u7684 ",(0,d.jsx)(n.code,{children:"Next()"})," \u4E26\u7528 ",(0,d.jsx)(n.code,{children:"EvaluateJoin"})," \u4F86\u5224\u65B7\u6709\u6C92\u6709\u7B26\u5408\u689D\u4EF6\uFF0C\u5982\u679C\u6709\u5C31\u628A\u5169\u500B tuple \u5408\u4F75\u8D77\u4F86\u4E26\u56DE\u50B3\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u5982\u679C\u662F ",(0,d.jsx)(n.code,{children:"LEFT JOIN"})," \u7684\u8A71\uFF0C\u7576\u53F3\u908A\u7684 executor \u6383\u63CF\u5B8C\u4E4B\u5F8C\u9084\u6C92\u6709\u627E\u5230\u7B26\u5408\u689D\u4EF6\u7684 tuple\uFF0C\u5C31\u8981\u56DE\u50B3\u5DE6\u908A\u7684 tuple \u4E26\u628A\u53F3\u908A\u7684\u6B04\u4F4D\u8A2D\u70BA ",(0,d.jsx)(n.code,{children:"NULL"}),"\uFF0C\u53EF\u4EE5\u4F7F\u7528 ",(0,d.jsx)(n.code,{children:"ValueFactory::GetNullValueByType()"})," \u4F86\u7522\u751F ",(0,d.jsx)(n.code,{children:"NULL"}),"\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"nestedindexjoin",children:"NestedIndexJoin"}),"\n",(0,d.jsxs)(n.p,{children:["\u6574\u9AD4\u908F\u8F2F\u8DDF ",(0,d.jsx)(n.code,{children:"NestedLoopJoin"})," \u5DEE\u4E0D\u591A\uFF0C\u5DEE\u5225\u5728\u65BC\u53F3\u908A\u7684 executor \u662F\u4E00\u500B ",(0,d.jsx)(n.code,{children:"IndexScan"}),"\uFF0C\u6240\u4EE5\u6BCF\u6B21\u8B80\u5DE6\u908A\u7684 tuple \u4E4B\u5F8C\u8981\u7528 ",(0,d.jsx)(n.code,{children:"KeyPredicate"})," \u4F86\u751F\u6210 probe key\u3002"]}),"\n",(0,d.jsx)(n.h2,{id:"task-3---hashjoin-executor-and-optimization",children:"Task 3 - HashJoin Executor and Optimization"}),"\n",(0,d.jsx)(n.h3,{id:"hashjoin",children:"HashJoin"}),"\n",(0,d.jsxs)(n.p,{children:["\u9019\u500B task \u8981\u505A\u7684\u4E8B\u60C5\u9084\u883B\u591A\u7684\uFF0C\u9664\u4E86 ",(0,d.jsx)(n.code,{children:"Init()"})," \u8DDF ",(0,d.jsx)(n.code,{children:"Next()"})," \u4E4B\u5916\uFF0C\u9084\u8981\u5BE6\u4F5C\u91DD\u5C0D ",(0,d.jsx)(n.code,{children:"std::vector<Value>"})," \u7684 hash \u65B9\u6CD5\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u6211\u5BE6\u4F5C\u4E86\u4E00\u500B ",(0,d.jsx)(n.code,{children:"JoinKey"})," \u7684 class \u4F86\u4EE3\u8868 join key\uFF0C\u4E26\u4E14\u5BE6\u4F5C\u4E86 ",(0,d.jsx)(n.code,{children:"operator=="})," \u8DDF ",(0,d.jsx)(n.code,{children:"std::hash"})," \u4F86\u8B93\u5B83\u53EF\u4EE5\u88AB hash\uFF0C\u9019\u90E8\u5206\u53EF\u4EE5\u5927\u81F4\u53C3\u8003 ",(0,d.jsx)(n.code,{children:"AggregationPlanNode"})," \u7684\u5BE6\u4F5C\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u5728 ",(0,d.jsx)(n.code,{children:"Init()"})," \u7684\u6642\u5019\u53EF\u4EE5\u5148\u628A\u4E00\u908A\u7684\u8CC7\u6599\u90FD\u8B80\u9032\u4F86\u4E26\u5EFA\u7ACB hash table\uFF0C\u6211\u7684\u5132\u5B58\u65B9\u5F0F\u662F ",(0,d.jsx)(n.code,{children:"std::unordered_map<JoinKey, std::vector<Tuple>>"}),"\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u5728 ",(0,d.jsx)(n.code,{children:"Next()"})," \u7684\u6642\u5019\u5C31\u4E0D\u65B7\u8B80\u53E6\u4E00\u908A\u7684\u8CC7\u6599\uFF0C\u7136\u5F8C\u7528 join key \u53BB hash table \u88E1\u9762\u627E\u6709\u6C92\u6709\u7B26\u5408\u7684 tuple\uFF0C\u5982\u679C\u6709\u5C31\u628A\u5169\u500B tuple \u5408\u4F75\u8D77\u4F86\u4E26\u56DE\u50B3\uFF0C\u9700\u8981\u7279\u5225\u8655\u7406\u4E00\u5C0D\u591A\u7684\u60C5\u6CC1\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"hashjoin-optimizer",children:"HashJoin Optimizer"}),"\n",(0,d.jsx)(n.p,{children:"\u6709\u5169\u7A2E\u60C5\u6CC1\u53EF\u4EE5\u512A\u5316\u6210 HashJoin :"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM t1 JOIN t2 ON t1.v1 = t2.v1;\nSELECT * FROM t1 JOIN t2 ON t1.v1 = t2.v1 AND t1.v2 = t2.v2;\n"})}),"\n",(0,d.jsx)(n.p,{children:"\u9996\u5148\uFF0C\u8DDF\u5176\u4ED6 optimizer \u4E00\u6A23\u9700\u8981\u5148\u628A\u6A39\u905E\u8FF4\u5230\u5E95\u5728\u958B\u59CB\u3002"}),"\n",(0,d.jsxs)(n.p,{children:["\u5C0D\u65BC\u7B2C\u4E00\u7A2E\u60C5\u6CC1\u4F86\u8AAA\uFF0C\u9700\u8981\u6AA2\u67E5\u6383\u63CF\u65B9\u6CD5\u662F\u4E0D\u662F ",(0,d.jsx)(n.code,{children:"NestedLoopJoin"})," \u4E14\u662F\u900F\u904E ",(0,d.jsx)(n.code,{children:"ComparisonType::Equal"})," \u8DDF ",(0,d.jsx)(n.code,{children:"ColumnValueExpression"})," \u4F86 join \u7684\uFF0C\u63A5\u8457\u518D\u78BA\u5B9A\u4ED6\u5011\u662F\u4E0D\u662F\u4F86\u81EA\u4E0D\u540C\u7684 table\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u5C0D\u65BC\u7B2C\u4E8C\u7A2E\u60C5\u6CC1\u4F86\u8AAA\uFF0C\u9084\u9700\u8981\u8003\u616E AND \u7684\u60C5\u6CC1\uFF0C\u53EF\u4EE5\u7528\u905E\u8FF4\u7684\u65B9\u5F0F\u4F86\u6AA2\u67E5 ",(0,d.jsx)(n.code,{children:"LogicExpression"})," \u662F\u4E0D\u662F ",(0,d.jsx)(n.code,{children:"LogicType::And"}),"\uFF0C\u7136\u5F8C\u6AA2\u67E5\u5DE6\u53F3\u5B50\u7BC0\u9EDE\u7B26\u4E0D\u7B26\u5408\u7B2C\u4E00\u7A2E\u60C5\u6CC1\u7684\u689D\u4EF6\u3002"]}),"\n",(0,d.jsx)(n.h2,{id:"task-4---external-merge-sort--limit-executors",children:"Task 4 - External Merge Sort + Limit Executors"}),"\n",(0,d.jsx)(n.h3,{id:"external-merge-sort",children:"External Merge Sort"}),"\n",(0,d.jsxs)(n.p,{children:["\u9996\u5148\u8981\u5BE6\u4F5C ",(0,d.jsx)(n.code,{children:"TupleComparator::operator()"})," \u4F86\u6BD4\u8F03\u5169\u500B tuple \u7684\u5927\u5C0F\uFF0C\u9019\u90E8\u5206\u53EF\u4EE5\u7528 ",(0,d.jsx)(n.code,{children:"Value"})," \u88E1\u9762\u7684 ",(0,d.jsx)(n.code,{children:"CompareEquals()"}),"\u3001",(0,d.jsx)(n.code,{children:"CompareLessThan()"})," \u4F86\u6BD4\u8F03\u5927\u5C0F\uFF0C\u8981\u5340\u5206 ",(0,d.jsx)(n.code,{children:"ASC"})," (",(0,d.jsx)(n.code,{children:"DEFAULT"}),") \u8DDF ",(0,d.jsx)(n.code,{children:"DESC"}),"\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u63A5\u8457\u5BE6\u4F5C ",(0,d.jsx)(n.code,{children:"GenerateSortKey()"})," \u4F86\u7522\u751F\u6392\u5E8F\u7684 key\uFF0C\u53EF\u4EE5\u7528 ",(0,d.jsx)(n.code,{children:"MakeKeyFromTuple()"})," \u4F86\u7522\u751F\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u7136\u5F8C\u9700\u8981\u5BE6\u4F5C ",(0,d.jsx)(n.code,{children:"SortPage"})," \u8DDF ",(0,d.jsx)(n.code,{children:"MergeSortRun"})," \u4F86\u4EE3\u8868\u786C\u789F\u4E0A\u7684 page \u4EE5\u53CA\u4E00\u500B\u908F\u8F2F\u4E0A\u7684 run\uFF0C\u53EF\u4EE5\u81EA\u884C\u4F9D\u64DA\u9700\u6C42\u5BEB\u4E00\u4E9B helper function\u3002\n\u5728\u6211\u81EA\u5DF1\u7684\u5BE6\u4F5C\u4E2D\uFF0C",(0,d.jsx)(n.code,{children:"SortPage"})," \u6703\u5305\u542B\u4E00\u500B\u6210\u54E1 ",(0,d.jsx)(n.code,{children:"char data_[BUSTUB_PAGE_SIZE]"}),"\uFF0C\u9019\u500B\u6210\u54E1\u7684\u524D 4 \u500B byte \u6703\u7528\u4F86\u8A18\u9304\u9019\u500B page \u88E1\u9762\u6709\u591A\u5C11\u500B tuple\uFF0C\u5269\u4E0B\u7684\u7A7A\u9593\u5C31\u7528\u4F86\u653E tuple \u7684\u8CC7\u6599\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u9019\u908A\u6709\u5169\u500B\u554F\u984C\u8981\u6CE8\u610F\uFF0C\u7B2C\u4E00\u500B\u662F\u8981\u5728 ",(0,d.jsx)(n.code,{children:"MergeSortRun"})," \u4E2D\u7684 ",(0,d.jsx)(n.code,{children:"Iterator"})," \u4FDD\u7559\u4E0A\u4E00\u6B21\u8B80\u53D6\u7684 ",(0,d.jsx)(n.code,{children:"ReadPageGuard"}),"\uFF0C\u4E0D\u7136\u6E2C\u8A66\u5F88\u5BB9\u6613\u8D85\u6642\u3002\n\u7B2C\u4E8C\u500B\u662F\u5982\u679C\u9047\u5230\u4E86 ",(0,d.jsx)(n.code,{children:"test incurred 0 times of disk deletion, which is too low"})," \u7684\u932F\u8AA4\u8A0A\u606F\uFF0C\u4EE3\u8868\u6709\u53EF\u80FD\u5728 project 1 \u7684\u6642\u5019\u5C31\u6C92\u6709\u6B63\u78BA\u4F7F\u7528 ",(0,d.jsx)(n.code,{children:"disk_scheduler_->DeallocatePage()"})," \u5C0E\u81F4\u5B83\u6293\u4E0D\u5230 page \u7684\u522A\u9664\u6B21\u6578\u3002"]}),"\n",(0,d.jsxs)(n.p,{children:["\u6700\u5F8C\u5C31\u662F\u5BE6\u4F5C\u771F\u6B63\u7684 ",(0,d.jsx)(n.code,{children:"ExternalMergeSortExecutor"})," \u4E86\uFF0C\u9019\u88E1\u6211\u5BE6\u4F5C\u4E86 4 \u500B helper function \u4F86\u5206\u5225\u8655\u7406\u4E0D\u540C\u7684\u968E\u6BB5 :"]}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"CreateInitialRuns()"})," : \u5F9E child executor \u62C9 tuple\uFF0C\u7D44\u6210 ",(0,d.jsx)(n.code,{children:"<sort_key, tuple>"})," \u7684 pair\uFF0C\u6EFF\u4E00\u500B page \u7684\u5927\u5C0F\u5C31\u547C\u53EB ",(0,d.jsx)(n.code,{children:"FlushRunToDisk()"})," \u4F86\u628A\u9019\u4E9B tuple \u6392\u5E8F\u4E26\u5BEB\u5230\u786C\u789F\u4E0A"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"FlushRunToDisk()"})," : \u628A\u4E00\u500B run \u7684 tuple \u6392\u5E8F\u4E26\u5BEB\u5230\u786C\u789F\u4E0A\uFF0C\u9019\u88E1\u53EF\u4EE5\u7528 ",(0,d.jsx)(n.code,{children:"std::sort()"})," \u4F86\u6392\u5E8F\uFF0C\u4E26\u5BEB\u5165\u5230 ",(0,d.jsx)(n.code,{children:"SortPage"})," \u4E2D\u6700\u5F8C\u628A page_id \u8A18\u9304\u8D77\u4F86\u4E26\u585E\u56DE\u786C\u789F\u4E2D"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"MergeRuns()"})," : \u6BCF\u6B21\u53D6\u51FA\u5169\u500B page \u4E26\u547C\u53EB ",(0,d.jsx)(n.code,{children:"MergeTwoRuns()"})," \u4F86\u5408\u4F75\u6210\u4E00\u500B\u65B0\u7684 run\uFF0C\u6700\u5F8C\u56DE\u50B3\u65B0\u7684 run \u7684 page_id"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"MergeTwoRuns()"})," : \u904B\u7528\u5169\u500B iterator \u4F86\u5C07\u5169\u500B ",(0,d.jsx)(n.code,{children:"MergeSortRun"})," \u5408\u4F75\u6210\u4E00\u500B\u65B0\u7684 ",(0,d.jsx)(n.code,{children:"MergeSortRun"})]}),"\n"]}),"\n",(0,d.jsxs)(n.p,{children:["\u540C\u6642\u9019\u500B executor \u4E5F\u662F\u4E00\u500B pipeline breaker\uFF0C\u6240\u4EE5\u5728 ",(0,d.jsx)(n.code,{children:"Init()"})," \u7684\u6642\u5019\u5C31\u8981\u628A\u6240\u6709\u8CC7\u6599\u90FD\u8B80\u9032\u4F86\u4E26\u6392\u5E8F\u597D\uFF0C\u6700\u5F8C\u5728 ",(0,d.jsx)(n.code,{children:"Next()"})," \u7684\u6642\u5019\u53EA\u9700\u8981\u4E0D\u65B7\u5730\u5F9E\u6392\u5E8F\u597D\u7684 run \u4E2D\u8B80\u53D6 tuple \u4E26\u56DE\u50B3\u3002"]}),"\n",(0,d.jsx)(n.h3,{id:"limit",children:"Limit"}),"\n",(0,d.jsxs)(n.p,{children:["\u9019\u61C9\u8A72\u662F\u6700\u7C21\u55AE\u7684 executor\uFF0C\u53EA\u9700\u8981\u5728 ",(0,d.jsx)(n.code,{children:"Next()"})," \u7684\u6642\u5019\u8A08\u6578\uFF0C\u7576\u8D85\u904E limit \u7684\u6578\u91CF\u5C31\u56DE\u50B3 false\u3002"]}),"\n",(0,d.jsx)(n.h2,{id:"submit",children:"Submit"}),"\n",(0,d.jsxs)(n.p,{children:["\u5982\u679C\u8981\u57F7\u884C SQL\uFF0C\u53EF\u4EE5\u4F7F\u7528\u4EE5\u4E0B\u6307\u4EE4\u6216\u662F\u5230",(0,d.jsx)(n.a,{href:"https://15445.courses.cs.cmu.edu/fall2024/bustub/",children:"\u9019\u500B\u7DB2\u7AD9"}),"\u4E0A\u57F7\u884C :"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"make -j$(nproc) shell && ./bin/bustub-shell\n"})}),"\n",(0,d.jsx)(n.p,{children:"\u6E2C\u8A66\u7684\u65B9\u5F0F\u6709\u9EDE\u9EBB\u7169\uFF0C\u8981\u81EA\u5DF1\u4E00\u500B\u4E00\u500B\u8A66 :"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"make -j$(nproc) sqllogictest && \\\n./bin/bustub-sqllogictest ../test/sql/p3.05-index-scan-btree.slt --verbose\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"make format && make check-format && make check-lint && make check-clang-tidy-p3\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"make submit-p3\n"})}),"\n",(0,d.jsx)(n.h2,{id:"takeaways",children:"Takeaways"}),"\n",(0,d.jsx)(n.p,{children:"\u9019\u500B project \u505A\u8D77\u4F86\u5176\u5BE6\u883B\u7121\u804A\u7684\uFF0C\u56E0\u70BA\u5927\u90E8\u5206\u90FD\u662F\u7167\u8457\u898F\u683C\u4E00\u6B65\u4E00\u6B65\u5BE6\u4F5C\u5C31\u597D\uFF0C\u6C92\u6709\u4EC0\u9EBC\u7279\u5225\u7684\u6280\u5DE7\uFF0C\u4E0D\u904E\u56E0\u70BA\u8981\u770B\u7684\u6771\u897F\u4E0D\u5C11\uFF0C\u6240\u4EE5\u9084\u662F\u82B1\u4E86\u6211\u883B\u591A\u6642\u9593\u7684\u3002"}),"\n",(0,d.jsx)(n.p,{children:"\u5C0D\u65BC\u60F3\u8981\u5FEB\u901F\u901A\u95DC\u7684\u4EBA\u4F86\u8AAA\u6211\u89BA\u5F97 AI \u5728\u9019\u500B project \u4E0A\u9762\u61C9\u8A72\u53EF\u4EE5\u5E6B\u52A9\u5F88\u5927\uFF0C\u4F46\u8981\u6CE8\u610F\u4E00\u5B9A\u8981\u80FD\u7406\u89E3 AI \u5E6B\u4F60\u5BEB\u7684\u6771\u897F\uFF0C\u56E0\u70BA\u4E0B\u4E00\u500B project \u6703\u9700\u8981\u5728\u9019\u500B project \u7684\u57FA\u790E\u4E0A\u7E7C\u7E8C\u5BE6\u4F5C\u3002"}),"\n",(0,d.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/5843407385",children:"CMU Fall 2024 15-445 P3[\u5F85\u4F18\u5316]&PaperNotes"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/587566135",children:"\u505A\u4E2A\u6570\u636E\u5E93\uFF1A2022 CMU15-445 Project3 Query Execution"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/570917775",children:"BusTub \u517B\u6210\u8BB0\uFF1A\u4ECE\u8BFE\u7A0B\u9879\u76EE\u5230 SQL \u6570\u636E\u5E93"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/593909820",children:"CMU 15445-2022 P3 Query Optimize"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.a,{href:"https://juejin.cn/post/7527199538878939146",children:"CMU15445-2024fall-project3 \u8E29\u5751\u7ECF\u5386"})}),"\n"]})]})}function x(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(a,{...e})}):a(e)}function h(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},4429:function(e,n,i){i.d(n,{R:()=>s,x:()=>c});var l=i(6540);let d={},r=l.createContext(d);function s(e){let n=l.useContext(r);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:s(e.components),l.createElement(r.Provider,{value:n},e.children)}}}]);